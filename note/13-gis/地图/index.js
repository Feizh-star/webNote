class t{on(t,e,i){if(this.events=this.events||{},!(t in this.events))return this.events[t]=[{fn:e,context:i}],void this.newEvent(t);let o={fn:e,context:i},n=this.events[t];for(let t=0;t<n.length;t++)if(n[t].fn===e&&n[t].context===i)return;n.push(o)}fire(t,e){if(!this.events)return;const i=this.events[t];if(i)for(let t=0;t<i.length;t++){const o=i[t];o.fn.call(o.context||this,e)}}off(t,e,i){if(this.events=this.events||{},!(t in this.events))return void console.warn("事件不存在");let o=this.events[t];for(let n=0;n<o.length;n++)if(o[n].context===i&&o[n].fn===e)return o.splice(n,1),void(0==o.length&&(delete this.events[t],this.emptyEvent(t)))}newEvent(){}emptyEvent(){}}function e(t,e){this.x=t,this.y=e}e.prototype.isZero=function(){return 0===this.x&&0===this.y},e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y)},e.prototype.sub=function(t){return new e(this.x-t.x,this.y-t.y)},e.prototype.selfAdd=function(t){this.x+=t.x,this.y+=t.y},e.prototype.selfSub=function(t){this.x-=t.x,this.y-=t.y},e.prototype.distance=function(t){return Math.sqrt((this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y))},e.prototype.sub=function(t){return new e(this.x-t.x,this.y-t.y)},e.prototype.mu=function(t){return new e(this.x*t,this.y*t)},e.prototype.normalize=function(){const t=Math.sqrt(this.x*this.x+this.y*this.y);return new e(this.x/t,this.y/t)},e.prototype.dot=function(t){return this.x*t.x+this.y*t.y},e.prototype.equal=function(t){return this.x===t.x&&this.y===t.y};const i=6378137,o=85.0511287798;function n(t,i,n){const s=Math.PI/180,r=o;t=Math.max(Math.min(r,t),-r);const a=Math.sin(t*s);let h=i*s*.5/Math.PI,l=Math.log((1+a)/(1-a))/4/Math.PI;const c=256*Math.pow(2,n);return h=c*(h+.5),l=c*(.5-l),new e(h,l)}function s(t,e){const i=Math.PI/180,n=o;t=Math.max(Math.min(n,t),-n);const s=Math.sin(t*i);let r=Math.log((1+s)/(1-s))/4/Math.PI;return r=256*Math.pow(2,e)*(.5-r),r}function r(t,n){var s=Math.PI/180,r=o,a=(t=Math.max(Math.min(r,t),-r),Math.sin(t*s));return new e(i*n*s,i*Math.log((1+a)/(1-a))/2)}function a(t,e,i){const o=256*Math.pow(2,i);t=2*(t/o-.5)*Math.PI,e=2*-(e/o-.5)*Math.PI;const n=180/Math.PI;return{lat:(2*Math.atan(Math.exp(e))-Math.PI/2)*n,lon:t*n}}function h(t){const e=Math.PI/180,i=o;t=Math.max(Math.min(i,t),-i);const n=Math.sin(t*e);return Math.log((1+n)/(1-n))/4/Math.PI}function l(){}window.consoleMyName=function(){console.log("本软件由柴亚东（手机：15210569112）开发，非本人授权，不得使用")};class c extends t{constructor(t){super(),this.testOptions(t),this._contentEle=t.content,this._center={lat:t.center[0],lon:t.center[1]},this._zoom=t.zoom,this.maxZoom=t.maxZoom&&t.maxZoom<=20?t.maxZoom:20,this.minZoom=t.minZoom&&t.minZoom>=1?t.minZoom:3,this.preserveDrawingBuffer=t.preserveDrawingBuffer,this.wheelSpeed=t.wheelSpeed||1/800,this.zoomSpeed=t.zoomSpeed||200,this.animateSpeed=t.animateSpeed||5,this.dblclickZoom=t.dblclickZoom,this.dblclickZoomSpeed=t.dblclickZoomSpeed||500,this._pixelCenter=null,this._zoomScale=1,this.mousePosition={},this.moveSpeed=new e(0,0),this.moving=null,this.dragable=!0,this.moveStatus="end",this.zoomToChange=0,this.startZoomTime=(new Date).getTime(),this.beforeZoomTime=null,this.zooming=null,this.zoomState="zoomend",this.zoomable=!0,this.clickPos={},this.stayTime=t.stayTime||300,this.lastMoveTime=(new Date).getTime(),this.stayTimer=null,this.stayFired=!0,this.mouseOffsetX=0,this.mouseOffsetY=0,this.syncs=[],this.init()}testOptions(t){if(!t.content)throw new Error("map error: no content, init map failed");if(!t.center)throw new Error("map error: no center, init map failed");if(!t.zoom)throw new Error("map error: no zoom, init map failed")}init(){this.id=(new Date).getTime()+Math.round(1e4*Math.random()).toString(),this.layers={},this.layergroups={},this.eventLayer={},this.contexts={},this.createContent(),this.setMapStateByCenterLatlng(),this.initEvents()}createContent(){const t=document.createElement("canvas");let e;if(e=this._contentEle instanceof HTMLElement?this._contentEle:document.getElementById(this._contentEle),e.childNodes.length>0)throw new Error("请选择空元素作为地图容器");const i=document.createElement("div");i.setAttribute("class","cyd-map"),t.setAttribute("class","cyd-map-baseCanvas"),e.appendChild(i),i.appendChild(t);const o=e.offsetWidth,n=e.offsetHeight;(o<=100||n<100)&&console.warn("map content is too small"),t.width=o*devicePixelRatio,t.height=n*devicePixelRatio,this.clientX=o,this.clientY=n,this.drawSizeX=t.width,this.drawSizeY=t.height,this.canvasContent=i,this.contexts.baseCanvas={canvas:t,context:t.getContext("2d"),type:"2d"};const s=document.createElement("canvas");s.setAttribute("class","cyd-map-glCanvas"),i.appendChild(s),s.width=o*devicePixelRatio,s.height=n*devicePixelRatio;const r=s.getContext("webgl2",{preserveDrawingBuffer:this.preserveDrawingBuffer});if(!r)throw new Error("init gl failed");r.clearColor(0,0,0,0),r.enable(r.BLEND),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),this.contexts.glCanvas={type:"3d",canvas:s,context:r}}initEvents(){this.mouseDownEvents=this.mouseDownEvents.bind(this),this.fireclickEvent=this.fireclickEvent.bind(this),this.fireotherMouseEvent=this.fireotherMouseEvent.bind(this),this.firemoveEvent=this.firemoveEvent.bind(this),this.mouseUpEvents=this.mouseUpEvents.bind(this),this.mouseMoveEvent=this.mouseMoveEvent.bind(this),this.fireMouseEvent=this.fireMouseEvent.bind(this),this.resizeEvent=this.resizeEvent.bind(this),this.stayMoveEvent=this.stayMoveEvent.bind(this),this.initMouseDownEvents(),this.initMouseWheelEvent(),this.dblclickZoom&&this.initDblclickEvent(),this.initWindowResizeEvent(),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this._layerChange()}))}newEvent(t){const e=this.contexts.baseCanvas.canvas;"click"==t||"contextmenu"==t||"dblclick"==t?(e.removeEventListener(t,this.fireclickEvent),e.addEventListener(t,this.fireclickEvent)):"mousemove"==t?(e.removeEventListener(t,this.firemoveEvent),e.addEventListener(t,this.firemoveEvent)):"mousedown"==t||"mouseup"==t?(e.removeEventListener(t,this.fireotherMouseEvent),e.addEventListener(t,this.fireotherMouseEvent)):"mouseout"==t||"mouseover"==t?(e.removeEventListener("mousemove",this.firemoveEvent),e.addEventListener("mousemove",this.firemoveEvent)):"mousestay"==t&&(e.addEventListener("mousemove",this.stayMoveEvent),this.stayTimer=requestAnimationFrame(function(){this.checkStayMove()}.bind(this)))}emptyEvent(t){if(t in this.eventLayer&&this.eventLayer[t].length>0)return;const e=this.contexts.baseCanvas.canvas;"click"==t||"contextmenu"==t?e.removeEventListener(t,this.fireclickEvent):"mousemove"==t?e.removeEventListener(t,this.firemoveEvent):"mousedown"==t||"mouseup"==t?e.removeEventListener(t,this.fireotherMouseEvent):"mousestay"==t&&(e.removeEventListener("mousemove",this.stayMoveEvent),cancelAnimationFrame(this.stayTimer))}setLayerEventThis(t,e){const i=this.eventLayer;(!i[t]||0==i[t].length)&&(i[t]=[],this.newEvent(t));let o=0;"uparCanvas"==e.target&&(o=1e4);const n=e.index+o;let s=i[t];for(let t=0;t<s.length;t++)if(s[t].id==e.id)return;let r=0;for(let t=0;t<s.length;t++){if(s[t].index>n){r=t;break}if(!s[t+1]||s[t+1].index>n){r=t+1;break}}s.splice(r,0,e)}setLayerEvent(t,e,i,o){"mouseover"==t||"mouseout"==t?(e.on("mousemove",l),e.on(t,i),this.setLayerEventThis("mousemove",e),e.events.mousemove.stopPropagation=o):(e.on(t,i),this.setLayerEventThis(t,e),e.events[t].stopPropagation=o)}removeLayerEventThis(t,e){const i=this.eventLayer;if(!i[t])return;const o=i[t];for(let i=0;i<o.length;i++)if(o[i].id==e.id){o.splice(i,1),0==o.length&&(!this.events||!this.events[t])&&this.emptyEvent(t);break}}removeLayerEvent(t,e,i){if("mouseover"==t||"mouseout"==t){e.off(t,i);const o=e.events;!("mouseover"in o)&&!("mouseout"in o)&&(e.off("mousemove",l),this.removeLayerEventThis("mousemove",e))}else e.off(t,i),this.removeLayerEventThis(t,e)}fireMouseEvent(t){if("mousedown"==t.type&&2==t.button)return;const e={offsetX:t.clientX,offsetY:t.clientY,latlon:t.latlon};e.type=t.type,this.fire(t.type,e)}checkLayerEvent(t){const e=t.type,i=this.eventLayer[e],o=this.computeLatLngByContainPx(t.offsetX,t.offsetY,this._zoom);if(t.latlon=o,i)for(let o=i.length-1;o>=0;o--){const n=i[o];if(n.events&&n.events[e]){const e=n.fireEvent(t);if(e)return e}}}fireclickEvent(t){t.preventDefault(),t.offsetX==this.clickPos.x&&t.offsetY==this.clickPos.y&&!this.checkLayerEvent(t)&&this.fireMouseEvent(t)}firemoveEvent(t){t.preventDefault(),"moving"!=this.moveStatus&&!this.checkLayerEvent(t)&&this.fireMouseEvent(t)}stayMoveEvent(t){this.stayFired=!1,this.lastMoveTime=(new Date).getTime(),this.mouseOffsetX=t.offsetX,this.mouseOffsetY=t.offsetY}checkStayMove(){!this.stayFired&&(new Date).getTime()-this.lastMoveTime>this.stayTime&&(this.stayFired=!0,this.fireStayMoveEvent({type:"mousestay",offsetX:this.mouseOffsetX,offsetY:this.mouseOffsetY})),this.stayTimer=requestAnimationFrame(function(){this.checkStayMove()}.bind(this))}fireStayMoveEvent(t){this.checkLayerEvent(t)||this.fireMouseEvent(t)}fireotherMouseEvent(t){t.preventDefault(),!this.checkLayerEvent(t)&&this.fireMouseEvent(t)}initMouseDownEvents(){document.addEventListener("mousedown",this.mouseDownEvents)}mouseDownEvents(t){this.dragable&&t.target===this.contexts.baseCanvas.canvas&&(this.mousePosition=new e(t.clientX,t.clientY),this.clickPos=new e(t.offsetX,t.offsetY),cancelAnimationFrame(this.moving),document.addEventListener("mousemove",this.mouseMoveEvent),document.addEventListener("mouseup",this.mouseUpEvents))}mouseUpEvents(t){if(this.moveSpeed.isZero())return document.removeEventListener("mousemove",this.mouseMoveEvent),document.removeEventListener("mouseup",this.mouseUpEvents),(t.offsetX!=this.clickPos.x||t.offsetY!=this.clickPos.y)&&this.fire("moveend"),void(this.moveStatus="end");const e=(new Date).getTime();this.moving=requestAnimationFrame(function(){this.moveAnimate(e,this.moveSpeed,this.animateSpeed)}.bind(this)),document.removeEventListener("mousemove",this.mouseMoveEvent),document.removeEventListener("mouseup",this.mouseUpEvents)}mouseMoveEvent(t){"end"==this.moveStatus&&(this.fire("movestart"),this.moveStatus="moving");const i=this.mousePosition.x-t.clientX,o=this.mousePosition.y-t.clientY;this.moveSpeed=new e(i,o),this.mousePosition=new e(t.clientX,t.clientY),this._pixelCenter.selfAdd(this.moveSpeed),this.setMapStateByCenterPx(),this.render(),this.fireSync(),this.fire("move",{offsetX:t.offsetX,offsetY:t.offsetY})}moveAnimate(t,e,i){const o=(new Date).getTime(),n=Math.sign(e.x),s=Math.sign(e.y);let r=(o-t)/i,a=Math.abs(e.x)>r?n*r:e.x,h=Math.abs(e.y)>r?s*r:e.y;if(e.selfSub({x:a,y:h}),this._pixelCenter.selfAdd(e),this.setMapStateByCenterPx(),this.fireSync(),this.render(),e.isZero())return this.fire("moveend"),void(this.moveStatus="end");this.fire("move"),this.moving=requestAnimationFrame(function(){this.moveAnimate(o,e,i)}.bind(this))}initMouseWheelEvent(){const t=this.contexts.baseCanvas.canvas;t.addEventListener("wheel",function(e){if(!this.zoomable)return;e.stopPropagation(),e.preventDefault();let i=e.deltaY;1==e.deltaMode&&(i*=30);const o=-i*this.wheelSpeed;this.zoomToChange+=o,cancelAnimationFrame(this.zooming);const n=t.getBoundingClientRect(),s=e.clientX-n.left,r=e.clientY-n.top;this.zooming=window.requestAnimationFrame(function(){this.renderZoom(!0,s,r,this.zoomToChange)}.bind(this))}.bind(this),{passive:!1})}initDblclickEvent(){this.contexts.baseCanvas.canvas.ondblclick=function(t){if(!this.zoomable)return;t.stopPropagation(),t.preventDefault();const e=this.dblclickZoomSpeed*this.wheelSpeed;this.zoomToChange+=e,cancelAnimationFrame(this.zooming),this.zooming=window.requestAnimationFrame(function(){this.renderZoom(!0,t.offsetX,t.offsetY,this.zoomToChange)}.bind(this))}.bind(this)}renderZoom(t,e,i,o){if(0==this.zoomToChange)return;const n=this.zoomSpeed;if(t)return this.startZoomTime=(new Date).getTime(),this.beforeZoomTime=0,void(this.zooming=window.requestAnimationFrame(function(){this.renderZoom(!1,e,i,o)}.bind(this)));let s=(new Date).getTime()-this.startZoomTime;s>n&&(s=n);const r=(s-this.beforeZoomTime)/n*o;if(this._zoom==this.maxZoom&&r>=0)this.zoomToChange=0;else{if(!(this._zoom==this.minZoom&&r<=0))return this.zoomToChange-=r,this.beforeZoomTime=s,this.renderByZoom(e,i,r),this.beforeZoomTime>=n?(this.zoomToChange=0,void setTimeout(function(){0==this.zoomToChange&&(this.zoomState="zoomend",this.fire("zoomend"),this.fire("moveend"))}.bind(this),200)):void(this.zooming=window.requestAnimationFrame(function(){this.renderZoom(!1,e,i,o)}.bind(this)));this.zoomToChange=0}}renderZoomAndLatLon(t,e,i,o){if(0==this.zoomToChange)return;const n=this.zoomSpeed;if(t)return this.startZoomTime=(new Date).getTime(),this.beforeZoomTime=0,void(this.zooming=window.requestAnimationFrame(function(){this.renderZoomAndLatLon(!1,e,i,o)}.bind(this)));let s=(new Date).getTime()-this.startZoomTime;s>n&&(s=n);const r=(s-this.beforeZoomTime)/n*o,a=(s-this.beforeZoomTime)/n*e,h=(s-this.beforeZoomTime)/n*i;if(this._zoom==this.maxZoom&&r>=0)return void(this.zoomToChange=0);if(this._zoom==this.minZoom&&r<=0)return void(this.zoomToChange=0);this.zoomToChange-=r,this.beforeZoomTime=s,this._zoom=this._zoom+r;const l=this._center.lat+a,c=this._center.lon+h;if(this._center={lat:l,lon:c},this.setMapStateByCenterLatlng(),this.render(),this.beforeZoomTime>=n)return this.zoomToChange=0,void setTimeout(function(){0==this.zoomToChange&&(this.zoomState="zoomend",this.fire("zoomend"),this.fire("moveend"))}.bind(this),200);this.zooming=window.requestAnimationFrame(function(){this.renderZoomAndLatLon(!1,e,i,o)}.bind(this))}renderByZoom(t,e,i){"zoomend"==this.zoomState&&(this.zoomState="zooming",this.fire("zoomstart")),this.computeCenterPxByWheel(t,e,i),this.setMapStateByCenterPx(),this.fireSync(t,e,i),this.render(),"zooming"==this.zoomState&&this.fire("zoom")}computeCenterPxByWheel(t,e,i){const o=this.computeLatLngByContainPx(t,e,this._zoom);this._zoom+=i,this._zoom>this.maxZoom?(this._zoom=this.maxZoom,this.zoomToChange=0,"zooming"==this.zoomState&&(this.zoomState="zoomend",this.fire("zoomend"),this.fire("moveend"))):this._zoom<this.minZoom&&(this._zoom=this.minZoom,this.zoomToChange=0,"zooming"==this.zoomState&&(this.zoomState="zoomend",this.fire("zoomend"),this.fire("moveend")));const r=n(o.lat,o.lon,this._zoom);this.minYx=s(85,this._zoom),this.maxYx=s(-85,this._zoom);const a=this._pixelCenter,h=this.clientX/2-t,l=this.clientY/2-e;a.x=r.x+h,a.y=r.y+l}initWindowResizeEvent(){window.addEventListener("resize",this.resizeEvent)}resizeEvent(){const t=this.canvasContent,e=t.offsetWidth,i=t.offsetHeight;for(let t in this.contexts){const o=this.contexts[t];"2d"==o.type?(o.canvas.width=e*devicePixelRatio,o.canvas.height=i*devicePixelRatio):"3d"==o.type&&(o.canvas.width=e*devicePixelRatio,o.canvas.height=i*devicePixelRatio,o.context.viewport(0,0,o.canvas.width,o.canvas.height))}this.drawSizeX=e*devicePixelRatio,this.drawSizeY=i*devicePixelRatio,this.clientX=e,this.clientY=i,this.setMapStateByCenterPx(),this.render()}setPxView(t,i,o){this._pixelCenter=new e(t,i),this._zoom=o,this.setMapStateByCenterPx(),this.render()}sync(t){this.syncs.push(t)}unsync(t){const e=this.syncs;for(let i=0;i<e.length;i++)e[i].content===t.content&&e.splice(i,1)}fireSync(t,e,i){for(let o=0;o<this.syncs.length;o++)t&&e&&this.syncs[o].computeCenterPxByWheel(t,e,i),this.syncs[o].setPxView(this._pixelCenter.x,this._pixelCenter.y,this._zoom)}setMapStateByCenterLatlng(){this.minYx=s(85,this._zoom),this.maxYx=s(-85,this._zoom),this._pixelCenter=n(this._center.lat,this._center.lon,this._zoom),this.setMapStateByCenterPx()}setMapStateByCenterPx(){const t=this._zoom,e=Math.round(t);this._zoomScale=function(t,e){const i=t-e;return Math.pow(2,i)}(t,e);const i=this._pixelCenter,o=this.clientX/2,s=this.clientY/2;let r=i.x-o,h=i.x+o,l=i.y-s,c=i.y+s;l<this.minYx&&(c+=this.minYx-l,this._pixelCenter.y+=this.minYx-l,l=this.minYx),c>this.maxYx&&(l+=this.maxYx-c,this._pixelCenter.y+=this.maxYx-c,c=this.maxYx),r=Math.round(r),h=Math.round(h),l=Math.round(l),c=Math.round(c),this.pxbounds={xmin:r,xmax:h,ymin:l,ymax:c};const u=a(r,c,t),m=a(h,l,t);this.bounds={latlngMin:u,latlngMax:m};let d=n(m.lat,u.lon,e),f=n(u.lat,m.lon,e);this.zoomBounds={xmin:d.x,xmax:f.x,ymin:d.y,ymax:f.y},this._center=a(i.x,i.y,t)}computeLatLngByContainPx(t,e,i){const o=this._pixelCenter,n=this.clientX/2-t,s=this.clientY/2-e;return a(o.x-n,o.y-s,i)}getPxCenter(){return this._pixelCenter}getCenter(){return this._center}getPxBounds(){return this.pxbounds}getBounds(){return this.bounds}getSize(){return{x:this.clientX,y:this.clientY}}getZoom(){return this._zoom}setView(t,e,i){this._zoom=i,this._center={lat:t,lon:e},this.setMapStateByCenterLatlng(),this.fire("moveend"),this.render()}flyTo(t,e,i){const o=i-this._zoom;this.zoomToChange+=o;const n=t-this._center.lat,s=e-this._center.lon;cancelAnimationFrame(this.zooming),this.zooming=window.requestAnimationFrame(function(){this.renderZoomAndLatLon(!0,n,s,o)}.bind(this)),this.render()}flyToBounds(t,e,i,o){const n=(this.getSize().y-80)/2,s=(this.getSize().x-80)/2,r=(t+e)/2,a=(i+o)/2,l=function(t,e,i){const o=h(t),n=h(e);return Math.log2(i/(n-o)/256)}(r,e,n),c=function(t,e,i){const o=t/360,n=e/360;return Math.log2(i/(n-o)/256)}(a,o,s),u=Math.min(l,c,this.maxZoom);this.flyTo(r,a,u)}setZoom(t){this._zoom=t,this.setMapStateByCenterLatlng(),this.render()}zoomTo(t){const e=t-this._zoom;this.zoomToChange+=e,cancelAnimationFrame(this.zooming);const i=Math.round(this.clientX/2),o=Math.round(this.clientY/2);this.zooming=window.requestAnimationFrame(function(){this.renderZoom(!0,i,o,this.zoomToChange)}.bind(this))}setDragable(t){this.dragable=t}setZoomable(t){this.zoomable=t}showFps(){this.pscontent||(this.pscontent=document.createElement("div"),this.pscontent.setAttribute("class","cyd-map-ps"),this.pscontent.innerText="帧率：0",this.canvasContent.appendChild(this.pscontent)),this.lastTime=Date.now(),this.frameCount=0,this.computeFps()}computeFps(){let t=Date.now()-this.lastTime;this.frameCount++,t>=1e3&&(this.pscontent.innerText=this.frameCount,this.frameCount=0,this.lastTime=Date.now()),window.requestAnimationFrame(this.computeFps.bind(this))}project(t,e,i){return n(t,e,i)}unproject(t,e,i){return a(t,e,i)}latlonToPxContainer(t,e,i){return n(t,e,i).sub({x:this.pxbounds.xmin,y:this.pxbounds.ymin})}addLayer(t){const e=this.layers,i=t.target;if(i in e&&e[i].length>0){let o=e[i],n=0;for(let e=0;e<o.length;e++){if(o[e].index>t.index){n=e;break}if(!o[e+1]||o[e+1].index>t.index){n=e+1;break}}o.splice(n,0,t)}else e[i]=[t];if(t.events)for(let e in t.events)this.setLayerEventThis(e,t);"eleContent"!=t.target&&this.render()}hasLayer(t){let e=!1;if(!t)return!1;if("group"==t.type)return this.layergroups[t.id]&&(e=!0),e;const i=t.target;if(!i)return!1;const o=this.layers[i];if(!o)return!1;for(let i=0;i<o.length;i++)if(o[i].id===t.id){e=!0;break}return e}hasEventListeners(t){return t in this.events}getLayers(){return this.layers}removeLayer(t){const e=t.target,i=this.layers[e];for(let e=0;e<i.length;e++)if(i[e].id===t.id){if(t.events)for(let e in t.events)this.removeLayerEventThis(e,t);if(i.splice(e,1),0==i.length){const e=t.target;if("2d"==this.contexts[e].type)this.contexts[e].context.clearRect(0,0,this.drawSizeX,this.drawSizeY);else if("3d"==this.contexts[e].type){const t=this.contexts[e].context;t.clear(t.COLOR_BUFFER_BIT)}}else this.render();break}}_layerChange(){this.render()}hideAllTooltip(t){const e=this.layers;for(let i in e){const o=e[i];for(let e=0;e<o.length;e++){const i=o[e];i.tooltip&&i.id!=t&&(i.mouseIn=!1,i.tooltip.setVisiable(!1))}}}render(){void 0===this.animationDelayKey_&&(this.animationDelayKey_=requestAnimationFrame(this.animationDelay_.bind(this)))}animationDelay_(){this.animationDelayKey_=void 0,this.renderFrame()}renderFrame(){const t={pxbounds:this.pxbounds,bounds:this.bounds,drawNext:!1,context:null,zoom:this._zoom,devicePixelRatio:devicePixelRatio,firstDraw:!0,drawSize:[this.drawSizeX,this.drawSizeY],zoomScale:this._zoomScale,zoomBounds:this.zoomBounds,zoomState:this.zoomState,time:(new Date).getTime()};for(let e in this.layers){const i=this.layers[e];t.context=this.contexts[e].context,t.firstDraw=!0;for(let e=0;e<i.length;e++)i[e].render(t)}t.drawNext&&this.render()}destroy(){if(this.id){for(let t in this.layers){const e=this.layers[t];for(let t=0;t<e.length;t++)e[t].destroy(this)}document.removeEventListener("mousedown",this.mouseDownEvents),window.removeEventListener("resize",this.resizeEvent);for(let t in this.contexts)"3d"==this.contexts[t].type&&this.contexts[t].context.getExtension("WEBGL_lose_context").loseContext();this.canvasContent.parentNode.removeChild(this.canvasContent);for(let t in this)delete this[t]}else console.log("地图已经被销毁")}}class u extends t{constructor(t){super(),this.id=(new Date).getTime()+Math.round(1e4*Math.random()).toString(),this.index=0,this.target="baseCanvas",this._layerChange=[],this.init(t)}init(t){}initContent(t){const e=this.target;const i=document.createElement("canvas");i.setAttribute("class","cyd-map-"+e);const o=t.canvasContent;o.appendChild(i),this.targetZindex&&(i.style.zIndex=this.targetZindex,i.style.position="absolute",i.style.top=0,i.style.pointerEvents="none"),i.style.width="100%",i.style.height="100%";const n=o.offsetWidth,s=o.offsetHeight;i.width=n*devicePixelRatio,i.height=s*devicePixelRatio,t.contexts[e]={type:"2d",canvas:i},t.contexts[e].context=i.getContext("2d")}addTo(t){return"group"==t.type?(t.addLayer(this),this):(t.contexts[this.target]||this.initContent(t),t.addLayer(this),this._layerChange.push(t._layerChange.bind(t)),this)}removeFromMap(t){t.removeLayer(this),this.childLayers&&this.childLayers.length>0&&this.childLayers.forEach((e=>{e.removeFromMap(t)}))}layerChangeEvent(){this._layerChange.forEach((t=>{t()}))}render(){}destroy(){for(let t=0;t<arguments.length;t++)this.removeFromMap(arguments[t]),this.childLayers&&this.childLayers.length>0&&this.childLayers.forEach((e=>{e.destroy(arguments[t])}));for(let t in this)delete this[t]}}const m=10,d=20,f=100,x=500,p=600,y=200,g=500;class v extends u{constructor(t){super(t)}init(t){"target"in t&&(this.target=t.target),this.targetZindex=t.targetZindex,this.testOptions(t),this.index=m,this.tileSize=t.tileSize||256,this.url=t.url,this.customUrlFun=t.customUrlFun,this.cachedTiles={},this.loadingTiles={},this.loadingNum=0,this.useCros=!("useCros"in t)||t.useCross}testOptions(t){if(!t.url&&!t.customUrlFun)throw new Error("no tile url")}changeUrl(t){this.url=t,this.cachedTiles={},this.loadingTiles={},this.loadingNum=0,this.layerChangeEvent()}computeTiles(t,e,i,o){const n=this.tileSize;return{xminNum:Math.floor(t/n),xmaxNum:Math.floor(e/n),yminNum:Math.floor(i/n),ymaxNum:Math.floor(o/n)}}tileUrlFunction(t,e,i){if(this.customUrlFun)return this.customUrlFun(t,e,i);let o=this.url;return o=o.replace("{z}",t),o=o.replace("{x}",e),o=o.replace("{y}",i),o}getToCachedTiles(t,e){const i=[],o=t.xminNum+(t.xmaxNum-t.xminNum)/2,n=t.yminNum+(t.ymaxNum-t.yminNum)/2,s=Math.pow(2,e);for(let o=t.xminNum;o<=t.xmaxNum;o++){const n=o>=0?o%s:(o%s+s)%s;for(let s=t.yminNum;s<=t.ymaxNum;s++)i.push({zoom:e,i:o,ti:n,j:s})}return i.sort((function(t,e){return(t.i-o)*(t.i-o)+(t.j-n)*(t.j-n)-((e.i-o)*(e.i-o)+(e.j-n)*(e.j-n))})),i}clearCachedTiles(t,e,i,o,n,s,r){const a=this.cachedTiles,h=this.tileSize,l=t;for(let t in a){const c=a[t];if(Math.abs(c.z-l)>2){delete a[t];continue}if(!c.loaded)continue;const u=c.z;if(u===l)continue;const m=Math.pow(2,l-u);let d=!0;if(m>1){const t=c.x*m,s=c.x*m+m,f=c.y*m,x=c.y*m+m;for(let p=t;p<s;p++)if(!(p<e.xminNum||p>e.xmaxNum))for(let s=f;s<x;s++)if(!(s<e.yminNum||s>e.ymaxNum)){if(m>2){if(u+1+"_"+Math.floor(p/2)+"_"+Math.floor(s/2)in a)continue}if(!(l+"_"+p+"_"+s in a)){const e=(p-t)/m*h,a=(s-f)/m*h,l=1/m*h,u=Math.round((p*h-o.xmin)*n*r),x=Math.round((s*h-o.ymin)*n*r),y=Math.round((p*h+h-o.xmin)*n*r),g=Math.round((s*h+h-o.ymin)*n*r);i.drawImage(c.source,e,a,l,l,u,x,y-u,g-x),d=!1}}}else{if(m<.5){if(u-1+"_"+Math.floor(c.x/2)+"_"+Math.floor(c.y/2)in a)continue}const t=Math.floor(c.x*m),e=Math.floor(c.y*m),f=c.x*m-t,x=c.y*m-e;if(!(l+"_"+t+"_"+e in a)){const a=t*h-o.xmin+f*h,l=e*h-o.ymin+x*h,u=s*m;i.drawImage(c.source,a*n*r,l*n*r,u*r,u*r),d=!1}}d&&Math.abs(c.z-l)>1&&delete a[t]}}render(t){const e=t.zoomBounds,i=this.tileSize*t.zoomScale,o=this.computeTiles(e.xmin,e.xmax,e.ymin,e.ymax),n=this.cachedTiles,s=this.loadingTiles,r=Math.round(t.zoom),a=t.context;const h=this.getToCachedTiles(o,r);let l=!1;t.firstDraw&&(a.clearRect(0,0,t.drawSize[0],t.drawSize[1]),t.firstDraw=!1),this.clearCachedTiles(r,o,a,e,t.zoomScale,i,devicePixelRatio);for(let i=0;i<h.length;i++){let o=h[i],c=o.zoom+"_"+o.i+"_"+o.j;if(c in n){if(n[c].loaded){const i=n[c];let o=Math.round((i.x*this.tileSize-e.xmin)*t.zoomScale*devicePixelRatio),s=Math.round((i.y*this.tileSize-e.ymin)*t.zoomScale*devicePixelRatio),r=Math.round(((i.x+1)*this.tileSize-e.xmin)*t.zoomScale*devicePixelRatio),h=Math.round(((i.y+1)*this.tileSize-e.ymin)*t.zoomScale*devicePixelRatio);a.drawImage(i.source,o,s,r-o,h-s)}}else{if(!(c in s)&&this.loadingNum<=6){s[c]=!0;const t=new Image;this.useCros&&(t.crossOrigin="anonymous"),t.onload=function(){n[c]={z:r,x:o.i,y:o.j,source:t,loaded:!0},c in s&&(delete s[c],this.loadingNum--)}.bind(this),t.onerror=function(){n[c]={z:r,x:o.i,y:o.j,source:null,loaded:!1},c in s&&(delete s[c],this.loadingNum--)}.bind(this),t.src=this.tileUrlFunction(o.zoom,o.ti,o.j),this.loadingNum++}l=!0}}l&&(t.drawNext=l)}}function T(t,e,i){var o=t.createShader(e);if(t.shaderSource(o,i),t.compileShader(o),t.getShaderParameter(o,t.COMPILE_STATUS))return o;t.deleteShader(o)}function b(t,e,i){var o=T(t,t.VERTEX_SHADER,e),n=T(t,t.FRAGMENT_SHADER,i),s=t.createProgram();if(t.attachShader(s,o),t.attachShader(s,n),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS))return s.vshader=o,s.fshader=n,s;t.deleteProgram(s)}function E(t,e){const i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),i}function R(t,e,i){const o=t.createVertexArray();return t.bindVertexArray(o),t.enableVertexAttribArray(e),t.vertexAttribPointer(e,i,t.FLOAT,!1,0,0),o}function L(t,e,i,o,n){var s=t.createTexture();return t.activeTexture(t.TEXTURE0+i),n?t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1):t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.bindTexture(t.TEXTURE_2D,s),o?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),s}function w(t,e,i,o,n,s,r){var a=t.createTexture();return t.activeTexture(t.TEXTURE0+n),r?t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,1):t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.bindTexture(t.TEXTURE_2D,a),s?(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)):(t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.R32F,i,o,0,t.RED,t.FLOAT,new Float32Array(e)),a}class _ extends u{constructor(t){super(t),this.target=t.target||"glCanvas"}init(){this.v="#version 300 es\n        in vec4 a_position;\n        void main(){\n            gl_Position = a_position;\n        }",this.f="#version 300 es\n        precision highp float;\n        out vec4 outColor;\n        void main(){\n            outColor = vec4(1.0, 0.0, 0.5, 0.2);\n        }\n        "}addTo(t){return super.addTo(t),"group"==t.type||(this.gl||this.initSelfDraw(t),this.childLayers&&this.childLayers.length>0&&this.childLayers.forEach((e=>{e.addTo(t)}))),this}createDraw(t,e,i){const o=b(t,e,i);if(!o)throw new Error("init program failed");this.program=o,this.initVao(t)}initVao(t){let e=new Float32Array([-1,1,-1,-1,1,1,1,-1]),i=t.getAttribLocation(this.program,"a_position");var o=E(t,e);this.vbuffer=o;var n=R(t,i,2);this.vao=n}render(t){const e=t.context;e.useProgram(this.program),e.bindVertexArray(this.vao),t.firstDraw&&e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLE_STRIP,0,4)}}class P extends _{constructor(t){super(t),this.index=t.index||m,this.minst=0,this.maxst=1}init(t){this.tileSize=t.tileSize||256,this.url=t.url,this.customUrlFun=t.customUrlFun,this.cachedTiles={},this.loadingTiles={},this.loadingNum=0,this.maxTileZoom=t.maxTileZoom||18}initSelfDraw(t){this.createDraw(t.contexts[this.target].context,"#version 300 es\n        in vec4 a_position;\n        in vec2 st;\n        out vec2 v_st;\n        void main(){\n            v_st = st;\n            gl_Position = a_position;\n        }","#version 300 es\n        precision highp float;\n        uniform sampler2D img;\n        in vec2 v_st;\n        out vec4 outColor;\n        void main(){\n            // outColor = vec4(v_st, 0., 1.0);\n            outColor = texture(img,v_st);\n            // outColor = vec4(1.,0,0,1.);\n        }\n        ")}changeUrl(t){this.url=t,this.cachedTiles={},this.loadingTiles={},this.loadingNum=0,this.layerChangeEvent()}initVao(t){let e=new Float32Array([-1,1,-1,-1,1,1,1,-1]),i=new Float32Array([0,1,0,0,1,1,1,0]),o=t.getAttribLocation(this.program,"a_position");var n=E(t,e);this.vbuffer=n;var s=R(t,o,2);this.vao=s;let r=t.getAttribLocation(this.program,"st");this.typebuffer=E(t,new Float32Array(i)),t.enableVertexAttribArray(r),t.vertexAttribPointer(r,2,t.FLOAT,!1,0,0)}computeTiles(t,e,i,o,n){const s=this.tileSize,r=this.maxTileZoom;return n>r&&(t/=Math.pow(2,n-r),e/=Math.pow(2,n-r),i/=Math.pow(2,n-r),o/=Math.pow(2,n-r)),{xminNum:Math.floor(t/s),xmaxNum:Math.floor(e/s),yminNum:Math.floor(i/s),ymaxNum:Math.floor(o/s)}}tileUrlFunction(t,e,i){if(this.customUrlFun)return this.customUrlFun(t,e,i);let o=this.url;return o=o.replace("{z}",t),o=o.replace("{x}",e),o=o.replace("{y}",i),o}getToCachedTiles(t,e){const i=[],o=t.xminNum+(t.xmaxNum-t.xminNum)/2,n=t.yminNum+(t.ymaxNum-t.yminNum)/2;e>this.maxTileZoom&&(e=this.maxTileZoom);const s=Math.pow(2,e);for(let o=t.xminNum;o<=t.xmaxNum;o++){const n=o>=0?o%s:(o%s+s)%s;for(let s=t.yminNum;s<=t.ymaxNum;s++)i.push({zoom:e,i:o,ti:n,j:s})}return i.sort((function(t,e){return(t.i-o)*(t.i-o)+(t.j-n)*(t.j-n)-((e.i-o)*(e.i-o)+(e.j-n)*(e.j-n))})),i}clearCachedTiles(t,e,i,o,n,s,r,a){const h=this.cachedTiles,l=this.tileSize;let c=e,u=this.maxTileZoom;c>u&&(c=u);for(let m in h){const d=h[m];if(Math.abs(d.z-c)>2){t.deleteTexture(h[m].source),delete h[m];continue}if(!d.loaded)continue;let f=d.z;if(f===c)continue;let x=Math.pow(2,c-f),p=!0;if(x>1){const m=d.x*x,y=d.x*x+x,g=d.y*x,v=d.y*x+x;for(let T=m;T<y;T++)if(!(T<i.xminNum||T>i.xmaxNum))for(let y=g;y<v;y++)if(!(y<i.yminNum||y>i.ymaxNum)){if(x>2){if(f+1+"_"+Math.floor(T/2)+"_"+Math.floor(y/2)in h)continue}if(!(c+"_"+T+"_"+y in h)){const i=(T-m)/x,h=(y-g)/x,c=1/x;let f=(T*l-o.xmin)*n,v=(y*l-o.ymin)*n,b=f+s,E=v+s;e>u&&(f*=Math.pow(2,e-u),v*=Math.pow(2,e-u),b*=Math.pow(2,e-u),E*=Math.pow(2,e-u)),f=Math.round(f),v=Math.round(v),b=Math.round(b),E=Math.round(E),f=f*r/a[0],v=v*r/a[1],b=b*r/a[0],E=E*r/a[1],f=2*f-1,v=1-2*v,b=2*b-1,E=1-2*E;const R=new Float32Array([f,E,f,v,b,E,b,v]);t.bindBuffer(t.ARRAY_BUFFER,this.vbuffer),t.bufferData(t.ARRAY_BUFFER,R,t.STATIC_DRAW);let L=i,w=i+c,_=h,P=h+c;0==L&&(L=this.minst),0==_&&(_=this.minst),(b=1)&&(b=this.maxst),(E=1)&&(E=this.maxst);const S=new Float32Array([L,P,L,_,w,P,w,_]);t.bindBuffer(t.ARRAY_BUFFER,this.typebuffer),t.bufferData(t.ARRAY_BUFFER,S,t.STATIC_DRAW),t.bindTexture(t.TEXTURE_2D,d.source),t.drawArrays(t.TRIANGLE_STRIP,0,4),p=!1}}}else{if(f>this.maxTileZoom&&(f=this.maxTileZoom),x=Math.pow(2,c-f),x<.5){if(f-1+"_"+Math.floor(d.x/2)+"_"+Math.floor(d.y/2)in h)continue}const e=Math.floor(d.x*x),i=Math.floor(d.y*x),u=d.x*x-e,m=d.y*x-i;if(!(c+"_"+e+"_"+i in h)){let h=(e*l-o.xmin+u*l)*n,c=(i*l-o.ymin+m*l)*n,f=h+s*x,y=c+s*x;h=Math.round(h)*r/a[0],c=Math.round(c)*r/a[1],f=Math.round(f)*r/a[0],y=Math.round(y)*r/a[1],h=2*h-1,c=1-2*c,f=2*f-1,y=1-2*y;const g=new Float32Array([h,y,h,c,f,y,f,c]);t.bindBuffer(t.ARRAY_BUFFER,this.vbuffer),t.bufferData(t.ARRAY_BUFFER,g,t.STATIC_DRAW);let v=new Float32Array([this.minst,this.maxst,this.minst,this.minst,this.maxst,this.maxst,this.maxst,this.minst]);t.bindBuffer(t.ARRAY_BUFFER,this.typebuffer),t.bufferData(t.ARRAY_BUFFER,v,t.STATIC_DRAW),t.bindTexture(t.TEXTURE_2D,d.source),t.drawArrays(t.TRIANGLE_STRIP,0,4),p=!1}}p&&Math.abs(d.z-c)>1&&(t.deleteTexture(h[m].source),delete h[m])}}render(t){const e=t.zoomBounds,i=t.pxbounds,o=this.tileSize*t.zoomScale,n=t.drawSize,s=Math.round(t.zoom);this.zoom=s;const r=this.computeTiles(e.xmin,e.xmax,e.ymin,e.ymax,s),a=this.cachedTiles,h=this.loadingTiles,l=this.maxTileZoom,c=t.context;c.useProgram(this.program),c.bindVertexArray(this.vao);const u=t.devicePixelRatio,m=this.getToCachedTiles(r,s);let d=!1;t.firstDraw&&(c.clear(c.COLOR_BUFFER_BIT),t.firstDraw=!1),this.clearCachedTiles(c,s,r,e,t.zoomScale,o,u,n),c.activeTexture(c.TEXTURE0);for(let e=0;e<m.length;e++){let o=m[e],r=o.zoom+"_"+o.i+"_"+o.j;if(r in a){if(a[r].loaded){const e=a[r];let o=e.x*this.tileSize*t.zoomScale-i.xmin,h=e.y*this.tileSize*t.zoomScale-i.ymin;s>l&&(o=e.x*Math.pow(2,s-l)*this.tileSize*t.zoomScale-i.xmin,h=e.y*Math.pow(2,s-l)*this.tileSize*t.zoomScale-i.ymin);let m=(e.x+1)*this.tileSize*t.zoomScale-i.xmin,d=(e.y+1)*this.tileSize*t.zoomScale-i.ymin;s>l&&(m=(e.x+1)*Math.pow(2,s-l)*this.tileSize*t.zoomScale-i.xmin,d=(e.y+1)*Math.pow(2,s-l)*this.tileSize*t.zoomScale-i.ymin),m=Math.round(m),d=Math.round(d),o=Math.round(o),h=Math.round(h),o=o*u/n[0],h=h*u/n[1],m=m*u/n[0],d=d*u/n[1],o=2*o-1,h=1-2*h,m=2*m-1,d=1-2*d;const f=new Float32Array([o,d,o,h,m,d,m,h]);c.bindBuffer(c.ARRAY_BUFFER,this.vbuffer),c.bufferData(c.ARRAY_BUFFER,f,c.STATIC_DRAW);let x=new Float32Array([this.minst,this.maxst,this.minst,this.minst,this.maxst,this.maxst,this.maxst,this.minst]);c.bindBuffer(c.ARRAY_BUFFER,this.typebuffer),c.bufferData(c.ARRAY_BUFFER,x,c.STATIC_DRAW),c.bindTexture(c.TEXTURE_2D,e.source),c.drawArrays(c.TRIANGLE_STRIP,0,4)}}else{if(!(r in h)&&this.loadingNum<=6){h[r]=!0;const t=new Image;t.crossOrigin="anonymous",t.onload=function(){var e=c.createTexture();c.bindTexture(c.TEXTURE_2D,e),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,t),a[r]={z:s,x:o.i,y:o.j,tx:o.ti,source:e,loaded:!0},r in h&&(delete h[r],this.loadingNum--)}.bind(this),t.onerror=function(){a[r]={z:s,x:o.i,y:o.j,tx:o.ti,source:null,loaded:!1},r in h&&(delete h[r],this.loadingNum--)}.bind(this),t.src=this.tileUrlFunction(o.zoom,o.ti,o.j),this.loadingNum++}d=!0}}d&&(t.drawNext=d)}destroy(t){if(!this.target)return void console.warn("图层不存在，无法删除");const e=t.contexts[this.target].context;e.deleteVertexArray(this.vao);const i=this.program;e.deleteBuffer(this.vbuffer),e.deleteBuffer(this.typebuffer),e.deleteTexture(this.colorTexture);for(let t in this.cachedTiles)e.deleteTexture(this.cachedTiles[t].source);e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i),super.destroy(t)}}const S="KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO3ZhciBGPXt9O0YucmVhZD1mdW5jdGlvbihlLHQsaSxyLHMpe3ZhciBhLG4sbD1zKjgtci0xLGY9KDE8PGwpLTEsaD1mPj4xLG89LTcsZD1pP3MtMTowLHU9aT8tMToxLHg9ZVt0K2RdO2ZvcihkKz11LGE9eCYoMTw8LW8pLTEseD4+PS1vLG8rPWw7bz4wO2E9YSoyNTYrZVt0K2RdLGQrPXUsby09OCk7Zm9yKG49YSYoMTw8LW8pLTEsYT4+PS1vLG8rPXI7bz4wO249bioyNTYrZVt0K2RdLGQrPXUsby09OCk7aWYoYT09PTApYT0xLWg7ZWxzZXtpZihhPT09ZilyZXR1cm4gbj9OYU46KHg/LTE6MSkqKDEvMCk7bj1uK01hdGgucG93KDIsciksYT1hLWh9cmV0dXJuKHg/LTE6MSkqbipNYXRoLnBvdygyLGEtcil9LEYud3JpdGU9ZnVuY3Rpb24oZSx0LGkscixzLGEpe3ZhciBuLGwsZixoPWEqOC1zLTEsbz0oMTw8aCktMSxkPW8+PjEsdT1zPT09MjM/TWF0aC5wb3coMiwtMjQpLU1hdGgucG93KDIsLTc3KTowLHg9cj8wOmEtMSx5PXI/MTotMSxwPXQ8MHx8dD09PTAmJjEvdDwwPzE6MDtmb3IodD1NYXRoLmFicyh0KSxpc05hTih0KXx8dD09PTEvMD8obD1pc05hTih0KT8xOjAsbj1vKToobj1NYXRoLmZsb29yKE1hdGgubG9nKHQpL01hdGguTE4yKSx0KihmPU1hdGgucG93KDIsLW4pKTwxJiYobi0tLGYqPTIpLG4rZD49MT90Kz11L2Y6dCs9dSpNYXRoLnBvdygyLDEtZCksdCpmPj0yJiYobisrLGYvPTIpLG4rZD49bz8obD0wLG49byk6bitkPj0xPyhsPSh0KmYtMSkqTWF0aC5wb3coMixzKSxuPW4rZCk6KGw9dCpNYXRoLnBvdygyLGQtMSkqTWF0aC5wb3coMixzKSxuPTApKTtzPj04O2VbaSt4XT1sJjI1NSx4Kz15LGwvPTI1NixzLT04KTtmb3Iobj1uPDxzfGwsaCs9cztoPjA7ZVtpK3hdPW4mMjU1LHgrPXksbi89MjU2LGgtPTgpO2VbaSt4LXldfD1wKjEyOH07ZnVuY3Rpb24gYyhlKXt0aGlzLmJ1Zj1BcnJheUJ1ZmZlci5pc1ZpZXcmJkFycmF5QnVmZmVyLmlzVmlldyhlKT9lOm5ldyBVaW50OEFycmF5KGV8fDApLHRoaXMucG9zPTAsdGhpcy50eXBlPTAsdGhpcy5sZW5ndGg9dGhpcy5idWYubGVuZ3RofWMuVmFyaW50PTAsYy5GaXhlZDY0PTEsYy5CeXRlcz0yLGMuRml4ZWQzMj01O3ZhciBTPTEyLFY9dHlwZW9mIFRleHREZWNvZGVyPiJ1Ij9udWxsOm5ldyBUZXh0RGVjb2RlcigidXRmOCIpO2MucHJvdG90eXBlPXtkZXN0cm95OmZ1bmN0aW9uKCl7dGhpcy5idWY9bnVsbH0scmVhZEZpZWxkczpmdW5jdGlvbihlLHQsaSl7Zm9yKGk9aXx8dGhpcy5sZW5ndGg7dGhpcy5wb3M8aTspe3ZhciByPXRoaXMucmVhZFZhcmludCgpLHM9cj4+MyxhPXRoaXMucG9zO3RoaXMudHlwZT1yJjcsZShzLHQsdGhpcyksdGhpcy5wb3M9PT1hJiZ0aGlzLnNraXAocil9cmV0dXJuIHR9LHJlYWRNZXNzYWdlOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIHRoaXMucmVhZEZpZWxkcyhlLHQsdGhpcy5yZWFkVmFyaW50KCkrdGhpcy5wb3MpfSxyZWFkVmFyaW50OmZ1bmN0aW9uKGUpe3ZhciB0PXRoaXMuYnVmLGkscjtyZXR1cm4gcj10W3RoaXMucG9zKytdLGk9ciYxMjcscjwxMjh8fChyPXRbdGhpcy5wb3MrK10saXw9KHImMTI3KTw8NyxyPDEyOCl8fChyPXRbdGhpcy5wb3MrK10saXw9KHImMTI3KTw8MTQscjwxMjgpfHwocj10W3RoaXMucG9zKytdLGl8PShyJjEyNyk8PDIxLHI8MTI4KT9pOihyPXRbdGhpcy5wb3NdLGl8PShyJjE1KTw8MjgsTShpLGUsdGhpcykpfSxyZWFkU1ZhcmludDpmdW5jdGlvbigpe3ZhciBlPXRoaXMucmVhZFZhcmludCgpO3JldHVybiBlJTI9PT0xPyhlKzEpLy0yOmUvMn0scmVhZERvdWJsZTpmdW5jdGlvbigpe3ZhciBlPUYucmVhZCh0aGlzLmJ1Zix0aGlzLnBvcywhMCw1Miw4KTtyZXR1cm4gdGhpcy5wb3MrPTgsZX0scmVhZFN0cmluZzpmdW5jdGlvbigpe3ZhciBlPXRoaXMucmVhZFZhcmludCgpK3RoaXMucG9zLHQ9dGhpcy5wb3M7cmV0dXJuIHRoaXMucG9zPWUsZS10Pj1TJiZWP2sodGhpcy5idWYsdCxlKTpUKHRoaXMuYnVmLHQsZSl9LHJlYWRCeXRlczpmdW5jdGlvbigpe3ZhciBlPXRoaXMucmVhZFZhcmludCgpK3RoaXMucG9zLHQ9dGhpcy5idWYuc3ViYXJyYXkodGhpcy5wb3MsZSk7cmV0dXJuIHRoaXMucG9zPWUsdH0sc2tpcDpmdW5jdGlvbihlKXt2YXIgdD1lJjc7aWYodD09PWMuVmFyaW50KWZvcig7dGhpcy5idWZbdGhpcy5wb3MrK10+MTI3Oyljb25zb2xlLmxvZyh0KTtlbHNlIGlmKHQ9PT1jLkJ5dGVzKXRoaXMucG9zPXRoaXMucmVhZFZhcmludCgpK3RoaXMucG9zO2Vsc2UgaWYodD09PWMuRml4ZWQzMil0aGlzLnBvcys9NDtlbHNlIGlmKHQ9PT1jLkZpeGVkNjQpdGhpcy5wb3MrPTg7ZWxzZSB0aHJvdyBuZXcgRXJyb3IoIlVuaW1wbGVtZW50ZWQgdHlwZTogIit0KX19O2Z1bmN0aW9uIE0oZSx0LGkpe3ZhciByPWkuYnVmLHMsYTtpZihhPXJbaS5wb3MrK10scz0oYSYxMTIpPj40LGE8MTI4fHwoYT1yW2kucG9zKytdLHN8PShhJjEyNyk8PDMsYTwxMjgpfHwoYT1yW2kucG9zKytdLHN8PShhJjEyNyk8PDEwLGE8MTI4KXx8KGE9cltpLnBvcysrXSxzfD0oYSYxMjcpPDwxNyxhPDEyOCl8fChhPXJbaS5wb3MrK10sc3w9KGEmMTI3KTw8MjQsYTwxMjgpfHwoYT1yW2kucG9zKytdLHN8PShhJjEpPDwzMSxhPDEyOCkpcmV0dXJuIHYoZSxzLHQpO3Rocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdmFyaW50IG5vdCBtb3JlIHRoYW4gMTAgYnl0ZXMiKX1mdW5jdGlvbiB2KGUsdCxpKXtyZXR1cm4gaT90KjQyOTQ5NjcyOTYrKGU+Pj4wKToodD4+PjApKjQyOTQ5NjcyOTYrKGU+Pj4wKX1mdW5jdGlvbiBUKGUsdCxpKXtmb3IodmFyIHI9IiIscz10O3M8aTspe3ZhciBhPWVbc10sbj1udWxsLGw9YT4yMzk/NDphPjIyMz8zOmE+MTkxPzI6MTtpZihzK2w+aSlicmVhazt2YXIgZixoLG87bD09PTE/YTwxMjgmJihuPWEpOmw9PT0yPyhmPWVbcysxXSwoZiYxOTIpPT09MTI4JiYobj0oYSYzMSk8PDZ8ZiY2MyxuPD0xMjcmJihuPW51bGwpKSk6bD09PTM/KGY9ZVtzKzFdLGg9ZVtzKzJdLChmJjE5Mik9PT0xMjgmJihoJjE5Mik9PT0xMjgmJihuPShhJjE1KTw8MTJ8KGYmNjMpPDw2fGgmNjMsKG48PTIwNDd8fG4+PTU1Mjk2JiZuPD01NzM0MykmJihuPW51bGwpKSk6bD09PTQmJihmPWVbcysxXSxoPWVbcysyXSxvPWVbcyszXSwoZiYxOTIpPT09MTI4JiYoaCYxOTIpPT09MTI4JiYobyYxOTIpPT09MTI4JiYobj0oYSYxNSk8PDE4fChmJjYzKTw8MTJ8KGgmNjMpPDw2fG8mNjMsKG48PTY1NTM1fHxuPj0xMTE0MTEyKSYmKG49bnVsbCkpKSxuPT09bnVsbD8obj02NTUzMyxsPTEpOm4+NjU1MzUmJihuLT02NTUzNixyKz1TdHJpbmcuZnJvbUNoYXJDb2RlKG4+Pj4xMCYxMDIzfDU1Mjk2KSxuPTU2MzIwfG4mMTAyMykscis9U3RyaW5nLmZyb21DaGFyQ29kZShuKSxzKz1sfXJldHVybiByfWZ1bmN0aW9uIGsoZSx0LGkpe3JldHVybiBWLmRlY29kZShlLnN1YmFycmF5KHQsaSkpfWZ1bmN0aW9uIG0oZSx0LGkscixzKXt0aGlzLnByb3BlcnRpZXM9e30sdGhpcy5leHRlbnQ9aSx0aGlzLnR5cGU9MCx0aGlzLl9wYmY9ZSx0aGlzLl9nZW9tZXRyeT0tMSx0aGlzLl9rZXlzPXIsdGhpcy5fdmFsdWVzPXMsZS5yZWFkRmllbGRzKEMsdGhpcyx0KX1mdW5jdGlvbiBDKGUsdCxpKXtlPT0xP3QuaWQ9aS5yZWFkVmFyaW50KCk6ZT09Mj9CKGksdCk6ZT09Mz90LnR5cGU9aS5yZWFkVmFyaW50KCk6ZT09NCYmKHQuX2dlb21ldHJ5PWkucG9zKX1mdW5jdGlvbiBCKGUsdCl7Zm9yKHZhciBpPWUucmVhZFZhcmludCgpK2UucG9zO2UucG9zPGk7KXt2YXIgcj10Ll9rZXlzW2UucmVhZFZhcmludCgpXSxzPXQuX3ZhbHVlc1tlLnJlYWRWYXJpbnQoKV07dC5wcm9wZXJ0aWVzW3JdPXN9fW0udHlwZXM9WyJVbmtub3duIiwiUG9pbnQiLCJMaW5lU3RyaW5nIiwiUG9seWdvbiJdLG0ucHJvdG90eXBlLmxvYWRHZW9tZXRyeT1mdW5jdGlvbigpe3ZhciBlPXRoaXMuX3BiZjtlLnBvcz10aGlzLl9nZW9tZXRyeTt2YXIgdD1lLnJlYWRWYXJpbnQoKStlLnBvcyxpPTEscj0wLHM9MCxhPTAsbj1uZXcgQXJyYXkoMTAwKSxsO2xldCBmPTAsaD0hMSxvPW51bGwsZD1udWxsLHU9MDtmb3IoO2UucG9zPHQ7KXtpZihyPD0wKXt2YXIgeD1lLnJlYWRWYXJpbnQoKTtpPXgmNyxyPXg+PjN9aWYoci0tLGk9PT0xKXMrPWUucmVhZFNWYXJpbnQoKSxhKz1lLnJlYWRTVmFyaW50KCksaD0hMCx1PTAsbz1zLGQ9YSxsJiYobltmXT1sLGYrKyk7ZWxzZSBpZihpPT09Mil7aWYocys9ZS5yZWFkU1ZhcmludCgpLGErPWUucmVhZFNWYXJpbnQoKSxoKXtsZXQgeT1yKzI7bD1uZXcgQXJyYXkoeSksbFswXT17eDpvLHk6ZH0saD0hMX11Kz0xLGxbdV09e3g6cyx5OmF9fWVsc2UgaWYoaT09PTcpe3UrPTE7dHJ5e2xbdV09bFswXX1jYXRjaCh5KXtjb25zb2xlLmxvZyh5KX19ZWxzZSB0aHJvdyBuZXcgRXJyb3IoInVua25vd24gY29tbWFuZCAiK2kpfXJldHVybiBsPyhuW2ZdPWwsZisrLG4ubGVuZ3RoPWYpOm8hPW51bGwmJmQhPW51bGwmJiFuWzBdJiYoZj0xLG49e3g6byx5OmR9KSxufTtmdW5jdGlvbiBfKGUsdCl7dGhpcy52ZXJzaW9uPTEsdGhpcy5uYW1lPW51bGwsdGhpcy5leHRlbnQ9NDA5Nix0aGlzLmxlbmd0aD0wLHRoaXMuX3BiZj1lLHRoaXMuX2tleXM9W10sdGhpcy5fdmFsdWVzPVtdLHRoaXMuX2ZlYXR1cmVzPVtdLGUucmVhZEZpZWxkcyhELHRoaXMsdCksdGhpcy5sZW5ndGg9dGhpcy5fZmVhdHVyZXMubGVuZ3RofWZ1bmN0aW9uIEQoZSx0LGkpe2U9PT0xNT90LnZlcnNpb249aS5yZWFkVmFyaW50KCk6ZT09PTE/dC5uYW1lPWkucmVhZFN0cmluZygpOmU9PT01P3QuZXh0ZW50PWkucmVhZFZhcmludCgpOmU9PT0yP3QuX2ZlYXR1cmVzLnB1c2goaS5wb3MpOmU9PT0zP3QuX2tleXMucHVzaChpLnJlYWRTdHJpbmcoKSk6ZT09PTQmJnQuX3ZhbHVlcy5wdXNoKEUoaSkpfWZ1bmN0aW9uIEUoZSl7Zm9yKHZhciB0PW51bGwsaT1lLnJlYWRWYXJpbnQoKStlLnBvcztlLnBvczxpOyl7dmFyIHI9ZS5yZWFkVmFyaW50KCk+PjM7dD1yPT09MT9lLnJlYWRTdHJpbmcoKTpyPT09Mj9lLnJlYWRGbG9hdCgpOnI9PT0zP2UucmVhZERvdWJsZSgpOnI9PT00P2UucmVhZFZhcmludDY0KCk6cj09PTU/ZS5yZWFkVmFyaW50KCk6cj09PTY/ZS5yZWFkU1ZhcmludCgpOnI9PT03P2UucmVhZEJvb2xlYW4oKTpudWxsfXJldHVybiB0fV8ucHJvdG90eXBlLmZlYXR1cmU9ZnVuY3Rpb24oZSl7aWYoZTwwfHxlPj10aGlzLl9mZWF0dXJlcy5sZW5ndGgpdGhyb3cgbmV3IEVycm9yKCJmZWF0dXJlIGluZGV4IG91dCBvZiBib3VuZHMiKTt0aGlzLl9wYmYucG9zPXRoaXMuX2ZlYXR1cmVzW2VdO3ZhciB0PXRoaXMuX3BiZi5yZWFkVmFyaW50KCkrdGhpcy5fcGJmLnBvcztyZXR1cm4gbmV3IG0odGhpcy5fcGJmLHQsdGhpcy5leHRlbnQsdGhpcy5fa2V5cyx0aGlzLl92YWx1ZXMpfTtmdW5jdGlvbiBOKGUsdCl7dGhpcy5sYXllcnM9ZS5yZWFkRmllbGRzKEEse30sdCl9ZnVuY3Rpb24gQShlLHQsaSl7aWYoZT09PTMpe3ZhciByPW5ldyBfKGksaS5yZWFkVmFyaW50KCkraS5wb3MpO3IubGVuZ3RoJiYodFtyLm5hbWVdPXIpfX1sZXQgdz1udWxsO2Z1bmN0aW9uIEcoZSl7bGV0IHQ9bmV3IFhNTEh0dHBSZXF1ZXN0O3QucmVzcG9uc2VUeXBlPSJhcnJheWJ1ZmZlciIsdC5vbmxvYWQ9ZnVuY3Rpb24oKXtpZih0LnN0YXR1cyE9MjAwKXtzZWxmLnBvc3RNZXNzYWdlKHttc2c6ImZhaWxlZCIsZGF0YTplfSk7cmV0dXJufWxldCBpPW5ldyBVaW50OEFycmF5KHQucmVzcG9uc2UpLHI7dHJ5e3I9bmV3IE4obmV3IGMoaSkpfWNhdGNoe3NlbGYucG9zdE1lc3NhZ2Uoe21zZzoiZmFpbGVkIixkYXRhOmV9KSxjb25zb2xlLmxvZygiZXIyIik7cmV0dXJufWlmKE9iamVjdC5rZXlzKHIubGF5ZXJzKS5sZW5ndGg9PTApe1UoZSk7cmV0dXJufXooZSxyKX0sdC5vbmVycm9yPWZ1bmN0aW9uKCl7Y29uc29sZS5sb2coImVycm9yIil9LHQub3BlbigiR0VUIixlLnVybCwhMCksdC5zZW5kKCl9ZnVuY3Rpb24gVShlKXtjb25zdCB0PW5ldyBPZmZzY3JlZW5DYW52YXMoZS50aWxlU2l6ZSxlLnRpbGVTaXplKSxpPXQuZ2V0Q29udGV4dCgiMmQiKSxyPXcuc2VhO3ImJihpLmZpbGxTdHlsZT1yLmZpbGxTdHlsZSxpLmZpbGxSZWN0KDAsMCx0LndpZHRoLHQuaGVpZ2h0KSk7dmFyIHM9dC50cmFuc2ZlclRvSW1hZ2VCaXRtYXAoKTtzZWxmLnBvc3RNZXNzYWdlKHttc2c6InN1Y2Nlc3MiLGRhdGE6ZSxpbWFnZUJpdG1hcDpzfSxbc10pfWZ1bmN0aW9uIHooZSx0KXtjb25zdCBpPW5ldyBPZmZzY3JlZW5DYW52YXMoZS50aWxlU2l6ZSxlLnRpbGVTaXplKSxyPWkuZ2V0Q29udGV4dCgiMmQiKTtsZXQgcz0yMDQ4L2UudGlsZVNpemU7Y29uc3QgYT13LnNlYTthJiYoci5maWxsU3R5bGU9YS5maWxsU3R5bGUsci5maWxsUmVjdCgwLDAsaS53aWR0aCxpLmhlaWdodCkpO2NvbnN0IG49e307Zm9yKGxldCBmIGluIHQubGF5ZXJzKXtsZXQgaD10LmxheWVyc1tmXSxvPXdbZl07aWYobyl7aWYoby50eXBlPT0icG9seWdvbiIpe3IuYmVnaW5QYXRoKCk7Y29uc3QgZD1oLmxlbmd0aDtmb3IobGV0IHU9MDt1PGQ7dSsrKWguZmVhdHVyZSh1KS5sb2FkR2VvbWV0cnkoKS5mb3JFYWNoKHA9PntyLm1vdmVUbyhwWzBdLngvcyxwWzBdLnkvcyk7Zm9yKGxldCBnPTE7ZzxwLmxlbmd0aDtnKyspci5saW5lVG8ocFtnXS54L3MscFtnXS55L3MpO3IuY2xvc2VQYXRoKCl9KTtyLnNhdmUoKSxvLmZpbGxTdHlsZSYmKHIuZmlsbFN0eWxlPW8uZmlsbFN0eWxlLHIuZmlsbCgpKSxvLnN0cm9rZVN0eWxlJiYoci5zdHJva2VTdHlsZT1vLnN0cm9rZVN0eWxlLHIuc3Ryb2tlKCkpLHIucmVzdG9yZSgpfWVsc2UgaWYoby50eXBlPT0icG9pbnQiKXtjb25zdCBkPWgubGVuZ3RoO25bZl09bmV3IEFycmF5KGQpO2ZvcihsZXQgdT0wO3U8ZDt1Kyspe2xldCB4PWguZmVhdHVyZSh1KSx5PXgubG9hZEdlb21ldHJ5KCk7eS5uYW1lPXgucHJvcGVydGllc1tvLmxhYmVsS2V5XSx5LngvPXMseS55Lz1zLG5bZl1bdV09eX19ZWxzZSBpZihvLnR5cGU9PSJsaW5lIil7ci5iZWdpblBhdGgoKTtjb25zdCBkPWgubGVuZ3RoO2ZvcihsZXQgdT0wO3U8ZDt1KyspaC5mZWF0dXJlKHUpLmxvYWRHZW9tZXRyeSgpLmZvckVhY2gocD0+e3IubW92ZVRvKHBbMF0ueC9zLHBbMF0ueS9zKTtmb3IobGV0IGc9MTtnPHAubGVuZ3RoO2crKylyLmxpbmVUbyhwW2ddLngvcyxwW2ddLnkvcyl9KTtyLnNhdmUoKSxvLmxpbmVXaWR0aCYmKHIubGluZVdpZHRoPW8ubGluZVdpZHRoKSxvLnN0cm9rZVN0eWxlJiYoci5zdHJva2VTdHlsZT1vLnN0cm9rZVN0eWxlLHIuc3Ryb2tlKCkpLHIucmVzdG9yZSgpfX19dmFyIGw9aS50cmFuc2ZlclRvSW1hZ2VCaXRtYXAoKTtzZWxmLnBvc3RNZXNzYWdlKHttc2c6InN1Y2Nlc3MiLGRhdGE6ZSxpbWFnZUJpdG1hcDpsLHBvaW50czpufSxbbF0pfXNlbGYub25tZXNzYWdlPWZ1bmN0aW9uKGUpe2lmKGUuZGF0YS50eXBlPT0ic3R5bGUiKXt3PWUuZGF0YS5zdHlsZTtyZXR1cm59RyhlLmRhdGEpfX0pKCk7Cg==",M=typeof window<"u"&&window.Blob&&new Blob([atob(S)],{type:"text/javascript;charset=utf-8"});function A(t){let e;try{if(e=M&&(window.URL||window.webkitURL).createObjectURL(M),!e)throw"";const i=new Worker(e,{name:null==t?void 0:t.name});return i.addEventListener("error",(()=>{(window.URL||window.webkitURL).revokeObjectURL(e)})),i}catch{return new Worker("data:application/javascript;base64,"+S,{name:null==t?void 0:t.name})}finally{e&&(window.URL||window.webkitURL).revokeObjectURL(e)}}class Z extends v{constructor(t){super(t)}init(t){this.index=t.index||d,this.target=t.target||"baseCanvas",this.cachedTiles={},this.loadingTiles={},this.loadingNum=0,this.tileSize=t.tileSize||1024,this.zoomOffset=Math.log2(this.tileSize/256),this.maxLoadNum=2,this.url=t.url,this.styles=t.style,this.createWorker(t.style)}initContent(t){super.initContent(t);const e=t.contexts[this.target].canvas;t.contexts[this.target].context||(t.contexts[this.target].context=e.getContext("2d"))}createWorker(t){const e=new A;e.postMessage({type:"style",style:t}),e.onmessage=function(t){this.cacheTile(t.data)}.bind(this),this.worker=e,this.workingNum=0}cacheTile(t){const e=t.data,i=e.zoom+"_"+e.i+"_"+e.j;delete this.loadingTiles[i],this.loadingNum--,"failed"!=t.msg?(delete this.loadingTiles[i],this.loadingNum--,this.cachedTiles[i]={z:e.zoom,x:e.i,y:e.j,source:t.imageBitmap,loaded:!0,points:t.points}):this.cachedTiles[i]={z:e.zoom,x:e.i,y:e.j,source:null,loaded:!1}}drawPoints(t,e,i,o,n){const s=this.cachedTiles,r=this.styles,a=this.tileSize;i*=o;for(let h=0;h<e.length;h++){let l=e[h],c=l.zoom+"_"+l.i+"_"+l.j;const u=l.i*a-n.xmin,m=l.j*a-n.ymin;if(s[c]&&s[c].points!={})for(let e in s[c].points){t.save(),t.beginPath();const n=s[c].points[e],a=r[e];if(!a)continue;const h=a.fontFamily||"arial",l=a.fontSize||16;t.font=l*o+"px "+h;for(let e=0;e<n.length;e++){const s=n[e].x+u,r=n[e].y+m;a.radius?(t.moveTo(s*i+a.radius,r*i),t.arc(s*i,r*i,a.radius*o,0,2*Math.PI,!1),t.fillText(n[e].name,s*i+a.radius*o+2,r*i+a.radius*o)):t.fillText(n[e].name,s*i+4,r*i+4)}a.strokeWidth&&(t.lineWidth=a.strokeWidth),a.strokeStyle&&(t.strokeStyle=a.strokeStyle,t.stroke()),t.restore()}}}testOptions(t){if(!t.url)throw new Error("no tile url")}render(t){const e=t.zoomBounds,i=this.tileSize*t.zoomScale,o=this.computeTiles(e.xmin,e.xmax,e.ymin,e.ymax),n=t.zoom,s=t.context,r=Math.round(n)-this.zoomOffset,a=t.drawSize,h=this.loadingTiles,l=this.cachedTiles,c=this.getToCachedTiles(o,r),u=this.maxLoadNum;let m=!1;t.firstDraw&&(s.clearRect(0,0,a[0],a[1]),t.firstDraw=!1),this.clearCachedTiles(r,o,t.context,e,t.zoomScale,i,devicePixelRatio);for(let o=0;o<c.length;o++){let n=c[o],r=n.zoom+"_"+n.i+"_"+n.j;if(l[r]){if(l[r].loaded){const o=l[r],n=o.x*this.tileSize-e.xmin,a=o.y*this.tileSize-e.ymin;s.drawImage(o.source,n*t.zoomScale*devicePixelRatio,a*t.zoomScale*devicePixelRatio,i*devicePixelRatio,i*devicePixelRatio)}}else{if(!h[r]&&this.loadingNum<u){const t=this.tileUrlFunction(n.zoom,n.ti,n.j);n.url=t,n.tileSize=this.tileSize,this.worker.postMessage(n),h[r]=!0,this.loadingNum++}m=!0}}this.drawPoints(s,c,t.zoomScale,devicePixelRatio,e),t.drawNext=m}destroy(){this.worker.terminate(),super.destroy(...arguments)}}class U extends u{constructor(t){super(t),this.target="uparCanvas"}initContent(t){super.initContent(t);const e=t.contexts[this.target].canvas;t.contexts[this.target].context||(t.contexts[this.target].context=e.getContext("2d"))}}class C extends U{constructor(t){super(t)}init(t){this.index=t.index||x,this.position=t.position,this.text=t.text,this.point=t.point,this.rotate=t.rotate,this.text||(this.point=!0),this.point&&(this.fillStyle=t.fillStyle,this.lineWidth=t.lineWidth,this.strokeStyle=t.strokeStyle||"blue",this.radius=t.radius||6),this.text&&(this.textColor=t.textColor||this.fillStyle||this.strokeStyle,this.fontFamily=t.fontFamily||"arial",this.fontWeight=t.fontWeight||"500",this.fontSize=t.fontSize,this.offSetX=t.offSetX||0,this.offSetY=t.offSetY||0,this.strokeWidth=t.strokeWidth,this.strokeColor=t.strokeColor||"black",this.shadowColor=t.shadowColor,this.shadowBlur=t.shadowBlur,this.shadowOffsetX=t.shadowOffsetX,this.shadowOffsetY=t.shadowOffsetY)}fireEvent(t){const e=t.offsetX,i=t.offsetY;if(this.px.distance({x:e,y:i})<=this.radius){const o={lat:this.position[0],lon:this.position[1],x:e,y:i,id:this.id};if(this.fire(t.type,o),this.events[t.type].stopPropagation)return!0}}setLatLng(t,e){this.position=[t,e],this.layerChangeEvent()}render(t){const e=this.position,i=t.pxbounds,o=t.context,s=n(e[0],e[1],t.zoom);if(s.x-=i.xmin,s.y-=i.ymin,this.px=s,t.firstDraw&&(o.clearRect(0,0,t.drawSize[0],t.drawSize[1]),t.firstDraw=!1),this.point&&(o.beginPath(),o.moveTo((s.x+this.radius)*devicePixelRatio,s.y*devicePixelRatio),o.arc(s.x*devicePixelRatio,s.y*devicePixelRatio,this.radius*devicePixelRatio,0,2*Math.PI,!1),this.fillStyle&&(o.fillStyle=this.fillStyle,o.fill()),o.lineWidth=this.lineWidth,o.strokeStyle=this.strokeStyle,o.stroke()),this.text){if(o.save(),this.rotate){const t=this.rotate*Math.PI/180;o.translate(s.x,s.y),o.rotate(t),s.x=0,s.y=0}s.x+=this.offSetX,s.y+=this.offSetY;let t=this.fontWeight+" "+this.fontSize*devicePixelRatio+"px "+this.fontFamily;o.font=t;const e=o.measureText(this.text);s.x*=devicePixelRatio,s.y*=devicePixelRatio,s.x-=e.width/2,e.fontBoundingBoxAscent&&e.fontBoundingBoxDescent?s.y+=(e.fontBoundingBoxAscent+e.fontBoundingBoxDescent-e.hangingBaseline/2)/2:o.fillText(this.text,s.x,s.y),o.fillStyle=this.textColor,this.strokeWidth&&(o.strokeStyle=this.strokeColor,o.lineWidth=this.strokeWidth,o.strokeText(this.text,s.x,s.y)),this.shadowColor&&(o.shadowColor=this.shadowColor,o.shadowBlur=this.shadowBlur,o.shadowOffsetX=this.shadowOffsetX,o.shadowOffsetY=this.shadowOffsetY),o.fillText(this.text,s.x,s.y),o.restore()}}}class X{constructor(){this.type="group",this.layers=[],this.map=null,this.id=(new Date).getTime()+Math.round(1e4*Math.random()).toString()}addTo(t){if(!this.map){if(this.map=t,t.layergroups[this.id]=1,this.layers.length>0)for(let e=this.layers.length-1;e>=0;e--){const i=this.layers[e];i.id?i.addTo(t):this.layers.splice(e,1)}return this}console.warn("图层组已经被添加到地图上，请勿重复操作")}addLayer(t){let e=!1;for(let i=0;i<this.layers.length;i++)this.layers[i].id==t.id&&(e=!0);e||(this.layers.push(t),this.map&&t.addTo(this.map))}removeLayer(t){for(let e=this.layers.length-1;e>=0;e--)if(this.layers[e].id){if(!t.id)throw new Error("传入参数非图层");this.layers[e].id==t.id&&(this.layers.splice(e,1),this.map&&this.map.removeLayer(t))}else this.layers.splice(e,1)}clearLayers(t){typeof t>"u"&&(t=!0);const e=this.map;for(let i=0;i<this.layers.length;i++){const o=this.layers[i];t?o.destroy(e):e.removeLayer(o)}this.layers=[]}removeFrom(t){for(let e=0;e<this.layers.length;e++)this.layers[e].removeFromMap(t);delete this.map.layergroups[this.id],this.map=null}destroy(){const t=this.map;delete this.map.layergroups[this.id];for(let e=0;e<this.layers.length;e++)this.layers[e].destroy(t);for(let t in this)delete this[t]}}class G extends _{constructor(t){super(t)}init(t){this.index=t.index||x,this.data=t.position,this.radius=t.radius||12,this.color=t.color||[255,0,0,255],this.color=this.color.map((t=>t/255))}initSelfDraw(t){this.createDraw(t.contexts[this.target].context,"#version 300 es\nin vec2 a_position;\nuniform float scale;\nuniform vec2 oripx;\nuniform vec2 size;\nuniform float radius;\nout float v_radius;\nvoid main(){\n    vec2 point = a_position*scale;\n    point = point - oripx;\n    point.x = point.x / size.x;\n    point.y = point.y / size.y;\n    point.y = 1.0 - 2.0*point.y;\n    point.x = 2.0*point.x - 1.0;\n    gl_Position = vec4(point,0.0,1.0);\n    gl_PointSize = radius*2.0 + 1.0;\n    v_radius = radius;\n}","#version 300 es\nprecision highp float;\nin float v_radius;\nuniform vec4 color;\nout vec4 outColor;\nvoid main(){\n    float d = distance(gl_PointCoord, vec2(0.5));\n    float adis = 0.5/v_radius;\n    float a = (0.5-d)/adis;\n    a = max(a,0.0);\n    a = min(a,color.a);\n    outColor = vec4(color.xyz, a);\n    \n}\n")}computePxInZoom8(){const t=this.data,e=[],i=n(t[0],t[1],8);return e.push(i.x,i.y),e}initVao(t){t.useProgram(this.program);const e=this.computePxInZoom8();let i=new Float32Array(e);this.drawNum=e.length/2;let o=t.getAttribLocation(this.program,"a_position");var n=E(t,i);this.vbuffer=n;var s=R(t,o,2);this.vao=s,this.t_scale=t.getUniformLocation(this.program,"scale"),this.t_oripx=t.getUniformLocation(this.program,"oripx"),this.t_size=t.getUniformLocation(this.program,"size"),this.setUniforms(t)}setUniforms(t){const e=t.getUniformLocation(this.program,"radius"),i=t.getUniformLocation(this.program,"color");t.uniform1f(e,this.radius),t.uniform4f(i,...this.color)}render(t){const e=t.context,i=t.zoom,o=t.pxbounds,n=t.drawSize;this.zoom=i,this.pxbounds=o,e.useProgram(this.program),e.bindVertexArray(this.vao);const s=Math.pow(2,i-8);e.uniform1f(this.t_scale,s),e.uniform2f(this.t_oripx,o.xmin,o.ymin),e.uniform3f(this.t_size,n[0],n[1],devicePixelRatio),t.firstDraw&&(e.clear(e.COLOR_BUFFER_BIT),t.firstDraw=!1),e.drawArrays(e.POINTS,0,this.drawNum)}}const F={v:"#version 300 es\nin vec4 a_position;uniform vec2 oripx;uniform vec2 size;uniform float scale;void main(){vec2 point = a_position.xy * scale;point = point - oripx;point.x = point.x / size.x;point.y = point.y / size.y;point.y = 1.0 - 2.0*point.y;point.x = 2.0*point.x - 1.0;gl_Position = vec4(point,0.0,1.0);}",f:"#version 300 es\n    precision highp float;out vec4 outColor;uniform vec4 color;void main(){outColor = color;}"};class I extends t{constructor(t){super(t),this.id=(new Date).getTime()+Math.round(1e4*Math.random()).toString(),this.target="eleContent",this._layerChange=[],this.init(t)}init(t){this.visiable=!("visiable"in t)||t.visiable,this.position=t.position,this.pointEvent=t.pointEvent,this.index=t.index,this.createContent(),this.setElement(t)}setElement(t){t.source instanceof Element?(this.elecontent.innerHTML="",this.elecontent.appendChild(t.source)):this.elecontent.innerHTML=t.source}createContent(){this.elecontent=document.createElement("div"),this.visiable||(this.elecontent.style.display="none"),this.elecontent.setAttribute("class","cyd-ele-content-min"),this.index&&(this.elecontent.style.zIndex=this.index),this.pointEvent&&(this.elecontent.style.pointerEvents="all")}setLatLng(t,e){this.position=[t,e],this.layerChangeEvent()}setVisiable(t){this.elecontent.style.display=t?"block":"none"}layerChangeEvent(){this._layerChange.forEach((t=>{t()}))}addTo(t){if("group"==t.type)return t.addLayer(this),this;this.initContent(t),t.contexts[this.target].context.appendChild(this.elecontent);const e=t.getPxBounds(),i=t.getZoom(),o=this.position,s=n(o[0],o[1],i);return s.selfSub({x:e.xmin,y:e.ymin}),this.elecontent.style.transform="translate("+s.x+"px,"+s.y+"px)",t.addLayer(this),this._layerChange.push(t._layerChange.bind(t)),this}initContent(t){if(!t.contexts[this.target]){const e=t.canvasContent,i=document.createElement("div");i.setAttribute("class","cyd-ele-content"),e.appendChild(i),t.contexts[this.target]={type:"ele",context:i}}}bindTooltip(t,e,i){this.tooltip=new I({position:this.position,source:e,visiable:!1,index:i}).addTo(t),this.elecontent.style.pointerEvents="all",this.elecontent.onmouseover=function(){this.tooltip.setVisiable(!0)}.bind(this),this.elecontent.onmouseout=function(){this.tooltip.setVisiable(!1)}.bind(this)}render(t){const e=t.pxbounds;this.zoom=t.zoom;const i=this.position,o=n(i[0],i[1],t.zoom);o.selfSub({x:e.xmin,y:e.ymin}),this.elecontent.style.transform="translate("+o.x+"px,"+o.y+"px)"}removeFromMap(t){const e=t.contexts[this.target].context;e.contains(this.elecontent)&&(e.removeChild(this.elecontent),t.removeLayer(this))}destroy(t){if(this.id){this.removeFromMap(t);for(let t in this)delete this[t]}}}class D extends G{constructor(t){super(t),this.index=t.index||p}init(t){this.data=t.position,this.source=t.source,this.imgSize=t.imgSize,this.eventSize=t.eventSize,this.rotate=t.rotate||0,this.offset=t.offset||[0,0],this.ready=!1,this.mouseIn=!1}initSelfDraw(t){return this.createDraw(t.contexts[this.target].context,"#version 300 es\nin vec2 a_position;\nuniform float scale;\nuniform vec2 oripx;\nuniform vec3 size;\nuniform vec2 imgSize;\nuniform vec2 offset;\nvoid main(){\n    vec2 point = a_position*scale;\n    point = point - oripx + offset;\n    point.x = point.x / size.x*size.z;\n    point.y = point.y / size.y*size.z;\n    point.y = 1.0 - 2.0*point.y;\n    point.x = 2.0*point.x - 1.0;\n    gl_Position = vec4(point,0.0,1.0);\n    float psize = max(imgSize.x,imgSize.y)*size.z;\n    gl_PointSize = psize* sqrt(2.);\n}","#version 300 es\nprecision highp float;\nuniform sampler2D u_img;\nuniform vec2 imgSize;\nout vec4 outColor;\nuniform float rotate;\nvoid main(){\n    float rad = radians(rotate);\n    float cosrot = cos(rad);\n    float sinrot = sin(rad);\n    mat2 rotMatrix = mat2(cosrot,sinrot,-sinrot,cosrot);\n    vec2 xy = gl_PointCoord - 0.5;\n    xy = xy * rotMatrix;\n    // if(abs(xy.x) >sqrt(2.)/4. || abs(xy.y)>sqrt(2.)/4.){\n    //     discard;\n    // }\n    xy = xy * sqrt(2.);\n    xy+=0.5;\n    float psize = max(imgSize.x,imgSize.y);\n    float mid = abs(imgSize.x - imgSize.y)/psize;\n    if(imgSize.x > imgSize.y){\n        xy.y = (xy.y - mid/2.0)/(1.0 - mid);\n        if(xy.y<0.0 || xy.y>1.0){\n            discard;\n        }\n    }else{\n        xy.x = (xy.x - mid/2.0)/(1.0 - mid);\n        if(xy.x<0.0 || xy.x>1.0){\n            discard;\n        }\n    }\n    outColor =texture(u_img,xy);\n    // 处理边缘模糊\n    float a = (0.5 - abs(xy.x - 0.5))*psize;\n    float b = (0.5 - abs(xy.y - 0.5))*psize;\n    a = min(a,b);\n    a = min(a,1.);\n    outColor.a = min(outColor.a,a);\n}"),this.hideAllTooltip=t.hideAllTooltip.bind(t),this}fireEvent(t){const e=t.offsetX,i=t.offsetY;let o=n(this.data[0],this.data[1],this.zoom);if(!this.pxbounds)return;o.selfSub({x:this.pxbounds.xmin,y:this.pxbounds.ymin}),o.selfAdd({x:this.offset[0],y:this.offset[1]});const s=this.eventSize?this.eventSize:this.imgSize;if(Math.abs(e-o.x)<=s[0]/2&&Math.abs(i-o.y)<=s[1]/2){const o={lat:this.data[0],lon:this.data[1],x:e,y:i,id:this.id};return this.fire(t.type,o),this.mouseIn||(this.fire("mouseover",t),this.mouseIn=!0,this.tooltip&&(this.hideAllTooltip(this.id),this.tooltip.setVisiable(!0))),!!this.events[t.type].stopPropagation||void 0}return!(!this.mouseIn||(this.mouseIn=!1,this.fire("mouseout",t),this.tooltip&&this.tooltip.setVisiable(!1),!this.events[t.type].stopPropagation))}getSource(){return new Promise((t=>{if(this.source instanceof HTMLImageElement)t(this.source);else{const e=new Image;e.onload=function(){t(e)},e.onerror=function(){console.warn("加载图片失败");const e=new OffscreenCanvas(30,30),i=e.getContext("2d");i.font="30px Arial",i.fillText("柴",0,28),t(e)},e.src=this.source}}),this)}setUniforms(t){this.gl=t;const e=t.getUniformLocation(this.program,"rotate");t.uniform1f(e,this.rotate);const i=t.getUniformLocation(this.program,"offset");t.uniform2f(i,...this.offset);const o=t.getUniformLocation(this.program,"imgSize");this.u_img=t.getUniformLocation(this.program,"u_img"),this.getSource().then((e=>{t.useProgram(this.program),this.gif&&(this.img=e),this.imgSize||(this.imgSize=[e.width,e.height]),t.uniform2f(o,...this.imgSize),this.texture=L(t,e,0,!1,!1),t.uniform1i(this.u_img,0),this.ready=!0}))}render(t){if(!this.ready)return void(t.drawNext=!0);const e=t.context;e.useProgram(this.program),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.uniform1i(this.u_img,0),super.render(t)}setLatLng(t,e){const i=this.gl;this.data=[t,e];const o=this.computePxInZoom8();let n=new Float32Array(o);i.bindBuffer(i.ARRAY_BUFFER,this.vbuffer),i.bufferData(i.ARRAY_BUFFER,n,i.STATIC_DRAW),this.layerChangeEvent()}setImg(t){this.source=t,this.getSource().then((t=>{const e=this.gl;e.useProgram(this.program),this.gif&&(this.img=t),e.useProgram(this.program),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),this.layerChangeEvent()}),this)}bindTooltip(t,e,i){this.tooltip=null,this.tooltip||(this.tooltip=new I({position:this.data,source:e,visiable:!1,index:i}).addTo(t),t.setLayerEvent("mousemove",this,this.setTooltipState,!0))}openPopup(t,e,i){this.popup||(this.popup=new I({position:this.data,source:e,visiable:!0,index:i}).addTo(t))}closePopup(t){this.popup&&this.popup.destroy(t)}setTooltipState(){}destroy(t){if(!t)throw new Error("请输入地图参数");if(!this.id)throw new Error("请勿重复删除图层");this.tooltip&&this.tooltip.destroy(t),this.popup&&this.popup.destroy(t);const e=t.contexts[this.target].context;e.deleteVertexArray(this.vao);const i=this.program;e.deleteBuffer(this.vbuffer),e.deleteTexture(this.texture),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i),super.destroy(t)}}let W=class extends U{constructor(t){super(t)}init(t){this.index=t.index||x,this.data=t.data,this.zoom=null,this.text=t.text,this.point=t.point,this.textKey=t.textKey,this.textKey||(this.point=!0),this.point&&(this.fillStyle=t.fillStyle,this.lineWidth=t.lineWidth,this.strokeStyle=t.strokeStyle,this.radius=t.radius||6),this.textKey&&(this.textColor=t.textColor||this.fillStyle||this.strokeStyle,this.fontFamily=t.fontFamily||"arial",this.fontWeight=t.fontWeight||"500",this.fontSize=t.fontSize,this.offSetX=t.offSetX||0,this.offSetY=t.offSetY||0,this.strokeWidth=t.strokeWidth,this.strokeColor=t.strokeColor||"black",this.shadowColor=t.shadowColor,this.shadowBlur=t.shadowBlur,this.shadowOffsetX=t.shadowOffsetX,this.shadowOffsetY=t.shadowOffsetY)}computePxData(){const t=this.data,e=this.zoom;for(let i=0;i<t.length;i++){const o=t[i],s=n(o.lat,o.lon,e);o.x=s.x,o.y=s.y}}addData(t){const e=this.data,i=n(t.lat,t.lon,this.zoom);t.x=i.x,t.y=i.y,e.push(t),this.layerChangeEvent()}changeData(t){this.data=t,this.zoom=-1,this.layerChangeEvent()}drawPoints(t,e,i){const o=this.data,n=this.radius;t.save(),t.beginPath();for(let s=0;s<o.length;s++){const r=o[s],a=(r.x-e.xmin)*i,h=(r.y-e.ymin)*i;t.moveTo((a+n)*devicePixelRatio,h*devicePixelRatio),t.arc(a*devicePixelRatio,h*devicePixelRatio,n*devicePixelRatio,0,2*Math.PI,!1)}if(this.fillStyle&&(t.fillStyle=this.fillStyle,t.fill()),this.strokeStyle&&(t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeStyle,t.stroke()),this.textKey){const n=this.textKey,s=this.strokeWidth;let r=this.fontWeight+" "+this.fontSize*devicePixelRatio+"px "+this.fontFamily;t.font=r,t.fillStyle=this.textColor,s&&(t.strokeStyle=this.strokeColor,t.lineWidth=s),this.shadowColor&&(t.shadowColor=this.shadowColor,t.shadowBlur=this.shadowBlur,t.shadowOffsetX=this.shadowOffsetX,t.shadowOffsetY=this.shadowOffsetY);for(let r=0;r<o.length;r++){const a=o[r],h=(a.x-e.xmin)*i+this.offSetX*devicePixelRatio,l=(a.y-e.ymin)*i+this.offSetY*devicePixelRatio;s&&t.strokeText(a[n],h*devicePixelRatio,l*devicePixelRatio),t.fillText(a[n],h*devicePixelRatio,l*devicePixelRatio)}}t.restore()}render(t){const e=t.zoom,i=t.context,o=Math.round(e),n=t.zoomBounds,s=t.zoomScale;this.zoom!=o&&(this.zoom=o,this.computePxData()),t.firstDraw&&(i.clearRect(0,0,t.drawSize[0],t.drawSize[1]),t.firstDraw=!1),this.drawPoints(i,n,s)}};function B(t,e){e||(e=0);var i=t.r.length,o=t.v[0],n=t.v[i-1]+5,s=document.createElement("canvas");s.width=25*i+5,s.height=3;var r=s.getContext("2d");let a=r.createLinearGradient(0,0,s.width,0);for(var h=0;h<i-1;h++){let i=(t.v[h]-o)/(n-o),s=(t.v[h+1]-(t.v[h+1]-t.v[h])*e-o)/(n-o),r="rgba("+t.r[h]+","+t.g[h]+","+t.b[h]+","+t.o[h]+")";a.addColorStop(i,r),a.addColorStop(s,r)}let l="rgba("+t.r.at(-1)+","+t.g.at(-1)+","+t.b.at(-1)+","+t.o.at(-1)+")",c=(t.v.at(-1)-o)/(n-o);return a.addColorStop(c,l),a.addColorStop(1,l),r.fillStyle=a,r.fillRect(0,0,s.width,s.height),{vmin:o,vmax:n,canvas:s}}function Y(t){function e(e){let i=t+"-"+e+".png";return new Promise(((t,e)=>{let o=new Image;o.src=i,o.crossOrigin="anonymous",o.onload=function(){t(o)},o.onerror=function(){e("数据加载失败")}}))}var i=[];for(let t=0;t<36;t++)i.push(e(t));return new Promise(((t,e)=>{Promise.all(i).then((e=>{var i=document.createElement("canvas"),o=e[0].width,n=e[0].height;i.width=6*o,i.height=6*n;var s=i.getContext("2d");for(let t=0;t<6;t++)for(let i=0;i<6;i++){let r=6*t+i;s.drawImage(e[r],i*o,t*n)}t(i)})).catch((t=>{e(t)}))}))}function K(t){let e=[1,0,0,1];if(t instanceof Array)e=t.map((t=>t/255));else if("#"==t.substring(0,1)){const i=t.replace("#","");e[0]=parseInt(i.substring(0,2),16),e[1]=parseInt(i.substring(2,4),16),e[2]=parseInt(i.substring(4,6),16)}return e}function N(t,e){for(var i=t[0],o=t[1],n=!1,s=0,r=e.length-1;s<e.length;r=s++){var a=e[s][0],h=e[s][1],l=e[r][0],c=e[r][1];h>o!=c>o&&i<(l-a)*(o-h)/(c-h)+a&&(n=!n)}return n}function V(t){let e=t,i=e instanceof Array;if(!i)return 0;let o=1;for(;;){if(e=e[0],i=e instanceof Array,!i)return o;o+=1}}function k(t,e){var i=Math.PI/180,o=t.lat*i,n=e.lat*i,s=Math.sin((e.lat-t.lat)*i/2),r=Math.sin((e.lon-t.lon)*i/2),a=s*s+Math.cos(o)*Math.cos(n)*r*r;return 6371e3*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))}function H(t,e,i,o,n){const s=document.createElement("canvas");s.width=s.height=2*t*5;const r=s.getContext("2d"),a=t/2.5;r.beginPath();for(let e=0;e<5;e++)for(let i=0;i<5;i++){let o=5*i+e;if(o=o?2*o:1,o>40)continue;r.save();const n=e*t*2+t,s=i*t*2+t;r.translate(n,s),h(o),r.restore()}function h(e){if(0!=e&&(r.moveTo(0,0),r.lineTo(0,-2*a),!(e<=1)))if(e<=2){const e=t-(a/2+a/4),i=a/2*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(i,a/2-t)}else if(e<=4)r.lineTo(a*Math.sin(Math.PI/3),-t);else if(e<=6){r.lineTo(a*Math.sin(Math.PI/3),-t);const e=t-(a/2+a/4),i=a/2*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(i,a/2-t)}else if(e<=8){r.lineTo(a*Math.sin(Math.PI/3),-t);const e=t-(a/2+a/4),i=t-a/4,o=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(o,-i)}else if(e<=10){r.lineTo(a*Math.sin(Math.PI/3),-t);let e=t-(a/2+a/4);const i=t-a/4,o=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(o,-i),e=t-a;let n=e+a/4;const s=a/2*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(s,-n)}else if(e<=12){r.lineTo(a*Math.sin(Math.PI/3),-t);let e=t-(a/2+a/4);const i=t-a/4,o=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(o,-i),e=t-a;let n=e+a/2;const s=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(s,-n)}else if(e<=14){r.lineTo(a*Math.sin(Math.PI/3),-t);let e=t-(a/2+a/4);const i=t-a/4,o=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(o,-i),e=t-a;let n=e+a/2;const s=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(s,-n),e=t-1.25*a;const h=e+.25*a,l=a/2*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(l,-h)}else if(e<=16){r.lineTo(a*Math.sin(Math.PI/3),-t);let e=t-(a/2+a/4);const i=t-a/4,o=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(o,-i),e=t-a;let n=e+a/2;const s=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(s,-n),e=t-1.25*a;const h=e+.5*a,l=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(l,-h)}else if(e<=18){r.lineTo(a*Math.sin(Math.PI/3),-t);let e=t-(a/2+a/4);const i=t-a/4,o=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(o,-i),e=t-a;let n=e+a/2;const s=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(s,-n),e=t-1.25*a;const h=e+.5*a,l=a*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(l,-h),e=t-1.5*a;const c=e+.25*a,u=a/2*Math.sin(Math.PI/3);r.moveTo(0,-e),r.lineTo(u,-c)}else if(e<=20){const e=a*Math.sin(Math.PI/3);r.lineTo(e,a/2-t),r.lineTo(0,-t+a)}else if(e<=22){const e=a*Math.sin(Math.PI/3);r.lineTo(e,a/2-t),r.lineTo(0,-t+a);let i=-t+a+a/4;const o=a/2*Math.sin(Math.PI/3),n=-t+a;r.moveTo(0,i),r.lineTo(o,n)}else if(e<=24){const e=a*Math.sin(Math.PI/3);r.lineTo(e,a/2-t),r.lineTo(0,-t+a);let i=-t+a+a/4;const o=a*Math.sin(Math.PI/3),n=-t+a-a/4;r.moveTo(0,i),r.lineTo(o,n)}else if(e<=26){const e=a*Math.sin(Math.PI/3);r.lineTo(e,a/2-t),r.lineTo(0,-t+a);let i=-t+a+a/4;const o=a*Math.sin(Math.PI/3),n=-t+a-a/4;r.moveTo(0,i),r.lineTo(o,n),i=-t+a+a/2;const s=a/2*Math.sin(Math.PI/3),h=-t+a+a/4;r.moveTo(0,i),r.lineTo(s,h)}else if(e<=28){const e=a*Math.sin(Math.PI/3);r.lineTo(e,a/2-t),r.lineTo(0,-t+a);let i=-t+a+a/4;const o=a*Math.sin(Math.PI/3),n=-t+a-a/4;r.moveTo(0,i),r.lineTo(o,n),i=-t+a+a/2;const s=a*Math.sin(Math.PI/3),h=-t+a;r.moveTo(0,i),r.lineTo(s,h)}else if(e<=30){const e=a*Math.sin(Math.PI/3);r.lineTo(e,a/2-t),r.lineTo(0,-t+a);let i=-t+a+a/4;const o=a*Math.sin(Math.PI/3),n=-t+a-a/4;r.moveTo(0,i),r.lineTo(o,n),i=-t+a+a/2;const s=a*Math.sin(Math.PI/3),h=-t+a;r.moveTo(0,i),r.lineTo(s,h),i=-t+a+a/2+a/4;const l=a/2*Math.sin(Math.PI/3),c=-t+a+a/2;r.moveTo(0,i),r.lineTo(l,c)}else if(e<=32){const e=a*Math.sin(Math.PI/3);r.lineTo(e,a/2-t),r.lineTo(0,-t+a);let i=-t+a+a/4;const o=a*Math.sin(Math.PI/3),n=-t+a-a/4;r.moveTo(0,i),r.lineTo(o,n),i=-t+a+a/2;const s=a*Math.sin(Math.PI/3),h=-t+a;r.moveTo(0,i),r.lineTo(s,h),i=-t+a+a/2+a/4;const l=a*Math.sin(Math.PI/3),c=-t+a+a/4;r.moveTo(0,i),r.lineTo(l,c)}else if(e<=34){const e=a*Math.sin(Math.PI/3);r.lineTo(e,a/2-t),r.lineTo(0,-t+a);let i=-t+a+a/4;const o=a*Math.sin(Math.PI/3),n=-t+a-a/4;r.moveTo(0,i),r.lineTo(o,n),i=-t+a+a/2;const s=a*Math.sin(Math.PI/3),h=-t+a;r.moveTo(0,i),r.lineTo(s,h),i=-t+a+a/2+a/4;const l=a*Math.sin(Math.PI/3),c=-t+a+a/4;r.moveTo(0,i),r.lineTo(l,c),i=2*a-t;const u=a/2*Math.sin(Math.PI/3),m=-t+a+a/2+a/4;r.moveTo(0,i),r.lineTo(u,m)}else if(e<=36){const e=a*Math.sin(Math.PI/3);r.lineTo(e,a/2-t),r.lineTo(0,-t+a);let i=-t+a+a/4;const o=a*Math.sin(Math.PI/3),n=-t+a-a/4;r.moveTo(0,i),r.lineTo(o,n),i=-t+a+a/2;const s=a*Math.sin(Math.PI/3),h=-t+a;r.moveTo(0,i),r.lineTo(s,h),i=-t+a+a/2+a/4;const l=a*Math.sin(Math.PI/3),c=-t+a+a/4;r.moveTo(0,i),r.lineTo(l,c),i=2*a-t;const u=a*Math.sin(Math.PI/3),m=-t+a+a/2;r.moveTo(0,i),r.lineTo(u,m)}else if(e<=38){const e=a*Math.sin(Math.PI/3);r.lineTo(e,a/2-t),r.lineTo(0,-t+a);let i=-t+a+a/4;const o=a*Math.sin(Math.PI/3),n=-t+a-a/4;r.moveTo(0,i),r.lineTo(o,n),i=-t+a+a/2;const s=a*Math.sin(Math.PI/3),h=-t+a;r.moveTo(0,i),r.lineTo(s,h),i=-t+a+a/2+a/4;const l=a*Math.sin(Math.PI/3),c=-t+a+a/4;r.moveTo(0,i),r.lineTo(l,c),i=2*a-t;const u=a*Math.sin(Math.PI/3),m=-t+a+a/2;r.moveTo(0,i),r.lineTo(u,m),i=2*a-t+a/4;const d=a/2*Math.sin(Math.PI/3),f=2*a-t;r.moveTo(0,i),r.lineTo(d,f)}else{const e=a*Math.sin(Math.PI/3);r.lineTo(e,a/2-t),r.lineTo(0,-t+a),r.moveTo(0,-t+a+a/4),r.lineTo(e,-t+a+a/4),r.lineTo(0,-t+a+a/2+a/4)}}return n&&(r.strokeStyle=n),o&&(r.lineWidth=o,r.stroke()),e&&(r.strokeStyle=e),r.lineWidth=i||1,r.stroke(),r.stroke(),s}function O(t,e){return new Promise(((i,o)=>{const n=new Image;e&&(n.crossOrigin="anonymous"),n.onload=function(){i(n)},n.onerror=function(){o("图片加载失败")},n.src=t}))}function j(t,e,i,o,n,s,r){if(t<i||t>o||e<n||e>s)return{x:null,y:null};return{x:Math.round((e-n)/r),y:Math.round((t-i)/r)}}const J={f:"#version 300 es\n    precision highp float;\n    in float vx;uniform float u_width;\n    uniform vec4 color;\n    out vec4 outColor;void main(){\toutColor = color;float dif = abs(vx - 0.5);float adis = 0.5/u_width;float a = (0.5 - dif)/adis;a = min(a,1.0);a = max(a,0.0);outColor.a = a;}",v:"#version 300 es\n    in float type;\n    in float vertices;\n    uniform vec2 oripx;\n    uniform vec2 size;\n    uniform float scale;\n    uniform float texnum;\n    uniform sampler2D u_t;\n    uniform float u_width;\n    out float vx;\n    vec2 computeXy(float num){\n        float x = mod(num,texnum)/(texnum-1.0);\n        float y = floor(num/texnum)/(texnum-1.0);\n        return vec2(x,y);\n    }\n    void main(){\n        float width = u_width + 0.5; \n        vec2 dir;\n        vec2 normal;\n        vec2 xypos =computeXy(vertices);\n        float nextnum = vertices + 1.0;\n        float presnum = vertices - 1.0;\n        // if(presnum<0.0){\n        //     presnum = texnum*texnum;\n        // }\n        // if(nextnum > texnum*texnum){\n        //     nextnum = 1.0;\n        // }\n        vec2 xypres = computeXy(presnum);\n        vec2 xynext = computeXy(nextnum);\n        vec2 position = texture(u_t,xypos).rg;\n        vec2 pres = texture(u_t,xypres).rg;\n        vec2 next = texture(u_t,xynext).rg;\n        position = position *  scale - oripx;\n        pres = pres *  scale - oripx;\n        next = next *  scale - oripx;\n        vec2 xy = vec2(0.0);\n        if(type==0.0){dir = next - position;dir = normalize(dir);normal = vec2(-dir.y,dir.x);xy = normal*width;xy = position.xy - xy.xy;vx = 0.0;}else if(type == 1.0){dir = next - position;dir = normalize(dir);normal = vec2(-dir.y,dir.x);xy = normal*width;xy = position.xy + xy.xy;vx = 1.0;}else if(type == 2.0){dir = position - pres;dir = normalize(dir);normal = vec2(-dir.y,dir.x);xy = normal*width;xy = position.xy - xy.xy;vx = 0.0;}else if(type == 3.0){dir = position - pres;dir = normalize(dir);normal = vec2(-dir.y,dir.x);xy = normal*width;xy = position.xy + xy.xy;vx = 1.0;}else if(type==4.0){vec2 v1 = position - pres;v1 = normalize(v1);float isleft = (position.x - pres.x) * (next.y - pres.y) - (position.y - pres.y) * (next.x - pres.x);float munum = isleft < 0.0 ? -1.0 : 1.0;normal = vec2(-v1.y, v1.x);xy = normal*width*munum;xy = position.xy - xy.xy;vx = isleft < 0.0 ?1.0:0.0;}else if(type == 5.0){float isleft = (position.x - pres.x) * (next.y - pres.y) - (position.y - pres.y) * (next.x - pres.x);vec2 v1 = normalize(position - pres);vec2 v2 = normalize(position - next);vec2 v = normalize(v1+v2);xy = v*width;xy = position.xy + xy.xy;vx = isleft < 0.0 ?1.0:0.0;}else if(type == 6.0){vec2 v2 = next - position;v2 = normalize(v2);float isleft = (position.x - pres.x) * (next.y - pres.y) - (position.y - pres.y) * (next.x - pres.x);float munum = isleft < 0.0 ? -1.0 : 1.0;normal = vec2(-v2.y, v2.x);xy = normal*width*munum;xy = position.xy - xy.xy;vx = isleft < 0.0 ?1.0:0.0;}else if(type == 7.0){vec2 v1 = position - pres;v1 = normalize(v1);float isleft = (position.x - pres.x) * (next.y - pres.y) - (position.y - pres.y) * (next.x - pres.x);float munum = isleft < 0.0 ? -1.0 : 1.0;normal = vec2(v1.y, -v1.x)*munum;vec2 v2 = normalize(position - next);vec2 v = normalize(v1+v2);normal = normalize(normal + v);xy = normal*width;xy = position.xy + xy.xy;vx = isleft < 0.0 ?1.0:0.0;}else if(type == 8.0){vec2 v2 = position - next;v2 = normalize(v2);float isleft = (position.x - pres.x) * (next.y - pres.y) - (position.y - pres.y) * (next.x - pres.x);float munum = isleft < 0.0 ? -1.0 : 1.0;normal = vec2(-v2.y, v2.x)*munum;vec2 v1 = normalize(position - pres);vec2 v = normalize(v1+v2);normal = normalize(normal + v);xy = normal*width;xy = position.xy + xy.xy;vx = isleft < 0.0 ?1.0:0.0;}else{xy = position.xy;vx = 0.5;}xy.x = xy.x / size.x;xy.y = xy.y / size.y;xy.y = 1.0 - 2.0*xy.y;xy.x = 2.0*xy.x - 1.0;gl_Position = vec4(xy,0.0,1.0);}"};class Q extends _{constructor(t){super(t),this.index=t.index||f}init(t){this.coords=t.coords,this.lineWidth=t.lineWidth||1,this.color=t.color||[255,0,0,255],this.color=K(this.color),this.lineWidth<1?this.computeVertices_1():this.computeVertices_n()}computeVertices_1(){let t=[];const e=this.coords,i=V(e);if(i<2)throw new Error("非二维或者三维数组，无法解析");if(2==i)for(let i=0;i<e.length;i++){const o=n(e[i][0],e[i][1],8);t.push(o.x,o.y)}else if(3==i)for(let i=0;i<e.length;i++)for(let o=0;o<e[i].length;o++){const s=n(e[i][o][0],e[i][o][1],8);t.push(s.x,s.y)}this.pxs=t}computePoints(t,e,i){let o=n(t[t.length-2][0],t[t.length-2][1],8);e.push(o.x,o.y);for(let o=0;o<t.length;o++){const s=n(t[o][0],t[o][1],8);e.push(s.x,s.y),i.push(s)}let s=n(t[1][0],t[1][1],8);e.push(s.x,s.y)}computeVertices_one(t,e,i,o){const n=[];let s=e.length/2+1;this.computePoints(t,e,n);for(let t=0;t<n.length;t++)0==t?n[0].equal(n[n.length-1])&&(i.push(t+s,t+s,t+s),o.push(10,4,7),i.push(t+s,t+s,t+s),o.push(10,7,5),i.push(t+s,t+s,t+s),o.push(10,5,8),i.push(t+s,t+s,t+s),o.push(10,8,6)):t==n.length-1?(i.push(t+s,t+s-1,t+s-1,t+s,t+s,t+s-1),o.push(2,0,1,2,3,1)):(i.push(t+s,t+s-1,t+s-1,t+s,t+s,t+s-1),o.push(2,0,1,2,3,1),i.push(t+s,t+s,t+s),o.push(10,4,7),i.push(t+s,t+s,t+s),o.push(10,7,5),i.push(t+s,t+s,t+s),o.push(10,5,8),i.push(t+s,t+s,t+s),o.push(10,8,6))}computeVertices_n(){const t=[],e=[],i=[],o=this.coords,n=V(o);if(n<2)throw new Error("非二维或者三维数组，无法解析");if(2==n)this.computeVertices_one(o,t,e,i);else if(3==n)for(let n=0;n<o.length;n++)this.computeVertices_one(o[n],t,e,i);const s=t.length/2,r=Math.sqrt(s);let a=0;for(let t=0;t<8e3;t++)if(t>r){a=t;break}const h=t[t.length-4],l=t[t.length-3];for(let e=t.length;e<a*a*2;e+=2)t[e]=h,t[e+1]=l;this.pxs=t,this.vertices=e,this.type=i,this.texnum=a}initSelfDraw(t){this.lineWidth<1?this.createDraw(t.contexts[this.target].context,F.v,F.f):this.createDraw(t.contexts[this.target].context,J.v,J.f)}initVao(t){this.gl=t,t.useProgram(this.program);const e=this.program;if(this.lineWidth<1){const e=new Float32Array(this.pxs);this.drawNum=e.length/2;let i=t.getAttribLocation(this.program,"a_position"),o=E(t,e);this.vbuffer=o;let n=R(t,i,2);this.vao=n}else{this.drawNum=this.vertices.length,this.texture=t.createTexture(),t.activeTexture(t.TEXTURE0),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.bindTexture(t.TEXTURE_2D,this.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RG32F,this.texnum,this.texnum,0,t.RG,t.FLOAT,new Float32Array(this.pxs));const i=t.getUniformLocation(e,"texnum");t.uniform1f(i,this.texnum);let o=t.getAttribLocation(e,"vertices"),n=E(t,new Float32Array(this.vertices)),s=R(t,o,1);this.vao=s,this.vbuffer=n;let r=t.getAttribLocation(e,"type");this.typebuffer=E(t,new Float32Array(this.type)),t.enableVertexAttribArray(r),t.vertexAttribPointer(r,1,t.FLOAT,!1,0,0)}this.t_scale=t.getUniformLocation(this.program,"scale"),this.t_oripx=t.getUniformLocation(this.program,"oripx"),this.t_size=t.getUniformLocation(this.program,"size");const i=t.getUniformLocation(this.program,"u_width");t.uniform1f(i,this.lineWidth/2);const o=t.getUniformLocation(this.program,"color");t.uniform4f(o,...this.color)}changeColor(t){this.gl.useProgram(this.program),this.color=K(t);const e=this.gl.getUniformLocation(this.program,"color");this.gl.uniform4f(e,...this.color),this.layerChangeEvent()}changeCoords(t){this.coords=t;const e=this.gl;if(this.lineWidth<1)this.computeVertices_1(),e.bindBuffer(e.ARRAY_BUFFER,this.vbuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.pxs),e.STATIC_DRAW);else{this.computeVertices_n(),this.drawNum=this.vertices.length,e.useProgram(this.program),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RG32F,this.texnum,this.texnum,0,e.RG,e.FLOAT,new Float32Array(this.pxs));const t=e.getUniformLocation(this.program,"texnum");e.uniform1f(t,this.texnum),e.bindBuffer(e.ARRAY_BUFFER,this.vbuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.vertices),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.typebuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.type),e.STATIC_DRAW)}this.layerChangeEvent()}addLatLng(t,e){this.coords.push([t,e]),this.changeCoords(this.coords)}getLatLngs(){return this.coords}render(t){const e=t.context,i=t.zoom,o=t.pxbounds,n=t.drawSize;this.pxbounds=o,e.useProgram(this.program),e.bindVertexArray(this.vao);const s=Math.pow(2,i-8);if(e.uniform1f(this.t_scale,s),e.uniform2f(this.t_oripx,o.xmin,o.ymin),e.uniform2f(this.t_size,n[0]/devicePixelRatio,n[1]/devicePixelRatio),t.firstDraw&&(e.clear(e.COLOR_BUFFER_BIT),t.firstDraw=!1),this.lineWidth<1)e.drawArrays(e.LINE_STRIP,0,this.drawNum);else{e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture);const t=e.getUniformLocation(this.program,"u_t");e.uniform1i(t,0),e.drawArrays(e.TRIANGLES,0,this.drawNum)}}destroy(t){const e=t.contexts[this.target].context,i=this.program;e.deleteBuffer(this.vbuffer),this.typebuffer&&e.deleteBuffer(this.typebuffer),e.deleteTexture(this.texture),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i),super.destroy(t)}}const q={v:"#version 300 es\n    in vec4 a_position;out vec2 point;void main(){gl_Position = a_position;point = a_position.xy;}",f:"#version 300 es\n    #define PI 3.141592653589793238\n    #define PID 57.29577951308232\n    #define Rm 8495.1907\n    #ifdef GL_ES\n    precision highp float;\n    #endif\n    uniform float minpx;\n    uniform sampler2D u_lat;\n    uniform float latnum;\n    uniform float scc;\n    out vec4 outColor;\n    vec2 pxToLatlng(vec3 px){\n       float scale = px.z;\n       float x = scale*px.x - PI;\n       float ynum = px.y*scc - minpx;\n       float stx = mod(ynum,latnum)/(latnum-1.0);\n       float sty = floor(ynum/latnum)/(latnum-1.0);\n       float lat = texture(u_lat,vec2(stx,sty)).r;\n       float lon = x;\n       lon = mod(lon,360.0);\n       return vec2(lat,lon);\n   }\n   uniform vec3 info;\n    vec2 latlngToJ(float latpt,float lonpt){\n       float lonrad = info.y;\n       float latrad = info.x;  \n       float x0 = lonpt;\n       float y0 = latpt;\n       float z0 = info.z;\n       float havLat = sin((latrad - y0) / 2.0);\n       float havLon = sin((lonrad - x0) / 2.0);\n       float a = havLat * havLat + cos(latrad) * cos(y0) * havLon * havLon;\n       float s = 2.0 * atan(sqrt(a),sqrt(1.0 - a));\n       float s1 = 1.5 * atan(sqrt(a)/sqrt(1.0 - a));\n       float r = sin(s1)*Rm /(cos(z0+s1));\n       float aa = cos(y0) * sin(x0 - lonrad) / sin(s);\n       float bb = (sin(y0) - cos(s)*sin(latrad)) / sin(s) / cos(latrad);\n       float a1 = 0.0;\n       if (aa <= 0.93969 && aa >= -0.93969) {\n           a1 = asin(aa);\n           if (bb<=0.0) {\n               a1 = PI - a1;\n           }\n           else if (aa<=0.0 && bb>0.0) {\n               a1 = 2.0 * PI + a1;\n           }\n       }\n       else {\n           a1 = acos(bb);\n           if (lonrad >= x0) {\n               a1 = 2.0 * PI - a1;\n           }\n       }\n       float azi = a1 * PID;\n       return vec2(r,azi);\n   }in vec2 point;uniform sampler2D u_color;uniform sampler2D u_img;uniform vec4 oripx;uniform vec3 scale;uniform vec2 vrange;\n   uniform bool tminOpacity;uniform vec2 rs;uniform float rto;\n   void main(){\n       float x = oripx.x +gl_FragCoord.x/rto;  \n       float y = oripx.y + (oripx.w - gl_FragCoord.y)/rto;\n       vec2 latlng = pxToLatlng(vec3(x,y,oripx.z));\n       vec2 ij = latlngToJ(latlng.x,latlng.y);\n        float r = ij.x /rs.x;\n        if(fract(r)>=0.5){\n            r = ceil(r);\n        }else{\n            r = floor(r);\n        }\n        r *= rs.x;\n        float a = (r-rs.x)/(rs.y-rs.x);\n   \n        if(fract(ij.y)>0.5){\n            ij.y = ceil(ij.y);\n        }else{\n            ij.y = floor(ij.y);\n        }\n        float b = ij.y==360.?0.:ij.y/359.;\n        float value = 0.0;  \n       if(a>=0.0&&a<=1.0){ \n           vec4 color = texture(u_img,vec2(a,b))*255.0;\n           value = color.r/scale.x + color.g/scale.y +color.b/scale.z;  \n       }else{\n           discard;  \n       }  float vin = (value - vrange.x)/(vrange.y -vrange.x); outColor = texture(u_color,vec2(vin,0.5));  \n         if(tminOpacity){float o = (value - vrange.x*0.8)/0.5/vrange.x;o = max(o,0.0); o = min(o,1.0); outColor.a = outColor.a *o;}}"};class $ extends _{constructor(t){super(t),this.index=t.index||y}init(t){this.testOptions(t),this.latst=t.latst,this.lonst=t.lonst,this.elev=t.elev,this.rmin=t.rmin,this.rmax=t.rmax,this.img=t.img,this.scale=t.scale,this.colors=t.colors,this.linear=t.linear||0,this.minOpacity=t.minOpacity,this.interval=t.interval,this.useCros=t.useCros,this.maxRange=t.maxRange||5,this.pxZoom=t.pxZoom||15,this.devicePixelRatio=1,this.ready=!1,this.hasdata=!1,this.cutready=!1,this.eventable=!1,this.grid=!0,this.flipy=0,this.computePxToLat()}initSelfDraw(t){this.createDraw(t.contexts[this.target].context,q.v,q.f),this.setUniforms(t.contexts[this.target].context,this.program),this.createTexture(t.contexts[this.target].context)}testOptions(t){if(!t.latst||!t.lonst)throw new Error("error center pos");if(!t.elev&&0!=t.elev)throw new Error("no elevs info");if(!t.rmin||!t.rmax)throw new Error("no distance info");if(!t.img)throw new Error("no img or no url");if(!t.scale)throw new Error("no data scale");if(!t.colors)throw new Error("no img color")}computePxToLat(){const t=this.latst-this.maxRange,e=this.latst+this.maxRange,i=this.pxZoom,o=Math.floor(n(e,this.lonst,i).y),s=Math.ceil(n(t,this.lonst,i).y),r=Math.ceil(Math.sqrt(s-o+1)),a=new Float32Array(r*r),h=256*Math.pow(2,i);for(let t=0,e=o;e<=s;e++,t++){let i=2*-(e/h-.5)*Math.PI,o=2*Math.atan(Math.exp(i))-Math.PI/2;a[t]=o}this.pxToLat=a,this.latTextureSize=r,this.minpx=o,this.maxpx=s}createTexture(t){const e=typeof this.img;let i=null,o=t.getUniformLocation(this.program,"u_img");this.u_img=o,"string"!=e?(i=this.img,this.texture=L(t,i,0,this.grid,this.flipy),this.ready=!0,this.hasdata=!0):(i=new Image,this.useCros&&(i.crossOrigin="anonymous"),i.onload=function(){this.texture=L(t,i,0,this.grid,this.flipy),this.ready=!0,this.img=i,this.hasdata=!0}.bind(this),i.onerror=function(){console.warn("图片加载失败:"+this.img);const e=document.createElement("canvas");e.width=1,e.height=1,this.texture=L(t,e,0,this.grid,this.flipy),this.ready=!0,this.img=e,this.hasdata=!1}.bind(this),i.src=this.img);const n=B(this.colors,this.linear);this.colorTexture=L(t,n.canvas,1),this.u_color=t.getUniformLocation(this.program,"u_color"),t.uniform1i(this.u_color,1),this.vrange=t.getUniformLocation(this.program,"vrange"),t.uniform2f(this.vrange,n.vmin,n.vmax)}setUniforms(t,e){this.gl=t,t.useProgram(this.program),this.oripx=t.getUniformLocation(e,"oripx"),this.radarInfo=t.getUniformLocation(e,"info"),t.uniform3f(this.radarInfo,this.latst*Math.PI/180,this.lonst*Math.PI/180,this.elev*Math.PI/180),this.rs=t.getUniformLocation(e,"rs"),t.uniform2f(this.rs,this.rmin,this.rmax);const i=t.getUniformLocation(e,"scale");t.uniform3f(i,this.scale.r,this.scale.g,this.scale.b);const o=t.getUniformLocation(e,"tminOpacity");t.uniform1f(o,this.minOpacity),this.rto=t.getUniformLocation(e,"rto"),t.uniform1f(this.rto,1),this.u_lat=t.getUniformLocation(e,"u_lat"),this.latTexture=t.createTexture(),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,this.latTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.R32F,this.latTextureSize,this.latTextureSize,0,t.RED,t.FLOAT,this.pxToLat);const n=t.getUniformLocation(e,"minpx");t.uniform1f(n,this.minpx);const s=t.getUniformLocation(e,"latnum");t.uniform1f(s,this.latTextureSize),this.scdif=t.getUniformLocation(e,"scc")}changeImage(t){if(!this.ready)return;const e=this.gl;if("string"!=typeof t)e.useProgram(this.program),e.activeTexture(e.TEXTURE0),this.flipy?e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1):e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),this.layerChangeEvent(),this.hasdata=!0;else{const i=new Image;this.useCros&&(i.crossOrigin="anonymous"),i.onload=function(){e.useProgram(this.program),e.activeTexture(e.TEXTURE0),this.flipy?e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1):e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),this.layerChangeEvent(),this.hasdata=!0}.bind(this),i.onerror=function(){e.useProgram(this.program),console.warn("图片加载失败:"+this.img);const t=document.createElement("canvas");t.width=1,t.height=1,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),this.layerChangeEvent(),this.hasdata=!1}.bind(this),i.src=t}}changeEvel(t,e){this.elev=t;const i=this.gl;i.useProgram(this.program),i.uniform3f(this.radarInfo,this.latst*Math.PI/180,this.lonst*Math.PI/180,this.elev*Math.PI/180),this.changeImage(e)}changeColor(t){this.colors=t;const e=B(t,this.linear),i=this.gl;i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.colorTexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e.canvas),this.layerChangeEvent()}changeGrid(t){const e=this.gl;e.bindTexture(e.TEXTURE_2D,this.texture),t?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR)),this.layerChangeEvent()}changeData(t){const e=this.gl;if(e.useProgram(this.program),t.colors){this.colors=colors;const t=B(colors,this.linear);e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.colorTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.canvas)}t.elev&&(this.elev=elev,e.uniform3f(this.radarInfo,this.latst*Math.PI/180,this.lonst*Math.PI/180,this.elev*Math.PI/180)),t.url?this.changeImage(url):this.layerChangeEvent()}setGetGrid(t){this.ready?t?this.setPixels():(this.pixels=null,this.eventable=!1):window.requestAnimationFrame(function(){this.setGetGrid(t)}.bind(this))}setPixels(){const t=this.gl;this.frameBuffer||(this.frameBuffer=t.createFramebuffer()),t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture,0),t.bindFramebuffer(t.FRAMEBUFFER,null),this.eventable=!0}getGridDataByLatLon(t,e){if(!this.eventable)return;this.interval||console.warn("启用获取数值，需要传入径向距离间隔");const i=3.141592653589793,o=25485.572/3;let n=i/180,s=this.lonst*n,r=this.latst*n,a=e*n,h=t*n,l=this.elev*n,c=Math.sin((r-h)/2),u=Math.sin((s-a)/2),m=c*c+Math.cos(r)*Math.cos(h)*u*u,d=2*Math.atan(Math.sqrt(m)/Math.sqrt(1-m)),f=1.5*Math.atan(Math.sqrt(m)/Math.sqrt(1-m)),x=o/(Math.cos(f)-Math.tan(l)*Math.sin(f)),p=Math.sin(f)*o/Math.cos(l+f),y=x-o,g=Math.cos(h)*Math.sin(a-s)/Math.sin(d),v=(Math.sin(h)-Math.cos(d)*Math.sin(r))/Math.sin(d)/Math.cos(r),T=0;g<=.93969&&g>=-.93969?(T=Math.asin(g),v<=0?T=i-T:g<=0&&v>0&&(T=2*i+T)):(T=Math.acos(v),s>=a&&(T=2*i-T));let b=57.29577951308232*T;if(p>this.rmax)return{lat:t,lon:e,data:null};let E=Math.round(b);360==E&&(E=0);const R=Math.round((p-this.rmin)/this.interval),L=this.gl;L.bindFramebuffer(L.FRAMEBUFFER,this.frameBuffer);const w=new Uint8Array(4);return L.readPixels(R,E,1,1,L.RGBA,L.UNSIGNED_BYTE,w),L.bindFramebuffer(L.FRAMEBUFFER,null),{data:w[0]/this.scale.r+w[1]/this.scale.g+w[2]/this.scale.b,lat:t,lon:e,azi:b,r:p,elev:this.elev,h:y}}setUniformScale(t,e){const i=e.pxbounds,o=1/e.zoomScale,n=Math.PI/(128*Math.pow(2,Math.round(e.zoom)))*o;t.uniform4f(this.oripx,i.xmin,i.ymin,n,e.drawSize[1]);const s=Math.pow(2,this.pxZoom-e.zoom);t.uniform1f(this.scdif,s),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,this.latTexture),t.uniform1i(this.u_lat,2)}render(t){if(!this.ready)return void(t.drawNext=!0);if(this.cut&&!this.cutready)return void(t.drawNext=!0);const e=t.context;e.useProgram(this.program),this.setUniformScale(e,t),devicePixelRatio!=this.devicePixelRatio&&(this.devicePixelRatio=devicePixelRatio,e.uniform1f(this.rto,this.devicePixelRatio)),e.bindVertexArray(this.vao),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.uniform1i(this.u_img,0),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.colorTexture),e.uniform1i(this.u_color,1),this.cutTexture&&(e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,this.cutTexture),e.uniform1i(this.u_cut,2)),t.firstDraw&&(e.clear(e.COLOR_BUFFER_BIT),t.firstDraw=!1),e.drawArrays(e.TRIANGLE_STRIP,0,4)}destroy(t){if(!this.target)return void console.warn("图层不存在，无法删除");const e=t.contexts[this.target].context;e.deleteVertexArray(this.vao);const i=this.program;e.deleteBuffer(this.vbuffer),e.deleteTexture(this.texture),e.deleteTexture(this.colorTexture),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i),this.frameBuffer&&e.deleteFramebuffer(this.frameBuffer),super.destroy(t)}}class tt extends ${constructor(t){super(t)}init(t){this.img=t.img,this.latmin=t.latmin,this.latmax=t.latmax,this.lonmin=t.lonmin,this.lonmax=t.lonmax,this.scale=t.scale,this.colors=t.colors,this.linear=t.linear||0,this.flipy=t.flipy||0,this.grid=t.grid,this.minOpacity=t.minOpacity,this.cut=t.cut,this.cutUrl=t.cutUrl,this.cutlatmin=t.cutlatmin,this.cutlatmax=t.cutlatmax,this.cutlonmin=t.cutlonmin,this.cutlonmax=t.cutlonmax,this.interval=t.interval,this.useCros=t.useCros,this.ready=!1,this.cutready=!1,this.eventable=!1}initSelfDraw(t){let e="#version 300 es\n#define PI 3.141592653589793238\n#define PID 57.29577951308232\n#define useCut true\n#ifdef GL_ES\n    precision highp float;\n#endif\nvec2 pxToLatlng(vec3 px){\n    float x = (px.x*px.z - 0.5)*360.0;\n    float y = -(px.y*px.z - 0.5)*PI*2.0;\n    float lat = (2.0 * atan(exp(y)) - (PI / 2.0)) *PID ;\n    float lon = x;\n    lon = mod(lon,360.0);\n    return vec2(lat,lon);\n}\nin vec2 point;\nuniform sampler2D u_color;\nuniform sampler2D u_img;\nuniform vec4 oripx;\nuniform float rto;\nuniform vec4 tbound;\nuniform vec4 scale;\nuniform vec2 vrange;\nuniform bool tminOpacity;\nout vec4 outColor;\n#ifdef useCut\nuniform sampler2D cutImg;\nuniform vec4 cutArea;\nvoid main(){    \n    float x = oripx.x +gl_FragCoord.x/rto;                  \n    float y = oripx.y + (oripx.w - gl_FragCoord.y)/rto;\n    vec2 latlng = pxToLatlng(vec3(x,y,oripx.z));\n    float cuta = (latlng.x - cutArea.x)/(cutArea.y - cutArea.x);\n    float cutb = (latlng.y - cutArea.z)/(cutArea.w - cutArea.z);\n    float cutValue = texture(cutImg,vec2(cutb,cuta)).r;\n    if(cutValue>0.5){\n        discard;\n    }\n    float value = 0.0;\n    float b = (latlng.x - tbound.x)/(tbound.y - tbound.x);\n    float a = (latlng.y - tbound.z)/(tbound.w - tbound.z);\n    vec4 color = texture(u_img,vec2(a,b))*255.0;\n    value = color.r/scale.x + color.g/scale.y +color.b/scale.z+color.a/scale.w;\n    float vin = (value - vrange.x)/(vrange.y -vrange.x);\n    outColor = texture(u_color,vec2(vin,0.5));\n    if(tminOpacity){\n        float o = (value - vrange.x*0.8)/0.5/vrange.x;\n        o = max(o,0.0);\n        o = min(o,1.0);\n        outColor.a = outColor.a *o;\n    }\n}\n#else\nvoid main(){    \n    float x = oripx.x +gl_FragCoord.x/rto;                  \n    float y = oripx.y + (oripx.w - gl_FragCoord.y)/rto;\n    vec2 latlng = pxToLatlng(vec3(x,y,oripx.z));\n    float value = 0.0;\n    if(latlng.x>=tbound.x&&latlng.x<=tbound.y&&latlng.y>=tbound.z&&latlng.y<=tbound.w){\n        float b = (latlng.x - tbound.x)/(tbound.y - tbound.x);\n        float a = (latlng.y - tbound.z)/(tbound.w - tbound.z);\n        vec4 color = texture(u_img,vec2(a,b))*255.0;\n        value = color.r/scale.x + color.g/scale.y +color.b/scale.z+color.a/scale.w;\n    }else{\n        discard;\n    }\n    float vin = (value - vrange.x)/(vrange.y -vrange.x);\n    outColor = texture(u_color,vec2(vin,0.5));\n    if(tminOpacity){\n        float o = (value - vrange.x*0.8)/0.5/vrange.x;\n        o = max(o,0.0);\n        o = min(o,1.0);\n        outColor.a = outColor.a *o;\n    }\n}\n#endif\n";this.cut||(e=e.replace("#define useCut true","")),this.createDraw(t.contexts[this.target].context,"#version 300 es\nin vec4 a_position;\nout vec2 point;\nvoid main(){\n    gl_Position = a_position;\n    point = a_position.xy;\n}",e),this.setUniforms(t.contexts[this.target].context,this.program),this.createTexture(t.contexts[this.target].context),this.cut&&this.createCutTexture(t.contexts[this.target].context)}createCutTexture(t){const e=new Image;e.onload=function(){t.useProgram(this.program),this.cutTexture=L(t,e,2,!1,1),this.u_cut=t.getUniformLocation(this.program,"cutImg");const i=t.getUniformLocation(this.program,"cutArea");t.uniform4f(i,this.cutlatmin,this.cutlatmax,this.cutlonmin,this.cutlonmax),this.cutready=!0}.bind(this),e.onerror=function(){console.warn("裁剪图片加载失败"),this.cutready=!0},e.src=this.cutUrl}setUniforms(t,e){if(this.gl=t,t.useProgram(this.program),this.oripx=t.getUniformLocation(e,"oripx"),this.radarInfo=t.getUniformLocation(e,"tbound"),t.uniform4f(this.radarInfo,this.latmin,this.latmax,this.lonmin,this.lonmax),this.scale){const i=t.getUniformLocation(e,"scale");t.uniform4f(i,this.scale.r,this.scale.g,this.scale.b,this.scale.a),this.t_scale=i}const i=t.getUniformLocation(e,"tminOpacity");t.uniform1f(i,this.minOpacity),this.tminOpacity=i,this.rto=t.getUniformLocation(e,"rto"),t.uniform1f(this.rto,1)}setUniformScale(t,e){const i=e.pxbounds,o=1/e.zoomScale,n=1/Math.pow(2,Math.round(e.zoom))*o/256;t.uniform4f(this.oripx,i.xmin,i.ymin,n,e.drawSize[1])}getGridDataByLatLon(t,e){if(!this.eventable)return;if(this.interval||console.warn("启用获取数值，需要传入经纬度间隔"),!this.hasdata)return{data:null,lat:t,lon:e};const{x:i,y:o}=j(t,e,this.latmin,this.latmax,this.lonmin,this.lonmax,this.interval);if(null==i)return{data:null,lat:t,lon:e};const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,this.frameBuffer);const s=new Uint8Array(4);return n.readPixels(i,o,1,1,n.RGBA,n.UNSIGNED_BYTE,s),n.bindFramebuffer(n.FRAMEBUFFER,null),{data:s[0]/this.scale.r+s[1]/this.scale.g+s[2]/this.scale.b+s[3]/this.scale.a,lat:t,lon:e}}changeAll(t){const e=this.gl;if(e.useProgram(this.program),"minOpacity"in t&&e.uniform1f(this.tminOpacity,t.minOpacity),t.scale&&e.uniform4f(this.t_scale,t.scale.r,t.scale.g,t.scale.b,t.scale.a),t.colors){this.colors=t.colors;const i=B(t.colors,this.linear);e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.colorTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i.canvas),e.uniform2f(this.vrange,i.vmin,i.vmax)}t.url?this.changeImage(t.url):this.layerChangeEvent()}changeImageArea(t,e,i,o,n,s){if(!this.ready)return void window.requestAnimationFrame(function(){this.changeImageArea(t,e,i,o,n,s)}.bind(this));this.flipy=s.flipy||this.flipy,this.interval=s.interval||this.interval;const r=this.gl;r.useProgram(this.program),this.latmin=e,this.latmax=i,this.lonmin=o,this.lonmax=n;let a=r.getUniformLocation(this.program,"tbound");if(r.uniform4f(a,e,i,o,n),s&&s.grid&&(this.grid=s.grid,r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.texture),this.grid?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR))),s&&s.colors){this.colors=s.colors;const t=B(this.colors,this.linear),e=this.gl;e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.colorTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.canvas)}this.changeImage(t)}changeLinear(t){this.linear=t,this.changeColor(this.colors)}changeGrid(t){const e=this.gl;this.grid!=t&&(this.grid=t,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),t?(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST)):(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR)),this.layerChangeEvent())}destroy(t){this.target?(this.cutTexture&&t.contexts[this.target].context.deleteTexture(this.texture),super.destroy(t)):console.warn("图层不存在，无法删除")}}function et(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var it={exports:{}};function ot(t,e,i){i=i||2;var o,n,s,r,a,h,l,c=e&&e.length,u=c?e[0]*i:t.length,m=nt(t,0,u,i,!0),d=[];if(!m||m.next===m.prev)return d;if(c&&(m=function(t,e,i,o){var n,s,r,a,h,l=[];for(n=0,s=e.length;n<s;n++)r=e[n]*o,a=n<s-1?e[n+1]*o:t.length,(h=nt(t,r,a,o,!1))===h.next&&(h.steiner=!0),l.push(xt(h));for(l.sort(ut),n=0;n<l.length;n++)i=mt(l[n],i);return i}(t,e,m,i)),t.length>80*i){o=s=t[0],n=r=t[1];for(var f=i;f<u;f+=i)(a=t[f])<o&&(o=a),(h=t[f+1])<n&&(n=h),a>s&&(s=a),h>r&&(r=h);l=0!==(l=Math.max(s-o,r-n))?32767/l:0}return rt(m,d,i,o,n,l,0),d}function nt(t,e,i,o,n){var s,r;if(n===St(t,e,i,o)>0)for(s=e;s<i;s+=o)r=wt(s,t[s],t[s+1],r);else for(s=i-o;s>=e;s-=o)r=wt(s,t[s],t[s+1],r);return r&&vt(r,r.next)&&(_t(r),r=r.next),r}function st(t,e){if(!t)return t;e||(e=t);var i,o=t;do{if(i=!1,o.steiner||!vt(o,o.next)&&0!==gt(o.prev,o,o.next))o=o.next;else{if(_t(o),(o=e=o.prev)===o.next)break;i=!0}}while(i||o!==e);return e}function rt(t,e,i,o,n,s,r){if(t){!r&&s&&function(t,e,i,o){var n=t;do{0===n.z&&(n.z=ft(n.x,n.y,e,i,o)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==t);n.prevZ.nextZ=null,n.prevZ=null,function(t){var e,i,o,n,s,r,a,h,l=1;do{for(i=t,t=null,s=null,r=0;i;){for(r++,o=i,a=0,e=0;e<l&&(a++,o=o.nextZ);e++);for(h=l;a>0||h>0&&o;)0!==a&&(0===h||!o||i.z<=o.z)?(n=i,i=i.nextZ,a--):(n=o,o=o.nextZ,h--),s?s.nextZ=n:t=n,n.prevZ=s,s=n;i=o}s.nextZ=null,l*=2}while(r>1)}(n)}(t,o,n,s);for(var a,h,l=t;t.prev!==t.next;)if(a=t.prev,h=t.next,s?ht(t,o,n,s):at(t))e.push(a.i/i|0),e.push(t.i/i|0),e.push(h.i/i|0),_t(t),t=h.next,l=h.next;else if((t=h)===l){r?1===r?rt(t=lt(st(t),e,i),e,i,o,n,s,2):2===r&&ct(t,e,i,o,n,s):rt(st(t),e,i,o,n,s,1);break}}}function at(t){var e=t.prev,i=t,o=t.next;if(gt(e,i,o)>=0)return!1;for(var n=e.x,s=i.x,r=o.x,a=e.y,h=i.y,l=o.y,c=n<s?n<r?n:r:s<r?s:r,u=a<h?a<l?a:l:h<l?h:l,m=n>s?n>r?n:r:s>r?s:r,d=a>h?a>l?a:l:h>l?h:l,f=o.next;f!==e;){if(f.x>=c&&f.x<=m&&f.y>=u&&f.y<=d&&pt(n,a,s,h,r,l,f.x,f.y)&&gt(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function ht(t,e,i,o){var n=t.prev,s=t,r=t.next;if(gt(n,s,r)>=0)return!1;for(var a=n.x,h=s.x,l=r.x,c=n.y,u=s.y,m=r.y,d=a<h?a<l?a:l:h<l?h:l,f=c<u?c<m?c:m:u<m?u:m,x=a>h?a>l?a:l:h>l?h:l,p=c>u?c>m?c:m:u>m?u:m,y=ft(d,f,e,i,o),g=ft(x,p,e,i,o),v=t.prevZ,T=t.nextZ;v&&v.z>=y&&T&&T.z<=g;){if(v.x>=d&&v.x<=x&&v.y>=f&&v.y<=p&&v!==n&&v!==r&&pt(a,c,h,u,l,m,v.x,v.y)&&gt(v.prev,v,v.next)>=0||(v=v.prevZ,T.x>=d&&T.x<=x&&T.y>=f&&T.y<=p&&T!==n&&T!==r&&pt(a,c,h,u,l,m,T.x,T.y)&&gt(T.prev,T,T.next)>=0))return!1;T=T.nextZ}for(;v&&v.z>=y;){if(v.x>=d&&v.x<=x&&v.y>=f&&v.y<=p&&v!==n&&v!==r&&pt(a,c,h,u,l,m,v.x,v.y)&&gt(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;T&&T.z<=g;){if(T.x>=d&&T.x<=x&&T.y>=f&&T.y<=p&&T!==n&&T!==r&&pt(a,c,h,u,l,m,T.x,T.y)&&gt(T.prev,T,T.next)>=0)return!1;T=T.nextZ}return!0}function lt(t,e,i){var o=t;do{var n=o.prev,s=o.next.next;!vt(n,s)&&Tt(n,o,o.next,s)&&Rt(n,s)&&Rt(s,n)&&(e.push(n.i/i|0),e.push(o.i/i|0),e.push(s.i/i|0),_t(o),_t(o.next),o=t=s),o=o.next}while(o!==t);return st(o)}function ct(t,e,i,o,n,s){var r=t;do{for(var a=r.next.next;a!==r.prev;){if(r.i!==a.i&&yt(r,a)){var h=Lt(r,a);return r=st(r,r.next),h=st(h,h.next),rt(r,e,i,o,n,s,0),void rt(h,e,i,o,n,s,0)}a=a.next}r=r.next}while(r!==t)}function ut(t,e){return t.x-e.x}function mt(t,e){var i=function(t,e){var i,o=e,n=t.x,s=t.y,r=-1/0;do{if(s<=o.y&&s>=o.next.y&&o.next.y!==o.y){var a=o.x+(s-o.y)*(o.next.x-o.x)/(o.next.y-o.y);if(a<=n&&a>r&&(r=a,i=o.x<o.next.x?o:o.next,a===n))return i}o=o.next}while(o!==e);if(!i)return null;var h,l=i,c=i.x,u=i.y,m=1/0;o=i;do{n>=o.x&&o.x>=c&&n!==o.x&&pt(s<u?n:r,s,c,u,s<u?r:n,s,o.x,o.y)&&(h=Math.abs(s-o.y)/(n-o.x),Rt(o,t)&&(h<m||h===m&&(o.x>i.x||o.x===i.x&&dt(i,o)))&&(i=o,m=h)),o=o.next}while(o!==l);return i}(t,e);if(!i)return e;var o=Lt(i,t);return st(o,o.next),st(i,i.next)}function dt(t,e){return gt(t.prev,t,e.prev)<0&&gt(e.next,t,t.next)<0}function ft(t,e,i,o,n){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*n|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-o)*n|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function xt(t){var e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function pt(t,e,i,o,n,s,r,a){return(n-r)*(e-a)>=(t-r)*(s-a)&&(t-r)*(o-a)>=(i-r)*(e-a)&&(i-r)*(s-a)>=(n-r)*(o-a)}function yt(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Tt(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(Rt(t,e)&&Rt(e,t)&&function(t,e){var i=t,o=!1,n=(t.x+e.x)/2,s=(t.y+e.y)/2;do{i.y>s!=i.next.y>s&&i.next.y!==i.y&&n<(i.next.x-i.x)*(s-i.y)/(i.next.y-i.y)+i.x&&(o=!o),i=i.next}while(i!==t);return o}(t,e)&&(gt(t.prev,t,e.prev)||gt(t,e.prev,e))||vt(t,e)&&gt(t.prev,t,t.next)>0&&gt(e.prev,e,e.next)>0)}function gt(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function vt(t,e){return t.x===e.x&&t.y===e.y}function Tt(t,e,i,o){var n=Et(gt(t,e,i)),s=Et(gt(t,e,o)),r=Et(gt(i,o,t)),a=Et(gt(i,o,e));return!!(n!==s&&r!==a||0===n&&bt(t,i,e)||0===s&&bt(t,o,e)||0===r&&bt(i,t,o)||0===a&&bt(i,e,o))}function bt(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function Et(t){return t>0?1:t<0?-1:0}function Rt(t,e){return gt(t.prev,t,t.next)<0?gt(t,e,t.next)>=0&&gt(t,t.prev,e)>=0:gt(t,e,t.prev)<0||gt(t,t.next,e)<0}function Lt(t,e){var i=new Pt(t.i,t.x,t.y),o=new Pt(e.i,e.x,e.y),n=t.next,s=e.prev;return t.next=e,e.prev=t,i.next=n,n.prev=i,o.next=i,i.prev=o,s.next=o,o.prev=s,o}function wt(t,e,i,o){var n=new Pt(t,e,i);return o?(n.next=o.next,n.prev=o,o.next.prev=n,o.next=n):(n.prev=n,n.next=n),n}function _t(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Pt(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function St(t,e,i,o){for(var n=0,s=e,r=i-o;s<i;s+=o)n+=(t[r]-t[s])*(t[s+1]+t[r+1]),r=s;return n}it.exports=ot,it.exports.default=ot,ot.deviation=function(t,e,i,o){var n=e&&e.length,s=n?e[0]*i:t.length,r=Math.abs(St(t,0,s,i));if(n)for(var a=0,h=e.length;a<h;a++){var l=e[a]*i,c=a<h-1?e[a+1]*i:t.length;r-=Math.abs(St(t,l,c,i))}var u=0;for(a=0;a<o.length;a+=3){var m=o[a]*i,d=o[a+1]*i,f=o[a+2]*i;u+=Math.abs((t[m]-t[f])*(t[d+1]-t[m+1])-(t[m]-t[d])*(t[f+1]-t[m+1]))}return 0===r&&0===u?0:Math.abs((u-r)/r)},ot.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},o=0,n=0;n<t.length;n++){for(var s=0;s<t[n].length;s++)for(var r=0;r<e;r++)i.vertices.push(t[n][s][r]);n>0&&(o+=t[n-1].length,i.holes.push(o))}return i};const Mt=et(it.exports),At="#version 300 es\nin vec2 a_position;\nuniform vec2 oripx;\nuniform vec2 size;\nuniform float scale;\nvoid main(){\n    vec2 point = a_position.xy * scale;\n    point = point - oripx;\n    point.x = point.x / size.x;\n    point.y = point.y / size.y;\n    point.y = 1.0 - 2.0*point.y;\n    point.x = 2.0*point.x - 1.0;\n    gl_Position = vec4(point,0.0,1.0);\n}";let Zt="#version 300 es\n#define usetexture true\nprecision highp float;\nout vec4 outColor;\nuniform vec2 test;\n#ifdef usetexture\nuniform sampler2D img;\nuniform vec2 texpx;\nvoid main(){\n    vec2 coord;\n    coord.x = fract((gl_FragCoord.x  + texpx.x)/ 200.0);\n    coord.y = fract((922.0-gl_FragCoord.y +texpx.y)/ 200.0);\n    outColor = texture(img,vec2(coord));\n}\n#else\nuniform vec4 color;\nvoid main(){\n    outColor = color;\n}\n#endif\n";class Ut extends _{constructor(t){super(t),this.index=t.index||f}init(t){this.coords=t.coords,this.color=t.color||[255,0,0,255],this.color=K(this.color),this.source=t.source,this.computePxs_8()}initSelfDraw(t){if(this.source)this.createDraw(t.contexts[this.target].context,At,Zt);else{const e=Zt.replace("#define usetexture true","");this.createDraw(t.contexts[this.target].context,At,e)}this.source&&(this.texture=L(t.contexts[this.target].context,this.source,0,!1,0),this.texpx=t.contexts[this.target].context.getUniformLocation(this.program,"texpx"))}initVao(t){this.gl=t,t.useProgram(this.program);const e=this.program;this.drawNum=this.indices.length;let i=t.getAttribLocation(e,"a_position");var o=E(t,this.vertices),n=R(t,i,2);this.vao=n,this.vbuffer=o,this.indexbuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexbuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),t.STATIC_DRAW),this.t_scale=t.getUniformLocation(e,"scale"),this.t_oripx=t.getUniformLocation(e,"oripx"),this.t_size=t.getUniformLocation(e,"size"),this.source||(this.t_color=t.getUniformLocation(e,"color"),t.uniform4f(this.t_color,...this.color))}fireEvent(t){if(N([t.latlon.lat,t.latlon.lon],this.coords)){const e={latlon:t.latlon,x:t.clientX,y:t.clientY};if(this.fire(t.type,e),this.events&&this.events[t.type].stopPropagation)return!0}}computePxs_8(){const t=this.coords;if(2==V(t)){console.log(t);let e=new Float32Array(2*t.length);if(t.length<3||t[0][0]!=t[t.length-1][0]||t[0][1]!=t[t.length-1][1])throw new Error("错误的多边形格式");for(let i=0;i<t.length;i++){const o=n(t[i][0],t[i][1],8);e.set([o.x,o.y],2*i)}this.vertices=e,this.indices=this.computeIndices(e,0)}else{const e=[],i=[];for(let o=0;o<t.length;o++){const s=t[o];if(s.length<3||s[0][0]!=s[s.length-1][0]||s[0][1]!=s[s.length-1][1])throw new Error("错误的多边形格式");let r=[];for(let t=0;t<s.length;t++){const e=n(s[t][0],s[t][1],8);r.push(e.x,e.y)}const a=e.length/2;let h=this.computeIndices(r,a);Array.prototype.push.apply(e,r),Array.prototype.push.apply(i,h)}this.vertices=e,this.indices=i}}computeIndices(t,e){const i=Mt(t);if(e>0)for(let t=0;t<i.length;t++)i[t]+=e;return i}changeCoords(t){const e=this.gl;this.coords=t,this.computePxs_8(),e.bindBuffer(e.ARRAY_BUFFER,this.vbuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.vertices),e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexbuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),e.STATIC_DRAW),this.layerChangeEvent()}changeColor(t){const e=this.gl;this.color=t||[255,0,0,255],this.color=K(this.color),this.source||(this.t_color=e.getUniformLocation(this.program,"color"),e.uniform4f(this.t_color,...this.color),this.layerChangeEvent())}getLatLngs(){return this.coords}render(t){const e=t.context,i=t.zoom,o=t.pxbounds,n=t.drawSize;this.pxbounds=o,e.useProgram(this.program),e.bindVertexArray(this.vao);const s=Math.pow(2,i-8);if(e.uniform1f(this.t_scale,s),e.uniform2f(this.t_oripx,o.xmin,o.ymin),e.uniform2f(this.t_size,n[0]/devicePixelRatio,n[1]/devicePixelRatio),this.texture){e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture);const t=e.getUniformLocation(this.program,"img");e.uniform1i(t,0),this.zoom!=i?(e.uniform2f(this.texpx,0,0),this.zoom=i):e.uniform2f(this.texpx,o.xmin,o.ymin)}t.firstDraw&&(e.clear(e.COLOR_BUFFER_BIT),t.firstDraw=!1),e.drawElements(e.TRIANGLES,this.drawNum,e.UNSIGNED_SHORT,0)}destroy(t){const e=t.contexts[this.target].context,i=this.program;e.deleteVertexArray(this.vao),e.deleteBuffer(this.vbuffer),e.deleteBuffer(this.indexbuffer),this.texture&&e.deleteTexture(this.texture),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i),super.destroy(t)}}const zt="KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIGxlKGUpe3JldHVybiBlJiZlLl9fZXNNb2R1bGUmJk9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChlLCJkZWZhdWx0Iik/ZS5kZWZhdWx0OmV9dmFyIGI9e2V4cG9ydHM6e319O2IuZXhwb3J0cz1YLGIuZXhwb3J0cy5kZWZhdWx0PVg7ZnVuY3Rpb24gWChlLHQscil7cj1yfHwyO3ZhciBzPXQmJnQubGVuZ3RoLG89cz90WzBdKnI6ZS5sZW5ndGgsaT1yZShlLDAsbyxyLCEwKSxuPVtdO2lmKCFpfHxpLm5leHQ9PT1pLnByZXYpcmV0dXJuIG47dmFyIGYsdSxsLHAseCxhLHY7aWYocyYmKGk9eWUoZSx0LGkscikpLGUubGVuZ3RoPjgwKnIpe2Y9bD1lWzBdLHU9cD1lWzFdO2Zvcih2YXIgYz1yO2M8bztjKz1yKXg9ZVtjXSxhPWVbYysxXSx4PGYmJihmPXgpLGE8dSYmKHU9YSkseD5sJiYobD14KSxhPnAmJihwPWEpO3Y9TWF0aC5tYXgobC1mLHAtdSksdj12IT09MD8zMjc2Ny92OjB9cmV0dXJuIGooaSxuLHIsZix1LHYsMCksbn1mdW5jdGlvbiByZShlLHQscixzLG8pe3ZhciBpLG47aWYobz09PWVlKGUsdCxyLHMpPjApZm9yKGk9dDtpPHI7aSs9cyluPWllKGksZVtpXSxlW2krMV0sbik7ZWxzZSBmb3IoaT1yLXM7aT49dDtpLT1zKW49aWUoaSxlW2ldLGVbaSsxXSxuKTtyZXR1cm4gbiYmJChuLG4ubmV4dCkmJihLKG4pLG49bi5uZXh0KSxufWZ1bmN0aW9uIHooZSx0KXtpZighZSlyZXR1cm4gZTt0fHwodD1lKTt2YXIgcj1lLHM7ZG8gaWYocz0hMSwhci5zdGVpbmVyJiYoJChyLHIubmV4dCl8fFYoci5wcmV2LHIsci5uZXh0KT09PTApKXtpZihLKHIpLHI9dD1yLnByZXYscj09PXIubmV4dClicmVhaztzPSEwfWVsc2Ugcj1yLm5leHQ7d2hpbGUoc3x8ciE9PXQpO3JldHVybiB0fWZ1bmN0aW9uIGooZSx0LHIscyxvLGksbil7aWYoZSl7IW4mJmkmJmdlKGUscyxvLGkpO2Zvcih2YXIgZj1lLHUsbDtlLnByZXYhPT1lLm5leHQ7KXtpZih1PWUucHJldixsPWUubmV4dCxpP2FlKGUscyxvLGkpOmhlKGUpKXt0LnB1c2godS5pL3J8MCksdC5wdXNoKGUuaS9yfDApLHQucHVzaChsLmkvcnwwKSxLKGUpLGU9bC5uZXh0LGY9bC5uZXh0O2NvbnRpbnVlfWlmKGU9bCxlPT09Zil7bj9uPT09MT8oZT14ZSh6KGUpLHQsciksaihlLHQscixzLG8saSwyKSk6bj09PTImJnBlKGUsdCxyLHMsbyxpKTpqKHooZSksdCxyLHMsbyxpLDEpO2JyZWFrfX19fWZ1bmN0aW9uIGhlKGUpe3ZhciB0PWUucHJldixyPWUscz1lLm5leHQ7aWYoVih0LHIscyk+PTApcmV0dXJuITE7Zm9yKHZhciBvPXQueCxpPXIueCxuPXMueCxmPXQueSx1PXIueSxsPXMueSxwPW88aT9vPG4/bzpuOmk8bj9pOm4seD1mPHU/ZjxsP2Y6bDp1PGw/dTpsLGE9bz5pP28+bj9vOm46aT5uP2k6bix2PWY+dT9mPmw/ZjpsOnU+bD91OmwsYz1zLm5leHQ7YyE9PXQ7KXtpZihjLng+PXAmJmMueDw9YSYmYy55Pj14JiZjLnk8PXYmJlUobyxmLGksdSxuLGwsYy54LGMueSkmJlYoYy5wcmV2LGMsYy5uZXh0KT49MClyZXR1cm4hMTtjPWMubmV4dH1yZXR1cm4hMH1mdW5jdGlvbiBhZShlLHQscixzKXt2YXIgbz1lLnByZXYsaT1lLG49ZS5uZXh0O2lmKFYobyxpLG4pPj0wKXJldHVybiExO2Zvcih2YXIgZj1vLngsdT1pLngsbD1uLngscD1vLnkseD1pLnksYT1uLnksdj1mPHU/ZjxsP2Y6bDp1PGw/dTpsLGM9cDx4P3A8YT9wOmE6eDxhP3g6YSxNPWY+dT9mPmw/ZjpsOnU+bD91OmwsZz1wPng/cD5hP3A6YTp4PmE/eDphLG09UCh2LGMsdCxyLHMpLFQ9UChNLGcsdCxyLHMpLGQ9ZS5wcmV2Wix3PWUubmV4dFo7ZCYmZC56Pj1tJiZ3JiZ3Lno8PVQ7KXtpZihkLng+PXYmJmQueDw9TSYmZC55Pj1jJiZkLnk8PWcmJmQhPT1vJiZkIT09biYmVShmLHAsdSx4LGwsYSxkLngsZC55KSYmVihkLnByZXYsZCxkLm5leHQpPj0wfHwoZD1kLnByZXZaLHcueD49diYmdy54PD1NJiZ3Lnk+PWMmJncueTw9ZyYmdyE9PW8mJnchPT1uJiZVKGYscCx1LHgsbCxhLHcueCx3LnkpJiZWKHcucHJldix3LHcubmV4dCk+PTApKXJldHVybiExO3c9dy5uZXh0Wn1mb3IoO2QmJmQuej49bTspe2lmKGQueD49diYmZC54PD1NJiZkLnk+PWMmJmQueTw9ZyYmZCE9PW8mJmQhPT1uJiZVKGYscCx1LHgsbCxhLGQueCxkLnkpJiZWKGQucHJldixkLGQubmV4dCk+PTApcmV0dXJuITE7ZD1kLnByZXZafWZvcig7dyYmdy56PD1UOyl7aWYody54Pj12JiZ3Lng8PU0mJncueT49YyYmdy55PD1nJiZ3IT09byYmdyE9PW4mJlUoZixwLHUseCxsLGEsdy54LHcueSkmJlYody5wcmV2LHcsdy5uZXh0KT49MClyZXR1cm4hMTt3PXcubmV4dFp9cmV0dXJuITB9ZnVuY3Rpb24geGUoZSx0LHIpe3ZhciBzPWU7ZG97dmFyIG89cy5wcmV2LGk9cy5uZXh0Lm5leHQ7ISQobyxpKSYmbmUobyxzLHMubmV4dCxpKSYmVyhvLGkpJiZXKGksbykmJih0LnB1c2goby5pL3J8MCksdC5wdXNoKHMuaS9yfDApLHQucHVzaChpLmkvcnwwKSxLKHMpLEsocy5uZXh0KSxzPWU9aSkscz1zLm5leHR9d2hpbGUocyE9PWUpO3JldHVybiB6KHMpfWZ1bmN0aW9uIHBlKGUsdCxyLHMsbyxpKXt2YXIgbj1lO2Rve2Zvcih2YXIgZj1uLm5leHQubmV4dDtmIT09bi5wcmV2Oyl7aWYobi5pIT09Zi5pJiZtZShuLGYpKXt2YXIgdT1zZShuLGYpO249eihuLG4ubmV4dCksdT16KHUsdS5uZXh0KSxqKG4sdCxyLHMsbyxpLDApLGoodSx0LHIscyxvLGksMCk7cmV0dXJufWY9Zi5uZXh0fW49bi5uZXh0fXdoaWxlKG4hPT1lKX1mdW5jdGlvbiB5ZShlLHQscixzKXt2YXIgbz1bXSxpLG4sZix1LGw7Zm9yKGk9MCxuPXQubGVuZ3RoO2k8bjtpKyspZj10W2ldKnMsdT1pPG4tMT90W2krMV0qczplLmxlbmd0aCxsPXJlKGUsZix1LHMsITEpLGw9PT1sLm5leHQmJihsLnN0ZWluZXI9ITApLG8ucHVzaChNZShsKSk7Zm9yKG8uc29ydChjZSksaT0wO2k8by5sZW5ndGg7aSsrKXI9dmUob1tpXSxyKTtyZXR1cm4gcn1mdW5jdGlvbiBjZShlLHQpe3JldHVybiBlLngtdC54fWZ1bmN0aW9uIHZlKGUsdCl7dmFyIHI9ZGUoZSx0KTtpZighcilyZXR1cm4gdDt2YXIgcz1zZShyLGUpO3JldHVybiB6KHMscy5uZXh0KSx6KHIsci5uZXh0KX1mdW5jdGlvbiBkZShlLHQpe3ZhciByPXQscz1lLngsbz1lLnksaT0tMS8wLG47ZG97aWYobzw9ci55JiZvPj1yLm5leHQueSYmci5uZXh0LnkhPT1yLnkpe3ZhciBmPXIueCsoby1yLnkpKihyLm5leHQueC1yLngpLyhyLm5leHQueS1yLnkpO2lmKGY8PXMmJmY+aSYmKGk9ZixuPXIueDxyLm5leHQueD9yOnIubmV4dCxmPT09cykpcmV0dXJuIG59cj1yLm5leHR9d2hpbGUociE9PXQpO2lmKCFuKXJldHVybiBudWxsO3ZhciB1PW4sbD1uLngscD1uLnkseD0xLzAsYTtyPW47ZG8gcz49ci54JiZyLng+PWwmJnMhPT1yLngmJlUobzxwP3M6aSxvLGwscCxvPHA/aTpzLG8sci54LHIueSkmJihhPU1hdGguYWJzKG8tci55KS8ocy1yLngpLFcocixlKSYmKGE8eHx8YT09PXgmJihyLng+bi54fHxyLng9PT1uLngmJndlKG4scikpKSYmKG49cix4PWEpKSxyPXIubmV4dDt3aGlsZShyIT09dSk7cmV0dXJuIG59ZnVuY3Rpb24gd2UoZSx0KXtyZXR1cm4gVihlLnByZXYsZSx0LnByZXYpPDAmJlYodC5uZXh0LGUsZS5uZXh0KTwwfWZ1bmN0aW9uIGdlKGUsdCxyLHMpe3ZhciBvPWU7ZG8gby56PT09MCYmKG8uej1QKG8ueCxvLnksdCxyLHMpKSxvLnByZXZaPW8ucHJldixvLm5leHRaPW8ubmV4dCxvPW8ubmV4dDt3aGlsZShvIT09ZSk7by5wcmV2Wi5uZXh0Wj1udWxsLG8ucHJldlo9bnVsbCxGZShvKX1mdW5jdGlvbiBGZShlKXt2YXIgdCxyLHMsbyxpLG4sZix1LGw9MTtkb3tmb3Iocj1lLGU9bnVsbCxpPW51bGwsbj0wO3I7KXtmb3IobisrLHM9cixmPTAsdD0wO3Q8bCYmKGYrKyxzPXMubmV4dFosISFzKTt0KyspO2Zvcih1PWw7Zj4wfHx1PjAmJnM7KWYhPT0wJiYodT09PTB8fCFzfHxyLno8PXMueik/KG89cixyPXIubmV4dFosZi0tKToobz1zLHM9cy5uZXh0Wix1LS0pLGk/aS5uZXh0Wj1vOmU9byxvLnByZXZaPWksaT1vO3I9c31pLm5leHRaPW51bGwsbCo9Mn13aGlsZShuPjEpO3JldHVybiBlfWZ1bmN0aW9uIFAoZSx0LHIscyxvKXtyZXR1cm4gZT0oZS1yKSpvfDAsdD0odC1zKSpvfDAsZT0oZXxlPDw4KSYxNjcxMTkzNSxlPShlfGU8PDQpJjI1MjY0NTEzNSxlPShlfGU8PDIpJjg1ODk5MzQ1OSxlPShlfGU8PDEpJjE0MzE2NTU3NjUsdD0odHx0PDw4KSYxNjcxMTkzNSx0PSh0fHQ8PDQpJjI1MjY0NTEzNSx0PSh0fHQ8PDIpJjg1ODk5MzQ1OSx0PSh0fHQ8PDEpJjE0MzE2NTU3NjUsZXx0PDwxfWZ1bmN0aW9uIE1lKGUpe3ZhciB0PWUscj1lO2RvKHQueDxyLnh8fHQueD09PXIueCYmdC55PHIueSkmJihyPXQpLHQ9dC5uZXh0O3doaWxlKHQhPT1lKTtyZXR1cm4gcn1mdW5jdGlvbiBVKGUsdCxyLHMsbyxpLG4sZil7cmV0dXJuKG8tbikqKHQtZik+PShlLW4pKihpLWYpJiYoZS1uKSoocy1mKT49KHItbikqKHQtZikmJihyLW4pKihpLWYpPj0oby1uKSoocy1mKX1mdW5jdGlvbiBtZShlLHQpe3JldHVybiBlLm5leHQuaSE9PXQuaSYmZS5wcmV2LmkhPT10LmkmJiFWZShlLHQpJiYoVyhlLHQpJiZXKHQsZSkmJkFlKGUsdCkmJihWKGUucHJldixlLHQucHJldil8fFYoZSx0LnByZXYsdCkpfHwkKGUsdCkmJlYoZS5wcmV2LGUsZS5uZXh0KT4wJiZWKHQucHJldix0LHQubmV4dCk+MCl9ZnVuY3Rpb24gVihlLHQscil7cmV0dXJuKHQueS1lLnkpKihyLngtdC54KS0odC54LWUueCkqKHIueS10LnkpfWZ1bmN0aW9uICQoZSx0KXtyZXR1cm4gZS54PT09dC54JiZlLnk9PT10Lnl9ZnVuY3Rpb24gbmUoZSx0LHIscyl7dmFyIG89SihWKGUsdCxyKSksaT1KKFYoZSx0LHMpKSxuPUooVihyLHMsZSkpLGY9SihWKHIscyx0KSk7cmV0dXJuISEobyE9PWkmJm4hPT1mfHxvPT09MCYmSShlLHIsdCl8fGk9PT0wJiZJKGUscyx0KXx8bj09PTAmJkkocixlLHMpfHxmPT09MCYmSShyLHQscykpfWZ1bmN0aW9uIEkoZSx0LHIpe3JldHVybiB0Lng8PU1hdGgubWF4KGUueCxyLngpJiZ0Lng+PU1hdGgubWluKGUueCxyLngpJiZ0Lnk8PU1hdGgubWF4KGUueSxyLnkpJiZ0Lnk+PU1hdGgubWluKGUueSxyLnkpfWZ1bmN0aW9uIEooZSl7cmV0dXJuIGU+MD8xOmU8MD8tMTowfWZ1bmN0aW9uIFZlKGUsdCl7dmFyIHI9ZTtkb3tpZihyLmkhPT1lLmkmJnIubmV4dC5pIT09ZS5pJiZyLmkhPT10LmkmJnIubmV4dC5pIT09dC5pJiZuZShyLHIubmV4dCxlLHQpKXJldHVybiEwO3I9ci5uZXh0fXdoaWxlKHIhPT1lKTtyZXR1cm4hMX1mdW5jdGlvbiBXKGUsdCl7cmV0dXJuIFYoZS5wcmV2LGUsZS5uZXh0KTwwP1YoZSx0LGUubmV4dCk+PTAmJlYoZSxlLnByZXYsdCk+PTA6VihlLHQsZS5wcmV2KTwwfHxWKGUsZS5uZXh0LHQpPDB9ZnVuY3Rpb24gQWUoZSx0KXt2YXIgcj1lLHM9ITEsbz0oZS54K3QueCkvMixpPShlLnkrdC55KS8yO2RvIHIueT5pIT1yLm5leHQueT5pJiZyLm5leHQueSE9PXIueSYmbzwoci5uZXh0Lngtci54KSooaS1yLnkpLyhyLm5leHQueS1yLnkpK3IueCYmKHM9IXMpLHI9ci5uZXh0O3doaWxlKHIhPT1lKTtyZXR1cm4gc31mdW5jdGlvbiBzZShlLHQpe3ZhciByPW5ldyBxKGUuaSxlLngsZS55KSxzPW5ldyBxKHQuaSx0LngsdC55KSxvPWUubmV4dCxpPXQucHJldjtyZXR1cm4gZS5uZXh0PXQsdC5wcmV2PWUsci5uZXh0PW8sby5wcmV2PXIscy5uZXh0PXIsci5wcmV2PXMsaS5uZXh0PXMscy5wcmV2PWksc31mdW5jdGlvbiBpZShlLHQscixzKXt2YXIgbz1uZXcgcShlLHQscik7cmV0dXJuIHM/KG8ubmV4dD1zLm5leHQsby5wcmV2PXMscy5uZXh0LnByZXY9byxzLm5leHQ9byk6KG8ucHJldj1vLG8ubmV4dD1vKSxvfWZ1bmN0aW9uIEsoZSl7ZS5uZXh0LnByZXY9ZS5wcmV2LGUucHJldi5uZXh0PWUubmV4dCxlLnByZXZaJiYoZS5wcmV2Wi5uZXh0Wj1lLm5leHRaKSxlLm5leHRaJiYoZS5uZXh0Wi5wcmV2Wj1lLnByZXZaKX1mdW5jdGlvbiBxKGUsdCxyKXt0aGlzLmk9ZSx0aGlzLng9dCx0aGlzLnk9cix0aGlzLnByZXY9bnVsbCx0aGlzLm5leHQ9bnVsbCx0aGlzLno9MCx0aGlzLnByZXZaPW51bGwsdGhpcy5uZXh0Wj1udWxsLHRoaXMuc3RlaW5lcj0hMX1YLmRldmlhdGlvbj1mdW5jdGlvbihlLHQscixzKXt2YXIgbz10JiZ0Lmxlbmd0aCxpPW8/dFswXSpyOmUubGVuZ3RoLG49TWF0aC5hYnMoZWUoZSwwLGkscikpO2lmKG8pZm9yKHZhciBmPTAsdT10Lmxlbmd0aDtmPHU7ZisrKXt2YXIgbD10W2ZdKnIscD1mPHUtMT90W2YrMV0qcjplLmxlbmd0aDtuLT1NYXRoLmFicyhlZShlLGwscCxyKSl9dmFyIHg9MDtmb3IoZj0wO2Y8cy5sZW5ndGg7Zis9Myl7dmFyIGE9c1tmXSpyLHY9c1tmKzFdKnIsYz1zW2YrMl0qcjt4Kz1NYXRoLmFicygoZVthXS1lW2NdKSooZVt2KzFdLWVbYSsxXSktKGVbYV0tZVt2XSkqKGVbYysxXS1lW2ErMV0pKX1yZXR1cm4gbj09PTAmJng9PT0wPzA6TWF0aC5hYnMoKHgtbikvbil9O2Z1bmN0aW9uIGVlKGUsdCxyLHMpe2Zvcih2YXIgbz0wLGk9dCxuPXItcztpPHI7aSs9cylvKz0oZVtuXS1lW2ldKSooZVtpKzFdK2VbbisxXSksbj1pO3JldHVybiBvfVguZmxhdHRlbj1mdW5jdGlvbihlKXtmb3IodmFyIHQ9ZVswXVswXS5sZW5ndGgscj17dmVydGljZXM6W10saG9sZXM6W10sZGltZW5zaW9uczp0fSxzPTAsbz0wO288ZS5sZW5ndGg7bysrKXtmb3IodmFyIGk9MDtpPGVbb10ubGVuZ3RoO2krKylmb3IodmFyIG49MDtuPHQ7bisrKXIudmVydGljZXMucHVzaChlW29dW2ldW25dKTtvPjAmJihzKz1lW28tMV0ubGVuZ3RoLHIuaG9sZXMucHVzaChzKSl9cmV0dXJuIHJ9O3ZhciBaZT1iLmV4cG9ydHMsX2U9bGUoWmUpO2Z1bmN0aW9uIFooZSx0KXt0aGlzLng9ZSx0aGlzLnk9dH1aLnByb3RvdHlwZS5pc1plcm89ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy54PT09MCYmdGhpcy55PT09MH0sWi5wcm90b3R5cGUuYWRkPWZ1bmN0aW9uKGUpe2NvbnN0IHQ9dGhpcy54K2UueCxyPXRoaXMueStlLnk7cmV0dXJuIG5ldyBaKHQscil9LFoucHJvdG90eXBlLnN1Yj1mdW5jdGlvbihlKXtjb25zdCB0PXRoaXMueC1lLngscj10aGlzLnktZS55O3JldHVybiBuZXcgWih0LHIpfSxaLnByb3RvdHlwZS5zZWxmQWRkPWZ1bmN0aW9uKGUpe3RoaXMueCs9ZS54LHRoaXMueSs9ZS55fSxaLnByb3RvdHlwZS5zZWxmU3ViPWZ1bmN0aW9uKGUpe3RoaXMueC09ZS54LHRoaXMueS09ZS55fSxaLnByb3RvdHlwZS5kaXN0YW5jZT1mdW5jdGlvbihlKXtyZXR1cm4gTWF0aC5zcXJ0KCh0aGlzLngtZS54KSoodGhpcy54LWUueCkrKHRoaXMueS1lLnkpKih0aGlzLnktZS55KSl9LFoucHJvdG90eXBlLnN1Yj1mdW5jdGlvbihlKXtjb25zdCB0PXRoaXMueC1lLngscj10aGlzLnktZS55O3JldHVybiBuZXcgWih0LHIpfSxaLnByb3RvdHlwZS5tdT1mdW5jdGlvbihlKXtjb25zdCB0PXRoaXMueCplLHI9dGhpcy55KmU7cmV0dXJuIG5ldyBaKHQscil9LFoucHJvdG90eXBlLm5vcm1hbGl6ZT1mdW5jdGlvbigpe2NvbnN0IGU9TWF0aC5zcXJ0KHRoaXMueCp0aGlzLngrdGhpcy55KnRoaXMueSksdD10aGlzLngvZSxyPXRoaXMueS9lO3JldHVybiBuZXcgWih0LHIpfSxaLnByb3RvdHlwZS5kb3Q9ZnVuY3Rpb24oZSl7cmV0dXJuIHRoaXMueCplLngrdGhpcy55KmUueX0sWi5wcm90b3R5cGUuZXF1YWw9ZnVuY3Rpb24oZSl7cmV0dXJuIHRoaXMueD09PWUueCYmdGhpcy55PT09ZS55fTt2YXIgUT17fTtRLnJlYWQ9ZnVuY3Rpb24oZSx0LHIscyxvKXt2YXIgaSxuLGY9byo4LXMtMSx1PSgxPDxmKS0xLGw9dT4+MSxwPS03LHg9cj9vLTE6MCxhPXI/LTE6MSx2PWVbdCt4XTtmb3IoeCs9YSxpPXYmKDE8PC1wKS0xLHY+Pj0tcCxwKz1mO3A+MDtpPWkqMjU2K2VbdCt4XSx4Kz1hLHAtPTgpO2ZvcihuPWkmKDE8PC1wKS0xLGk+Pj0tcCxwKz1zO3A+MDtuPW4qMjU2K2VbdCt4XSx4Kz1hLHAtPTgpO2lmKGk9PT0wKWk9MS1sO2Vsc2V7aWYoaT09PXUpcmV0dXJuIG4/TmFOOih2Py0xOjEpKigxLzApO249bitNYXRoLnBvdygyLHMpLGk9aS1sfXJldHVybih2Py0xOjEpKm4qTWF0aC5wb3coMixpLXMpfSxRLndyaXRlPWZ1bmN0aW9uKGUsdCxyLHMsbyxpKXt2YXIgbixmLHUsbD1pKjgtby0xLHA9KDE8PGwpLTEseD1wPj4xLGE9bz09PTIzP01hdGgucG93KDIsLTI0KS1NYXRoLnBvdygyLC03Nyk6MCx2PXM/MDppLTEsYz1zPzE6LTEsTT10PDB8fHQ9PT0wJiYxL3Q8MD8xOjA7Zm9yKHQ9TWF0aC5hYnModCksaXNOYU4odCl8fHQ9PT0xLzA/KGY9aXNOYU4odCk/MTowLG49cCk6KG49TWF0aC5mbG9vcihNYXRoLmxvZyh0KS9NYXRoLkxOMiksdCoodT1NYXRoLnBvdygyLC1uKSk8MSYmKG4tLSx1Kj0yKSxuK3g+PTE/dCs9YS91OnQrPWEqTWF0aC5wb3coMiwxLXgpLHQqdT49MiYmKG4rKyx1Lz0yKSxuK3g+PXA/KGY9MCxuPXApOm4reD49MT8oZj0odCp1LTEpKk1hdGgucG93KDIsbyksbj1uK3gpOihmPXQqTWF0aC5wb3coMix4LTEpKk1hdGgucG93KDIsbyksbj0wKSk7bz49ODtlW3Irdl09ZiYyNTUsdis9YyxmLz0yNTYsby09OCk7Zm9yKG49bjw8b3xmLGwrPW87bD4wO2Vbcit2XT1uJjI1NSx2Kz1jLG4vPTI1NixsLT04KTtlW3Irdi1jXXw9TSoxMjh9O2Z1bmN0aW9uIEMoZSl7dGhpcy5idWY9QXJyYXlCdWZmZXIuaXNWaWV3JiZBcnJheUJ1ZmZlci5pc1ZpZXcoZSk/ZTpuZXcgVWludDhBcnJheShlfHwwKSx0aGlzLnBvcz0wLHRoaXMudHlwZT0wLHRoaXMubGVuZ3RoPXRoaXMuYnVmLmxlbmd0aH1DLlZhcmludD0wLEMuRml4ZWQ2ND0xLEMuQnl0ZXM9MixDLkZpeGVkMzI9NTt2YXIgVGU9MTIsb2U9dHlwZW9mIFRleHREZWNvZGVyPiJ1Ij9udWxsOm5ldyBUZXh0RGVjb2RlcigidXRmOCIpO0MucHJvdG90eXBlPXtkZXN0cm95OmZ1bmN0aW9uKCl7dGhpcy5idWY9bnVsbH0scmVhZEZpZWxkczpmdW5jdGlvbihlLHQscil7Zm9yKHI9cnx8dGhpcy5sZW5ndGg7dGhpcy5wb3M8cjspe3ZhciBzPXRoaXMucmVhZFZhcmludCgpLG89cz4+MyxpPXRoaXMucG9zO3RoaXMudHlwZT1zJjcsZShvLHQsdGhpcyksdGhpcy5wb3M9PT1pJiZ0aGlzLnNraXAocyl9cmV0dXJuIHR9LHJlYWRNZXNzYWdlOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIHRoaXMucmVhZEZpZWxkcyhlLHQsdGhpcy5yZWFkVmFyaW50KCkrdGhpcy5wb3MpfSxyZWFkRmxvYXQ6ZnVuY3Rpb24oKXt2YXIgZT1RLnJlYWQodGhpcy5idWYsdGhpcy5wb3MsITAsMjMsNCk7cmV0dXJuIHRoaXMucG9zKz00LGV9LHJlYWRWYXJpbnQ6ZnVuY3Rpb24oZSl7dmFyIHQ9dGhpcy5idWYscixzO3JldHVybiBzPXRbdGhpcy5wb3MrK10scj1zJjEyNyxzPDEyOHx8KHM9dFt0aGlzLnBvcysrXSxyfD0ocyYxMjcpPDw3LHM8MTI4KXx8KHM9dFt0aGlzLnBvcysrXSxyfD0ocyYxMjcpPDwxNCxzPDEyOCl8fChzPXRbdGhpcy5wb3MrK10scnw9KHMmMTI3KTw8MjEsczwxMjgpP3I6KHM9dFt0aGlzLnBvc10scnw9KHMmMTUpPDwyOCxDZShyLGUsdGhpcykpfSxyZWFkVmFyaW50NjQ6ZnVuY3Rpb24oKXtyZXR1cm4gdGhpcy5yZWFkVmFyaW50KCEwKX0scmVhZFNWYXJpbnQ6ZnVuY3Rpb24oKXt2YXIgZT10aGlzLnJlYWRWYXJpbnQoKTtyZXR1cm4gZSUyPT09MT8oZSsxKS8tMjplLzJ9LHJlYWREb3VibGU6ZnVuY3Rpb24oKXt2YXIgZT1RLnJlYWQodGhpcy5idWYsdGhpcy5wb3MsITAsNTIsOCk7cmV0dXJuIHRoaXMucG9zKz04LGV9LHJlYWRTdHJpbmc6ZnVuY3Rpb24oKXt2YXIgZT10aGlzLnJlYWRWYXJpbnQoKSt0aGlzLnBvcyx0PXRoaXMucG9zO3JldHVybiB0aGlzLnBvcz1lLGUtdD49VGUmJm9lP05lKHRoaXMuYnVmLHQsZSk6a2UodGhpcy5idWYsdCxlKX0scmVhZEJ5dGVzOmZ1bmN0aW9uKCl7dmFyIGU9dGhpcy5yZWFkVmFyaW50KCkrdGhpcy5wb3MsdD10aGlzLmJ1Zi5zdWJhcnJheSh0aGlzLnBvcyxlKTtyZXR1cm4gdGhpcy5wb3M9ZSx0fSxza2lwOmZ1bmN0aW9uKGUpe3ZhciB0PWUmNztpZih0PT09Qy5WYXJpbnQpZm9yKDt0aGlzLmJ1Zlt0aGlzLnBvcysrXT4xMjc7KWNvbnNvbGUubG9nKHQpO2Vsc2UgaWYodD09PUMuQnl0ZXMpdGhpcy5wb3M9dGhpcy5yZWFkVmFyaW50KCkrdGhpcy5wb3M7ZWxzZSBpZih0PT09Qy5GaXhlZDMyKXRoaXMucG9zKz00O2Vsc2UgaWYodD09PUMuRml4ZWQ2NCl0aGlzLnBvcys9ODtlbHNlIHRocm93IG5ldyBFcnJvcigiVW5pbXBsZW1lbnRlZCB0eXBlOiAiK3QpfX07ZnVuY3Rpb24gQ2UoZSx0LHIpe3ZhciBzPXIuYnVmLG8saTtpZihpPXNbci5wb3MrK10sbz0oaSYxMTIpPj40LGk8MTI4fHwoaT1zW3IucG9zKytdLG98PShpJjEyNyk8PDMsaTwxMjgpfHwoaT1zW3IucG9zKytdLG98PShpJjEyNyk8PDEwLGk8MTI4KXx8KGk9c1tyLnBvcysrXSxvfD0oaSYxMjcpPDwxNyxpPDEyOCl8fChpPXNbci5wb3MrK10sb3w9KGkmMTI3KTw8MjQsaTwxMjgpfHwoaT1zW3IucG9zKytdLG98PShpJjEpPDwzMSxpPDEyOCkpcmV0dXJuIEcoZSxvLHQpO3Rocm93IG5ldyBFcnJvcigiRXhwZWN0ZWQgdmFyaW50IG5vdCBtb3JlIHRoYW4gMTAgYnl0ZXMiKX1mdW5jdGlvbiBHKGUsdCxyKXtyZXR1cm4gcj90KjQyOTQ5NjcyOTYrKGU+Pj4wKToodD4+PjApKjQyOTQ5NjcyOTYrKGU+Pj4wKX1mdW5jdGlvbiBrZShlLHQscil7Zm9yKHZhciBzPSIiLG89dDtvPHI7KXt2YXIgaT1lW29dLG49bnVsbCxmPWk+MjM5PzQ6aT4yMjM/MzppPjE5MT8yOjE7aWYobytmPnIpYnJlYWs7dmFyIHUsbCxwO2Y9PT0xP2k8MTI4JiYobj1pKTpmPT09Mj8odT1lW28rMV0sKHUmMTkyKT09PTEyOCYmKG49KGkmMzEpPDw2fHUmNjMsbjw9MTI3JiYobj1udWxsKSkpOmY9PT0zPyh1PWVbbysxXSxsPWVbbysyXSwodSYxOTIpPT09MTI4JiYobCYxOTIpPT09MTI4JiYobj0oaSYxNSk8PDEyfCh1JjYzKTw8NnxsJjYzLChuPD0yMDQ3fHxuPj01NTI5NiYmbjw9NTczNDMpJiYobj1udWxsKSkpOmY9PT00JiYodT1lW28rMV0sbD1lW28rMl0scD1lW28rM10sKHUmMTkyKT09PTEyOCYmKGwmMTkyKT09PTEyOCYmKHAmMTkyKT09PTEyOCYmKG49KGkmMTUpPDwxOHwodSY2Myk8PDEyfChsJjYzKTw8NnxwJjYzLChuPD02NTUzNXx8bj49MTExNDExMikmJihuPW51bGwpKSksbj09PW51bGw/KG49NjU1MzMsZj0xKTpuPjY1NTM1JiYobi09NjU1MzYscys9U3RyaW5nLmZyb21DaGFyQ29kZShuPj4+MTAmMTAyM3w1NTI5Niksbj01NjMyMHxuJjEwMjMpLHMrPVN0cmluZy5mcm9tQ2hhckNvZGUobiksbys9Zn1yZXR1cm4gc31mdW5jdGlvbiBOZShlLHQscil7cmV0dXJuIG9lLmRlY29kZShlLnN1YmFycmF5KHQscikpfWZ1bmN0aW9uIHRlKGUsdCxyLHMsbyl7dGhpcy5wcm9wZXJ0aWVzPXt9LHRoaXMuZXh0ZW50PXIsdGhpcy50eXBlPTAsdGhpcy5fcGJmPWUsdGhpcy5fZ2VvbWV0cnk9LTEsdGhpcy5fa2V5cz1zLHRoaXMuX3ZhbHVlcz1vLGUucmVhZEZpZWxkcyhCZSx0aGlzLHQpfWZ1bmN0aW9uIEJlKGUsdCxyKXtlPT0xP3QuaWQ9ci5yZWFkVmFyaW50KCk6ZT09Mj9EZShyLHQpOmU9PTM/dC50eXBlPXIucmVhZFZhcmludCgpOmU9PTQmJih0Ll9nZW9tZXRyeT1yLnBvcyl9ZnVuY3Rpb24gRGUoZSx0KXtmb3IodmFyIHI9ZS5yZWFkVmFyaW50KCkrZS5wb3M7ZS5wb3M8cjspe3ZhciBzPXQuX2tleXNbZS5yZWFkVmFyaW50KCldLG89dC5fdmFsdWVzW2UucmVhZFZhcmludCgpXTt0LnByb3BlcnRpZXNbc109b319dGUudHlwZXM9WyJVbmtub3duIiwiUG9pbnQiLCJMaW5lU3RyaW5nIiwiUG9seWdvbiJdLHRlLnByb3RvdHlwZS5sb2FkR2VvbWV0cnk9ZnVuY3Rpb24oKXt2YXIgZT10aGlzLl9wYmY7ZS5wb3M9dGhpcy5fZ2VvbWV0cnk7dmFyIHQ9ZS5yZWFkVmFyaW50KCkrZS5wb3Mscj0xLHM9MCxvPTAsaT0wLG49bmV3IEFycmF5KDEwMCksZjtsZXQgdT0wLGw9ITEscD1udWxsLHg9bnVsbCxhPTA7Zm9yKDtlLnBvczx0Oyl7aWYoczw9MCl7dmFyIHY9ZS5yZWFkVmFyaW50KCk7cj12Jjcscz12Pj4zfWlmKHMtLSxyPT09MSlvKz1lLnJlYWRTVmFyaW50KCksaSs9ZS5yZWFkU1ZhcmludCgpLGw9ITAsYT0wLHA9byx4PWksZiYmKG5bdV09Zix1KyspO2Vsc2UgaWYocj09PTIpe2lmKG8rPWUucmVhZFNWYXJpbnQoKSxpKz1lLnJlYWRTVmFyaW50KCksbCl7bGV0IGM9cysyO2Y9bmV3IEFycmF5KGMpLGZbMF09e3g6cCx5Onh9LGw9ITF9YSs9MSxmW2FdPXt4Om8seTppfX1lbHNlIGlmKHI9PT03KXthKz0xO3RyeXtmW2FdPWZbMF19Y2F0Y2goYyl7Y29uc29sZS5sb2coYyl9fWVsc2UgdGhyb3cgbmV3IEVycm9yKCJ1bmtub3duIGNvbW1hbmQgIityKX1yZXR1cm4gZj8oblt1XT1mLHUrKyxuLmxlbmd0aD11KTpwIT1udWxsJiZ4IT1udWxsJiYhblswXSYmKHU9MSxuPXt4OnAseTp4fSksbn07ZnVuY3Rpb24gZmUoZSx0KXt0aGlzLnZlcnNpb249MSx0aGlzLm5hbWU9bnVsbCx0aGlzLmV4dGVudD00MDk2LHRoaXMubGVuZ3RoPTAsdGhpcy5fcGJmPWUsdGhpcy5fa2V5cz1bXSx0aGlzLl92YWx1ZXM9W10sdGhpcy5fZmVhdHVyZXM9W10sZS5yZWFkRmllbGRzKEVlLHRoaXMsdCksdGhpcy5sZW5ndGg9dGhpcy5fZmVhdHVyZXMubGVuZ3RofWZ1bmN0aW9uIEVlKGUsdCxyKXtlPT09MTU/dC52ZXJzaW9uPXIucmVhZFZhcmludCgpOmU9PT0xP3QubmFtZT1yLnJlYWRTdHJpbmcoKTplPT09NT90LmV4dGVudD1yLnJlYWRWYXJpbnQoKTplPT09Mj90Ll9mZWF0dXJlcy5wdXNoKHIucG9zKTplPT09Mz90Ll9rZXlzLnB1c2goci5yZWFkU3RyaW5nKCkpOmU9PT00JiZ0Ll92YWx1ZXMucHVzaCh6ZShyKSl9ZnVuY3Rpb24gemUoZSl7Zm9yKHZhciB0PW51bGwscj1lLnJlYWRWYXJpbnQoKStlLnBvcztlLnBvczxyOyl7dmFyIHM9ZS5yZWFkVmFyaW50KCk+PjM7dD1zPT09MT9lLnJlYWRTdHJpbmcoKTpzPT09Mj9lLnJlYWRGbG9hdCgpOnM9PT0zP2UucmVhZERvdWJsZSgpOnM9PT00P2UucmVhZFZhcmludDY0KCk6cz09PTU/ZS5yZWFkVmFyaW50KCk6cz09PTY/ZS5yZWFkU1ZhcmludCgpOnM9PT03P2UucmVhZEJvb2xlYW4oKTpudWxsfXJldHVybiB0fWZlLnByb3RvdHlwZS5mZWF0dXJlPWZ1bmN0aW9uKGUpe2lmKGU8MHx8ZT49dGhpcy5fZmVhdHVyZXMubGVuZ3RoKXRocm93IG5ldyBFcnJvcigiZmVhdHVyZSBpbmRleCBvdXQgb2YgYm91bmRzIik7dGhpcy5fcGJmLnBvcz10aGlzLl9mZWF0dXJlc1tlXTt2YXIgdD10aGlzLl9wYmYucmVhZFZhcmludCgpK3RoaXMuX3BiZi5wb3M7cmV0dXJuIG5ldyB0ZSh0aGlzLl9wYmYsdCx0aGlzLmV4dGVudCx0aGlzLl9rZXlzLHRoaXMuX3ZhbHVlcyl9O2Z1bmN0aW9uIE9lKGUsdCl7dGhpcy5sYXllcnM9ZS5yZWFkRmllbGRzKFNlLHt9LHQpfWZ1bmN0aW9uIFNlKGUsdCxyKXtpZihlPT09Myl7dmFyIHM9bmV3IGZlKHIsci5yZWFkVmFyaW50KCkrci5wb3MpO3MubGVuZ3RoJiYodFtzLm5hbWVdPXMpfX1sZXQgWT1udWxsO2Z1bmN0aW9uIFVlKGUpe2xldCB0PW5ldyBYTUxIdHRwUmVxdWVzdDt0LnJlc3BvbnNlVHlwZT0iYXJyYXlidWZmZXIiLHQub25sb2FkPWZ1bmN0aW9uKCl7bGV0IHI7aWYodC5zdGF0dXMhPTIwMCl7aWYoInNlYSJpbiBZKXtjb25zdCBvPXt9O2xldCBpPVtdO2NvbnN0IG49bmV3IEZsb2F0MzJBcnJheShbMCwwLDAsNDA5Niw0MDk2LDQwOTYsNDA5NiwwXSksZj1uZXcgVWludDE2QXJyYXkoWzAsMSwyLDAsMiwzXSk7aS5wdXNoKG4uYnVmZmVyLGYuYnVmZmVyKSxvLnNlYT17cG9zaXRpb25zOm4uYnVmZmVyLGluZGljZXM6Zi5idWZmZXIsZHJhd051bTo2fSxzZWxmLnBvc3RNZXNzYWdlKHttc2c6InN1Y2Nlc3MiLGRhdGE6ZSxvdXREYXRhOm99LGkpO3JldHVybn1zZWxmLnBvc3RNZXNzYWdlKHttc2c6ImZhaWxlZCIsZGF0YTplfSk7cmV0dXJufWxldCBzPW5ldyBVaW50OEFycmF5KHQucmVzcG9uc2UpO3RyeXtyPW5ldyBPZShuZXcgQyhzKSl9Y2F0Y2h7c2VsZi5wb3N0TWVzc2FnZSh7bXNnOiJmYWlsZWQiLGRhdGE6ZX0pO3JldHVybn1pZihPYmplY3Qua2V5cyhyLmxheWVycykubGVuZ3RoPT0wKXtzZWxmLnBvc3RNZXNzYWdlKHttc2c6ImZhaWxlZCIsZGF0YTplfSk7cmV0dXJufUdlKGUscil9LHQub25lcnJvcj1mdW5jdGlvbigpe3NlbGYucG9zdE1lc3NhZ2Uoe21zZzoiZmFpbGVkIixkYXRhOmV9KX0sdC5vcGVuKCJHRVQiLGUudXJsLCEwKSx0LnNlbmQoKX1mdW5jdGlvbiBHZShlLHQpe2NvbnN0IHI9e307bGV0IHM9W107aWYoInNlYSJpbiBZKXtjb25zdCBvPW5ldyBGbG9hdDMyQXJyYXkoWzAsMCwwLDQwOTYsNDA5Niw0MDk2LDQwOTYsMF0pLGk9bmV3IFVpbnQxNkFycmF5KFswLDEsMiwwLDIsM10pO3MucHVzaChvLmJ1ZmZlcixpLmJ1ZmZlciksci5zZWE9e3Bvc2l0aW9uczpvLmJ1ZmZlcixpbmRpY2VzOmkuYnVmZmVyLGRyYXdOdW06Nn19Zm9yKGxldCBvIGluIHQubGF5ZXJzKXtjb25zdCBpPVlbb107aWYoaSl7aWYoaS50eXBlPT0ibGluZXMiKXtsZXQgbj1bXSxmPVtdLHU9dC5sYXllcnNbb107Y29uc3QgbD11Lmxlbmd0aDtmb3IobGV0IHg9MDt4PGw7eCsrKXUuZmVhdHVyZSh4KS5sb2FkR2VvbWV0cnkoKS5mb3JFYWNoKGM9Pntjb25zdCBNPW4ubGVuZ3RoLzI7Zm9yKGxldCBnPTA7ZzxjLmxlbmd0aC0xO2crKyluLnB1c2goY1tnXS54LGNbZ10ueSksZi5wdXNoKE0rZyxNK2crMSk7bi5wdXNoKGNbYy5sZW5ndGgtMV0ueCxjW2MubGVuZ3RoLTFdLnkpfSk7Y29uc3QgcD1mLmxlbmd0aDtuPW5ldyBGbG9hdDMyQXJyYXkobiksZj1uZXcgVWludDE2QXJyYXkoZikscy5wdXNoKG4uYnVmZmVyLGYuYnVmZmVyKSxyW29dPXtwb3NpdGlvbnM6bi5idWZmZXIsaW5kaWNlczpmLmJ1ZmZlcixkcmF3TnVtOnB9fWVsc2UgaWYoaS50eXBlPT0icG9seWdvbiIpe2xldCBuPVtdLGY9W10sdT10LmxheWVyc1tvXTtjb25zdCBsPXUubGVuZ3RoO2ZvcihsZXQgeD0wO3g8bDt4Kyspe2xldCB2PXUuZmVhdHVyZSh4KS5sb2FkR2VvbWV0cnkoKTtmb3IobGV0IGM9MDtjPHYubGVuZ3RoO2MrKyl7Y29uc3QgTT12W2NdLGc9bmV3IEFycmF5KE0ubGVuZ3RoKjIpO2ZvcihsZXQgZD0wO2Q8TS5sZW5ndGg7ZCsrKWdbZCoyXT1NW2RdLngsZ1tkKjIrMV09TVtkXS55O2NvbnN0IG09bi5sZW5ndGgvMixUPV9lKGcpO2ZvcihsZXQgZD0wO2Q8VC5sZW5ndGg7ZCsrKVRbZF0rPW07QXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkobixnKSxBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShmLFQpfX1jb25zdCBwPWYubGVuZ3RoO249bmV3IEZsb2F0MzJBcnJheShuKSxmPW5ldyBVaW50MTZBcnJheShmKSxzLnB1c2gobi5idWZmZXIsZi5idWZmZXIpLHJbb109e3Bvc2l0aW9uczpuLmJ1ZmZlcixpbmRpY2VzOmYuYnVmZmVyLGRyYXdOdW06cH19ZWxzZSBpZihpLnR5cGU9PSJsaW5lTWl0ZXIiKXtsZXQgbj1bXSxmPVtdLHU9W10sbD1bXSxwPXQubGF5ZXJzW29dO2NvbnN0IHg9cC5sZW5ndGg7Zm9yKGxldCBtPTA7bTx4O20rKylwLmZlYXR1cmUobSkubG9hZEdlb21ldHJ5KCkuZm9yRWFjaCh3PT57Y29uc3QgTj13Lmxlbmd0aCxfPW4ubGVuZ3RoLEE9bmV3IEFycmF5KE4pO24ubGVuZ3RoPV8rTioyO2ZvcihsZXQgeT0wO3k8Tjt5KyspbltfK3kqMl09d1t5XS54LG5bXyt5KjIrMV09d1t5XS55LEFbeV09bmV3IFood1t5XS54LHdbeV0ueSk7Y29uc3QgRj1mLmxlbmd0aD09MD8wOmZbZi5sZW5ndGgtMV0rMTtsZXQgaD1mLmxlbmd0aDtmb3IobGV0IHk9MDt5PEEubGVuZ3RoO3krKyl5PT0wP0FbMF0uZXF1YWwoQVtBLmxlbmd0aC0xXSk/KGYucHVzaChGLEYpLHUucHVzaCg3LDYpLGgrPTIpOihmLnB1c2goRixGKSx1LnB1c2goMCwxKSxoKz0yKTp5PT1BLmxlbmd0aC0xP0FbMF0uZXF1YWwoQVtBLmxlbmd0aC0xXSk/KHUucHVzaCg1LDQpLGYucHVzaChGK3ksRit5KSxsLnB1c2goaC0yLGgtMSxoKzEsaC0xLGgsaCsxKSk6KHUucHVzaCgyLDMpLGYucHVzaChGK3ksRit5KSxsLnB1c2goaC0yLGgtMSxoLGgtMSxoLGgrMSkpOih1LnB1c2goNSw0KSxmLnB1c2goRit5LEYreSksbC5wdXNoKGgtMixoLTEsaCsxLGgtMSxoLGgrMSksaCs9MixmLnB1c2goRit5LEYreSksdS5wdXNoKDcsNiksaCs9Mil9KTtjb25zdCBhPWwubGVuZ3RoLHY9bi5sZW5ndGgsYz1uW3YtMl0sTT1uW3YtMV07bGV0IGc9TWF0aC5jZWlsKE1hdGguc3FydCh2LzIpKTtmb3IobGV0IG09MDttPDEwMDttKyspaWYoTWF0aC5wb3coMixtKT5nKXtnPU1hdGgucG93KDIsbSk7YnJlYWt9bltnKmcqMi0yXT1jLG5bZypnKjItMV09TSxmPW5ldyBGbG9hdDMyQXJyYXkoZiksdT1uZXcgRmxvYXQzMkFycmF5KHUpLGw9bmV3IFVpbnQxNkFycmF5KGwpLHMucHVzaChmLmJ1ZmZlcix1LmJ1ZmZlcixsLmJ1ZmZlcikscltvXT17cHhzOm4scG9zaXRpb25zOmYuYnVmZmVyLHR5cGU6dS5idWZmZXIsaW5kaWNlczpsLmJ1ZmZlcixkcmF3TnVtOmEsdGV4dHVyZVNpemU6Z319ZWxzZSBpZihpLnR5cGU9PSJsaW5lc1JvdW5kIil7bGV0IG49W10sZj1bXSx1PVtdLGw9W10scD10LmxheWVyc1tvXTtjb25zdCB4PXAubGVuZ3RoO2ZvcihsZXQgbT0wO208eDttKyspcC5mZWF0dXJlKG0pLmxvYWRHZW9tZXRyeSgpLmZvckVhY2godz0+e2NvbnN0IE49dy5sZW5ndGgsXz1uLmxlbmd0aCxBPW5ldyBBcnJheShOKTtuLmxlbmd0aD1fK04qMixuZXcgQXJyYXk7Zm9yKGxldCB5PTA7eTxOO3krKyluW18reSoyXT13W3ldLngsbltfK3kqMisxXT13W3ldLnksQVt5XT1uZXcgWih3W3ldLngsd1t5XS55KTtjb25zdCBGPWYubGVuZ3RoPT0wPzA6ZltmLmxlbmd0aC0xXSsxO2xldCBoPWYubGVuZ3RoO2ZvcihsZXQgeT0wO3k8QS5sZW5ndGg7eSsrKXk9PTA/QVswXS5lcXVhbChBW0EubGVuZ3RoLTFdKT8odS5wdXNoKDQpLGYucHVzaChGK3kpLGgrPTEsdS5wdXNoKDEwLDcsNSksbC5wdXNoKGgtMSxoLGgrMSksbC5wdXNoKGgsaCsxLGgrMiksZi5wdXNoKEYreSxGK3ksRit5KSxoKz0zLHUucHVzaCg4LDYpLGwucHVzaChoLTMsaC0xLGgpLGwucHVzaChoLTMsaCxoKzEpLGYucHVzaChGK3ksRit5KSxoKz0yLHUucHVzaCgwLDEpLGYucHVzaChGK3ksRit5KSxoKz0yKTooZi5wdXNoKEYsRiksdS5wdXNoKDAsMSksaCs9Mik6eT09QS5sZW5ndGgtMT8odS5wdXNoKDIsMyksZi5wdXNoKEYreSxGK3kpLGwucHVzaChoLTIsaC0xLGgsaC0xLGgsaCsxKSk6KHUucHVzaCgyLDMsNCwxMCw3LDUsOCw2LDAsMSksZi5wdXNoKEYreSxGK3ksRit5LEYreSxGK3ksRit5LEYreSxGK3ksRit5LEYreSksbC5wdXNoKGgtMixoLTEsaCxoLTEsaCxoKzEsaCsyLGgrMyxoKzQsaCszLGgrNCxoKzUsaCszLGgrNSxoKzYsaCszLGgrNixoKzcpLGgrPTEwKX0pO2NvbnN0IGE9bC5sZW5ndGgsdj1uLmxlbmd0aCxjPW5bdi0yXSxNPW5bdi0xXSxnPU1hdGguY2VpbChNYXRoLnNxcnQodi8yKSk7bi5sZW5ndGg9ZypnKjQsbltnKmcqNC0yXT1jLG5bZypnKjQtMV09TSxmPW5ldyBGbG9hdDMyQXJyYXkoZiksdT1uZXcgRmxvYXQzMkFycmF5KHUpLGw9bmV3IFVpbnQxNkFycmF5KGwpLHMucHVzaChmLmJ1ZmZlcix1LmJ1ZmZlcixsLmJ1ZmZlcikscltvXT17cHhzOm4scG9zaXRpb25zOmYuYnVmZmVyLHR5cGU6dS5idWZmZXIsaW5kaWNlczpsLmJ1ZmZlcixkcmF3TnVtOmEsdGV4dHVyZVNpemU6Z319ZWxzZSBpZihpLnR5cGU9PSJ0ZXh0Iil7Y29uc3Qgbj1lLnJ0bztsZXQgZj1pLmZvbnRTaXplfHwxODtmPWYqbjtsZXQgdT1pLnJhZGl1c3x8Mztjb25zdCBsPWkuZm9udEZhbWlseXx8IkFyaWFsIixwPWkuZm9udFdlaWdodHx8IiI7bGV0IHg9bmV3IE9mZnNjcmVlbkNhbnZhcyhmLGYpLGE9eC5nZXRDb250ZXh0KCIyZCIpO2EuZm9udD1wKyIgIitmKyJweCAiK2w7bGV0IHY9e307Y29uc3QgYz1bXTtsZXQgTT0wLGc9W10sbT1bXSxUPVtdLGQ9dC5sYXllcnNbb107Y29uc3Qgdz1kLmxlbmd0aDtmb3IobGV0IEI9MDtCPHc7QisrKXtsZXQgRD1kLmZlYXR1cmUoQiksRT1ELmxvYWRHZW9tZXRyeSgpO20ucHVzaChFLngsRS55KTtjb25zdCBrPUQucHJvcGVydGllc1tpLnRleHRLZXldO2lmKCFrKWNvbnRpbnVlO2NvbnN0IEg9ay5sZW5ndGg7bGV0IFI9aS5zaG93UG9pbnQ/dSsyOi1hLm1lYXN1cmVUZXh0KGspLndpZHRoLzI7Y29uc3QgTz1rLmNoYXJBdCgwKTtPIGluIHZ8fCh2W09dPU0sYy5wdXNoKE8pLE0rKyksUis9YS5tZWFzdXJlVGV4dChPKS53aWR0aC8yLGcucHVzaChFLngsRS55KSxULnB1c2godltPXSxSKTtmb3IobGV0IFM9MTtTPEg7UysrKXtjb25zdCBIZT1rLmNoYXJBdChTLTEpLEw9ay5jaGFyQXQoUyk7TCBpbiB2fHwodltMXT1NLGMucHVzaChMKSxNKyspLFIrPWEubWVhc3VyZVRleHQoTCkud2lkdGgvMithLm1lYXN1cmVUZXh0KEhlKS53aWR0aC8yKzEsZy5wdXNoKEUueCxFLnkpLFQucHVzaCh2W0xdLFIpfX1jb25zdCBOPWMubGVuZ3RoLF89TWF0aC5jZWlsKE1hdGguc3FydChOKSk7Zj1mO2xldCBBPTEwO3gud2lkdGg9XypmK18qQSx4LmhlaWdodD1fKmYrXypBLGEuZm9udD1wKyIgIitmKyJweCAiK2wsYS5maWxsU3R5bGU9aS5mb250Q29sb3IsaS5zaGFkb3dDb2xvciYmKGEuc2hhZG93Q29sb3I9aS5zaGFkb3dDb2xvciksaS5zaGFkb3dCbHVyJiYoYS5zaGFkb3dCbHVyPWkuc2hhZG93Qmx1ciksaS5zaGFkb3dPZmZzZXRYJiYoYS5zaGFkb3dPZmZzZXRYPWkuc2hhZG93T2Zmc2V0WCksaS5zaGFkb3dPZmZzZXRZJiYoYS5zaGFkb3dPZmZzZXRZPWkuc2hhZG93T2Zmc2V0WSk7Y29uc3QgRj1pLnNoYWRvd1dlaWdodHx8MTtmb3IobGV0IEI9MDtCPF87QisrKWZvcihsZXQgRD0wO0Q8XztEKyspe2NvbnN0IEU9RCpfK0Isaz1jW0VdO2lmKCFrKWNvbnRpbnVlO2NvbnN0IEg9YS5tZWFzdXJlVGV4dChrKSxSPUIqZitmLzItSC53aWR0aC8yK0IqQStBLzIsTz1EKmYrZi8yKyhILmZvbnRCb3VuZGluZ0JveEFzY2VudCtILmZvbnRCb3VuZGluZ0JveERlc2NlbnQtSC5oYW5naW5nQmFzZWxpbmUvMikvMitEKkErQS8yO2ZvcihsZXQgUz0wO1M8RjtTKyspYS5maWxsVGV4dChrLFIsTyl9Y29uc3QgaD1nLmxlbmd0aC8yLHk9bS5sZW5ndGgvMjttPW5ldyBGbG9hdDMyQXJyYXkobSksZz1uZXcgRmxvYXQzMkFycmF5KGcpLFQ9bmV3IEZsb2F0MzJBcnJheShUKTtjb25zdCB1ZT14LnRyYW5zZmVyVG9JbWFnZUJpdG1hcCgpO3MucHVzaChnLmJ1ZmZlcixULmJ1ZmZlcix1ZSxtLmJ1ZmZlcikscltvXT17ZHJhd051bTpoLHBvc2l0aW9uczpnLmJ1ZmZlcixzdHM6VC5idWZmZXIsaW1hZ2VCaXRtYXA6dWUsbjpfLHBvaW50czptLmJ1ZmZlcixwb2ludE51bTp5fX19fXNlbGYucG9zdE1lc3NhZ2Uoe21zZzoic3VjY2VzcyIsZGF0YTplLG91dERhdGE6cn0scyl9c2VsZi5vbm1lc3NhZ2U9ZnVuY3Rpb24oZSl7aWYoZS5kYXRhLnN0eWxlKXtZPWUuZGF0YS5zdHlsZTtyZXR1cm59VWUoZS5kYXRhKX19KSgpOwo=",Ct=typeof window<"u"&&window.Blob&&new Blob([atob(zt)],{type:"text/javascript;charset=utf-8"});function Xt(t){let e;try{if(e=Ct&&(window.URL||window.webkitURL).createObjectURL(Ct),!e)throw"";const i=new Worker(e,{name:null==t?void 0:t.name});return i.addEventListener("error",(()=>{(window.URL||window.webkitURL).revokeObjectURL(e)})),i}catch{return new Worker("data:application/javascript;base64,"+zt,{name:null==t?void 0:t.name})}finally{e&&(window.URL||window.webkitURL).revokeObjectURL(e)}}class Gt extends _{constructor(t){super(t)}init(t){this.index=t.index||m,this.tileSize=t.tileSize||1024,this.offset=Math.log2(this.tileSize/256),this.url=t.url,this.style=t.style,this.cachedTiles={},this.loadingTiles={},this.programs={},this.loadingNum=0,this.drawSize=[-1,-1],this.initWorker()}initWorker(){this.worker=new Xt,this.worker.postMessage({style:this.style}),this.worker.onmessage=function(t){this.cacheTile(t.data)}.bind(this)}cacheTile(t){const e=t.data,i=e.zoom+"_"+e.i+"_"+e.j;if(delete this.loadingTiles[i],this.loadingNum--,"failed"==t.msg)return void(this.cachedTiles[i]={z:e.zoom,x:e.i,y:e.j,outData:null,loaded:!1});const o=this.gl;o.bindVertexArray(this.vao);for(let e in t.outData){const i=this.style[e].type,n=t.outData[e],s=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,s),o.bufferData(o.ARRAY_BUFFER,n.positions,o.STATIC_DRAW);const r=o.createBuffer();if(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,r),o.bufferData(o.ELEMENT_ARRAY_BUFFER,n.indices,o.STATIC_DRAW),n.vbuffer=s,n.indexbuffer=r,delete n.positions,delete n.indices,"lineMiter"==i){const t=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,t),o.bufferData(o.ARRAY_BUFFER,n.type,o.STATIC_DRAW),n.typebuffer=t,delete n.type;const e=o.createTexture();o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,0),o.bindTexture(o.TEXTURE_2D,e),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE);const i=n.textureSize,s=new Float32Array(n.pxs);o.texImage2D(o.TEXTURE_2D,0,o.RG32F,i,i,0,o.RG,o.FLOAT,s),n.texture=e,delete n.pxs}}this.cachedTiles[i]={z:e.zoom,x:e.i,y:e.j,outData:t.outData,loaded:!0}}initSelfDraw(t){this.gl=t.contexts[this.target].context;for(let t in this.style){const e=this.style[t].type;"lines"!=e&&"polygon"!=e||"normal"in this.programs?"lineMiter"==e&&!("lineMiter"in this.programs)&&(this.programs.lineMiter=b(this.gl,"#version 300 es\nin float type;\nin float vertices;\nuniform vec3 coord;\nuniform vec2 drawsize;\nuniform float offset;\nuniform float rto;\nuniform float texnum;\nuniform sampler2D u_t;\nuniform float u_width;\nout float vx;\nvec2 computeXy(float num){\n    float x = mod(num,texnum)/(texnum-1.0);\n    float y = floor(num/texnum)/(texnum-1.0);\n    return vec2(x,y);\n}\nvoid main(){\n    float width = u_width;\n    vec2 dir;\n    vec2 normal;\n    vec2 xpos = computeXy(vertices);\n    float nextnum = vertices + 1.0;\n    float presnum = vertices - 1.0;\n    if(presnum<0.0){\n        presnum = texnum*texnum;\n    }\n    if(nextnum > texnum*texnum){\n        nextnum = 1.0;\n    }\n    vec2 xnext = computeXy(nextnum);\n    vec2 xpres = computeXy(presnum);\n    vec2 position = texture(u_t,xpos).rg;\n    vec2 pres = texture(u_t,xpres).rg;\n    vec2 next = texture(u_t,xnext).rg;\n    float scaleNum = offset/16.0 ;\n    // vec2 point = a_position*scaleNum*coord.z;\n    position = position * scaleNum*coord.z+coord.xy;\n    pres = pres * scaleNum*coord.z+coord.xy;\n    next = next *scaleNum*coord.z+coord.xy;\n    position = position * rto;\n    pres = pres * rto;\n    next = next * rto;\n    vec2 xy = vec2(0.0);\n    if(type==0.0){\n        dir = next - position;\n        dir = normalize(dir);\n        normal = vec2(-dir.y,dir.x);\n        xy = position - normal*width;\n        vx = 0.0;\n    }else if(type == 1.0){\n        dir = next - position;\n        dir = normalize(dir);\n        normal = vec2(-dir.y,dir.x);\n        xy = position + normal*width;\n        vx = 1.0;\n    }else if(type == 2.0){\n        dir = position - pres;\n        dir = normalize(dir);\n        normal = vec2(-dir.y,dir.x);\n        xy = position - normal*width;\n        vx = 0.0;\n    }else if(type == 3.0){\n        dir = position - pres;\n        dir = normalize(dir);\n        normal = vec2(-dir.y,dir.x);\n        xy = position + normal*width;\n        vx = 1.0;\n    }else if(type==4.0){\n        float isleft = (position.x - pres.x) * (next.y - pres.y) - (position.y - pres.y) * (next.x - pres.x);\n        if(isleft > 0.0){\n            vec2 v1 = position - pres;\n            v1 = normalize(v1);\n            vec2 v2 = position - next;\n            v2 = normalize(v2);\n            vec2 v = v1+v2;\n            v = normalize(v);\n            vec2 normal = vec2(-v1.y,v1.x);\n            float c = dot(normal,v);\n            if(abs(c)<=0.3){\n                c = 1.0;\n            }\n            xy = position - width/c * v;\n        }else{\n            dir = position - pres;\n            dir = normalize(dir);\n            normal = vec2(-dir.y,dir.x);\n            xy = position - normal*width;\n        }\n        \n    }else if(type == 5.0){\n        float isleft = (position.x - pres.x) * (next.y - pres.y) - (position.y - pres.y) * (next.x - pres.x);\n        if(isleft > 0.0){\n            dir = position - pres;\n            dir = normalize(dir);\n            normal = vec2(-dir.y,dir.x);\n            xy = normal*width;\n            xy = position + xy;\n            vx = 1.0;\n        }else{\n            vec2 v1 = position - pres;\n            v1 = normalize(v1);\n            vec2 v2 = position - next;\n            v2 = normalize(v2);\n            vec2 v = v1+v2;\n            v = normalize(v);\n            vec2 normal = vec2(-v1.y,v1.x);\n            float c = dot(normal,v);\n            if(abs(c)<=0.3){\n                c = 1.0;\n            }\n            xy = position + width/c * v;\n        }        \n    }else if(type == 6.0){\n        float isleft = (position.x - pres.x) * (next.y - pres.y) - (position.y - pres.y) * (next.x - pres.x);\n        if(isleft > 0.0){\n            dir = next - position;\n            dir = normalize(dir);\n            normal = vec2(-dir.y,dir.x);\n            xy = position + normal*width;\n            vx = 1.0;\n        }else{\n            vec2 v1 = position - pres;\n            v1 = normalize(v1);\n            vec2 v2 = position - next;\n            v2 = normalize(v2);\n            vec2 v = v1+v2;\n            v = normalize(v);\n            vec2 normal = vec2(-v1.y,v1.x);\n            float c = dot(normal,v);\n            if(abs(c)<=0.3){\n                c = 1.0;\n            }\n            xy = position + width/c * v;\n        }\n        \n    }else if(type == 7.0){\n        float isleft = (position.x - pres.x) * (next.y - pres.y) - (position.y - pres.y) * (next.x - pres.x);\n        if(isleft > 0.0){\n            vec2 v1 = position - pres;\n            v1 = normalize(v1);\n            vec2 v2 = position - next;\n            v2 = normalize(v2);\n            vec2 v = v1+v2;\n            v = normalize(v);\n            vec2 normal = vec2(-v1.y,v1.x);\n            float c = dot(normal,v);\n            if(abs(c)<=0.3){\n                c = 1.0;\n            }\n            xy = position - width/c * v;\n        }else{\n            dir = next - position;\n            dir = normalize(dir);\n            normal = vec2(-dir.y,dir.x);\n            xy = normal*width;\n            xy = position.xy - xy.xy;\n            vx = 1.0;\n        }\n    }\n    xy = xy/drawsize;\n    xy.y = 1.0 - 2.0*xy.y;\n    xy.x = 2.0*xy.x - 1.0;\n    gl_Position = vec4(xy,0.0,1.0);\n}","#version 300 es\nprecision highp float;\n// in float vx;\n// uniform float u_width;\nuniform vec4 color;\nout vec4 outColor;\nvoid main(){\n    outColor = color;\n}")):this.programs.normal=b(this.gl,"#version 300 es\n        in vec2 a_position;\n        uniform vec3 coord;\n        uniform vec2 drawsize;\n        uniform float offset;\n        uniform float rto;\n        void main(){\n            float scaleNum = offset/16.0 ;\n            vec2 point = a_position*scaleNum*coord.z;\n            point = point +coord.xy;\n            point = point * rto;\n            point /= drawsize;\n            point.x = 2.0*point.x - 1.0;\n            point.y = 1.0 - 2.0*point.y;\n            gl_Position = vec4(point,0.1,1.0);\n        }","#version 300 es\n        precision highp float;\n        out vec4 outColor;\n        uniform vec4 color;\n        void main(){\n            outColor = color;\n        }\n        ")}this.initVao(this.gl)}initVao(t){if("normal"in this.programs){const e=this.programs.normal,i=t.createVertexArray();t.bindVertexArray(i),e.vao=i,e.a_position=t.getAttribLocation(e,"a_position"),t.enableVertexAttribArray(e.a_position),e.coord=t.getUniformLocation(e,"coord"),e.u_color=t.getUniformLocation(e,"color"),t.useProgram(e);const o=t.getUniformLocation(e,"offset");t.uniform1f(o,this.tileSize/256)}if("lineMiter"in this.programs){const e=this.programs.lineMiter,i=t.createVertexArray();t.bindVertexArray(i),e.vao=i,e.a_position=t.getAttribLocation(e,"vertices"),t.enableVertexAttribArray(e.a_position),e.a_type=t.getAttribLocation(e,"type"),t.enableVertexAttribArray(e.a_type),e.coord=t.getUniformLocation(e,"coord"),e.u_color=t.getUniformLocation(e,"color"),e.texnum=t.getUniformLocation(e,"texnum"),e.u_t=t.getUniformLocation(e,"u_t"),t.useProgram(e),e.u_width=t.getUniformLocation(e,"u_width");const o=t.getUniformLocation(e,"offset");t.uniform1f(o,this.tileSize/256)}}computeTiles(t,e,i,o){const n=this.tileSize;return{xminNum:Math.floor(t/n),xmaxNum:Math.floor(e/n),yminNum:Math.floor(i/n),ymaxNum:Math.floor(o/n)}}tileUrlFunction(t,e,i){let o=this.url;return o=o.replace("{z}",t-this.offset),o=o.replace("{x}",e),o=o.replace("{y}",i),o}getToCachedTiles(t,e){const i=[],o=t.xminNum+(t.xmaxNum-t.xminNum)/2,n=t.yminNum+(t.ymaxNum-t.yminNum)/2,s=Math.pow(2,e);for(let o=t.xminNum;o<=t.xmaxNum;o++){const n=o>=0?o%s:(o%s+s)%s;for(let s=t.yminNum;s<=t.ymaxNum;s++)i.push({zoom:e,i:o,ti:n,j:s})}return i.sort((function(t,e){return(t.i-o)*(t.i-o)+(t.j-n)*(t.j-n)-((e.i-o)*(e.i-o)+(e.j-n)*(e.j-n))})),i}clearCachedTiles(t,e,i,o,n,s,r){const a=this.cachedTiles,h=this.style,l=t,c={};for(let t in a){const r=a[t];if(Math.abs(r.z-l)>2){const e=a[t].outData;for(let t in e)i.deleteBuffer(e[t].vbuffer),i.deleteBuffer(e[t].indexbuffer),e[t].typebuffer&&(i.deleteBuffer(e[t].typebuffer),i.deleteTexture(e[t].texture));delete a[t];continue}if(!r.loaded)continue;const u=r.z;if(u===l)continue;const m=Math.pow(2,l-u);let d=!0;if(m>1){const t=r.x*m,i=r.x*m+m,o=r.y*m,n=r.y*m+m;for(let s=t;s<i;s++)if(!(s<e.xminNum||s>e.xmaxNum))for(let t=o;t<n;t++)if(!(t<e.yminNum||t>e.ymaxNum)){if(m>2){if(u+1+"_"+Math.floor(s/2)+"_"+Math.floor(t/2)in a)continue}l+"_"+s+"_"+t in a||(d=!1)}}else{if(m<.5){if(u-1+"_"+Math.floor(r.x/2)+"_"+Math.floor(r.y/2)in a)continue}l+"_"+Math.floor(r.x*m)+"_"+Math.floor(r.y*m)in a||(d=!1)}if(d){if(Math.abs(r.z-l)>1){const e=a[t].outData;for(let t in e)i.deleteBuffer(e[t].vbuffer),i.deleteBuffer(e[t].indexbuffer),e[t].typebuffer&&(i.deleteBuffer(e[t].typebuffer),i.deleteTexture(e[t].texture));delete a[t]}}else{const t=r.x*s*m-o.xmin,e=r.y*s*m-o.ymin,i=r.outData;for(let o in i){const s=h[o].type;i[o].style=h[o],i[o].x=t,i[o].y=e,i[o].zoomScale=n*m,s in c?c[s].push(i[o]):c[s]=[i[o]]}}}this.drawTiles(c,i,r)}drawTiles(t,e,i){let o=!1;if((this.drawSize[0]!=i[0]||this.drawSize[1]!=i[1])&&(this.drawSize=i,o=!0),this.rto!=devicePixelRatio&&(this.rto=devicePixelRatio,o=!0),"normal"in this.programs){const n=this.programs.normal;if(e.bindVertexArray(n.vao),e.useProgram(n),o){const t=e.getUniformLocation(n,"drawsize");e.uniform2f(t,i[0],i[1]);const o=e.getUniformLocation(n,"rto");e.uniform1f(o,devicePixelRatio)}const s="polygon"in t?t.polygon:[];let r=e.TRIANGLES;for(let t=0;t<s.length;t++){const i=s[t],o=i.style.color;i.drawNum>0&&(e.uniform3f(n.coord,i.x,i.y,i.zoomScale),e.uniform4f(n.u_color,...o),e.bindBuffer(e.ARRAY_BUFFER,i.vbuffer),e.vertexAttribPointer(n.a_position,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.indexbuffer),e.drawElements(r,i.drawNum,e.UNSIGNED_SHORT,0))}const a="lines"in t?t.lines:[];r=e.LINES;for(let t=0;t<a.length;t++){const i=a[t],o=i.style.color;i.drawNum>0&&(e.uniform3f(n.coord,i.x,i.y,i.zoomScale),e.uniform4f(n.u_color,...o),e.bindBuffer(e.ARRAY_BUFFER,i.vbuffer),e.vertexAttribPointer(n.a_position,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.indexbuffer),e.drawElements(r,i.drawNum,e.UNSIGNED_SHORT,0))}}if("lineMiter"in this.programs){const n=this.programs.lineMiter;if(e.bindVertexArray(n.vao),e.useProgram(n),o){const t=e.getUniformLocation(n,"drawsize");e.uniform2f(t,i[0],i[1]);const o=e.getUniformLocation(n,"rto");e.uniform1f(o,devicePixelRatio)}const s="lineMiter"in t?t.lineMiter:[];for(let t=0;t<s.length;t++){const i=s[t],o=i.style,r=o.color,a=o.lineWidth/2||1;i.drawNum>0&&(e.uniform3f(n.coord,i.x,i.y,i.zoomScale),e.uniform4f(n.u_color,...r),e.uniform1f(n.texnum,i.textureSize),e.uniform1f(n.u_width,a),e.bindBuffer(e.ARRAY_BUFFER,i.vbuffer),e.vertexAttribPointer(n.a_position,1,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,i.typebuffer),e.vertexAttribPointer(n.a_type,1,e.FLOAT,!1,0,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,i.texture),e.uniform1i(n.u_t,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.indexbuffer),e.drawElements(e.TRIANGLES,i.drawNum,e.UNSIGNED_SHORT,0))}}}changeStyle(t){this.style=t,this.worker.postMessage({style:this.style}),this.cachedTiles={},this.layerChangeEvent()}render(t){const e=t.zoomBounds,i=t.pxbounds,o=this.tileSize*t.zoomScale,n=t.drawSize,s=this.style,r=this.computeTiles(e.xmin,e.xmax,e.ymin,e.ymax),a=this.cachedTiles,h=this.loadingTiles,l=Math.round(t.zoom),c=t.context;const u=this.getToCachedTiles(r,l);let m=!1;t.firstDraw&&(c.clear(c.COLOR_BUFFER_BIT),t.firstDraw=!1),this.clearCachedTiles(l,r,c,i,t.zoomScale,o,n);const d={};for(let e=0;e<u.length;e++){let n=u[e],r=n.zoom+"_"+n.i+"_"+n.j;if(r in a){if(a[r].loaded){const e=a[r],n=e.x*o-i.xmin,h=e.y*o-i.ymin,l=e.outData;for(let e in l){const i=s[e].type;l[e].style=s[e],l[e].x=n,l[e].y=h,l[e].zoomScale=t.zoomScale,i in d?d[i].push(l[e]):d[i]=[l[e]]}}}else{if(!(r in h)&&this.loadingNum<3){h[r]=!0;const t=this.tileUrlFunction(n.zoom,n.ti,n.j);n.url=t,this.worker.postMessage(n),this.loadingNum++}m=!0}}this.drawTiles(d,c,n),m&&(t.drawNext=m)}destroy(t){if(!this.target)return void console.warn("图层不存在，无法删除");this.worker.terminate();const e=t.contexts[this.target].context,i=this.cachedTiles;for(let t in i){const o=i[t].outData;for(let t in o)e.deleteBuffer(o[t].vbuffer),e.deleteBuffer(o[t].indexbuffer),o[t].typebuffer&&(e.deleteBuffer(o[t].typebuffer),e.deleteTexture(o[t].texture))}for(let t in this.programs){const i=this.programs[t];e.deleteVertexArray(i.vao),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i)}super.destroy(t)}}class Ft extends Gt{constructor(t){super(t)}initSelfDraw(t){this.vao||(this.createDraw(t.contexts[this.target].context,"#version 300 es\n        in vec4 a_position;\n        in vec2 sts;\n        uniform vec3 coord;\n        uniform vec2 drawsize;\n        uniform float offset;\n        out float v_sts;\n        uniform vec3 n;\n        uniform float rto;\n        void main(){\n            float scaleNum = offset/16.0 ;\n            vec2 point = a_position.xy*scaleNum*coord.z;\n            point = point +coord.xy;\n            if(n.y==0.){\n                point.x+=sts.y;\n                v_sts = sts.x;\n            }\n            point = point * rto;\n            point /= drawsize;\n            point.x = 2.0*point.x - 1.0;\n            point.y = 1.0 - 2.0*point.y;\n            gl_Position = vec4(point,0.0,1.0);\n            gl_PointSize = n.z * rto;\n        }","#version 300 es\n        precision highp float;\n        out vec4 outColor;\n        in float v_sts;\n        uniform vec3 n;\n        uniform sampler2D u_img;\n        void main(){\n            // outColor = vec4(1.0,0,0,1.0);\n            if(n.y==0.){\n                vec2 xy = gl_PointCoord.xy/n.x;\n                float bb = mod(v_sts,n.x);\n                if(bb>=n.x){\n                    bb = 0.;\n                }\n                float cc = v_sts/n.x;\n                if(fract(cc)>0.999){\n                    cc = ceil(cc);\n                }else{\n                    cc = floor(cc);\n                }\n                xy.x += bb/n.x;\n                xy.y += cc/n.x;\n                outColor = texture(u_img,xy);\n                return;\n            }\n            outColor = texture(u_img,gl_PointCoord.xy);\n            // outColor = vec4(1.0,0.,0.,1.0);\n        }\n        "),this.gl=t.contexts[this.target].context)}cacheTile(t){const e=t.data,i=e.zoom+"_"+e.i+"_"+e.j;if(delete this.loadingTiles[i],this.loadingNum--,"failed"==t.msg)return void(this.cachedTiles[i]={z:e.zoom,x:e.i,y:e.j,outData:null,loaded:!1});const o=this.gl;for(let e in t.outData){const i=t.outData[e].imageBitmap,n=document.createElement("canvas");n.width=i.width,n.height=i.height,n.getContext("2d").drawImage(i,0,0);const s=L(o,n,0,!0,!1);t.outData[e].texture=s}this.cachedTiles[i]={z:e.zoom,x:e.i,y:e.j,outData:t.outData,loaded:!0}}initVao(t){let e=new Float32Array([-1,1,-1,-1,1,1,1,-1]),i=t.getAttribLocation(this.program,"a_position");var o=E(t,e);this.vbuffer=o;var n=R(t,i,2);this.vao=n,this.coord=t.getUniformLocation(this.program,"coord"),this.textureSize=t.getUniformLocation(this.program,"n"),this.texture=t.getUniformLocation(this.program,"textue"),t.useProgram(this.program);const s=t.getUniformLocation(this.program,"offset");t.uniform1f(s,this.tileSize/256);let r=t.getAttribLocation(this.program,"sts");o=E(t,e);this.stbuffer=o,t.enableVertexAttribArray(r),t.vertexAttribPointer(r,2,t.FLOAT,!1,0,0);const a=this.style;for(let e in a){const i=a[e];if(!i.showPoint)continue;let o=i.radius||3;const n=new OffscreenCanvas(2*o,2*o),s=n.getContext("2d");i.outLineWidth&&(s.beginPath(),s.fillStyle=i.outLineColor,s.arc(o,o,o,0,2*Math.PI,!1),s.fill(),o-=i.outLineWidth),s.beginPath(),s.arc(n.width/2,n.height/2,o,0,2*Math.PI,!1),s.fillStyle=i.pointColor,s.fill(),i.texture=L(t,n,0,!1,!1)}}clearCachedTiles(t,e,i,o,n,s){const r=this.cachedTiles,a=this.style,h=t;for(let t in r){const l=r[t];if(Math.abs(l.z-h)>2){const e=r[t].outData;for(let t in e)i.deleteTexture(e[t].texture);delete r[t];continue}if(!l.loaded)continue;const c=l.z;if(c===h)continue;const u=Math.pow(2,h-c);let m=!0;if(u>1){const t=l.x*u,i=l.x*u+u,o=l.y*u,n=l.y*u+u;for(let s=t;s<i;s++)if(!(s<e.xminNum||s>e.xmaxNum))for(let t=o;t<n;t++)if(!(t<e.yminNum||t>e.ymaxNum)){if(u>2){if(c+1+"_"+Math.floor(s/2)+"_"+Math.floor(t/2)in r)continue}h+"_"+s+"_"+t in r||(m=!1)}}else{if(u<.5){if(c-1+"_"+Math.floor(l.x/2)+"_"+Math.floor(l.y/2)in r)continue}h+"_"+Math.floor(l.x*u)+"_"+Math.floor(l.y*u)in r||(m=!1)}if(m){if(Math.abs(l.z-h)>1){const e=r[t].outData;for(let t in e)i.deleteTexture(e[t].texture);delete r[t]}}else{const t=l.x*s*u-o.xmin,e=l.y*s*u-o.ymin;i.uniform3f(this.coord,t,e,n*u);const r=l.outData;this.drawTile(r,a,i)}}}drawTile(t,e,i){for(let o in t){const n=t[o],s=e[o];let r=s.fontSize||18;if(r+=10,n.drawNum>0){if(i.uniform3f(this.textureSize,n.n,0,r),i.bindBuffer(i.ARRAY_BUFFER,this.vbuffer),i.bufferData(i.ARRAY_BUFFER,n.positions,i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.stbuffer),i.bufferData(i.ARRAY_BUFFER,n.sts,i.STATIC_DRAW),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,n.texture),i.uniform1i(this.texture,0),i.drawArrays(i.POINTS,0,n.drawNum),!s.showPoint)continue;const t=s.radius||3;i.uniform3f(this.textureSize,0,1,2*t),i.bindBuffer(i.ARRAY_BUFFER,this.vbuffer),i.bufferData(i.ARRAY_BUFFER,n.points,i.STATIC_DRAW),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,s.texture),i.uniform1i(this.texture,0),i.drawArrays(i.POINTS,0,n.pointNum)}}}render(t){const e=t.zoomBounds,i=t.pxbounds,o=this.tileSize*t.zoomScale,n=t.drawSize,s=this.style,r=this.computeTiles(e.xmin,e.xmax,e.ymin,e.ymax),a=this.cachedTiles,h=this.loadingTiles,l=Math.round(t.zoom),c=t.context;c.useProgram(this.program),c.bindVertexArray(this.vao);if(this.drawSize[0]!=n[0]||this.drawSize[1]!=n[1]){this.drawSize=n;const t=c.getUniformLocation(this.program,"drawsize");c.uniform2f(t,n[0],n[1])}if(this.rto!=devicePixelRatio){this.rto=devicePixelRatio;const t=c.getUniformLocation(this.program,"rto");c.uniform1f(t,devicePixelRatio)}const u=this.getToCachedTiles(r,l);let m=!1;t.firstDraw&&(c.clear(c.COLOR_BUFFER_BIT),t.firstDraw=!1),this.clearCachedTiles(l,r,c,i,t.zoomScale,o);for(let e=0;e<u.length;e++){let n=u[e],r=n.zoom+"_"+n.i+"_"+n.j;if(r in a){if(a[r].loaded){const e=a[r];let n=e.x*o-i.xmin;Math.abs(n-parseInt(n))<.02&&(n+=.02);let h=e.y*o-i.ymin;Math.abs(h-Math.round(h))<.02&&(h+=.02),c.uniform3f(this.coord,n,h,t.zoomScale);const l=e.outData;this.drawTile(l,s,c)}}else{if(!(r in h)&&this.loadingNum<3){h[r]=!0;const t=this.tileUrlFunction(n.zoom,n.ti,n.j);n.url=t,n.rto=devicePixelRatio,this.worker.postMessage(n),this.loadingNum++}m=!0}}m&&(t.drawNext=m)}destroy(t){if(!this.target)return void console.warn("图层不存在，无法删除");this.worker.terminate();const e=t.contexts[this.target].context;this.program;const i=this.cachedTiles;for(let t in i){const o=i[t].outData;for(let t in o)e.deleteTexture(o[t].texture)}for(let t in this.style)this.style[t].texture&&e.deleteTexture(this.style[t].texture);e.deleteBuffer(this.vbuffer),e.deleteBuffer(this.stbuffer),super.destroy(t)}}class It extends I{constructor(t){super(t)}setElement(t){if(this.imgSize=t.imgSize,t.source instanceof Element)this.elecontent.appendChild(t.source),this.setImgOptions(t.source);else{const e=new Image;this.elecontent.appendChild(e),e.onload=function(){this.setImgOptions(e)}.bind(this),e.src=t.source}}setImgOptions(t){this.imgSize?(t.width=this.imgSize[0],t.height=this.imgSize[1]):this.imgSize=[t.width,t.height],t.style.transform="translate(-50%,-50%)"}fireEvent(t){if(!this.id)return;const e=t.clientX,i=t.clientY;let o=n(this.position[0],this.position[1],this.zoom);o.selfSub({x:this.pxbounds.xmin,y:this.pxbounds.ymin});const s=this.imgSize;if(Math.abs(e-o.x)<=s[0]/2&&Math.abs(i-o.y)<=s[1]/2){const o={lat:this.position[0],lon:this.position[1],x:e,y:i};return this.fire(t.type,o),!(this.mouseIn||(this.fire("mouseover",t),this.mouseIn=!0,this.tooltip&&this.tooltip.setVisiable(!0),!this.events[t.type].stopPropagation))||void 0}return!(!this.mouseIn||(this.mouseIn=!1,this.fire("mouseout",t),this.tooltip&&this.tooltip.setVisiable(!1),!this.events[t.type].stopPropagation))}bindTooltip(t,e,i){this.tooltip=null,this.tooltip||(this.tooltip=new I({position:this.position,source:e,visiable:!1,index:i}).addTo(t),t.setLayerEvent("mousemove",this,this.setTooltipState,this))}setTooltipState(){}}const Dt=function(t){t&&t.useCros&&(this.useCros=t.useCros),this.loadingNum=0,this.loadedArr=[],this.stoped=!1};Dt.prototype.load=function(t,e){this.maxNum=e,this.loadedArr.length=0,this.loadId++,this.urls=t;for(let e=0;e<t.length;e++)this.loadOne()},Dt.prototype.loadOne=function(){if(this.loadingNum>=this.maxNum)return;if(0==this.urls.length)return void(0==this.loadingNum&&this.loadAll(this.loadedArr));if(this.stoped)return;this.loadingNum++;const t=this.urls.length-1,e=this.urls.pop(),i=new Image;this.useCros&&(i.crossOrigin="anonymous"),i.onload=function(){this.stoped||(this.loadedArr[t]=i,this.loadingNum--,this.loadOne())}.bind(this),i.onerror=function(){this.loadAll(!1),this.stop()}.bind(this),i.src=e},Dt.prototype.loadAll=function(){},Dt.prototype.stop=function(){this.stoped=!0,this.loadedArr.length=0};const Wt="#version 300 es\n#define arrayNum tihuan2\n#define arrayNum1 tihuan3\n#define PI 3.141592653589793238\n#define Rm 8495.19\n#ifdef GL_ES\nprecision highp float;\n#endif\n    in vec2 point;\n    uniform sampler2D u_Color;\n    uniform sampler2D u_Sampler;\n    uniform vec3 scale;\n    uniform vec2 vrange;\n    uniform float unum;\n    uniform bool insert;\n    uniform vec4 latlon;\n    uniform vec2 center;\n    uniform vec2 rs;\n    uniform float es[arrayNum];\n    uniform float height;\n    uniform float xscale;\n    vec3 latlngToJ(float latpt, float lonpt, float h){\n        float mpi = PI / 180.0;\n        float lonrad = center.y * mpi;\n        float latrad = center.x * mpi;\n        float x0 = lonpt * mpi;\n        float y0 = latpt * mpi;\n        float havLat = sin((latrad - y0) / 2.0);\n        float havLon = sin((lonrad - x0) / 2.0);\n        float a = havLat * havLat + cos(latrad) * cos(y0) * havLon * havLon;\n        float s1 = 1.5 * atan(sqrt(a) , sqrt(1.0 - a));\n        float s = 2.0 * atan(sqrt(a),sqrt(1.0 - a));\n        float y = sin(x0 - lonrad) * cos(latrad);\n        float x = cos(y0) * sin(latrad) - sin(y0) * cos(latrad) * cos(lonrad - x0);\n        \n        float aa = cos(y0) * sin(x0 - lonrad) / sin(s);\n        float bb = (sin(y0) - cos(s)*sin(latrad)) / sin(s) / cos(latrad);\n        float a1 = 0.0;\n        if (aa <= 0.93969 && aa >= -0.93969) {\n            a1 = asin(aa);\n            if (bb<=0.0) {\n                a1 = PI - a1;\n            }\n            else if (aa<=0.0 && bb>0.0) {\n                a1 = 2.0 * PI + a1;\n            }\n        }\n        else {\n            a1 = acos(bb);\n            if (lonrad >= x0) {\n                a1 = 2.0 * PI - a1;\n            }\n        }\n        float z0 = atan((cos(s1) - Rm / (h / 1000.0 + Rm)) , sin(s1));\n        float elev = z0 / mpi;\n        const int esnum = arrayNum1;\n        float zzz = -1.0;\n        for (int i = 0; i < esnum; i++) {\n            float s,e;\n            if(i==0){\n                s = es[i]/2.0;\n            }else{\n                s = es[i] - (es[i] - es[i-1])/2.0;\n            }\n            if(i==esnum-1){\n                e = es[i] + (es[i] - es[i-1])/2.0;\n            }else{\n                e = es[i] + (es[i+1] - es[i])/2.0;\n            }\n            if (elev > s && elev <= e) {\n                zzz = float(i);\n                elev = es[i];\n                break;\n            }\n        }\n        if (zzz == -1.0) {\n            discard;\n        }\n        float azi = a1 * 180.0 / PI;\n        float r = Rm/(1./tan(s * 0.75)-tan(elev/180.0*PI))/cos(elev / 180.0 * PI);\n        return vec3(r,azi, zzz);\n    }\n    float esToR(float s,float elev){\n        return Rm/(1./tan(s * 0.75)-tan(elev/180.0*PI))/cos(elev / 180.0 * PI);\n    }\n    vec4 texture3Dfrom2D(float x, float y, float zz){\n        y = zz/unum+y/unum;\n        return texture(u_Sampler, vec2(x,y));\n    }\n    out vec4 outColor;\n    void main(){\n        float stx = (point.x + 1.0) / 2.0;\n        stx = (stx - (1.0 - xscale)/2.0)/xscale;\n        if(stx<0. || stx>1.){\n            discard;\n        }\n        float sty = (point.y + 1.0) / 2.0;\n        // 计算出来经纬度\n        float lat = latlon.x + (latlon.y - latlon.x) * stx;\n        float lon = latlon.z + (latlon.w - latlon.z) * stx;\n        float h = sty * height;\n        // 根据经纬度计算出来大远距离，方位角，位于第几层仰角\n        vec3 rae = latlngToJ(lat, lon, h);\n        if(rae.x<rs.x ||rae.x > rs.y){\n            discard;\n        }\n        float a = (rae.x - rs.x)/(rs.y - rs.x);\n        \n        float b = 0.0;\n        if(rae.y<=359.5){\n           b = (rae.y+0.5)/360.0;\n        }else{\n           b = (360.0 - rae.y)/360.0;\n        }\n        vec4 color = texture3Dfrom2D(a, b, rae.z) * 255.0;\n       \n\n        float value = color.r / scale.r + color.g / scale.g + color.b / scale.b;\n        float cx = (value - vrange.x) / (vrange.y - vrange.x);\n        outColor = texture(u_Color, vec2(cx, 0.5));\n        if (cx < 0.0) {\n            outColor.a = 0.0;\n        }\n    }\n";class Bt{constructor(t){this.map=t.map,this.loadTxtColor=t.loadTxtColor,this.content=t.content,this.as=t.as,this.maxElevNum=t.maxElevNum,this.latst=t.latst,this.lonst=t.lonst,this.rmin=t.rmin,this.rmax=t.rmax,this.interval=t.interval,this.url=t.url,this.colors=t.colors,this.scale=t.scale,this.useCenter=t.useCenter,this.useDem=t.useDem,this.demUrl=t.demUrl,this.demscale=t.demscale,this.latmin=t.latmin,this.latmax=t.latmax,this.lonmin=t.lonmin,this.lonmax=t.lonmax,this.height=t.height,this.demColor=t.demColor,this.useCros=t.useCros,this.minShowDistance=t.minShowDistance||10,this.maxLoadNum=t.maxLoadNum||3,this.preserveDrawingBuffer=t.preserveDrawingBuffer,this.drawEnable=!("drawEnable"in t)||t.drawEnable,this.points=0,this.ready=!1,this.demReady=!1,!1 in t&&(this.insert=!0),this.init(),this.initContet(),this.initGl(),this.createTexture()}init(){this.infoDiv=document.createElement("div"),this.infoDiv.innerText="abcdefghtml",this.infoDiv.style.fontSize="18px",this.infoDiv.style.width="260px",this.infoDiv.style.position="relative",this.infoDiv.style.top="-10px",this.infoDiv.style.color=this.lineColor||"black",this.mapLayers=new X,this.mapLayers.addTo(this.map),this.setEvent()}initContet(){const t=this.content.clientWidth,e=this.content.clientHeight;this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.content.appendChild(this.canvas),this.loaddiv=document.createElement("div"),this.loaddiv.style.position="absolute",this.loaddiv.style.top=0,this.loaddiv.style.zIndex=1e3,this.loaddiv.style.height=e+"px",this.loaddiv.style.width=t+"px",this.loaddiv.innerText="数据加载中",this.content.appendChild(this.loaddiv),this.loaddiv.style.fontSize=this.loadTxtSize?this.loadTxtSize+"px":"30px",this.loaddiv.style.color=this.loadTxtColor?this.loadTxtColor:"black",this.loaddiv.style.fontWeight="bold",this.loaddiv.style.lineHeight=e+"px",this.loaddiv.style.textAlign="center"}resizeEvent(){const t=this.content.clientWidth,e=this.content.clientHeight;this.canvas.width=t,this.canvas.height=e,this.gl.viewport(0,0,t,e)}initGl(){let t,e=Wt.replace("tihuan2",String(this.maxElevNum));e=e.replace("tihuan3",String(this.maxElevNum-1)),t=this.preserveDrawingBuffer?this.canvas.getContext("webgl2",{preserveDrawingBuffer:!0}):this.canvas.getContext("webgl2"),t||console.log("init gl failed"),this.gl=t,t.clearColor(0,0,0,0),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA_SATURATE,t.ZERO);const i=b(t,"#version 300 es\nin vec4 a_Position;\nout vec2 point;\nvoid main(){        \n    gl_Position = a_Position;        \n    point = gl_Position.xy;\n}",e);i?(t.program=i,t.useProgram(i)):cydEvent.cydError("init gl failed");let o=new Float32Array([-1,1,-1,-1,1,1,1,-1]),n=t.getAttribLocation(t.program,"a_Position");var s=E(t,o);t.vbuffer=s;var r=R(t,n,2);if(t.vao=r,this.setProfileUniforms(),this.useDem){const e=b(t,"#version 300 es\nin vec4 a_Position;\nuniform sampler2D u_Dem;\nuniform vec4 demst;\nuniform float demscale;\nuniform float heighth;\nvoid main(){                     \n    float stx = (a_Position.x + 1.0)/2.0;                      \n    float demx = demst.x + (demst.z - demst.x)*stx;            \n    float demy = demst.y + (demst.w - demst.y)*stx;            \n    vec4 dems = texture( u_Dem, vec2(demx,demy) )*255.0*demscale/1000.0;      \n    float dem = dems.r + dems.g + dems.b + dems.a;    \n    float h = dem/heighth;    \n    gl_Position = a_Position;    \n    gl_Position.y = h*2.0 - 1.0;\n}","#version 300 es\n#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform vec4 demColor;\nout vec4 outColor;\nvoid main(){ \n    outColor = demColor;\n}"),i=this.canvas;if(e){t.demprogram=e,t.useProgram(e);let o=[],n=0;for(let t=0;t<i.width;t+=2){let e=t/i.width*2-1;o.push(e),o.push(0),n++}o=new Float32Array(o);let s=E(t,o);t.dembuffer=s,this.demnum=n;let r=t.getAttribLocation(t.demprogram,"a_Position");var a=R(t,r,2);t.demvao=a,this.setDemUniforms()}}}setProfileUniforms(){const t=this.gl;t.useProgram(t.program);const e=t.getUniformLocation(t.program,"center");t.uniform2f(e,this.latst,this.lonst);const i=t.getUniformLocation(t.program,"rs");t.uniform2f(i,this.rmin,this.rmax);const o=t.getUniformLocation(t.program,"unum");t.uniform1f(o,this.as.length);let n=t.getUniformLocation(t.program,"insert");t.uniform1f(n,this.insert);const s=t.getUniformLocation(t.program,"scale");t.uniform3f(s,this.scale.r,this.scale.g,this.scale.b);for(let e=0;e<this.maxElevNum;e++){let i=t.getUniformLocation(t.program,"es["+e+"]");e<this.as.length?t.uniform1fv(i,[this.as[e]]):e==this.as.length?t.uniform1fv(i,[this.as[e-1]+(this.as[e-1]-this.as[e-2])/2]):t.uniform1fv(i,[0])}this.profileHeight=t.getUniformLocation(t.program,"height"),this.u_latlon=t.getUniformLocation(t.program,"latlon"),this.u_xscale=t.getUniformLocation(t.program,"xscale")}setDemUniforms(){const t=this.gl;t.useProgram(t.demprogram);const e=t.getUniformLocation(t.demprogram,"demscale");t.uniform1f(e,this.demscale);const i=t.getUniformLocation(t.demprogram,"demColor");t.uniform4f(i,...this.demColor),this.demst=t.getUniformLocation(t.demprogram,"demst"),this.demh=t.getUniformLocation(t.demprogram,"heighth");const o=new Image;o.onload=function(){t.useProgram(t.demprogram);const e=t.getUniformLocation(t.demprogram,"u_Dem");this.demTexture=L(t,o,2,!1,!1),t.uniform1i(e,2),this.demReady=!0}.bind(this),o.src=this.demUrl}createTexture(){const t=this.gl;t.useProgram(t.program);const e=this.as.length,i=[];for(let t=0;t<e;t++)i.push(this.url+"_"+t+".png");this.loader=new Dt({useCros:this.useCros}),this.loader.loadAll=function(i){if(!i)return t.clear(this.gl.COLOR_BUFFER_BIT),void(this.loaddiv.innerText="数据加载失败");var o=document.createElement("canvas"),n=i[0].width,s=i[0].height;o.width=n,o.height=s*e;var r=o.getContext("2d");for(let t=0;t<e;t++)r.drawImage(i[t],0,t*s);if(this.destroyed)return;t.useProgram(t.program);const a=t.getUniformLocation(t.program,"u_Sampler");this.texture=L(t,o,0,!0,!1),t.uniform1i(a,0),this.ready=!0,this.content.removeChild(this.loaddiv),this.loader.stop(),this.loader=null}.bind(this),this.loader.load(i,this.maxLoadNum);const o=B(this.colors,0),n=t.getUniformLocation(t.program,"u_Color");this.colorTexture=L(t,o.canvas,1),t.uniform1i(n,1);const s=t.getUniformLocation(t.program,"vrange");t.uniform2f(s,o.vmin,o.vmax)}setEvent(){this.clickEvent=this.clickEvent.bind(this),this.mouseMoveEvent=this.mouseMoveEvent.bind(this),this.map.on("click",this.clickEvent)}clickEvent(t){this.drawEnable&&(2==this.points&&(this.points=0,this.mapLayers.clearLayers(),this.line=null),0==this.points?(this.useCenter?(this.startLat=this.latst,this.startLon=this.lonst):(this.startLat=t.latlon.lat,this.startLon=t.latlon.lon),new C({position:[this.startLat,this.startLon],point:!0,fillStyle:this.lineColor||"black",radius:5}).addTo(this.mapLayers),this.points=1,this.map.on("mousemove",this.mouseMoveEvent),this.draw()):1==this.points&&(this.endLat=t.latlon.lat,this.endLon=t.latlon.lon,new C({position:[this.endLat,this.endLon],point:!0,fillStyle:"black",radius:5}).addTo(this.mapLayers),this.points=2,this.map.off("mousemove",this.mouseMoveEvent),this.line?this.line.changeCoords([[this.startLat,this.startLon],[this.endLat,this.endLon]]):this.line=new Q({coords:[[this.startLat,this.startLon],[this.endLat,this.endLon]],lineWidth:3,index:1e3,color:[0,0,0,255]}).addTo(this.mapLayers)))}mouseMoveEvent(t){if(this.destroyed)return;this.endLat=t.latlon.lat,this.endLon=t.latlon.lon;const e=(this.startLat+this.endLat)/2,i=(this.startLon+this.endLon)/2;this.line?this.line.changeCoords([[this.startLat,this.startLon],[this.endLat,this.endLon]]):this.line=new Q({coords:[[this.startLat,this.startLon],[this.endLat,this.endLon]],lineWidth:3,index:1e3,color:[0,0,0,255]}).addTo(this.mapLayers);const o=k({lat:this.startLat,lon:this.startLon},{lat:this.endLat,lon:this.endLon}),n=k({lat:this.startLat,lon:this.startLon},{lat:this.endLat,lon:this.startLon});let s=180*Math.acos(n/o)/Math.PI;this.endLat>this.startLat?this.endLon<this.startLon&&(s=360-s):this.endLon<this.startLon?s+=180:s=180-s;const r="距离："+(o/1e3).toFixed(2)+"km，角度："+s.toFixed(0)+"度";this.infoDiv.innerText=r;const a=-20*Math.sin(s*Math.PI/180),h=-125-14*Math.cos(s*Math.PI/180);this.infoDiv.style.marginLeft=h+"px",this.infoDiv.style.marginTop=a+"px",s<180?s-=90:s+=90,this.infoDiv.style.transform="rotate("+s+"deg)",this.infotext?this.infotext.setLatLng(e,i):this.infotext=new I({position:[e,i],source:this.infoDiv}).addTo(this.map),this.draw()}getLatLng(){}getHeight(){}computeMaxHeight(){if(this.height)return this.height;const t=6371.393,e=4*t/3,i=Math.PI/180,o=this.latst,n=this.lonst,s=o*i,r=n*i;let a=this.startLat,h=this.startLon,l=(this.startLat-o)*(this.startLat-o)+(this.startLon-n)*(this.startLon-n);(this.endLat-o)*(this.endLat-o)+(this.endLon-n)*(this.endLon-n)>l&&(a=this.endLat,h=this.endLon);let c=h*i,u=a*i,m=this.as.length-1;const d=(this.as[m]+(this.as[m]-this.as[m-1])/2)*i,f=Math.sin((s-u)/2),x=Math.sin((r-c)/2),p=f*f+Math.cos(s)*Math.cos(u)*x*x,y=2*t*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)),g=e/(Math.cos(y/e)-Math.tan(d)*Math.sin(y/e))-e;return Math.min(1e3*g,25e3)}changeImg(t){if(t==this.url)return;this.loader&&this.loader.stop(),this.url=t;const e=this.gl;this.ready=!1,this.content.appendChild(this.loaddiv),this.loaddiv.innerText="数据加载中";const i=this.as.length,o=[];for(let e=0;e<i;e++)o.push(t+"_"+e+".png");this.loader=new Dt({useCros:this.useCros}),this.loader.loadAll=function(t){if(!t)return e.clear(this.gl.COLOR_BUFFER_BIT),void(this.loaddiv.innerText="数据加载失败");var o=document.createElement("canvas"),n=t[0].width,s=t[0].height;o.width=n,o.height=s*i;var r=o.getContext("2d");for(let e=0;e<i;e++)r.drawImage(t[e],0,e*s);if(!this.destroyed){if(!this.texture){e.useProgram(e.program);const t=e.getUniformLocation(e.program,"u_Sampler");return this.texture=L(e,o,0,!0,!1),e.uniform1i(t,0),this.ready=!0,this.content.removeChild(this.loaddiv),this.loader.stop(),void(this.loader=null)}e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,o),this.ready=!0,this.content.removeChild(this.loaddiv),this.endLat&&this.draw(),this.loaded(),this.loader.stop(),this.loader=null}}.bind(this),this.loader.load(o,this.maxLoadNum)}changeData(t){if(t.url==this.url)return;const e=this.gl;if(e.useProgram(e.program),t.interval&&(this.interval=t.interval),t.rmin){this.rmin=t.rmin,this.rmax=t.rmax;const i=e.getUniformLocation(e.program,"rs");e.uniform2f(i,this.rmin,this.rmax)}if(t.colors){this.colors=t.colors;const i=B(t.colors,0);e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.colorTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i.canvas);const o=e.getUniformLocation(e.program,"vrange");e.uniform2f(o,i.vmin,i.vmax)}if(t.scale){this.scale=t.scale;const i=e.getUniformLocation(e.program,"scale");e.uniform3f(i,t.scale.r,t.scale.g,t.scale.b)}if(t.as){this.as=t.as;const i=e.getUniformLocation(e.program,"unum");e.uniform1f(i,this.as.length);for(let t=0;t<this.maxElevNum;t++){let i=e.getUniformLocation(e.program,"es["+t+"]");t<this.as.length?e.uniform1fv(i,[this.as[t]]):t==this.as.length?e.uniform1fv(i,[this.as[t-1]+(this.as[t-1]-this.as[t-2])/2]):e.uniform1fv(i,[0])}}t.url?this.changeImg(t.url):(this.draw(),this.loaded())}changeHeight(t){this.height=t,this.draw()}computeDistance(t,e,i,o){const n=.017453292519943295,s=e*n,r=t*n,a=o*n,h=i*n,l=Math.sin((r-h)/2),c=Math.sin((s-a)/2),u=l*l+Math.cos(r)*Math.cos(h)*c*c;return 12742.786*Math.atan(Math.sqrt(u)/Math.sqrt(1-u))}setGetgrid(t){if(this.ready||window.requestAnimationFrame(function(){this.setGetgrid(t)}.bind(this)),!this.destroyed&&t){const t=this.gl;this.frameBuffer||(this.frameBuffer=t.createFramebuffer()),t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture,0),t.bindFramebuffer(t.FRAMEBUFFER,null)}}latlngToJ(t,e,i){let o=Math.PI/180,n=this.lonst*o,s=this.latst*o,r=e*o,a=t*o,h=Math.sin((s-a)/2),l=Math.sin((n-r)/2),c=h*h+Math.cos(s)*Math.cos(a)*l*l,u=1.5*Math.atan(Math.sqrt(c)/Math.sqrt(1-c)),m=2*Math.atan(Math.sqrt(c),Math.sqrt(1-c)),d=Math.cos(a)*Math.sin(r-n)/Math.sin(m),f=(Math.sin(a)-Math.cos(m)*Math.sin(s))/Math.sin(m)/Math.cos(s),x=0;d<=.93969&&d>=-.93969?(x=Math.asin(d),f<=0?x=Math.PI-x:d<=0&&f>0&&(x=2*Math.PI+x)):(x=Math.acos(f),n>=r&&(x=2*Math.PI-x));let p=Math.atan((Math.cos(u)-8495.19/(i/1e3+8495.19))/Math.sin(u))/o,y=this.as.length,g=-1;const v=this.as;for(let t=0;t<y;t++){let e,i;if(e=0==t?v[t]/2:v[t]-(v[t]-v[t-1])/2,i=t==y-1?v[t]:v[t]+(v[t+1]-v[t])/2,p>e&&p<=i){g=t,p=v[t];break}}if(-1==g)return null;let T=180*x/Math.PI;return{r:8495.19/(1/Math.tan(.75*m)-Math.tan(p/180*Math.PI))/Math.cos(p/180*Math.PI),azi:T,zzz:g}}latlngToSAzi(t,e,i,o){let n=Math.PI/180,s=e*n,r=t*n,a=o*n,h=i*n,l=Math.sin((r-h)/2),c=Math.sin((s-a)/2),u=l*l+Math.cos(r)*Math.cos(h)*c*c,m=12742.786*Math.atan(Math.sqrt(u),Math.sqrt(1-u)),d=Math.cos(h)*Math.sin(a-s)/Math.sin(m/6371.393),f=(Math.sin(h)-Math.cos(m/6371.393)*Math.sin(r))/Math.sin(m/6371.393)/Math.cos(r),x=0;return d<=.93969&&d>=-.93969?(x=Math.asin(d),f<=0?x=Math.PI-x:d<=0&&f>0&&(x=2*Math.PI+x)):(x=Math.acos(f),s>=a&&(x=2*Math.PI-x)),{s:m,azi:180*x/Math.PI}}getDataByLatlonHeight(t,e,i){const o=this.gl,n=this.latlngToJ(t,e,i);if(!n)return null;let s=Math.round(n.azi);360==s&&(s=0),s=360*n.zzz+s;let r=Math.round((n.r-this.rmin)/this.interval);const a=new Uint8Array(4);o.bindFramebuffer(o.FRAMEBUFFER,this.frameBuffer),o.readPixels(r,s,1,1,o.RGBA,o.UNSIGNED_BYTE,a);const h=a[0]/this.scale.r+a[1]/this.scale.g+a[2]/this.scale.b;return o.bindFramebuffer(o.FRAMEBUFFER,null),{v:h,r:n.r,azi:n.azi,enum:n.zzz}}loaded(){}drawByLatLng(t,e,i,o){this.startLat=t,this.startLon=e,this.endLat=i,this.endLon=o,this.draw()}draw(){if(!this.ready)return;const t=this.gl;t.bindVertexArray(t.vao),t.useProgram(t.program);const e=this.computeMaxHeight();this.getHeight(e),t.uniform1f(this.profileHeight,e);let i=this.computeDistance(this.startLat,this.startLon,this.endLat,this.endLon)/this.minShowDistance;i=i>1?1:i;const o=this.latlngToSAzi(this.latst,this.lonst,this.startLat,this.startLon),n=this.latlngToSAzi(this.latst,this.lonst,this.endLat,this.endLon),s=this.latlngToSAzi(this.startLat,this.startLon,this.endLat,this.endLon);if(this.getLatLng({startLat:this.startLat,startLon:this.startLon,sDis:o.s,sAzi:o.azi,endLat:this.endLat,endLon:this.endLon,eDis:n.s,eAzi:n.azi,dis:s.s,xscale:i}),t.uniform1f(this.u_xscale,i),t.uniform4f(this.u_latlon,this.startLat,this.endLat,this.startLon,this.endLon),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),this.demReady){this.gl.useProgram(t.demprogram);const i=(this.startLon-this.lonmin)/(this.lonmax-this.lonmin),o=(this.startLat-this.latmin)/(this.latmax-this.latmin),n=(this.endLon-this.lonmin)/(this.lonmax-this.lonmin),s=(this.endLat-this.latmin)/(this.latmax-this.latmin);t.uniform4f(this.demst,i,o,n,s),t.uniform1f(this.demh,e/1e3),t.bindVertexArray(t.demvao),t.drawArrays(t.LINE_STRIP,0,this.demnum)}}destroy(){this.loader&&this.loader.stop(),this.map.off("click",this.clickEvent,this),this.map.off("mousemove",this.mouseMoveEvent),this.mapLayers.clearLayers(),this.mapLayers.destroy(),this.infotext&&this.infotext.destroy(this.map),this.gl.deleteTexture(this.texture),this.gl.deleteTexture(this.colorTexture),this.demTexture&&this.gl.deleteTexture(this.demTexture),this.frameBuffer&&this.gl.deleteFramebuffer(this.frameBuffer),this.gl.dembuffer&&(this.gl.deleteBuffer(this.gl.dembuffer),this.gl.deleteVertexArray(this.gl.demvao),this.gl.detachShader(this.gl.demprogram,this.gl.demprogram.vshader),this.gl.detachShader(this.gl.demprogram,this.gl.demprogram.fshader),this.gl.deleteShader(this.gl.demprogram.vshader),this.gl.deleteShader(this.gl.demprogram.fshader),this.gl.deleteProgram(this.gl.demprogram)),this.gl.deleteBuffer(this.gl.vbuffer),this.gl.deleteVertexArray(this.gl.vao),this.gl.detachShader(this.gl.program,this.gl.program.vshader),this.gl.detachShader(this.gl.program,this.gl.program.fshader),this.gl.deleteShader(this.gl.program.vshader),this.gl.deleteShader(this.gl.program.fshader),this.gl.deleteProgram(this.gl.program),this.gl.getExtension("WEBGL_lose_context").loseContext(),this.gl=null,this.content.removeChild(this.canvas),this.content.contains(this.loaddiv)&&this.content.removeChild(this.loaddiv);for(let t in this)delete this[t];this.destroyed=!0}[Symbol.toPrimitive](t){return"string"===t?"[MyClass instance]":null}}class Yt extends _{constructor(t){super(t)}init(t){this.index=t.index||g,this.data=t.data,this.fontSize=t.fontSize||20,this.fontColor=t.fontColor,this.fontWeight=t.fontWeight||500,this.strokeWidth=t.strokeWidth,this.strokeColor=t.strokeColor,this.devicePixelRatio=devicePixelRatio,this.v="#version 300 es\n        in vec3 a_position;\n        in float sts;\n        uniform float scale;\n        uniform vec2 oripx;\n        uniform vec2 size;\n        uniform float fontSize;\n        uniform float rto;\n        out float v_sts;\n        void main(){\n            vec2 point = a_position.xy*scale;\n            point = point - oripx;\n            // point = vec2(500.0);\n            point.x = (point.x+ a_position.z)*rto/ size.x;\n            point.y = point.y*rto / size.y;\n            point.y = 1.0 - 2.0*point.y;\n            point.x = 2.0*point.x - 1.0;\n            gl_Position = vec4(point,0.0,1.0);\n            // gl_Position = a_position;\n            gl_PointSize = fontSize*rto;\n            v_sts = sts;\n        }",this.f="#version 300 es\n        precision highp float;\n        uniform sampler2D u_img;\n        uniform float n;\n        out vec4 outColor;\n        in float v_sts;\n        void main(){\n            vec2 xy = gl_PointCoord.xy/n;\n            xy.x += mod(v_sts,n)/n;\n            xy.y += floor(v_sts/n)/n;\n            outColor = texture(u_img,xy);\n        }\n        "}initSelfDraw(t){this.createDraw(t.contexts[this.target].context,this.v,this.f),this.gl=t.contexts[this.target].context}computePxInZoom8(){const t=this.data,e=this.fontSize,i={},o=[];let s=0;const r=[],a=[];let h=new OffscreenCanvas(e,e),l=h.getContext("2d");l.font=this.fontWeight+" "+e+"px Arial";for(let e=0;e<t.length;e++){const h=t[e],c=n(h.lat,h.lon,8);h.x=c.x,h.y=c.y;const u=h.value.toString(),m=u.length;let d=-l.measureText(u).width/2;const f=u.charAt(0);f in i||(i[f]=s,o.push(f),s++),d+=l.measureText(f).width/2,r.push(c.x,c.y,d),a.push(i[f]);for(let t=1;t<m;t++){const e=u.charAt(t-1),n=u.charAt(t);n in i||(i[n]=s,o.push(n),s++),d+=l.measureText(n).width/2+l.measureText(e).width/2,r.push(c.x,c.y,d),a.push(i[n])}}const c=o.length,u=Math.ceil(Math.sqrt(c));h.width=u*e,h.height=u*e,l.font=this.fontWeight+" "+e+"px Arial",this.fontColor&&(l.fillStyle=this.fontColor),this.strokeWidth&&(l.lineWidth=this.strokeWidth),this.strokeColor&&(l.strokeStyle=this.strokeColor);for(let t=0;t<u;t++)for(let i=0;i<u;i++){const n=o[i*u+t];if(!n)continue;const s=l.measureText(n),r=t*e+e/2-s.width/2,a=i*e+e/2+(s.fontBoundingBoxAscent+s.fontBoundingBoxDescent-s.hangingBaseline/2)/2;this.strokeWidth&&l.strokeText(n,r,a),l.fillText(n,r,a)}return{vertices:r,sts:a,canvas:h,n:u}}initVao(t){const e=this.program;t.useProgram(e);let{vertices:i,sts:o,canvas:n,n:s}=this.computePxInZoom8();i=new Float32Array(i),o=new Float32Array(o),this.drawNum=o.length;let r=t.getAttribLocation(e,"a_position");var a=E(t,i);this.vbuffer=a;var h=R(t,r,3);this.vao=h;let l=t.getAttribLocation(e,"sts");this.stbuffer=E(t,new Float32Array(o)),t.enableVertexAttribArray(l),t.vertexAttribPointer(l,1,t.FLOAT,!1,0,0);const c=t.getUniformLocation(e,"n");t.uniform1f(c,s);const u=t.getUniformLocation(e,"fontSize");t.uniform1f(u,this.fontSize),this.u_rto=t.getUniformLocation(e,"rto"),t.uniform1f(this.u_rto,this.devicePixelRatio),this.t_scale=t.getUniformLocation(e,"scale"),this.t_oripx=t.getUniformLocation(e,"oripx"),this.t_size=t.getUniformLocation(e,"size"),this.texture=L(t,n,0,!0,!1),this.u_img=t.getUniformLocation(this.program,"u_img")}changeData(t){this.data=t;let{vertices:e,sts:i,canvas:o,n:n}=this.computePxInZoom8();e=new Float32Array(e),i=new Float32Array(i),this.drawNum=i.length;const s=this.gl;s.bindBuffer(s.ARRAY_BUFFER,this.vbuffer),s.bufferData(s.ARRAY_BUFFER,e,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,this.stbuffer),s.bufferData(s.ARRAY_BUFFER,i,s.STATIC_DRAW),s.activeTexture(s.TEXTURE0),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,0),s.bindTexture(s.TEXTURE_2D,this.texture),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,o);const r=s.getUniformLocation(this.program,"n");s.uniform1f(r,n),this.layerChangeEvent()}render(t){const e=t.context,i=t.zoom,o=t.pxbounds,n=t.drawSize;e.useProgram(this.program),e.bindVertexArray(this.vao);const s=Math.pow(2,i-8);e.uniform1f(this.t_scale,s),e.uniform2f(this.t_oripx,o.xmin,o.ymin),e.uniform2f(this.t_size,n[0],n[1]),this.devicePixelRatio!=devicePixelRatio&&(this.devicePixelRatio=devicePixelRatio,e.uniform1f(this.u_rto,this.devicePixelRatio)),t.firstDraw&&(e.clear(e.COLOR_BUFFER_BIT),t.firstDraw=!1),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.uniform1i(this.u_img,0),e.drawArrays(e.POINTS,0,this.drawNum)}destroy(t){if(!this.target)return void console.warn("图层不存在，无法删除");const e=t.contexts[this.target].context;e.deleteVertexArray(this.vao);const i=this.program;e.deleteBuffer(this.vbuffer),e.deleteTexture(this.texture),e.deleteBuffer(this.stbuffer),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i),super.destroy(t)}}class Kt{constructor(t){this.url=t.url,this.content=t.content,this.loadTxtColor=t.loadTxtColor,this.latmin=t.latmin,this.latmax=t.latmax,this.lonmin=t.lonmin,this.lonmax=t.lonmax,this.colors=t.colors;for(let t=0;t<this.colors.o.length;t++)if(this.colors.o[t]>0){this.colors.r.splice(0,t),this.colors.g.splice(0,t),this.colors.b.splice(0,t),this.colors.v.splice(0,t),this.colors.o.splice(0,t);break}this.ready=!1,t.onReady&&(this.onReady=t.onReady.bind(this)),this.init()}init(){this.initContet(),this.initGl(),this.createTexture()}initContet(){const t=this.content.clientWidth,e=this.content.clientHeight;this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.content.appendChild(this.canvas),this.loaddiv=document.createElement("div"),this.loaddiv.style.position="absolute",this.loaddiv.style.top=0,this.loaddiv.style.zIndex=1e3,this.loaddiv.style.height=e+"px",this.loaddiv.style.width=t+"px",this.loaddiv.innerText="数据加载中",this.content.appendChild(this.loaddiv),this.loaddiv.style.fontSize=this.loadTxtSize?this.loadTxtSize+"px":"30px",this.loaddiv.style.color=this.loadTxtColor?this.loadTxtColor:"black",this.loaddiv.style.fontWeight="bold",this.loaddiv.style.lineHeight=e+"px",this.loaddiv.style.textAlign="center"}initGl(){const t=this.canvas.getContext("webgl2");t||console.log("init gl failed"),this.gl=t,t.clearColor(0,0,0,0),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA_SATURATE,t.ZERO);const e=b(t,"#version 300 es\nin vec4 a_Position;\nin vec2 a_pos;\nout vec2 v_pos;\nout vec2 point;\nvoid main(){    \n    gl_Position = a_Position;    \n    point = gl_Position.xy;\n    v_pos = a_pos;\n}","#version 300 es\n#ifdef GL_ES\nprecision mediump float;\n#endif\nin vec2 point;\nin vec2 v_pos;\n// uniform vec4 latlons;\nuniform sampler2D u_Sampler;\nuniform sampler2D u_Color;\n// uniform sampler2D u_dem;\nuniform vec4 latlonbounds;\n// uniform vec4 demColor;\nuniform vec2 vrange;\nvec4 texture3Dfrom2D(float lat,float lon,float zz){    \n    vec4 colorSlice1, colorSlice2;    \n    vec2 texCoordSlice1, texCoordSlice2;    \n    float n = floor(zz);    \n    float n1 = n+1.0;    \n    float z= fract(zz);    \n    texCoordSlice1.x = mod(n,6.0)/6.0+(lon - latlonbounds.z)/((latlonbounds.w - latlonbounds.z)*6.0);    \n    texCoordSlice1.y = (floor((35.0-n)/6.0) + 1.0)/6.0 - (lat-latlonbounds.x)/((latlonbounds.y - latlonbounds.x)*6.0);    \n    texCoordSlice2.x = mod(n1,6.0)/6.0+(lon - latlonbounds.z)/((latlonbounds.w - latlonbounds.z)*6.0);    \n    texCoordSlice2.y = (floor((35.0-n1)/6.0)+1.0)/6.0 - (lat-latlonbounds.x)/((latlonbounds.y - latlonbounds.x)*6.0);    \n    colorSlice1 = texture( u_Sampler, texCoordSlice1 );    \n    colorSlice2 = texture( u_Sampler, texCoordSlice2 );    \n    if(colorSlice1.g < 1.0 ||  colorSlice2.g< 1.0){        \n        return vec4(0,0,0,0);    \n    }    \n    return mix(colorSlice1, colorSlice2, z) ;\n}\n// float getDem(float lat,float lon){    \n//     float y = (lat - latlonbounds.x)/(latlonbounds.y - latlonbounds.x);    \n//     float x = (lon - latlonbounds.z)/(latlonbounds.w - latlonbounds.z);    \n//     vec4 dems = texture2D( u_dem, vec2(x,y) )*255.0*5.0/1000.0;    \n//     if(dems.r == 0.0){        \n//         return 0.0;    \n//     }    \n//     float dem = dems.r + dems.g + dems.b + dems.a;    \n//     return dem;\n// }\nout vec4 outColor;\nvoid main(){\n    outColor = vec4(1.0,0,0,1.0);     \n    float z = (point.y +1.0)/2.0 * 35.0;    \n    // float x = (point.x + 1.0)/2.0;    \n    // float lat= mix(latlons.x,latlons.z,x);    \n    // float lon = mix(latlons.y,latlons.w,x);\n    float lat  = v_pos.x;    \n    float lon = v_pos.y;    \n    // float h = z*0.5+0.5;    \n    // float dem =  getDem(lat,lon);    \n    // if(h < dem){        \n    //     gl_FragColor = vec4(demColor);        \n    //     return;    \n    // }      \n    float value = 0.0;    \n    if(lat<latlonbounds.x || lat>latlonbounds.y || lon<latlonbounds.z || lon>latlonbounds.w){        \n        discard;    \n    }    \n    vec4 color = texture3Dfrom2D(lat,lon,z);    \n    value = color.b*255.0;\n    float m = vrange.x*0.2;\n    if(m > 1.){\n        m = 1.;\n    }\n    float mid = vrange.x - m;\n    float opa = (value - mid)/m*0.5;    \n    if(opa<0.0){        \n        opa = 0.0;    \n    }    \n    float vin = (value - vrange.x)/(vrange.y -vrange.x);    \n    vec2 p = vec2(vin,0.5);    \n    vec3 rgb = texture(u_Color,p).rgb;    \n    outColor = vec4(rgb,opa);\n}");e?(t.program=e,t.useProgram(e)):cydEvent.cydError("init gl failed");let i=new Float32Array([-1,1,-1,-1,1,1,1,-1]),o=t.getAttribLocation(t.program,"a_Position");var n=E(t,i);t.vbuffer=n;var s=R(t,o,2);t.vao=s;const r=new Float32Array([36.04021453857422,119.344482421875,36.04021453857422,119.344482421875,35.581382751464844,120.3936767578125,35.581382751464844,120.3936767578125]);let a=t.getAttribLocation(t.program,"a_pos");const h=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,h),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),t.enableVertexAttribArray(a),t.vertexAttribPointer(a,2,t.FLOAT,!1,0,0),t.pbuffer=h,this.setProfileUniforms()}setProfileUniforms(){const t=this.gl,e=t.getUniformLocation(t.program,"latlonbounds");t.uniform4f(e,this.latmin,this.latmax,this.lonmin,this.lonmax)}createTexture(){const t=this.gl;Y(this.url).then((e=>{t.useProgram(t.program);const i=t.getUniformLocation(t.program,"u_Sampler");this.texture=L(t,e,0,!1,!0),t.uniform1i(i,0),this.content.removeChild(this.loaddiv),this.ready=!0,this.onReady()}),this);const e=B(this.colors,0),i=t.getUniformLocation(t.program,"u_Color");this.colorTexture=L(t,e.canvas,1),t.uniform1i(i,1);const o=t.getUniformLocation(t.program,"vrange");t.uniform2f(o,e.vmin,e.vmax)}computeVertex(){const t=this.data;let e=0,i=0;for(let i=2;i<t.length;i+=2)e+=k({lat:t[i-2],lon:t[i-1]},{lat:t[i],lon:t[i+1]});const o=[-1,1,-1,-1];for(let n=2;n<t.length;n+=2){i+=k({lat:t[n-2],lon:t[n-1]},{lat:t[n],lon:t[n+1]});const s=i/e*2-1;o.push(s,1,s,-1)}return new Float32Array(o)}onReady(){}draw(t){if(!this.ready)return;this.data=t;const e=this.gl;e.program;const i=this.computeVertex();e.bindBuffer(e.ARRAY_BUFFER,e.vbuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW);let o=[];for(let e=0;e<t.length;e+=2)o.push(t[e],t[e+1],t[e],t[e+1]);e.bindBuffer(e.ARRAY_BUFFER,e.pbuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW),e.clear(this.gl.COLOR_BUFFER_BIT),e.drawArrays(this.gl.TRIANGLE_STRIP,0,o.length/2)}changeImg(t){const e=this.gl;Y(t).then((t=>{e.useProgram(e.program),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),this.data&&this.draw(this.data),this.onReady()}),this)}destroy(){this.gl.deleteTexture(this.texture),this.gl.deleteTexture(this.colorTexture),this.gl.deleteBuffer(this.gl.vbuffer),this.gl.deleteVertexArray(this.gl.vao),this.gl.detachShader(this.gl.program,this.gl.program.vshader),this.gl.detachShader(this.gl.program,this.gl.program.fshader),this.gl.deleteShader(this.gl.program.vshader),this.gl.deleteShader(this.gl.program.fshader),this.gl.deleteProgram(this.gl.program),this.gl.getExtension("WEBGL_lose_context").loseContext(),this.gl=null,this.content.removeChild(this.canvas),this.content.contains(this.loaddiv)&&this.content.removeChild(this.loaddiv);for(let t in this)delete this[t]}}class Nt extends _{constructor(t){super(t),this.index=t.index||y}init(t){this.latmin=t.latmin,this.latmax=t.latmax,this.lonmin=t.lonmin,this.lonmax=t.lonmax,this.img=t.img,this.useCros=t.useCros,this.grid=t.grid,this.opacity=t.opacity||1,this.ready=!1}initSelfDraw(t){this.createDraw(t.contexts[this.target].context,"#version 300 es\n    in vec4 a_position;\n    out vec2 point;\n    void main(){\n        gl_Position = a_position;\n        point = a_position.xy;\n    }","#version 300 es\n    #ifdef GL_ES\n    precision highp float;\n    #endif\n    uniform vec3 oripx;\n    uniform vec4 pxbounds;\n    uniform sampler2D u_img;\n    uniform float rto;\n    uniform float opacity;\n    out vec4 outColor;\n    void main(){\n        float x = oripx.x +gl_FragCoord.x/rto;  \n        float y = oripx.y + (oripx.z - gl_FragCoord.y)/rto;\n        x = (x - pxbounds.x)/(pxbounds.z - pxbounds.x);\n        y = (y - pxbounds.y)/(pxbounds.w - pxbounds.y);\n        if(x > 1. || x<0. || y > 1. || y<0.){\n            discard;\n        }\n        outColor =texture(u_img,vec2(x,y));\n        outColor.a = outColor.a * opacity;\n    }\n"),this.setUniforms(t.contexts[this.target].context,this.program),this.createTexture(t.contexts[this.target].context)}setUniforms(t,e){this.gl=t,t.useProgram(e),this.pxbounds=t.getUniformLocation(e,"pxbounds"),this.oripx=t.getUniformLocation(e,"oripx"),this.rto=t.getUniformLocation(e,"rto"),this.opa=t.getUniformLocation(e,"opacity"),t.uniform1f(this.opa,this.opacity)}createTexture(t){const e=typeof this.img;let i=null,o=t.getUniformLocation(this.program,"u_img");this.u_img=o,"string"!=e?(i=this.img,this.texture=L(t,i,0,this.grid,this.flipy),this.ready=!0):(i=new Image,this.useCros&&(i.crossOrigin="anonymous"),i.onload=function(){this.texture=L(t,i,0,this.grid,this.flipy),this.ready=!0,this.img=i}.bind(this),i.onerror=function(){console.warn("图片加载失败:"+this.img);const e=document.createElement("canvas");e.width=1,e.height=1,this.texture=L(t,e,0,!0,!1),this.ready=!0,this.img=e}.bind(this),i.src=this.img)}computePxBounds(t){return{pxmin:n(this.latmax,this.lonmin,t),pxmax:n(this.latmin,this.lonmax,t)}}setUniformScale(t,e){const i=e.pxbounds;t.uniform3f(this.oripx,i.xmin,i.ymin,e.drawSize[1]);const o=this.computePxBounds(e.zoom);t.uniform4f(this.pxbounds,o.pxmin.x,o.pxmin.y,o.pxmax.x,o.pxmax.y)}render(t){if(!this.ready)return void(t.drawNext=!0);const e=t.context;e.useProgram(this.program),this.setUniformScale(e,t),devicePixelRatio!=this.devicePixelRatio&&(this.devicePixelRatio=devicePixelRatio,e.uniform1f(this.rto,this.devicePixelRatio)),e.bindVertexArray(this.vao),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.uniform1i(this.u_img,0),t.firstDraw&&(e.clear(e.COLOR_BUFFER_BIT),t.firstDraw=!1),e.drawArrays(e.TRIANGLE_STRIP,0,4)}changeImage(t){if(!this.ready)return;const e=this.gl;if("string"!=typeof t)e.useProgram(this.program),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),this.layerChangeEvent();else{const i=new Image;this.useCros&&(i.crossOrigin="anonymous"),i.onload=function(){e.useProgram(this.program),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),this.layerChangeEvent()}.bind(this),i.onerror=function(){e.useProgram(this.program),console.warn("图片加载失败:"+this.img);const t=document.createElement("canvas");t.width=1,t.height=1,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),this.layerChangeEvent()}.bind(this),i.src=t}}destroy(t){if(!this.target)return void console.warn("图层不存在，无法删除");const e=t.contexts[this.target].context;e.deleteVertexArray(this.vao);const i=this.program;e.deleteBuffer(this.vbuffer),e.deleteTexture(this.texture),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i),super.destroy(t)}}let Vt=class extends G{constructor(t){super(t)}init(t){this.index=t.index||x,this.pointSize=t.pointSize||20,this.spdUrl=t.spdUrl,this.dirUrl=t.dirUrl,this.speedScale=t.speedScale,this.dirScale=t.dirScale,this.latmin=t.latmin,this.latmax=t.latmax,this.lonmin=t.lonmin,this.lonmax=t.lonmax,this.interval=t.interval,this.intervalZoom=t.intervalZoom||12,this.color=t.color,this.lineWidth=t.lineWidth,this.shadowWidth=t.shadowWidth,this.shadowColor=t.shadowColor,this.useCros=t.useCros,this.flipy=t.flipy,this.hasdata=!1,this.cut=t.cut,this.cutUrl=t.cutUrl,this.cutlatmin=t.cutlatmin,this.cutlatmax=t.cutlatmax,this.cutlonmin=t.cutlonmin,this.cutlonmax=t.cutlonmax,this.drawWindbar()}computePxInZoom8(){const t=this.data,e=[],i=[],o=[];for(let s=0;s<t.length;s++){if(0==t[s].spd)continue;if(t[s].spd<=1)i.push(1);else{let e=Math.floor(t[s].spd/2);e>20&&(e=20),i.push(e)}const r=n(t[s].lat,t[s].lon,8);e.push(r.x,r.y),o.push(t[s].dir)}return{pxs:e,sts:i,angles:o}}getImg(){const t=this.useCros;return new Promise(((e,i)=>{const o=new Promise(((e,i)=>{const o=new Image;t&&(o.crossOrigin="anonymous"),o.onload=function(){e(o)},o.onerror=function(){i("error")},o.src=this.spdUrl})),n=new Promise(((e,i)=>{const o=new Image;t&&(o.crossOrigin="anonymous"),o.onload=function(){e(o)},o.onerror=function(){i("error")},o.src=this.dirUrl}));Promise.all([o,n]).then((t=>{e(t)})).catch((t=>{i(t)}))}))}computePoints(t,e){let i=Math.round(Math.pow(2,Math.round(this.intervalZoom-t)))*this.interval;i<this.interval&&(i=this.interval);const o=e.latlngMin.lat-this.latmin,s=e.latlngMin.lon-this.lonmin;let r=Math.floor(o/i)*i+this.latmin,a=Math.floor(s/i)*i+this.lonmin;const h=[],l=[],c=[];let u=!1;if(this.startLat==r&&this.startLon==a&&this.nowInterval==i)return{stateChange:u,pxs:h,sts:l,angles:c};u=!0,this.startLat=r,this.startLon=a,this.nowInterval=i;const m=this.speedScale,d=this.dirScale,f=this.latmax,x=this.latmin,p=this.lonmax,y=this.lonmin,g=this.interval,v=this.imgWidth,T=this.spdData,b=this.dirData;for(;r<=e.latlngMax.lat&&!(r>f+1e-4);){if(r<x-1e-4){r+=i;continue}let t=a;for(;t<e.latlngMax.lon&&!(t>p+1e-4);){if(t<y-1e-4){t+=i;continue}const e=(t-y)/g,o=(r-x)/g,s=Math.round(o)*v+Math.round(e),a=T[4*s],u=T[4*s+1],f=T[4*s+2],p=T[4*s+3];if(0==a&&255==p){t+=i;continue}let E=a/m.r+u/m.g+f/m.b+p/m.a;const R=b[4*s],L=b[4*s+1],w=b[4*s+2],_=b[4*s+3];let P=R/d.r+L/d.g+w/d.b+_/d.a;if(0==E){t+=i;continue}if(E<=1)l.push(0);else{let t=Math.floor(E/2);t>20&&(t=20),l.push(t)}const S=n(r,t,8);h.push(S.x,S.y),c.push(P),t+=i}r+=i}return{stateChange:u,pxs:h,sts:l,angles:c}}initVao(t){this.gl=t,this.getpxdata(),t.useProgram(this.program);const e=t.createVertexArray();t.bindVertexArray(e);const i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i);let o=t.getAttribLocation(this.program,"a_position");t.enableVertexAttribArray(o),t.vertexAttribPointer(o,2,t.FLOAT,!1,0,0),this.vbuffer=i;let n=t.getAttribLocation(this.program,"a_sts");this.stbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.stbuffer),t.enableVertexAttribArray(n),t.vertexAttribPointer(n,1,t.FLOAT,!1,0,0);let s=t.getAttribLocation(this.program,"angle");this.angleBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.angleBuffer),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,1,t.FLOAT,!1,0,0),this.vao=e,this.t_scale=t.getUniformLocation(this.program,"scale"),this.t_oripx=t.getUniformLocation(this.program,"oripx"),this.t_size=t.getUniformLocation(this.program,"size"),this.setUniforms(t)}getpxdata(){let t=document.createElement("canvas").getContext("webgl2");const e=b(t,"#version 300 es\nin vec2 a_position;\nout vec2 point;\nvoid main(){\n    point = a_position;\n    gl_Position = vec4(a_position,0.0,1.0);\n}","#version 300 es\n        precision highp float;\n        out vec4 outColor;\n        in vec2 point;\n        uniform sampler2D u_sampler;\n        uniform sampler2D u_cut;\n        uniform vec4 datarange;\n        uniform vec4 cutrange;\n        void main(){\n            float x = (point.x + 1.0)/2.0;          \n            float y = (point.y + 1.0)/2.0;\n            float lat = datarange.x + (datarange.y - datarange.x)*y;          \n            float lon = datarange.z+(datarange.w - datarange.z)*x;          \n            float cx = (lat - cutrange.x)/(cutrange.y - cutrange.x);          \n            float cy = (lon - cutrange.z)/(cutrange.w - cutrange.z);          \n            vec4 color = texture(u_sampler,vec2(x,y));          \n            float d = texture(u_cut,vec2(cy,cx)).r;                    \n            outColor = color;\n            // outColor = vec4(0,0,0,1.);  \n            if(d>0.0){            \n                outColor = vec4(0.0,0,0,1.);          \n            }\n            // outColor = texture(u_sampler,vec2(x,y));\n        }\n        ");this.cutgl=t,this.cutprogram=e,this.getImg().then((e=>{if(t.viewport(0,0,e[0].width,e[0].height),this.framebuffer=t.createFramebuffer(),this.spdTexture=L(t,e[0],0,!1,this.flipy),this.dirTexture=L(t,e[1],0,!1,this.flipy),this.cut)this.drawCut(e[0]);else{t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer);const i=e[0].width,o=e[1].height;this.imgWidth=i,t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.spdTexture,0);const n=new Uint8Array(i*o*4);t.readPixels(0,0,i,o,t.RGBA,t.UNSIGNED_BYTE,n),this.spdData=n,t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.dirTexture,0);const s=new Uint8Array(i*o*4);t.readPixels(0,0,i,o,t.RGBA,t.UNSIGNED_BYTE,s),this.dirData=s,t.bindFramebuffer(t.FRAMEBUFFER,null),this.ready=!0}this.hasdata=!0}),this).catch((i=>{t.useProgram(e);const o=document.createElement("canvas");if(this.framebuffer=t.createFramebuffer(),this.spdTexture=L(t,o,0,!1,this.flipy),this.dirTexture=L(t,o,0,!1,this.flipy),this.cut)this.drawCut(o);else{t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer);const e=o.width,i=o.height;this.imgWidth=e,t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.spdTexture,0);const n=new Uint8Array(e*i*4);this.spdData=n,t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.dirTexture,0);const s=new Uint8Array(e*i*4);this.dirData=s,t.bindFramebuffer(t.FRAMEBUFFER,null),this.ready=!0,console.log("数据加载失败")}this.hasdata=!1}),this)}drawCut(t){const e=this.cutgl,i=this.cutprogram,o=new Image;o.onload=function(){e.useProgram(i);const n=e.createVertexArray();e.bindVertexArray(n);const s=e.createBuffer();let r=new Float32Array([-1,1,-1,-1,1,1,1,-1]);e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array(r),e.STATIC_DRAW);let a=e.getAttribLocation(i,"a_position");e.enableVertexAttribArray(a),e.vertexAttribPointer(a,2,e.FLOAT,!1,0,0),i.vbuffer=s,i.vao=n;const h=L(e,o,1,!1,!0);this.cutTexture=h;const l=e.getUniformLocation(i,"u_sampler");e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.spdTexture),e.uniform1i(l,0);const c=e.getUniformLocation(i,"u_cut");e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,h),e.uniform1i(c,1);const u=e.getUniformLocation(i,"datarange");e.uniform4f(u,this.latmin,this.latmax,this.lonmin,this.lonmax);const m=e.getUniformLocation(i,"cutrange");e.uniform4f(m,this.cutlatmin,this.cutlatmax,this.cutlonmin,this.cutlonmax);const d=e.createTexture();this.outtexture=d,e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,d);const f=t.width,x=t.height;this.imgWidth=f;const p=e.RGBA,y=e.RGBA,g=e.UNSIGNED_BYTE;e.texImage2D(e.TEXTURE_2D,0,p,f,x,0,y,g,null),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,d,0),e.disable(e.BLEND),e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLE_STRIP,0,4),e.enable(e.BLEND);const v=new Uint8Array(f*x*4);e.readPixels(0,0,f,x,e.RGBA,e.UNSIGNED_BYTE,v),this.spdData=v,e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.dirTexture,0);const T=new Uint8Array(f*x*4);e.readPixels(0,0,f,x,e.RGBA,e.UNSIGNED_BYTE,T),this.dirData=T,e.bindFramebuffer(e.FRAMEBUFFER,null),this.ready=!0}.bind(this),o.src=this.cutUrl}initSelfDraw(t){this.createDraw(t.contexts[this.target].context,"#version 300 es\nin vec2 a_position;\nin float a_sts;\nin float angle;\nuniform float scale;\nuniform vec2 oripx;\nuniform vec2 size;\nuniform float radius;\nuniform float rto;\n// out float v_radius;\nout float sts;\nout float v_angle;\nvoid main(){\n    vec2 point = a_position*scale;\n    point = point - oripx;\n    point.x = point.x / size.x*rto;\n    point.y = point.y / size.y*rto;\n    point.y = 1.0 - 2.0*point.y;\n    point.x = 2.0*point.x - 1.0;\n    gl_Position = vec4(point,0.0,1.0);\n    gl_PointSize = radius*2.0*rto + 1.0;\n    sts = a_sts;\n    v_angle = angle;\n    // v_radius = radius;\n}","#version 300 es\nprecision highp float;\nin float sts;\nin float v_angle;\nuniform vec4 color;\nuniform sampler2D u_img;\n\nout vec4 outColor;\nvoid main(){\n    float vnum = sts;\n    // float angle = 45.0;\n    float rad = radians(v_angle);\n    float cosrot = cos(rad);\n    float sinrot = sin(rad);\n    mat2 rotMatrix = mat2(cosrot,sinrot,-sinrot,cosrot);\n    vec2 xy = gl_PointCoord - 0.5;\n    xy = xy * rotMatrix;\n    if(abs(xy.x) >sqrt(2.)/4. || abs(xy.y)>sqrt(2.)/4.){\n        // outColor = vec4(0.0,0.0,0.0,1.0);\n        // return;\n        discard;\n    }\n    xy = xy * sqrt(2.);\n    xy +=0.5;\n    xy.y = floor(vnum/5.)/5. + xy.y/5.;\n    xy.x = mod(vnum,5.)/5. + xy.x/5.;\n    outColor = texture(u_img,xy);\n    // outColor = vec4(vnum/20.0,0,0,1.);\n    \n}\n")}setUniforms(t){this.texture=L(t,this.windCanvas,0,!1,!1),this.u_img=t.getUniformLocation(this.program,"u_img");const e=t.getUniformLocation(this.program,"radius");t.uniform1f(e,this.pointSize*Math.sqrt(2)),this.u_rto=t.getUniformLocation(this.program,"rto")}drawWindbar(){this.windCanvas=H(this.pointSize,this.color,this.lineWidth,this.shadowWidth,this.shadowColor)}changeData(t){this.spdUrl=t.spdUrl,this.dirUrl=t.dirUrl;const e=this.cutgl;this.getImg().then((t=>{if(this.cut){e.activeTexture(e.TEXTURE2),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindTexture(e.TEXTURE_2D,this.outtexture);const i=t[0].width,o=t[1].height;e.viewport(0,0,i,o),this.imgWidth=i;const n=0,s=e.RGBA,r=0,a=e.RGBA,h=e.UNSIGNED_BYTE;e.texImage2D(e.TEXTURE_2D,n,s,i,o,r,a,h,null),e.activeTexture(e.TEXTURE0),this.flipy?e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1):e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindTexture(e.TEXTURE_2D,this.spdTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t[0]),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.outtexture,0),e.disable(e.BLEND),e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLE_STRIP,0,4),e.enable(e.BLEND);const l=new Uint8Array(i*o*4);e.readPixels(0,0,i,o,e.RGBA,e.UNSIGNED_BYTE,l),this.spdData=l,e.bindTexture(e.TEXTURE_2D,this.dirTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t[1]),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.dirTexture,0);const c=new Uint8Array(i*o*4);e.readPixels(0,0,i,o,e.RGBA,e.UNSIGNED_BYTE,c),this.dirData=c,e.bindFramebuffer(e.FRAMEBUFFER,null),this.nowInterval=null,this.layerChangeEvent()}else{e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);const i=t[0].width,o=t[1].height;this.imgWidth=i,e.activeTexture(e.TEXTURE0),this.flipy?e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1):e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindTexture(e.TEXTURE_2D,this.spdTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t[0]),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.spdTexture,0);const n=new Uint8Array(i*o*4);e.readPixels(0,0,i,o,e.RGBA,e.UNSIGNED_BYTE,n),this.spdData=n,e.bindTexture(e.TEXTURE_2D,this.dirTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t[1]),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.dirTexture,0);const s=new Uint8Array(i*o*4);e.readPixels(0,0,i,o,e.RGBA,e.UNSIGNED_BYTE,s),this.dirData=s,e.bindFramebuffer(e.FRAMEBUFFER,null),this.nowInterval=null,this.layerChangeEvent()}this.hasdata=!0}),this).catch((()=>{e.useProgram(this.program);const t=document.createElement("canvas");e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);const i=t.width,o=t.height;this.imgWidth=i,e.bindTexture(e.TEXTURE_2D,this.spdTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.spdTexture,0);const n=new Uint8Array(i*o*4);this.spdData=n,e.bindTexture(e.TEXTURE_2D,this.dirTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.dirTexture,0);const s=new Uint8Array(i*o*4);this.dirData=s,e.bindFramebuffer(e.FRAMEBUFFER,null),this.nowInterval=null,this.layerChangeEvent(),console.log("数据加载失败"),this.hasdata=!1}))}getGridDataByLatLon(t,e){if(!this.hasdata)return{spd:null,dir:null,lat:t,lon:e};const{x:i,y:o}=j(t,e,this.latmin,this.latmax,this.lonmin,this.lonmax,this.interval);if(null==i)return{spd:null,dir:null,lat:t,lon:e};const n=o*this.imgWidth+i,s=this.spdData[4*n],r=this.spdData[4*n+1],a=this.spdData[4*n+2],h=this.spdData[4*n+3];if(0==s&&255==h)return{spd:0,dir:0,lat:t,lon:e};let l=s/this.speedScale.r+r/this.speedScale.g+a/this.speedScale.b+h/this.speedScale.a;const c=this.dirData[4*n],u=this.dirData[4*n+1],m=this.dirData[4*n+2],d=this.dirData[4*n+3];return{spd:l,dir:c/this.dirScale.r+u/this.dirScale.g+m/this.dirScale.b+d/this.dirScale.a,lat:t,lon:e}}render(t){if(!this.ready)return void(t.drawNext=!0);const e=t.zoom,i=t.context,o=t.pxbounds,n=t.drawSize;this.zoom=e,this.pxbounds=o,i.useProgram(this.program),i.bindVertexArray(this.vao);const{stateChange:s,pxs:r,sts:a,angles:h}=this.computePoints(e,t.bounds);s&&(this.drawNum=r.length/2,i.bindBuffer(i.ARRAY_BUFFER,this.vbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(r),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.stbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(a),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,this.angleBuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(h),i.STATIC_DRAW)),devicePixelRatio!=this.devicePixelRatio&&(this.devicePixelRatio=devicePixelRatio,i.uniform1f(this.u_rto,this.devicePixelRatio));const l=Math.pow(2,e-8);i.uniform1f(this.t_scale,l),i.uniform2f(this.t_oripx,o.xmin,o.ymin),i.uniform2f(this.t_size,n[0],n[1]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.texture),i.uniform1i(this.u_img,0),t.firstDraw&&(i.clear(i.COLOR_BUFFER_BIT),t.firstDraw=!1),i.drawArrays(i.POINTS,0,this.drawNum)}destroy(t){if(!this.target)return void console.warn("图层不存在，无法删除");const e=t.contexts[this.target].context;e.deleteVertexArray(this.vao);const i=this.program;e.deleteBuffer(this.vbuffer),e.deleteBuffer(this.stbuffer),e.deleteBuffer(this.angleBuffer),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i);const o=this.cutgl;o.deleteTexture(this.spdTexture),o.deleteTexture(this.dirTexture),o.deleteFramebuffer(this.framebuffer),o.deleteBuffer(this.cutprogram.vbuffer),o.deleteProgram(this.cutprogram),o.deleteVertexArray(this.cutprogram.vao),this.outtexture&&o.deleteTexture(this.outtexture),this.cutTexture&&o.deleteTexture(this.cutTexture),o.getExtension("WEBGL_lose_context").loseContext(),super.destroy(t)}};const kt=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Ht{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[e,i]=new Uint8Array(t,0,2);if(219!==e)throw new Error("Data does not appear to be in a KDBush format.");const o=i>>4;if(1!==o)throw new Error(`Got v${o} data when expected v1.`);const n=kt[15&i];if(!n)throw new Error("Unrecognized array type.");const[s]=new Uint16Array(t,2,1),[r]=new Uint32Array(t,4,1);return new Ht(r,s,n,t)}constructor(t,e=64,i=Float64Array,o){if(isNaN(t)||t<0)throw new Error(`Unexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+e,2),65535),this.ArrayType=i,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const n=kt.indexOf(this.ArrayType),s=2*t*this.ArrayType.BYTES_PER_ELEMENT,r=t*this.IndexArrayType.BYTES_PER_ELEMENT,a=(8-r%8)%8;if(n<0)throw new Error(`Unexpected typed array class: ${i}.`);o&&o instanceof ArrayBuffer?(this.data=o,this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+r+a,2*t),this._pos=2*t,this._finished=!0):(this.data=new ArrayBuffer(8+s+r+a),this.ids=new this.IndexArrayType(this.data,8,t),this.coords=new this.ArrayType(this.data,8+r+a,2*t),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+n]),new Uint16Array(this.data,2,1)[0]=e,new Uint32Array(this.data,4,1)[0]=t)}add(t,e){const i=this._pos>>1;return this.ids[i]=i,this.coords[this._pos++]=t,this.coords[this._pos++]=e,i}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return Ot(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,e,i,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:n,coords:s,nodeSize:r}=this,a=[0,n.length-1,0],h=[];for(;a.length;){const l=a.pop()||0,c=a.pop()||0,u=a.pop()||0;if(c-u<=r){for(let r=u;r<=c;r++){const a=s[2*r],l=s[2*r+1];a>=t&&a<=i&&l>=e&&l<=o&&h.push(n[r])}continue}const m=u+c>>1,d=s[2*m],f=s[2*m+1];d>=t&&d<=i&&f>=e&&f<=o&&h.push(n[m]),(0===l?t<=d:e<=f)&&(a.push(u),a.push(m-1),a.push(1-l)),(0===l?i>=d:o>=f)&&(a.push(m+1),a.push(c),a.push(1-l))}return h}within(t,e,i){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:o,coords:n,nodeSize:s}=this,r=[0,o.length-1,0],a=[],h=i*i;for(;r.length;){const l=r.pop()||0,c=r.pop()||0,u=r.pop()||0;if(c-u<=s){for(let i=u;i<=c;i++){let s=qt(n[2*i],n[2*i+1],t,e);s<=h&&a.push([o[i],Math.sqrt(s)])}continue}const m=u+c>>1,d=n[2*m],f=n[2*m+1];let x=qt(d,f,t,e);x<=h&&a.push([o[m],Math.sqrt(x)]),(0===l?t-i<=d:e-i<=f)&&(r.push(u),r.push(m-1),r.push(1-l)),(0===l?t+i>=d:e+i>=f)&&(r.push(m+1),r.push(c),r.push(1-l))}return a}}function Ot(t,e,i,o,n,s){if(n-o<=i)return;const r=o+n>>1;jt(t,e,r,o,n,s),Ot(t,e,i,o,r-1,1-s),Ot(t,e,i,r+1,n,1-s)}function jt(t,e,i,o,n,s){for(;n>o;){if(n-o>600){const r=n-o+1,a=i-o+1,h=Math.log(r),l=.5*Math.exp(2*h/3),c=.5*Math.sqrt(h*l*(r-l)/r)*(a-r/2<0?-1:1);jt(t,e,i,Math.max(o,Math.floor(i-a*l/r+c)),Math.min(n,Math.floor(i+(r-a)*l/r+c)),s)}const r=e[2*i+s];let a=o,h=n;for(Jt(t,e,o,i),e[2*n+s]>r&&Jt(t,e,o,n);a<h;){for(Jt(t,e,a,h),a++,h--;e[2*a+s]<r;)a++;for(;e[2*h+s]>r;)h--}e[2*o+s]===r?Jt(t,e,o,h):(h++,Jt(t,e,h,n)),h<=i&&(o=h+1),i<=h&&(n=h-1)}}function Jt(t,e,i,o){Qt(t,i,o),Qt(e,2*i,2*o),Qt(e,2*i+1,2*o+1)}function Qt(t,e,i){const o=t[e];t[e]=t[i],t[i]=o}function qt(t,e,i,o){const n=t-i,s=e-o;return n*n+s*s}class $t extends D{constructor(t){super(t),this.index=t.index||p}init(t){super.init(t),this.data=t.positions}computePxInZoom8(){const t=this.data,e=new Array(2*t.length);return t.forEach((function(t,i){const o=n(t[0],t[1],8);e[2*i]=o.x,e[2*i+1]=o.y})),e}setClickEnable(){this.clickEnable=!0,this.bush=new Ht(this.data.length,32),this.data.forEach((t=>{this.bush.add(t[0],t[1])})),this.bush.finish()}bindTooltip(t,e){this.bush=new Ht(this.data.length,32),this.data.forEach((t=>{this.bush.add(t[0],t[1])})),this.bush.finish(),this.getHtml="function"==typeof e?e:this.getHtml,this.tooltip?this.tooltip.destroy():(this.tooltip=new I({position:[33,114],source:"1111",visiable:!1,index:1e3}).addTo(t),this.setTooltipHide=this.setTooltipHide.bind(this),document.addEventListener("mousemove",this.setTooltipHide),t.setLayerEvent("mousestay",this,(t=>{})))}setTooltipHide(){this.tooltip.setVisiable(!1)}getHtml(t){return"--"}fireEvent(t){const e=n(t.latlon.lat,t.latlon.lon,this.zoom),i=e.x-this.imgSize[0]/2,o=e.y-this.imgSize[1]/2,s=e.x+this.imgSize[0]/2,r=a(i,e.y+this.imgSize[1]/2,this.zoom),h=a(s,o,this.zoom),l=this.bush.range(r.lat,r.lon,h.lat,h.lon);if(0===l.length)return!1;let c=-1;for(let t=0;t<l.length;t++)l[t]>c&&(c=l[t]);if(this.tooltip){const t=this.getHtml(c);this.tooltip.setLatLng(this.data[c][0],this.data[c][1]),this.tooltip.setElement({source:t}),window.requestAnimationFrame(function(){this.tooltip.setVisiable(!0)}.bind(this))}return this.clickEnable&&this.fire(t.type,{index:c}),!1}destroy(t){document.removeEventListener("mousemove",this.setTooltipHide),super.destroy(t)}}let te=class extends Q{constructor(t){super(t)}init(t){const e=t.data,i=e.type;this.useBounds=e.useBounds,this.maxlat=90,this.minlat=-90,this.maxlon=180,this.minlon=-180;const o=[];if("FeatureCollection"==i){const t=e.features,i=t[0].geometry.type;if("MultiLineString"==i)for(let e=0;e<t.length;e++)Array.prototype.push.apply(o,t[e].geometry.coordinates);else if("MultiPolygon"==i)for(let e=0;e<t.length;e++){const i=t[e].geometry.coordinates;for(let t=0;t<i.length;t++)Array.prototype.push.apply(o,i[t])}else if("LineString"==i)for(let e=0;e<t.length;e++)o.push(t[e].geometry.coordinates);else{if("Point"==i)throw new Error("点geojson，不支持绘制线");console.warn("未接入该geojson格式，请联系柴亚东进行增加新格式")}}else"Feature"==i&&"Polygon"==e.geometry.type?Array.prototype.push.apply(o,e.geometry.coordinates):console.warn("未接入该geojson格式，请联系柴亚东进行增加新格式");this.coords=o,this.lineWidth=t.lineWidth||1,this.color=t.color||[255,0,0,255],this.color=K(this.color),this.lineWidth<1?this.computeVertices_1():this.computeVertices_n()}compouteMaxRange(t){let e=t[0][1],i=t[0][0],o=t[0][1],n=t[0][0];for(let s=1;s<t.length;s++){const r=t[s][1],a=t[s][0];e=Math.max(e,r),i=Math.max(i,a),o=Math.min(o,r),n=Math.min(n,a)}this.maxlat=i,this.maxlon=e,this.minlat=n,this.minlon=o}computePoints(t,e,i){this.useBounds&&this.compouteMaxRange(t);let o=n(t[t.length-2][1],t[t.length-2][0],8);e.push(o.x,o.y);for(let o=0;o<t.length;o++){const s=n(t[o][1],t[o][0],8);e.push(s.x,s.y),i.push(s)}let s=n(t[1][1],t[1][0],8);e.push(s.x,s.y)}fireEvent(t){const e=t.latlon.lat,i=t.latlon.lon;if(e<this.minlat||e>this.maxlat||i<this.minlon||i>this.maxlon)return!1;let o=!1;for(let n=0;n<this.coords.length;n++)if(o=N([i,e],this.coords[n]),o)return this.fire(t.type,t),!!this.events[t.type].stopPropagation;return!1}};class ee extends G{constructor(t){super(t)}init(t){if(this.showPoints=t.showPoints,this.index=t.index||x,this.pointSize=t.pointSize||5,this.url=t.url,this.scale=t.scale,this.latmin=t.latmin,this.latmax=t.latmax,this.lonmin=t.lonmin,this.lonmax=t.lonmax,this.interval=t.interval,this.intervalZoom=t.intervalZoom||12,this.color=t.color||[255,0,0,255],this.useCros=t.useCros,this.flipy=t.flipy,this.color=this.color.map((t=>t/255)),this.showTexts=t.showTexts,this.fontSize=t.fontSize||16,this.fontWeight=t.fontWeight||500,this.textOffset=t.textOffset||[0,0],this.strokeWidth=t.strokeWidth,this.strokeColor=t.strokeColor,this.fontColor=t.fontColor||"black",this.cut=t.cut,this.cutUrl=t.cutUrl,this.cutlatmin=t.cutlatmin,this.cutlatmax=t.cutlatmax,this.cutlonmin=t.cutlonmin,this.cutlonmax=t.cutlonmax,this.values=t.values||[],this.labels=t.labels||[],t.getValue&&(this.getValue=t.getValue),this.showZero=!("showZero"in t)||t.showZero,this.textsMap={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10,"-":11},this.labels&&this.labels.length>0){this.textsMap={};for(let t=0;t<this.labels.length;t++)for(let e=0;e<this.labels[t].length;e++){const i=this.labels[t].charAt(e);this.textsMap[i]||(this.textsMap[i]=Object.keys(this.textsMap).length)}}}getValue(t){return"string"==typeof t?t:0==(t=t.toFixed(1)).split(".")[1]?t.split(".")[0]:t}computePoints(t,e){const i=this.textsMap,o=this.mesureCanvas,s=this.getValue,r=this.showZero;let a=Math.round(Math.pow(2,Math.round(this.intervalZoom-t)))*this.interval;a<this.interval&&(a=this.interval);const h=e.latlngMin.lat-this.latmin,l=e.latlngMin.lon-this.lonmin;let c=Math.floor(h/a)*a+this.latmin,u=Math.floor(l/a)*a+this.lonmin,m=Math.floor((e.latlngMax.lat-c)/a),d=Math.floor((e.latlngMax.lon-u)/a);const f=[],x=[],p=[];let y=!1;if(this.startLat==c&&this.startLon==u&&this.nowInterval==a&&this.latnum==m&&this.lonnum==d)return{stateChange:y,pxs:f,sts:x};y=!0,this.startLat=c,this.startLon=u,this.latnum=m,this.lonnum=d,this.nowInterval=a;const g=this.scale,v=this.latmax,T=this.latmin,b=this.lonmax,E=this.lonmin,R=this.interval,L=this.imgWidth,w=this.data;if(!this.imgLoaded)return{stateChange:y,pxs:f,sts:x,t_pxs:p};for(;c<=e.latlngMax.lat+a&&!(c>v+1e-4);){if(c<T-1e-4){c+=a;continue}let t=u;for(;t<e.latlngMax.lon+a&&!(t>b+1e-4);){if(t<E-1e-4){t+=a;continue}const e=(t-E)/R,h=(c-T)/R,l=Math.round(h)*L+Math.round(e),u=w[4*l],m=w[4*l+1],d=w[4*l+2],y=w[4*l+3];if(0==u&&255==y){t+=a;continue}let v=u/g.r+m/g.g+d/g.b+y/g.a;if(!r&&v<=0){t+=a;continue}const b=n(c,t,8);f.push(b.x,b.y);const _=s(v),P=_.length;let S=-o.measureText(_).width/2;const M=_.charAt(0);S+=o.measureText(M).width/2,p.push(b.x,b.y,S),x.push(i[M]);for(let t=1;t<P;t++){const e=_.charAt(t-1),n=_.charAt(t);S+=o.measureText(n).width/2+o.measureText(e).width/2,p.push(b.x,b.y,S),x.push(i[n])}t+=a}c+=a}return{stateChange:y,pxs:f,sts:x,t_pxs:p}}createTextTexture(){const t=this.fontSize,e=Object.keys(this.textsMap).length,i=document.createElement("canvas");i.width=this.fontSize*e,i.height=this.fontSize;const o=i.getContext("2d");o.font=this.fontWeight+" "+t+"px Arial",o.fillStyle=this.fontColor,this.strokeWidth&&(o.lineWidth=this.strokeWidth),this.strokeColor&&(o.strokeStyle=this.strokeColor);for(let e in this.textsMap){const i=this.textsMap[e],n=o.measureText(e),s=i*t+t/2-n.width/2,r=t/2+(n.fontBoundingBoxAscent+n.fontBoundingBoxDescent-n.hangingBaseline/2)/2;this.strokeWidth&&o.strokeText(e,s,r),o.fillText(e,s,r)}return this.mesureCanvas=o,i}initVao(t){if(this.gl=t,this.getpxdata(),this.showPoints){const e=this.programs.points,i=t.createVertexArray();t.bindVertexArray(i);const o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o);let n=t.getAttribLocation(e,"a_position");t.enableVertexAttribArray(n),t.vertexAttribPointer(n,2,t.FLOAT,!1,0,0),e.vbuffer=o,e.vao=i}if(this.showTexts){const e=this.createTextTexture(),i=this.programs.texts,o=t.createVertexArray();t.bindVertexArray(o);const n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n);let s=t.getAttribLocation(i,"a_position");t.enableVertexAttribArray(s),t.vertexAttribPointer(s,3,t.FLOAT,!1,0,0),i.vbuffer=n;let r=t.getAttribLocation(i,"sts");i.stbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i.stbuffer),t.enableVertexAttribArray(r),t.vertexAttribPointer(r,1,t.FLOAT,!1,0,0),i.vao=o,t.useProgram(i),this.texture=L(t,e,0,!0,!1)}this.setUniforms(t)}getpxdata(){let t=document.createElement("canvas").getContext("webgl2");const e=b(t,"#version 300 es\nin vec2 a_position;\nout vec2 point;\nvoid main(){\n    point = a_position;\n    gl_Position = vec4(a_position,0.0,1.0);\n}","#version 300 es\n        precision highp float;\n        out vec4 outColor;\n        in vec2 point;\n        uniform sampler2D u_sampler;\n        uniform sampler2D u_cut;\n        uniform vec4 datarange;\n        uniform vec4 cutrange;\n        void main(){\n            float x = (point.x + 1.0)/2.0;          \n            float y = (point.y + 1.0)/2.0;\n            float lat = datarange.x + (datarange.y - datarange.x)*y;          \n            float lon = datarange.z+(datarange.w - datarange.z)*x;          \n            float cx = (lat - cutrange.x)/(cutrange.y - cutrange.x);          \n            float cy = (lon - cutrange.z)/(cutrange.w - cutrange.z);          \n            vec4 color = texture(u_sampler,vec2(x,y));          \n            float d = texture(u_cut,vec2(cy,cx)).r;                    \n            outColor = color;\n            // outColor = vec4(0,0,0,1.);  \n            if(d>0.0){            \n                outColor = vec4(0.0,0,0,1.);          \n            }\n            // outColor = texture(u_sampler,vec2(x,y));\n        }\n        ");this.cutgl=t,this.cutprogram=e,O(this.url,this.useCros).then((e=>{if(t.viewport(0,0,e.width,e.height),this.framebuffer=t.createFramebuffer(),this.datatexture=L(t,e,0,!0,this.flipy),this.cut)this.drawCut(e);else{t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer);const i=e.width,o=e.height;this.imgWidth=i,t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.datatexture,0);const n=new Uint8Array(i*o*4);t.readPixels(0,0,i,o,t.RGBA,t.UNSIGNED_BYTE,n),this.data=n,t.bindFramebuffer(t.FRAMEBUFFER,null),this.ready=!0,this.imgLoaded=!0}}),this).catch((e=>{const i=document.createElement("canvas");if(t.viewport(0,0,i.width,i.height),this.framebuffer=t.createFramebuffer(),this.datatexture=L(t,i,0,!0,this.flipy),this.imgLoaded=!1,this.cut)this.drawCut(i);else{t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer);const e=i.width,o=i.height;this.imgWidth=e,t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.datatexture,0);const n=new Uint8Array(e*o*4);this.data=n,t.bindFramebuffer(t.FRAMEBUFFER,null),this.ready=!0,console.log("数据加载失败")}}),this)}drawCut(t){const e=this.cutgl,i=this.cutprogram,o=new Image;o.onload=function(){e.useProgram(i);const n=e.createVertexArray();e.bindVertexArray(n);const s=e.createBuffer();let r=new Float32Array([-1,1,-1,-1,1,1,1,-1]);e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,new Float32Array(r),e.STATIC_DRAW);let a=e.getAttribLocation(i,"a_position");e.enableVertexAttribArray(a),e.vertexAttribPointer(a,2,e.FLOAT,!1,0,0),i.vbuffer=s,i.vao=n;const h=L(e,o,1,!1,!0),l=e.getUniformLocation(i,"u_sampler");e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.datatexture),e.uniform1i(l,0);const c=e.getUniformLocation(i,"u_cut");e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,h),e.uniform1i(c,1);const u=e.getUniformLocation(i,"datarange");e.uniform4f(u,this.latmin,this.latmax,this.lonmin,this.lonmax);const m=e.getUniformLocation(i,"cutrange");e.uniform4f(m,this.cutlatmin,this.cutlatmax,this.cutlonmin,this.cutlonmax);const d=e.createTexture();this.outtexture=d,e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,d);const f=t.width,x=t.height;this.imgWidth=f;const p=e.RGBA,y=e.RGBA,g=e.UNSIGNED_BYTE;e.texImage2D(e.TEXTURE_2D,0,p,f,x,0,y,g,null),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,d,0),e.disable(e.BLEND),e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLE_STRIP,0,4),e.enable(e.BLEND);const v=new Uint8Array(f*x*4);e.readPixels(0,0,f,x,e.RGBA,e.UNSIGNED_BYTE,v),this.data=v,e.bindFramebuffer(e.FRAMEBUFFER,null),this.ready=!0,this.imgLoaded=!0}.bind(this),o.src=this.cutUrl}initSelfDraw(t){this.programs={},this.showPoints&&(this.programs.points=b(t.contexts[this.target].context,"#version 300 es\nin vec2 a_position;\nuniform float scale;\nuniform vec2 oripx;\nuniform vec2 size;\nuniform float radius;\nuniform float rto;\nout float v_radius;\nvoid main(){\n    vec2 point = a_position*scale;\n    point = point - oripx;\n    point.x = point.x*rto / size.x;\n    point.y = point.y *rto/ size.y;\n    point.y = 1.0 - 2.0*point.y;\n    point.x = 2.0*point.x - 1.0;\n    gl_Position = vec4(point,0.0,1.0);\n    gl_PointSize = radius*2.0 + 1.0;\n    v_radius = radius;\n}","#version 300 es\nprecision highp float;\nin float v_radius;\nuniform vec4 color;\nout vec4 outColor;\nvoid main(){\n    \n    float d = distance(gl_PointCoord, vec2(0.5));\n    float adis = 0.5/v_radius;\n    float a = (0.5-d)/adis;\n    a = max(a,0.0);\n    a = min(a,color.a);\n    outColor = vec4(color.xyz, a);\n    \n}\n")),this.showTexts&&(this.programs.texts=b(t.contexts[this.target].context,"#version 300 es\n        in vec3 a_position;\n        in float sts;\n        uniform float scale;\n        uniform vec2 oripx;\n        uniform vec2 size;\n        uniform float fontSize;\n        uniform float rto;\n        uniform vec2 offset;\n        out float v_sts;\n        void main(){\n            vec2 point = a_position.xy*scale + offset;\n            point = point - oripx;\n            // point = vec2(500.0);\n            point.x = (point.x+ a_position.z)*rto/ size.x;\n            point.y = point.y*rto / size.y;\n            point.y = 1.0 - 2.0*point.y;\n            point.x = 2.0*point.x - 1.0;\n            gl_Position = vec4(point,0.0,1.0);\n            // gl_Position = a_position;\n            gl_PointSize = fontSize*rto;\n            v_sts = sts;\n        }","#version 300 es\n        precision highp float;\n        uniform sampler2D u_img;\n        uniform float n;\n        out vec4 outColor;\n        in float v_sts;\n        void main(){\n            // float n = 12.;\n            vec2 xy = gl_PointCoord.xy;\n            xy.x = xy.x/n;\n            xy.x += v_sts/n;\n            // xy.y += floor(v_sts/n)/n;\n            outColor = texture(u_img,xy);\n            // outColor = vec4(1.,0,0,1.);\n        }\n        ")),this.initVao(t.contexts[this.target].context)}setUniforms(t){if(this.showPoints){const e=this.programs.points;t.useProgram(e),this.u_scale=t.getUniformLocation(e,"scale"),this.u_oripx=t.getUniformLocation(e,"oripx"),this.u_size=t.getUniformLocation(e,"size");const i=t.getUniformLocation(e,"radius");t.uniform1f(i,this.pointSize),this.u_rto=t.getUniformLocation(e,"rto");const o=t.getUniformLocation(e,"color");t.uniform4f(o,...this.color)}if(this.showTexts){const e=this.programs.texts;t.useProgram(e),this.t_scale=t.getUniformLocation(e,"scale"),this.t_oripx=t.getUniformLocation(e,"oripx"),this.t_size=t.getUniformLocation(e,"size"),this.t_img=t.getUniformLocation(e,"u_img");const i=t.getUniformLocation(e,"n");t.uniform1f(i,Object.keys(this.textsMap).length);const o=t.getUniformLocation(e,"fontSize");t.uniform1f(o,this.fontSize),this.t_rto=t.getUniformLocation(e,"rto");const n=t.getUniformLocation(e,"color");t.uniform4f(n,...this.color);const s=t.getUniformLocation(e,"offset");t.uniform2f(s,...this.textOffset)}}changeData(t){const e=this.cutgl,i=this.flipy;O(t,this.useCros).then((t=>{if(this.cut){e.viewport(0,0,t.width,t.height),e.activeTexture(e.TEXTURE2),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindTexture(e.TEXTURE_2D,this.outtexture);const o=t.width,n=t.height;this.imgWidth=o;const s=0,r=e.RGBA,a=0,h=e.RGBA,l=e.UNSIGNED_BYTE;e.texImage2D(e.TEXTURE_2D,s,r,o,n,a,h,l,null),e.activeTexture(e.TEXTURE0),i?e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1):e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindTexture(e.TEXTURE_2D,this.datatexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.outtexture,0),e.disable(e.BLEND),e.clear(e.COLOR_BUFFER_BIT),e.drawArrays(e.TRIANGLE_STRIP,0,4),e.enable(e.BLEND),this.imgLoaded=!0;const c=new Uint8Array(o*n*4);e.readPixels(0,0,o,n,e.RGBA,e.UNSIGNED_BYTE,c),this.data=c,e.bindFramebuffer(e.FRAMEBUFFER,null),this.nowInterval=null,this.layerChangeEvent()}else{e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);const o=t.width,n=t.height;this.imgWidth=o,e.activeTexture(e.TEXTURE0),i?e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1):e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindTexture(e.TEXTURE_2D,this.datatexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.datatexture,0);const s=new Uint8Array(o*n*4);e.readPixels(0,0,o,n,e.RGBA,e.UNSIGNED_BYTE,s),this.data=s,this.imgLoaded=!0,e.bindFramebuffer(e.FRAMEBUFFER,null),this.nowInterval=null,this.layerChangeEvent()}}),this).catch((()=>{this.imgLoaded=!1;const t=document.createElement("canvas");e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer);const i=t.width,o=t.height;this.imgWidth=i,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.datatexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.datatexture,0);const n=new Uint8Array(i*o*4);this.data=n,e.bindFramebuffer(e.FRAMEBUFFER,null),this.nowInterval=null,this.layerChangeEvent(),console.log("数据加载失败")}))}changeAllData(t){const e=t.url,i=this.cutgl,o=this.cutprogram;O(e,this.useCros).then((e=>{this.flipy=t.flipy||this.flipy;const n=this.flipy;this.scale=t.scale||this.scale,this.latmin=t.latmin||this.latmin,this.latmax=t.latmax||this.latmax,this.lonmin=t.lonmin||this.lonmin,this.lonmax=t.lonmax||this.lonmax,this.interval=t.interval||this.interval,this.intervalZoom=t.intervalZoom||this.intervalZoom;const s=i.getUniformLocation(o,"datarange");if(i.uniform4f(s,this.latmin,this.latmax,this.lonmin,this.lonmax),this.cut){i.viewport(0,0,e.width,e.height),i.activeTexture(i.TEXTURE0),n?i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,1):i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,0),i.bindTexture(i.TEXTURE_2D,this.datatexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.bindFramebuffer(i.FRAMEBUFFER,this.framebuffer),i.activeTexture(i.TEXTURE2),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,1),i.bindTexture(i.TEXTURE_2D,this.outtexture);const t=e.width,o=e.height,s=0,r=i.RGBA,a=0,h=i.RGBA,l=i.UNSIGNED_BYTE,c=null;this.imgLoaded=!0,i.texImage2D(i.TEXTURE_2D,s,r,t,o,a,h,l,c),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.outtexture,0),i.disable(i.BLEND),i.clear(i.COLOR_BUFFER_BIT),i.drawArrays(i.TRIANGLE_STRIP,0,4),i.enable(i.BLEND),this.imgWidth=t;const u=new Uint8Array(t*o*4);i.readPixels(0,0,t,o,i.RGBA,i.UNSIGNED_BYTE,u),this.data=u,i.bindFramebuffer(i.FRAMEBUFFER,null),this.nowInterval=null,this.layerChangeEvent()}else{i.bindFramebuffer(i.FRAMEBUFFER,this.framebuffer);const t=e.width,o=e.height;this.imgWidth=t,i.activeTexture(i.TEXTURE0),n?i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,1):i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,0),this.imgLoaded=!0,i.bindTexture(i.TEXTURE_2D,this.datatexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.datatexture,0);const s=new Uint8Array(t*o*4);i.readPixels(0,0,t,o,i.RGBA,i.UNSIGNED_BYTE,s),this.data=s,i.bindFramebuffer(i.FRAMEBUFFER,null),this.nowInterval=null,this.layerChangeEvent()}}),this).catch((()=>{this.imgLoaded=!1;const t=document.createElement("canvas");i.bindFramebuffer(i.FRAMEBUFFER,this.framebuffer);const e=t.width,o=t.height;this.imgWidth=e,i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.datatexture),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.datatexture,0);const n=new Uint8Array(e*o*4);this.data=n,i.bindFramebuffer(i.FRAMEBUFFER,null),this.nowInterval=null,this.layerChangeEvent(),console.log("数据加载失败")}))}render(t){if(!this.ready)return void(t.drawNext=!0);const e=t.zoom,i=t.context,o=t.pxbounds,n=t.drawSize;this.zoom=e,this.pxbounds=o;const{stateChange:s,pxs:r,sts:a,t_pxs:h}=this.computePoints(e,t.bounds);let l=!1;if(devicePixelRatio!=this.devicePixelRatio&&(this.devicePixelRatio=devicePixelRatio,l=!0),this.showPoints){let a=this.programs.points;i.useProgram(a),i.bindVertexArray(a.vao),s&&(this.u_drawNum=r.length/2,i.bindBuffer(i.ARRAY_BUFFER,a.vbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(r),i.STATIC_DRAW)),l&&i.uniform1f(this.u_rto,devicePixelRatio);const h=Math.pow(2,e-8);i.uniform1f(this.u_scale,h),i.uniform2f(this.u_oripx,o.xmin,o.ymin),i.uniform2f(this.u_size,n[0],n[1]),t.firstDraw&&(i.clear(i.COLOR_BUFFER_BIT),t.firstDraw=!1),i.drawArrays(i.POINTS,0,this.u_drawNum)}if(this.showTexts){let r=this.programs.texts;i.useProgram(r),i.bindVertexArray(r.vao),s&&(this.t_drawNum=h.length/3,i.bindBuffer(i.ARRAY_BUFFER,r.vbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(h),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,r.stbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(a),i.STATIC_DRAW)),l&&i.uniform1f(this.t_rto,devicePixelRatio);const c=Math.pow(2,e-8);i.uniform1f(this.t_scale,c),i.uniform2f(this.t_oripx,o.xmin,o.ymin),i.uniform2f(this.t_size,n[0],n[1]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.texture),i.uniform1i(this.t_img,0),t.firstDraw&&(i.clear(i.COLOR_BUFFER_BIT),t.firstDraw=!1),i.drawArrays(i.POINTS,0,this.t_drawNum)}}destroy(t){if(!this.target)return void console.warn("图层不存在，无法删除");const e=t.contexts[this.target].context;let i=this.programs.points;this.showPoints&&(e.deleteVertexArray(i.vao),e.deleteBuffer(i.vbuffer),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i)),this.showTexts&&(i=this.programs.texts,e.deleteVertexArray(i.vao),e.deleteBuffer(i.vbuffer),e.deleteBuffer(i.stbuffer),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i)),this.texture&&e.deleteTexture(this.texture);const o=this.cutgl;o&&(o.deleteTexture(this.datatexture),o.deleteFramebuffer(this.framebuffer),o.deleteBuffer(this.cutprogram.vbuffer),o.deleteProgram(this.cutprogram),o.deleteVertexArray(this.cutprogram.vao),this.outtexture&&o.deleteTexture(this.outtexture),this.cutTexture&&o.deleteTexture(this.cutTexture),o.getExtension("WEBGL_lose_context").loseContext()),super.destroy(t)}}class ie{constructor(t=[],e=((t,e)=>t<e?-1:t>e?1:0)){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this._down(t)}push(t){this.data.push(t),this._up(this.length++)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return--this.length>0&&(this.data[0]=e,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:e,compare:i}=this,o=e[t];for(;t>0;){const n=t-1>>1,s=e[n];if(i(o,s)>=0)break;e[t]=s,t=n}e[t]=o}_down(t){const{data:e,compare:i}=this,o=this.length>>1,n=e[t];for(;t<o;){let o=1+(t<<1);const s=o+1;if(s<this.length&&i(e[s],e[o])<0&&(o=s),i(e[o],n)>=0)break;e[t]=e[o],t=o}e[t]=n}}function oe(t,e,i,o,n){ne(t,e,i||0,o||t.length-1,n||re)}function ne(t,e,i,o,n){for(;o>i;){if(o-i>600){var s=o-i+1,r=e-i+1,a=Math.log(s),h=.5*Math.exp(2*a/3),l=.5*Math.sqrt(a*h*(s-h)/s)*(r-s/2<0?-1:1);ne(t,e,Math.max(i,Math.floor(e-r*h/s+l)),Math.min(o,Math.floor(e+(s-r)*h/s+l)),n)}var c=t[e],u=i,m=o;for(se(t,i,e),n(t[o],c)>0&&se(t,i,o);u<m;){for(se(t,u,m),u++,m--;n(t[u],c)<0;)u++;for(;n(t[m],c)>0;)m--}0===n(t[i],c)?se(t,i,m):se(t,++m,o),m<=e&&(i=m+1),e<=m&&(o=m-1)}}function se(t,e,i){var o=t[e];t[e]=t[i],t[i]=o}function re(t,e){return t<e?-1:t>e?1:0}class ae{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const i=[];if(!ve(t,e))return i;const o=this.toBBox,n=[];for(;e;){for(let s=0;s<e.children.length;s++){const r=e.children[s],a=e.leaf?o(r):r;ve(t,a)&&(e.leaf?i.push(r):ge(t,a)?this._all(r,i):n.push(r))}e=n.pop()}return i}searchOne(t){let e=this.data;const i=[];if(!ve(t,e))return i;const o=this.toBBox,n=[];for(;e;){for(let s=0;s<e.children.length;s++){const r=e.children[s],a=e.leaf?o(r):r;if(ve(t,a)){if(e.leaf)return r;ge(t,a)?this._all(r,i):n.push(r)}}e=n.pop()}return null}collides(t){let e=this.data;if(!ve(t,e))return!1;const i=[];for(;e;){for(let o=0;o<e.children.length;o++){const n=e.children[o],s=e.leaf?this.toBBox(n):n;if(ve(t,s)){if(e.leaf||ge(t,s))return!0;i.push(n)}}e=i.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(let e=0;e<t.length;e++)this.insert(t[e]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const t=this.data;this.data=e,e=t}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e;return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Te([]),this}remove(t,e){if(!t)return this;let i=this.data;const o=this.toBBox(t),n=[],s=[];let r,a,h;for(;i||n.length;){if(i||(i=n.pop(),a=n[n.length-1],r=s.pop(),h=!0),i.leaf){const o=he(t,i.children,e);if(-1!==o)return i.children.splice(o,1),n.push(i),this._condense(n),this}h||i.leaf||!ge(i,o)?a?(r++,i=a.children[r],h=!1):i=null:(n.push(i),s.push(r),r=0,a=i,i=i.children[0])}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const i=[];for(;t;)t.leaf?e.push(...t.children):i.push(...t.children),t=i.pop();return e}_build(t,e,i,o){const n=i-e+1;let s,r=this._maxEntries;if(n<=r)return s=Te(t.slice(e,i+1)),le(s,this.toBBox),s;o||(o=Math.ceil(Math.log(n)/Math.log(r)),r=Math.ceil(n/Math.pow(r,o-1))),s=Te([]),s.leaf=!1,s.height=o;const a=Math.ceil(n/r),h=a*Math.ceil(Math.sqrt(r));be(t,e,i,h,this.compareMinX);for(let n=e;n<=i;n+=h){const e=Math.min(n+h-1,i);be(t,n,e,a,this.compareMinY);for(let i=n;i<=e;i+=a){const n=Math.min(i+a-1,e);s.children.push(this._build(t,i,n,o-1))}}return le(s,this.toBBox),s}_chooseSubtree(t,e,i,o){for(;o.push(e),!e.leaf&&o.length-1!==i;){let i,o=1/0,n=1/0;for(let s=0;s<e.children.length;s++){const r=e.children[s],a=fe(r),h=pe(t,r)-a;h<n?(n=h,o=a<o?a:o,i=r):h===n&&a<o&&(o=a,i=r)}e=i||e.children[0]}return e}_insert(t,e,i){const o=i?t:this.toBBox(t),n=[],s=this._chooseSubtree(o,this.data,e,n);for(s.children.push(t),ue(s,o);e>=0&&n[e].children.length>this._maxEntries;)this._split(n,e),e--;this._adjustParentBBoxes(o,n,e)}_split(t,e){const i=t[e],o=i.children.length,n=this._minEntries;this._chooseSplitAxis(i,n,o);const s=this._chooseSplitIndex(i,n,o),r=Te(i.children.splice(s,i.children.length-s));r.height=i.height,r.leaf=i.leaf,le(i,this.toBBox),le(r,this.toBBox),e?t[e-1].children.push(r):this._splitRoot(i,r)}_splitRoot(t,e){this.data=Te([t,e]),this.data.height=t.height+1,this.data.leaf=!1,le(this.data,this.toBBox)}_chooseSplitIndex(t,e,i){let o,n=1/0,s=1/0;for(let r=e;r<=i-e;r++){const e=ce(t,0,r,this.toBBox),a=ce(t,r,i,this.toBBox),h=ye(e,a),l=fe(e)+fe(a);h<n?(n=h,o=r,s=l<s?l:s):h===n&&l<s&&(s=l,o=r)}return o||i-e}_chooseSplitAxis(t,e,i){const o=t.leaf?this.compareMinX:me,n=t.leaf?this.compareMinY:de;this._allDistMargin(t,e,i,o)<this._allDistMargin(t,e,i,n)&&t.children.sort(o)}_allDistMargin(t,e,i,o){t.children.sort(o);const n=this.toBBox,s=ce(t,0,e,n),r=ce(t,i-e,i,n);let a=xe(s)+xe(r);for(let o=e;o<i-e;o++){const e=t.children[o];ue(s,t.leaf?n(e):e),a+=xe(s)}for(let o=i-e-1;o>=e;o--){const e=t.children[o];ue(r,t.leaf?n(e):e),a+=xe(r)}return a}_adjustParentBBoxes(t,e,i){for(let o=i;o>=0;o--)ue(e[o],t)}_condense(t){for(let e,i=t.length-1;i>=0;i--)0===t[i].children.length?i>0?(e=t[i-1].children,e.splice(e.indexOf(t[i]),1)):this.clear():le(t[i],this.toBBox)}}function he(t,e,i){if(!i)return e.indexOf(t);for(let o=0;o<e.length;o++)if(i(t,e[o]))return o;return-1}function le(t,e){ce(t,0,t.children.length,e,t)}function ce(t,e,i,o,n){n||(n=Te(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(let s=e;s<i;s++){const e=t.children[s];ue(n,t.leaf?o(e):e)}return n}function ue(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function me(t,e){return t.minX-e.minX}function de(t,e){return t.minY-e.minY}function fe(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function xe(t){return t.maxX-t.minX+(t.maxY-t.minY)}function pe(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function ye(t,e){const i=Math.max(t.minX,e.minX),o=Math.max(t.minY,e.minY),n=Math.min(t.maxX,e.maxX),s=Math.min(t.maxY,e.maxY);return Math.max(0,n-i)*Math.max(0,s-o)}function ge(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function ve(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function Te(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function be(t,e,i,o,n){const s=[e,i];for(;s.length;){if((i=s.pop())-(e=s.pop())<=o)continue;const r=e+Math.ceil((i-e)/o/2)*o;oe(t,r,e,i,n),s.push(e,r,r,i)}}class Ee extends ee{constructor(t){super(t)}init(t){this.showPoints=t.showPoints,this.index=t.index||x,this.pointSize=t.pointSize||5,this.data=t.data,this.scale=t.scale,this.latmin=t.latmin,this.latmax=t.latmax,this.lonmin=t.lonmin,this.lonmax=t.lonmax,this.interval=t.interval,this.intervalZoom=t.intervalZoom||12,this.color=t.color||[255,0,0,255],this.useCros=t.useCros,this.deciNum=t.deciNum||50,this.minZoom=t.minZoom||4,this.useSort=t.useSort,this.sortKey=t.sortKey||"value",this.color=this.color.map((t=>t/255)),this.showTexts=t.showTexts,this.textKey=t.textKey,this.fontSize=t.fontSize||16,this.fontWeight=t.fontWeight||500,this.textOffset=t.textOffset||[0,0],this.strokeWidth=t.strokeWidth,this.strokeColor=t.strokeColor,this.fontColor=t.fontColor||"black",t.getValue&&(this.getValue=t.getValue),this.showZero=!("showZero"in t)||t.showZero,this.textsMap={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10,"-":11},this.rbush=new ae,this.useSort&&this.buildQueen()}getpxdata(){}buildQueen(){const t=(i=this.sortKey,new Function("a","b",`return a.${i} - b.${i}`)),e=new ie([],t);var i;let o=this.data;for(let t=0;t<this.data.length;t++){const i=o[t],n=i[this.sortKey];!n&&0!=n||n>9999||n<=-99||e.push(i)}this.q=e}computePointsByZoomSort(t){let e=this.minZoom;const i=this.rbush;i.clear();let o={};for(;t.length>0&&e<=13;){o[e]=[];const n=Math.pow(2,e-8),s=this.deciNum/n/devicePixelRatio;for(let n=t.length-1;n>=0;n--){const r=t[n],a=r.px.x,h=r.px.y;let l={minX:a-s,minY:h-s,maxX:a+s,maxY:h+s};i.collides(l)||(o[e].push(r),t.splice(n,1),i.insert({minX:a,minY:h,maxX:a,maxY:h}))}e++}this.drawZoomData=o}computePointsStatic(){const t=this.textsMap,e=this.mesureCanvas,i=this.getValue,o=[];if(this.useSort){let s=this.q;for(;s.length;){const r=s.pop(),a=r.lat,h=r.lon,l=n(a,h,8),c=i(r[this.textKey]),u=c.length;let m=-e.measureText(c).width/2;const d=c.charAt(0);m+=e.measureText(d).width/2;let f=[],x=[];f.push(l.x,l.y,m),x.push(t[d]);for(let i=1;i<u;i++){const o=c.charAt(i-1),n=c.charAt(i);m+=e.measureText(n).width/2+e.measureText(o).width/2,f.push(l.x,l.y,m),x.push(t[n])}o.push({px:l,tpxs:f,sts:x,lat:a,lon:h})}this.q=null}else{let s=this.data;for(let r=0;r<s.length;r++){const a=s[r],h=a.lat,l=a.lon,c=n(h,l,8),u=i(a[this.textKey]),m=u.length;let d=-e.measureText(u).width/2;const f=u.charAt(0);d+=e.measureText(f).width/2;let x=[],p=[];x.push(c.x,c.y,d),p.push(t[f]);for(let i=1;i<m;i++){const o=u.charAt(i-1),n=u.charAt(i);d+=e.measureText(n).width/2+e.measureText(o).width/2,x.push(c.x,c.y,d),p.push(t[n])}o.push({px:c,tpxs:x,sts:p,lat:h,lon:l})}}this.computePointsByZoomSort(o)}changeData(t,e){this.textKey=t,this.data=e,this.useSort&&this.buildQueen(),this.computePointsStatic(),this.pxlength=0,this.layerChangeEvent()}computePoints(t,e){t=Math.round(t);let i=[],o=[],n=[],s=this.minZoom;t<s&&(t=s);for(let r=s;r<=t;r++){let t=this.drawZoomData[r];if(t)for(let s=0;s<t.length;s++){let r=t[s].lat,a=t[s].lon;r<e.latlngMin.lat||r>e.latlngMax.lat||a<e.latlngMin.lon||a>e.latlngMax.lon||(i.push(t[s].px.x,t[s].px.y),Array.prototype.push.apply(o,t[s].sts),Array.prototype.push.apply(n,t[s].tpxs))}}return i.length==this.pxlength?{stateChange:!1}:(this.pxlength=i.length,{stateChange:!0,pxs:i,sts:o,t_pxs:n})}initVao(t){super.initVao(t),this.computePointsStatic()}render(t){const e=t.zoom,i=t.context,o=t.pxbounds,n=t.drawSize;this.zoom=e,this.pxbounds=o;const{stateChange:s,pxs:r,sts:a,t_pxs:h}=this.computePoints(e,t.bounds);let l=!1;if(devicePixelRatio!=this.devicePixelRatio&&(this.devicePixelRatio=devicePixelRatio,l=!0),this.showPoints){let a=this.programs.points;i.useProgram(a),i.bindVertexArray(a.vao),s&&(this.u_drawNum=r.length/2,i.bindBuffer(i.ARRAY_BUFFER,a.vbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(r),i.STATIC_DRAW)),l&&i.uniform1f(this.u_rto,devicePixelRatio);const h=Math.pow(2,e-8);i.uniform1f(this.u_scale,h),i.uniform2f(this.u_oripx,o.xmin,o.ymin),i.uniform2f(this.u_size,n[0],n[1]),t.firstDraw&&(i.clear(i.COLOR_BUFFER_BIT),t.firstDraw=!1),i.drawArrays(i.POINTS,0,this.u_drawNum)}if(this.showTexts){let r=this.programs.texts;i.useProgram(r),i.bindVertexArray(r.vao),s&&(this.t_drawNum=h.length/3,i.bindBuffer(i.ARRAY_BUFFER,r.vbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(h),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,r.stbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(a),i.STATIC_DRAW)),l&&i.uniform1f(this.t_rto,devicePixelRatio);const c=Math.pow(2,e-8);i.uniform1f(this.t_scale,c),i.uniform2f(this.t_oripx,o.xmin,o.ymin),i.uniform2f(this.t_size,n[0],n[1]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.texture),i.uniform1i(this.t_img,0),t.firstDraw&&(i.clear(i.COLOR_BUFFER_BIT),t.firstDraw=!1),i.drawArrays(i.POINTS,0,this.t_drawNum)}}}class Re extends te{constructor(t){super(t)}init(t){const e=t.data,i=e.type;this.useBounds=e.useBounds,this.maxlat=90,this.minlat=-90,this.maxlon=180,this.minlon=-180,this.useTag=t.useTag,this.tagDiff=t.tagDiff||300,this.tagDecinum=t.tagDecinum||20,this.fontColor=t.fontColor||"blue",this.fontSize=t.fontSize||20;const o=[];if(this.useTag&&(this.points=[],this.childLayers=[]),"FeatureCollection"==i){const t=e.features,i=t[0].geometry.type;if("MultiLineString"==i){const e=this.tagDiff;for(let i=0;i<t.length;i++)if(Array.prototype.push.apply(o,t[i].geometry.coordinates),this.useTag){const o=t[i].geometry.coordinates;for(let n=0;n<o.length;n++){const s=o[n];for(let o=1;o<s.length;o+=e)this.points.push({lat:s[o][1],lon:s[o][0],value:t[i].properties.value})}}}else if("MultiPolygon"==i)for(let e=0;e<t.length;e++){const i=t[e].geometry.coordinates;for(let t=0;t<i.length;t++)Array.prototype.push.apply(o,i[t])}else if("LineString"==i){const e=this.tagDiff;for(let i=0;i<t.length;i++)if(o.push(t[i].geometry.coordinates),this.useTag){const o=t[i].geometry.coordinates;for(let n=1;n<o.length;n+=e)this.points.push({lat:o[n][1],lon:o[n][0],value:t[i].properties.value})}}else{if("Point"==i)throw new Error("点geojson，不支持绘制线");console.warn("未接入该geojson格式，请联系柴亚东进行增加新格式")}}else"Feature"==i&&"Polygon"==e.geometry.type?Array.prototype.push.apply(o,e.geometry.coordinates):console.warn("未接入该geojson格式，请联系柴亚东进行增加新格式");if(this.useTag){let t=new Ee({showPoints:!1,pointSize:4,showTexts:!0,textKey:"value",textOffset:[0,0],strokeWidth:1,strokeColor:"yellow",fontWeight:600,fontSize:this.fontSize,fontColor:this.fontColor,data:this.points,color:[255,0,0,255],useSort:!1,deciNum:this.tagDecinum,minZoom:4});this.childLayers.push(t)}this.coords=o,this.lineWidth=t.lineWidth||1,this.color=t.color||[255,0,0,255],this.color=K(this.color),this.lineWidth<1?this.computeVertices_1():this.computeVertices_n()}}let Le=class extends _{constructor(t){super(t),this.index=t.index||f}init(t){this.data=t.data,this.color=t.color||[255,0,0,180],this.color=K(this.color),this.computePolygon()}initSelfDraw(t){this.createDraw(t.contexts[this.target].context,"#version 300 es\nin vec2 a_position;\nuniform vec2 oripx;\nuniform vec2 size;\nuniform float scale;\nvoid main(){\n    vec2 point = a_position.xy * scale;\n    point = point - oripx;\n    point.x = point.x / size.x;\n    point.y = point.y / size.y;\n    point.y = 1.0 - 2.0*point.y;\n    point.x = 2.0*point.x - 1.0;\n    gl_Position = vec4(point,0.0,1.0);\n}","#version 300 es\nprecision highp float;\nuniform vec4 color;\nout vec4 outColor;\nvoid main(){\n    outColor = color;\n}\n")}computePolygon(){const t=this.data;if("Feature"==t.type){const e=t.geometry;if("Polygon"==e.type){const t=e.coordinates,i=[],o=[];for(let e=0;e<t.length;e++)if(0==e){const e=t[0];for(let t=0;t<e.length;t++){const o=n(e[t][1],e[t][0],8);i.push(o.x,o.y)}}else{o.push(i.length/2);const s=t[e];for(let t=0;t<s.length;t++){const e=n(s[t][1],s[t][0],8);i.push(e.x,e.y)}}this.vertices=i,this.indices=this.computeIndices(i,o)}else console.log("未识别的格式，请联系柴亚东增加新的geojson格式")}else if("FeatureCollection"==t.type)if(t.features.length>1)console.log("未识别的格式，请联系柴亚东增加新的geojson格式");else{const e=t.features[0].geometry;if("MultiPolygon"==e.type){const t=[],i=[];for(let o=0;o<e.coordinates.length;o++){const s=e.coordinates[o],r=[],a=[];for(let t=0;t<s.length;t++)if(0==t){const t=s[0];for(let e=0;e<t.length;e++){const i=n(t[e][1],t[e][0],8);r.push(i.x,i.y)}}else{a.push(r.length/2);const e=s[t];for(let t=0;t<e.length;t++){const i=n(e[t][1],e[t][0],8);r.push(i.x,i.y)}}const h=t.length/2,l=this.computeIndices(r,a,h);Array.prototype.push.apply(t,r),Array.prototype.push.apply(i,l)}this.vertices=t,this.indices=i}else if("Polygon"==e.type){const t=e.coordinates,i=[],o=[];for(let e=0;e<t.length;e++)if(0==e){const e=t[0];for(let t=0;t<e.length;t++){const o=n(e[t][1],e[t][0],8);i.push(o.x,o.y)}}else{o.push(i.length/2);const s=t[e];for(let t=0;t<s.length;t++){const e=n(s[t][1],s[t][0],8);i.push(e.x,e.y)}}this.vertices=i,this.indices=this.computeIndices(i,o)}else console.log("未识别的格式，请联系柴亚东增加新的geojson格式")}else console.log("未识别的格式，请联系柴亚东增加新的geojson格式")}fireEvent(t){let e=!1;const i=this.data;if("Feature"==i.type){const o=i.geometry;if("Polygon"==o.type){const i=o.coordinates[0];e=N([t.latlon.lon,t.latlon.lat],i)}else console.log("未识别的格式，请联系柴亚东增加新的geojson格式")}else if("FeatureCollection"==i.type)if(i.features.length>1)console.log("未识别的格式，请联系柴亚东增加新的geojson格式");else{const o=i.features[0].geometry;if("MultiPolygon"==o.type)for(let i=0;i<o.coordinates.length;i++){const n=o.coordinates[i][0];if(e=N([t.latlon.lon,t.latlon.lat],n),e)break}else if("Polygon"==o.type){const i=o.coordinates[0];e=N([t.latlon.lon,t.latlon.lat],i)}else console.log("未识别的格式，请联系柴亚东增加新的geojson格式")}else console.log("未识别的格式，请联系柴亚东增加新的geojson格式");if(e){const e={latlon:t.latlon,x:t.clientX,y:t.clientY};if(this.fire(t.type,e),this.events&&this.events[t.type].stopPropagation)return!0}return!1}computeIndices(t,e,i){const o=Mt(t,e);if(i>0)for(let t=0;t<o.length;t++)o[t]+=i;return o}initVao(t){this.gl=t,t.useProgram(this.program);const e=this.program;this.drawNum=this.indices.length;let i=t.getAttribLocation(e,"a_position");var o=E(t,new Float32Array(this.vertices)),n=R(t,i,2);this.vao=n,this.vbuffer=o,this.indexbuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexbuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),t.STATIC_DRAW),this.t_scale=t.getUniformLocation(e,"scale"),this.t_oripx=t.getUniformLocation(e,"oripx"),this.t_size=t.getUniformLocation(e,"size");const s=t.getUniformLocation(e,"color");t.uniform4f(s,...this.color)}changeData(t){const e=this.gl;this.data=t,this.computePolygon(),e.bindBuffer(e.ARRAY_BUFFER,this.vbuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.vertices),e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexbuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),e.STATIC_DRAW),this.layerChangeEvent()}render(t){const e=t.context,i=t.zoom,o=t.pxbounds,n=t.drawSize;this.pxbounds=o,e.useProgram(this.program),e.bindVertexArray(this.vao);const s=Math.pow(2,i-8);e.uniform1f(this.t_scale,s),e.uniform2f(this.t_oripx,o.xmin,o.ymin),e.uniform2f(this.t_size,n[0]/devicePixelRatio,n[1]/devicePixelRatio),t.firstDraw&&(e.clear(e.COLOR_BUFFER_BIT),t.firstDraw=!1),e.drawElements(e.TRIANGLES,this.drawNum,e.UNSIGNED_SHORT,0)}destroy(t){const e=t.contexts[this.target].context,i=this.program;e.deleteVertexArray(this.vao),e.deleteBuffer(this.vbuffer),e.deleteBuffer(this.indexbuffer),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i),super.destroy(t)}};class we extends _{constructor(t){super(t),this.index=t.index||f}init(t){this.data=t.data,this.color=t.color||[255,0,0,255],this.sideTopColor=t.sideTopColor||[0,255,255,255],this.sideBottomColor=t.sideBottomColor||[0,125,255,30],this.color=K(this.color),this.sideTopColor=K(this.sideTopColor),this.sideBottomColor=K(this.sideBottomColor),this.offset=t.offset||10}initSelfDraw(t){this.gl=t.contexts[this.target].context,this.initSide(),this.initTop()}initSide(){const{pxs:t,indices:e,types:i}=this.computePolygon(),o=this.gl,n=b(o,"#version 300 es\nin vec2 a_position;\nin float type;\nuniform vec2 oripx;\nuniform vec2 size;\nuniform float scale;\nout float otype;\nvoid main(){\n    vec2 point = a_position.xy * scale;\n    point = point - oripx;\n    point.x = point.x / size.x;\n    point.y = point.y / size.y;\n    point.y = 1.0 - 2.0*point.y;\n    point.x = 2.0*point.x - 1.0;\n\n    otype = type;\n    gl_Position = vec4(point,0.0,1.0);\n}","#version 300 es\nprecision highp float;\nuniform vec4 topcolor;\nuniform vec4 bottomcolor;\nout vec4 outColor;\nin float otype;\nvoid main(){\n    outColor = mix(topcolor,bottomcolor,otype);\n}\n");n||console.log("初始化侧边绘图程序失败"),this.sideProgram=n,o.useProgram(n);const s=o.createVertexArray();o.bindVertexArray(s),this.sideVao=s;let r=o.getAttribLocation(n,"a_position");n.vbuffer=E(o,t),o.enableVertexAttribArray(r),o.vertexAttribPointer(r,2,o.FLOAT,!1,0,0);let a=o.getAttribLocation(n,"type");n.typebuffer=E(o,i),o.enableVertexAttribArray(a),o.vertexAttribPointer(a,1,o.FLOAT,!1,0,0),n.indexbuffer=o.createBuffer(),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,n.indexbuffer),o.bufferData(o.ELEMENT_ARRAY_BUFFER,e,o.STATIC_DRAW);const h=o.getUniformLocation(n,"topcolor");o.uniform4f(h,...this.sideTopColor);const l=o.getUniformLocation(n,"bottomcolor");o.uniform4f(l,...this.sideBottomColor),n.drawNum=e.length}initTop(){const{pxs:t,indices:e}=this.computeTopPolygon(),i=this.gl,o=b(i,"#version 300 es\nin vec2 a_position;\nuniform vec2 oripx;\nuniform vec2 size;\nuniform float scale;\nvoid main(){\n    vec2 point = a_position.xy * scale;\n    point = point - oripx;\n    point.x = point.x / size.x;\n    point.y = point.y / size.y;\n    point.y = 1.0 - 2.0*point.y;\n    point.x = 2.0*point.x - 1.0;\n    gl_Position = vec4(point,0.0,1.0);\n}","#version 300 es\nprecision highp float;\nuniform vec4 color;\nout vec4 outColor;\nvoid main(){\n    outColor = color;\n}\n");o||console.log("初始化侧边绘图程序失败"),this.topProgram=o,i.useProgram(o);const n=i.createVertexArray();i.bindVertexArray(n),this.topVao=n;let s=i.getAttribLocation(o,"a_position");o.vbuffer=E(i,new Float32Array(t)),i.enableVertexAttribArray(s),i.vertexAttribPointer(s,2,i.FLOAT,!1,0,0),o.indexbuffer=i.createBuffer(),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,o.indexbuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,new Uint16Array(e),i.STATIC_DRAW);const r=i.getUniformLocation(o,"color");i.uniform4f(r,...this.color),o.drawNum=e.length}computePolygon(){const t=this.data,e=this.offset;let i,o,s;if("Feature"==t.type){const r=t.geometry;if("Polygon"==r.type){const t=r.coordinates;let a=t[0].length;i=new Float32Array(4*a),o=new Uint16Array(6*(a-1)),s=new Float32Array(2*a);for(let r=0;r<t.length;r++)if(0==r){const r=t[0];for(let t=0;t<r.length-1;t++){const a=n(r[t][1],r[t][0],8);let h=4*t,l=2*t;i[h]=a.x,i[h+1]=a.y,s[l]=0,i[h+2]=a.x,i[h+3]=a.y+e,s[l+1]=1;let c=2*t,u=6*t;o[u]=c,o[u+1]=c+1,o[u+2]=c+2,o[u+3]=c+1,o[u+4]=c+2,o[u+5]=c+3}let a=r.length-1;const h=n(r[a][1],r[a][0],8);let l=4*a,c=2*a;i[l]=h.x,i[l+1]=h.y,s[c]=0,i[l+2]=h.x,i[l+3]=h.y+e,s[c+1]=0}}else"MultiPolygon"==type?r.coordinates:console.log("未识别的格式，请联系柴亚东增加新的geojson格式")}else if("FeatureCollection"==t.type)if(t.features.length>1)console.log("未识别的格式，请联系柴亚东增加新的geojson格式");else{const r=t.features[0].geometry;if("MultiPolygon"==r.type){const t=r.coordinates;let a=0,h=0;for(let e=0;e<t.length;e++)a+=t[e][0].length,h+=6*(t[e][0].length-1);i=new Float32Array(4*a),o=new Uint16Array(h),s=new Float32Array(2*a),h=0;let l=0;for(let r=0;r<t.length;r++){r>0&&(l+=2*t[r-1][0].length,h+=6*(t[r-1][0].length-1));const a=t[r];for(let t=0;t<a.length;t++)if(0==t){const t=a[0];for(let r=0;r<t.length-1;r++){const a=n(t[r][1],t[r][0],8);let c=4*r+2*l,u=2*r+l;i[c]=a.x,i[c+1]=a.y,s[u]=0,i[c+2]=a.x,i[c+3]=a.y+e,s[u+1]=1;let m=2*r+l,d=6*r+h;o[d]=m,o[d+1]=m+1,o[d+2]=m+2,o[d+3]=m+1,o[d+4]=m+2,o[d+5]=m+3}let r=t.length-1;const c=n(t[r][1],t[r][0],8);let u=4*r+2*l,m=2*r+l;i[u]=c.x,i[u+1]=c.y,s[m]=0,i[u+2]=c.x,i[u+3]=c.y+e,s[m+1]=0}}}else"Polygon"==r.type?console.log("未识别的格式，请联系柴亚东增加新的格式"):console.log("未识别的格式，请联系柴亚东增加新的geojson格式")}else console.log("未识别的格式，请联系柴亚东增加新的geojson格式");return{pxs:i,indices:o,types:s}}computeTopPolygon(){const t=this.data;let e;const i=[];let o;if("Feature"==t.type){const s=t.geometry;if("Polygon"==s.type){const t=s.coordinates;e=[];for(let o=0;o<t.length;o++)if(0==o){const i=t[0];for(let t=0;t<i.length;t++){const o=n(i[t][1],i[t][0],8);e.push(o.x,o.y)}}else{i.push(e.length/2);const s=t[o];for(let t=0;t<s.length;t++){const i=n(s[t][1],s[t][0],8);e.push(i.x,i.y)}}o=this.computeIndices(e,i)}else console.log("未识别的格式，请联系柴亚东增加新的geojson格式")}else if("FeatureCollection"==t.type)if(t.features.length>1)console.log("未识别的格式，请联系柴亚东增加新的geojson格式");else{const i=t.features[0].geometry;if("MultiPolygon"==i.type){const t=[],s=[];for(let e=0;e<i.coordinates.length;e++){const o=i.coordinates[e],r=[],a=[];for(let t=0;t<o.length;t++)if(0==t){const t=o[0];for(let e=0;e<t.length;e++){const i=n(t[e][1],t[e][0],8);r.push(i.x,i.y)}}else{a.push(r.length/2);const e=o[t];for(let t=0;t<e.length;t++){const i=n(e[t][1],e[t][0],8);r.push(i.x,i.y)}}const h=t.length/2,l=this.computeIndices(r,a,h);Array.prototype.push.apply(t,r),Array.prototype.push.apply(s,l)}e=t,o=s}else if("Polygon"==i.type){const t=i.coordinates,e=[],o=[];for(let i=0;i<t.length;i++)if(0==i){const i=t[0];for(let t=0;t<i.length;t++){const o=n(i[t][1],i[t][0],8);e.push(o.x,o.y)}}else{o.push(e.length/2);const s=t[i];for(let t=0;t<s.length;t++){const i=n(s[t][1],s[t][0],8);e.push(i.x,i.y)}}this.vertices=e,this.indices=this.computeIndices(e,o)}else console.log("未识别的格式，请联系柴亚东增加新的geojson格式")}else console.log("未识别的格式，请联系柴亚东增加新的geojson格式");return{pxs:e,indices:o}}computeIndices(t,e,i){const o=Mt(t,e);if(i>0)for(let t=0;t<o.length;t++)o[t]+=i;return o}initVao(t){this.gl=t,t.useProgram(this.program);const e=this.program;this.drawNum=this.indices.length;let i=t.getAttribLocation(e,"a_position");var o=E(t,new Float32Array(this.vertices)),n=R(t,i,2);this.vao=n,this.vbuffer=o;let s=t.getAttribLocation(e,"type");this.typebuffer=E(t,new Float32Array(this.types)),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,4,t.FLOAT,!1,0,0),this.indexbuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexbuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),t.STATIC_DRAW),this.t_scale=t.getUniformLocation(e,"scale"),this.t_oripx=t.getUniformLocation(e,"oripx"),this.t_size=t.getUniformLocation(e,"size");const r=t.getUniformLocation(e,"color");t.uniform4f(r,...this.color)}changeData(t){const e=this.gl;this.data=t,this.computePolygon(),e.bindBuffer(e.ARRAY_BUFFER,this.vbuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.vertices),e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexbuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),e.STATIC_DRAW),this.layerChangeEvent()}render(t){const e=t.context,i=t.zoom,o=t.pxbounds,n=t.drawSize;this.pxbounds=o;const s=Math.pow(2,i-8),r=this.sideProgram;e.useProgram(r),e.bindVertexArray(this.sideVao);const a=e.getUniformLocation(r,"scale"),h=e.getUniformLocation(r,"oripx"),l=e.getUniformLocation(r,"size");e.uniform1f(a,s),e.uniform2f(h,o.xmin,o.ymin),e.uniform2f(l,n[0]/devicePixelRatio,n[1]/devicePixelRatio),t.firstDraw&&(e.clear(e.COLOR_BUFFER_BIT),t.firstDraw=!1),e.drawElements(e.TRIANGLES,r.drawNum,e.UNSIGNED_SHORT,0);const c=this.topProgram;e.useProgram(c),e.bindVertexArray(this.topVao);const u=e.getUniformLocation(c,"scale"),m=e.getUniformLocation(c,"oripx"),d=e.getUniformLocation(c,"size");e.uniform1f(u,s),e.uniform2f(m,o.xmin,o.ymin),e.uniform2f(d,n[0]/devicePixelRatio,n[1]/devicePixelRatio),e.drawElements(e.TRIANGLES,c.drawNum,e.UNSIGNED_SHORT,0)}destroy(t){const e=t.contexts[this.target].context;let i=this.sideProgram;e.deleteVertexArray(this.sideVao),e.deleteBuffer(i.vbuffer),e.deleteBuffer(i.indexbuffer),e.deleteBuffer(i.typebuffer),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i),i=this.topProgram,e.deleteVertexArray(this.topVao),e.deleteBuffer(i.vbuffer),e.deleteBuffer(i.indexbuffer),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i),super.destroy(t)}}class _e extends G{constructor(t){super(t)}init(t){this.index=t.index||x,this.pointSize=t.pointSize||20,this.color=t.color,this.data=t.data,this.lineWidth=t.lineWidth,this.shadowWidth=t.shadowWidth,this.shadowColor=t.shadowColor,this.customWind=t.customWind,this.drawWindbar()}computePxInZoom8(){const t=this.data,e=[],i=[],o=[];let s=this.valueFun;for(let r=0;r<t.length;r++){const a=s(t[r].spd);if(-1==a)continue;i.push(a);const h=n(t[r].lat,t[r].lon,8);e.push(h.x,h.y),o.push(t[r].dir)}return{pxs:e,sts:i,angles:o}}valueFun(t){if(0==t)return-1;if(t<=1)return 1;{let e=Math.floor(t/2);return e>20&&(e=20),e}}initVao(t){this.gl=t;const{pxs:e,sts:i,angles:o}=this.computePxInZoom8();this.drawNum=e.length/2,t.useProgram(this.program);const n=t.createVertexArray();t.bindVertexArray(n);const s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW);let r=t.getAttribLocation(this.program,"a_position");t.enableVertexAttribArray(r),t.vertexAttribPointer(r,2,t.FLOAT,!1,0,0),this.vbuffer=s;let a=t.getAttribLocation(this.program,"a_sts");this.stbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.stbuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW),t.enableVertexAttribArray(a),t.vertexAttribPointer(a,1,t.FLOAT,!1,0,0);let h=t.getAttribLocation(this.program,"angle");this.angleBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.angleBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(o),t.STATIC_DRAW),t.enableVertexAttribArray(h),t.vertexAttribPointer(h,1,t.FLOAT,!1,0,0),this.vao=n,this.t_scale=t.getUniformLocation(this.program,"scale"),this.t_oripx=t.getUniformLocation(this.program,"oripx"),this.t_size=t.getUniformLocation(this.program,"size"),this.setUniforms(t)}initSelfDraw(t){this.createDraw(t.contexts[this.target].context,"#version 300 es\nin vec2 a_position;\nin float a_sts;\nin float angle;\nuniform float scale;\nuniform vec2 oripx;\nuniform vec2 size;\nuniform float radius;\nuniform float rto;\n// out float v_radius;\nout float sts;\nout float v_angle;\nvoid main(){\n    vec2 point = a_position*scale;\n    point = point - oripx;\n    point.x = point.x / size.x*rto;\n    point.y = point.y / size.y*rto;\n    point.y = 1.0 - 2.0*point.y;\n    point.x = 2.0*point.x - 1.0;\n    gl_Position = vec4(point,0.0,1.0);\n    gl_PointSize = radius*2.0*rto + 1.0;\n    sts = a_sts;\n    v_angle = angle;\n    // v_radius = radius;\n}","#version 300 es\nprecision highp float;\nin float sts;\nin float v_angle;\nuniform vec4 color;\nuniform sampler2D u_img;\n\nout vec4 outColor;\nvoid main(){\n    float vnum = sts;\n    // float angle = 60.0;\n    float rad = radians(v_angle);\n    float cosrot = cos(rad);\n    float sinrot = sin(rad);\n    mat2 rotMatrix = mat2(cosrot,sinrot,-sinrot,cosrot);\n    vec2 xy = gl_PointCoord - 0.5;\n    xy = xy * rotMatrix;\n    if(abs(xy.x) >sqrt(2.)/4. || abs(xy.y)>sqrt(2.)/4.){\n        // outColor = vec4(0.0,0.0,0.0,1.0);\n        // return;\n        discard;\n    }\n    xy = xy * sqrt(2.);\n    xy +=0.5;\n    xy.y = floor(vnum/5.)/5. + xy.y/5.;\n    xy.x = mod(vnum,5.)/5. + xy.x/5.;\n    outColor = texture(u_img,xy);\n    // outColor = vec4(vnum/20.0,0,0,1.);\n    \n}\n")}setUniforms(t){this.texture=L(t,this.windCanvas,0,!1,!1),this.u_img=t.getUniformLocation(this.program,"u_img");const e=t.getUniformLocation(this.program,"radius");t.uniform1f(e,this.pointSize*Math.sqrt(2)),this.u_rto=t.getUniformLocation(this.program,"rto")}drawWindbar(){this.customWind?(this.windCanvas=this.customWind.img,this.valueFun=this.customWind.valueFun):this.windCanvas=H(this.pointSize,this.color,this.lineWidth,this.shadowWidth,this.shadowColor)}changeData(t){const e=this.gl;this.data=t;const{pxs:i,sts:o,angles:n}=this.computePxInZoom8();e.bindBuffer(e.ARRAY_BUFFER,this.vbuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(i),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.stbuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(o),e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,this.angleBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(n),e.STATIC_DRAW),this.layerChangeEvent()}render(t){const e=t.zoom,i=t.context,o=t.pxbounds,n=t.drawSize;this.zoom=e,this.pxbounds=o,i.useProgram(this.program),i.bindVertexArray(this.vao),devicePixelRatio!=this.devicePixelRatio&&(this.devicePixelRatio=devicePixelRatio,i.uniform1f(this.u_rto,this.devicePixelRatio));const s=Math.pow(2,e-8);i.uniform1f(this.t_scale,s),i.uniform2f(this.t_oripx,o.xmin,o.ymin),i.uniform2f(this.t_size,n[0],n[1]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.texture),i.uniform1i(this.u_img,0),t.firstDraw&&(i.clear(i.COLOR_BUFFER_BIT),t.firstDraw=!1),i.drawArrays(i.POINTS,0,this.drawNum)}destroy(t){if(!this.target)return void console.warn("图层不存在，无法删除");const e=t.contexts[this.target].context;e.deleteVertexArray(this.vao);const i=this.program;e.deleteBuffer(this.vbuffer),e.deleteBuffer(this.stbuffer),e.deleteBuffer(this.angleBuffer),e.deleteTexture(this.spdTexture),e.deleteTexture(this.dirTexture),e.deleteFramebuffer(this.framebuffer),e.detachShader(i,i.vshader),e.detachShader(i,i.fshader),e.deleteShader(i.vshader),e.deleteShader(i.fshader),e.deleteProgram(i),this.frameBuffer&&e.deleteFramebuffer(this.frameBuffer),super.destroy(t)}}class Pe{constructor(t){this.ready=!1,this.galpha=t.galpha,this.global=t.global,this.maxAlpha=this.galpha,this.density=t.density||.04,this.url=t.url,this.latmin=t.latmin,this.latmax=t.latmax,this.lonmin=t.lonmin,this.lonmax=t.lonmax,this.interval=t.interval,this.vscale=t.vscale,this.maxAge=t.maxAge,this.fadeStyle=t.fadeStyle,this.strokeColor=t.strokeColor,this.zIndex=t.index||400,this.data=[],this.columns=[],this.particles=[]}addTo(t){return this._map=t,this.size=t.getSize(),this.size.x*=devicePixelRatio,this.size.y*=devicePixelRatio,this.size.x=Math.round(this.size.x),this.size.y=Math.round(this.size.y),this.wordPx=t.getPxBounds(),this.createElement(),this.setEvent(),this.createParticles(),this.buildData(),this}setEvent(){const t=this._map;this.setPosition=this.setPosition.bind(this),this.setMoveEndPosition=this.setMoveEndPosition.bind(this),this.zoomStartEvent=this.zoomStartEvent.bind(this),t.on("move",this.setPosition),t.on("moveend",this.setMoveEndPosition),t.on("zoomstart",this.zoomStartEvent)}setPosition(){const t=this._map.getPxBounds(),e=this.wordPx.xmin-t.xmin+"px",i=this.wordPx.ymin-t.ymin+"px";this.canvas.style.transform="translate("+e+","+i+")"}setMoveEndPosition(){this.wordPx=this._map.getPxBounds(),this.canvas.style.transform="translate(0px,0px)",this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.galpha=0,setTimeout(function(){cancelAnimationFrame(this.play),this.createParticles(),this.buildColumns(),this.run()}.bind(this),0),this.addAlpha()}zoomStartEvent(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),cancelAnimationFrame(this.play)}createElement(){const t=this._map,e=document.createElement("canvas"),i=this.size;e.width=i.x,e.height=i.y,e.style.position="absolute",e.style.left=0,e.style.top=0,e.style.zIndex=this.zIndex,e.style.pointerEvents="none",e.style.width="100%",e.style.height="100%",t.canvasContent.appendChild(e),this.canvas=e,this.ctx=e.getContext("2d"),this.ctx.fillStyle=this.fadeStyle,this.ctx.strokeStyle=this.strokeColor,this.ctx.lineWidth=3}createParticles(){const t=this.size,e=Math.floor(t.x*t.y*this.density*this.density),i=new Array(e),o=this.maxAge;for(let n=0;n<e;n++){const e=Math.round(Math.random()*t.x),s=Math.round(Math.random()*t.y),r=Math.round(Math.random()*o);i[n]={x:e,y:s,age:r,xt:e,yt:s}}this.particles=i}buildData(t){const e=document.createElement("canvas"),i=e.getContext("2d"),o=new Image;o.crossOrigin="anonymous",o.onload=function(){e.width=o.width,e.height=o.height,i.drawImage(o,0,0);const n=i.getImageData(0,0,o.width,o.height),s=this.global,r=new Array(o.height-1),a=n.data[0],h=n.data[1],l=n.data[4],c=n.data[5];for(let t=0;t<o.height-1;t++){r[t]=new Array(o.width);for(let e=0;e<o.width;e++){const i=4*((t+1)*o.width+e),s=[n.data[i]/h-a,n.data[i+1]/c-l];r[t][e]=s}s&&r[t].push(r[t][0])}this.data=r,this.buildColumns(),this.ready=!0,this.run(),t&&this.addAlpha()}.bind(this),o.src=this.url}buildColumns(){const t=this._map,e=this.size,i=t.getZoom(),o=this.latmin,n=this.lonmin,s=this.latmax,r=this.lonmax,a=this.data,h=new Array(e.y),l=this.vscale,c=this._map.getPxBounds(),u=c.xmin,m=c.ymin,d=this.interval,f=256*Math.pow(2,i),x=2*Math.PI,p=360/Math.PI;for(let t=0;t<e.y;t+=2){const i=new Array(e.x);for(let h=0;h<e.x;h+=2){const e=360*((u+h/devicePixelRatio)/f-.5),c=-((m+t/devicePixelRatio)/f-.5)*x;let y=Math.atan(Math.exp(c))*p-90,g=e%360;if(g=g>=0?g:g+360,y<o||y>s||g<n||g>r){i[h]=i[h+1]=[0,0,0];continue}const v=(g-n)/d,T=(y-o)/d,b=Math.floor(T),E=Math.floor(v),R=a[b][E],L=a[b][E+1],w=a[b+1][E],_=a[b+1][E+1],P=v-E,S=T-b,M=(1-P)*(1-S),A=P*(1-S),Z=S*(1-P),U=P*S,z=(R[0]*M+L[0]*A+w[0]*Z+_[0]*U)*l,C=-(R[1]*M+L[1]*A+w[1]*Z+_[1]*U)*l;i[h]=i[h+1]=[z,C,Math.sqrt(z*z+C*C)]}h[t]=h[t+1]=i}this.columns=h}addAlpha(){this.galpha+=.017,this.galpha>this.maxAlpha?this.galpha=this.maxAlpha:window.requestAnimationFrame(this.addAlpha.bind(this))}draw(){const t=this.size,e=this.maxAge;var i=this.ctx;i.globalCompositeOperation="destination-in",i.fillRect(0,0,t.x,t.y),i.globalCompositeOperation="lighter",i.globalAlpha=this.galpha,i.beginPath();const o=Array.from(this.particles),n=this.columns;for(let s=0;s<o.length;s++){const r=o[s];if(r.age>e){r.age=0;const e=Math.round(Math.random()*t.x),i=Math.round(Math.random()*t.y);r.x=r.xt=e,r.y=r.yt=i}const a=Math.round(r.xt);let h=n[Math.round(r.yt)];h?(h=h[a],h&&h[2]?(r.x=r.xt,r.y=r.yt,r.xt=r.x+h[0],r.yt=r.y+h[1],i.moveTo(r.x,r.y),i.lineTo(r.xt,r.yt),r.age=r.age+1):r.age=e+1):r.age=e+1}i.stroke()}run(){this.draw(),this.play=window.requestAnimationFrame(this.run.bind(this))}changeData(t){cancelAnimationFrame(this.play),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.galpha=0,this.url=t,this.ready=!1,this.createParticles(),this.buildData(!0)}destroy(){if(this.destroyed)return"图层已经删除，不需要重复删除";const t=this._map;t.off("zoomstart",this.zoomStartEvent),t.off("move",this.setPosition),t.off("moveend",this.setMoveEndPosition),cancelAnimationFrame(this.play),t.canvasContent.removeChild(this.canvas);for(let t in this)delete this[t];this.destroyed=!0}}class Se extends P{constructor(t){super(t),this.index=t.index||m,this.colors=t.colors,this.linear=t.linear||.1,this.minst=1/258,this.maxst=257/258,this.minOpacity=t.minOpacity,this.scale=t.scale}resetTileUrl(t){const e=this.cachedTiles[t],i=this.tileUrlFunction(e.z,e.tx,e.y),o=this.gl;return new Promise((t=>{const n=new Image;n.onload=function(){var i=o.createTexture();o.bindTexture(o.TEXTURE_2D,i),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,n),e.source=i,t("suc")},n.onerror=function(){e.source=null,t("suc")},n.src=i}))}changeUrl(t){this.url=t;let e=this.zoom;e>this.maxTileZoom&&(e=this.maxTileZoom);for(let t in this.cachedTiles)this.cachedTiles[t].z!=e&&delete this.cachedTiles[t];let i=[];for(let t in this.cachedTiles)i.push(this.resetTileUrl(t));Promise.all(i).then((t=>{this.layerChangeEvent()}))}initSelfDraw(t){this.createDraw(t.contexts[this.target].context,"#version 300 es\n        in vec4 a_position;\n        in vec2 st;\n        out vec2 v_st;\n        void main(){\n            v_st = st;\n            gl_Position = a_position;\n        }","#version 300 es\n        precision highp float;\n        uniform sampler2D img;\n        uniform sampler2D u_color;\n        uniform vec2 vrange;\n        in vec2 v_st;\n        out vec4 outColor;\n        uniform bool minOpacity;\n        uniform vec3 scale;\n        void main(){\n            // outColor = vec4(v_st, 0., 1.0);\n            vec4 color = texture(img,v_st);\n            float value = color.r*255.*scale.x + color.g*255.*scale.y + color.b*255.*scale.z;\n            // value = 5.0;\n            float vin = (value - vrange.x)/(vrange.y -vrange.x);\n            outColor = texture(u_color,vec2(vin,0.5));\n            if(minOpacity){\n                float o = (value - vrange.x*0.8)/0.5/vrange.x;\n                o = max(o,0.0);\n                o = min(o,1.0);\n                outColor.a = outColor.a *o;\n            }\n        }\n        ")}initVao(t){super.initVao(t),this.gl=t,t.useProgram(this.program);const e=B(this.colors,this.linear);this.colorTexture=L(t,e.canvas,1),this.u_color=t.getUniformLocation(this.program,"u_color"),t.uniform1i(this.u_color,1),this.vrange=t.getUniformLocation(this.program,"vrange"),t.uniform2f(this.vrange,e.vmin,e.vmax);const i=t.getUniformLocation(this.program,"minOpacity");t.uniform1f(i,this.minOpacity);const o=t.getUniformLocation(this.program,"scale");t.uniform3f(o,this.scale.r,this.scale.g,this.scale.b)}}class Me extends v{constructor(t){super(t),this.version=t.version||"1.1.0",this.format=t.format||"image/png",this.layers=t.layers,this.wmsKeys=t.wmsKeys||{},"createUrlFun"in t&&(this.createUrlFun=t.createUrlFun.bind(this)),this.createUrlFun()}createUrlFun(){let t=this.url;t=t+"?service=WMS&request=GetMap&layers="+this.layers+"&styles=&format="+this.format+"&transparent=true&version="+this.version;for(let e in this.wmsKeys)t+="&"+e+"="+this.wmsKeys[e];t+="&width=256&height=256&srs=EPSG%3A3857&bbox=",this.url=t}tileUrlFunction(t,e,i){let o=this.url;const n=function(t,e,i){const o=256*t,n=o+256,s=256*e;return{minLatlon:a(o,s+256,i),maxLatlon:a(n,s,i)}}(e,i,t),s=r(n.minLatlon.lat,n.minLatlon.lon),h=r(n.maxLatlon.lat,n.maxLatlon.lon);return o=o+s.x+","+s.y+","+h.x+","+h.y,o}}class Ae{constructor(t){this.initGl()}initGl(){let t=document.createElement("canvas").getContext("webgl2");this.gl=t,this.framebuffer=t.createFramebuffer(),this.datatexture=t.createTexture(),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer)}getdata(t,e){const i=new Array(t.height);for(let e=0;e<i.length;e++)i[e]=new Array(t.width);const o=e.scale,n=this.gl;n.activeTexture(n.TEXTURE0),e.flipy?n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,1):n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,0),n.bindTexture(n.TEXTURE_2D,this.datatexture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.datatexture,0);const s=new Uint8Array(t.width*t.height*4);n.readPixels(0,0,t.width,t.height,n.RGBA,n.UNSIGNED_BYTE,s);for(let e=0;e<s.length;e+=4){const n=s[e]/o.r+s[e+1]/o.g+s[e+2]/o.b+s[e+3]/o.a,r=e/4,a=Math.floor(r/t.width),h=r%t.width;i[t.height-a-1][h]=n}return i}getImgData(t,e){return new Promise((i=>{if(t instanceof HTMLImageElement){let o=this.getdata(t,e);i(o)}else{const o=new Image;e.useCros&&(o.crossOrigin="anonymous"),o.onload=function(){let t=this.getdata(o,e);i(t)}.bind(this),o.src=t}}))}destroy(){try{this.gl.deleteBuffer(this.framebuffer),this.gl.deleteTexture(this.datatexture),this.gl.getExtension("WEBGL_lose_context").loseContext(),this.gl=null}catch{cydEvent.cydWarn("webgl删除失败")}}}
/*!
* MarchingSquaresJS
* version 1.3.3
* https://github.com/RaumZeit/MarchingSquares.js
*
* @license GNU Affero General Public License.
* Copyright (c) 2015-2019 Ronny Lorenz <ronny@tbi.univie.ac.at>
*/function Ze(t,e,i){return t<e?(i-t)/(e-t):(t-i)/(t-e)}function Ue(){this.successCallback=null,this.verbose=!1,this.polygons=!1,this.polygons_full=!1,this.linearRing=!1,this.noQuadTree=!1,this.noFrame=!1}function ze(t,e,i,o){var n=[];return t.polygons.forEach((function(t){t.forEach((function(t){t[0]+=e,t[1]+=i})),o.linearRing&&t.push(t[0]),n.push(t)})),n}function Ce(t,e,i,o){return 0===i?(t+=1,e+=o[0][1]):1===i?t+=o[0][0]:2===i?e+=o[0][1]:3===i&&(t+=o[0][0],e+=1),[t,e]}function Xe(t,e,i){return 0===i?t++:1===i||(2===i?e++:3===i&&(t++,e++)),[t,e]}function Ge(t,e,i,o,n){var s=o,r=n,a=0,h=0;if(this.x=e,this.y=i,this.lowerBound=null,this.upperBound=null,this.childA=null,this.childB=null,this.childC=null,this.childD=null,1===o&&1===n)this.lowerBound=Math.min(t[i][e],t[i][e+1],t[i+1][e+1],t[i+1][e]),this.upperBound=Math.max(t[i][e],t[i][e+1],t[i+1][e+1],t[i+1][e]);else{if(o>1){for(;0!==s;)s>>=1,a++;o===1<<a-1&&a--,s=1<<a-1}if(n>1){for(;0!==r;)r>>=1,h++;n===1<<h-1&&h--,r=1<<h-1}this.childA=new Ge(t,e,i,s,r),this.lowerBound=this.childA.lowerBound,this.upperBound=this.childA.upperBound,o-s>0&&(this.childB=new Ge(t,e+s,i,o-s,r),this.lowerBound=Math.min(this.lowerBound,this.childB.lowerBound),this.upperBound=Math.max(this.upperBound,this.childB.upperBound),n-r>0&&(this.childC=new Ge(t,e+s,i+r,o-s,n-r),this.lowerBound=Math.min(this.lowerBound,this.childC.lowerBound),this.upperBound=Math.max(this.upperBound,this.childC.upperBound))),n-r>0&&(this.childD=new Ge(t,e,i+r,s,n-r),this.lowerBound=Math.min(this.lowerBound,this.childD.lowerBound),this.upperBound=Math.max(this.upperBound,this.childD.upperBound))}}function Fe(t){var e,i;if(!t)throw new Error("data is required");if(!Array.isArray(t)||!Array.isArray(t[0]))throw new Error("data must be scalar field, i.e. array of arrays");if(t.length<2)throw new Error("data must contain at least two rows");if((i=t[0].length)<2)throw new Error("data must contain at least two columns");for(e=1;e<t.length;e++){if(!Array.isArray(t[e]))throw new Error("Row "+e+" is not an array");if(t[e].length!=i)throw new Error("unequal row lengths detected, please provide a regular grid")}this.data=t,this.root=new Ge(t,0,0,t[0].length-1,t.length-1)}function Ie(t,e,i){var o,n,s,r=!1,a=!1,h=null,l=null,c=null,u=null,m=null,d=[];if(!t)throw new Error("data is required");if(null==e)throw new Error("threshold is required");if(i&&"object"!=typeof i)throw new Error("options must be an object");if(o=function(t){var e,i,o,n,s;for(n=new Ue,t=t||{},s=Object.keys(n),e=0;e<s.length;e++)typeof(o=t[i=s[e]])<"u"&&null!==o&&(n[i]=o);return n.polygons_full=!n.polygons,n.interpolate=Ze,n}(i),t instanceof Fe)h=t,l=t.root,c=t.data,o.noQuadTree||(r=!0);else{if(!Array.isArray(t)||!Array.isArray(t[0]))throw new Error("input is neither array of arrays nor object retrieved from 'QuadTree()'");c=t}if(Array.isArray(e)){for(a=!0,o.noQuadTree||(r=!0),n=0;n<e.length;n++)if(isNaN(+e[n]))throw new Error("threshold["+n+"] is not a number")}else{if(isNaN(+e))throw new Error("threshold must be a number or array of numbers");e=[e]}return r&&!l&&(h=new Fe(c),l=h.root,c=h.data),e.forEach((function(t,e){if(m=[],o.threshold=t,o.polygons)if(r)l.cellsBelowThreshold(o.threshold,!0).forEach((function(t){m=m.concat(ze(De(c,t.x,t.y,o),t.x,t.y,o))}));else for(s=0;s<c.length-1;++s)for(e=0;e<c[0].length-1;++e)m=m.concat(ze(De(c,e,s,o),e,s,o));else{for(u=[],e=0;e<c[0].length-1;++e)u[e]=[];if(r)l.cellsBelowThreshold(o.threshold,!1).forEach((function(t){u[t.x][t.y]=De(c,t.x,t.y,o)}));else for(e=0;e<c[0].length-1;++e)for(s=0;s<c.length-1;++s)u[e][s]=De(c,e,s,o);m=function(t,e,i){var o,n,s,r,a,h,l,c,u,m,d,f,x,p,y,g=[],v=t.length-1,T=t[0].length-1,b=["right","bottom","left","top"],E=[0,-1,0,1],R=[-1,0,1,0],L={bottom:1,left:2,top:3,right:0};return e.forEach((function(t,w){t.forEach((function(t,_){if(t&&0!=Object.keys(t.edges).length)for(n=0;n<4;n++)if(o=b[n],"object"==typeof t.edges[o]){for(a=[],s=t.edges[o],h=o,l=w,c=_,u=!1,m=[w+s.path[0][0],_+s.path[0][1]],a.push(m);!u&&"object"==typeof(r=e[l][c]).edges[h];)if(s=r.edges[h],delete r.edges[h],(d=s.path[1])[0]+=l,d[1]+=c,a.push(d),h=s.move.enter,l+=s.move.x,c+=s.move.y,typeof e[l]>"u"||typeof e[l][c]>"u"){if(!i.linearRing)break;if(f=0,x=0,l===T?(l--,f=0):l<0?(l++,f=2):c===v?(c--,f=3):c<0&&(c++,f=1),l===w&&c===_&&f===L[o]){u=!0,h=o;break}for(;;){if(p=!1,x>4)throw new Error("Direction change counter overflow! This should never happen!");if(!(typeof e[l]>"u"||typeof e[l][c]>"u")&&(r=e[l][c],y=b[f],"object"==typeof r.edges[y])){s=r.edges[y],a.push(Ce(l,c,f,s.path)),h=y,p=!0;break}if(p)break;if(a.push(Xe(l,c,f)),c+=R[f],(typeof e[l+=E[f]]>"u"||typeof e[l][c]>"u")&&(0===f&&c<0||1===f&&l<0||2===f&&c===v||3===f&&l===T)&&(l-=E[f],c-=R[f],f=(f+1)%4,x++),l===w&&c===_&&f===L[o]){u=!0,h=o;break}}}g.push(a)}}))})),g}(c,u,o)}a?d.push(m):d=m})),d}function De(t,e,i,o){var n,s,r,a,h,l=0,c=t[i+1][e],u=t[i+1][e+1],m=t[i][e+1],d=t[i][e],f=o.threshold;if(!(d<=-99||m<=-99||u<=-99||c<=-99)){switch(l|=c>=f?8:0,l|=u>=f?4:0,l|=m>=f?2:0,h={cval:l=+(l|=d>=f?1:0),polygons:[],edges:{},x0:d,x1:m,x2:u,x3:c},l){case 0:case 15:break;case 14:n=o.interpolate(d,c,f),a=o.interpolate(d,m,f),h.edges.left={path:[[0,n],[a,0]],move:{x:0,y:-1,enter:"top"}};break;case 13:a=o.interpolate(d,m,f),s=o.interpolate(m,u,f),h.edges.bottom={path:[[a,0],[1,s]],move:{x:1,y:0,enter:"left"}};break;case 11:s=o.interpolate(m,u,f),r=o.interpolate(c,u,f),h.edges.right={path:[[1,s],[r,1]],move:{x:0,y:1,enter:"bottom"}};break;case 7:n=o.interpolate(d,c,f),r=o.interpolate(c,u,f),h.edges.top={path:[[r,1],[0,n]],move:{x:-1,y:0,enter:"right"}};break;case 1:n=o.interpolate(d,c,f),a=o.interpolate(d,m,f),h.edges.bottom={path:[[a,0],[0,n]],move:{x:-1,y:0,enter:"right"}};break;case 2:a=o.interpolate(d,m,f),s=o.interpolate(m,u,f),h.edges.right={path:[[1,s],[a,0]],move:{x:0,y:-1,enter:"top"}};break;case 4:s=o.interpolate(m,u,f),r=o.interpolate(c,u,f),h.edges.top={path:[[r,1],[1,s]],move:{x:1,y:0,enter:"left"}};break;case 8:n=o.interpolate(d,c,f),r=o.interpolate(c,u,f),h.edges.left={path:[[0,n],[r,1]],move:{x:0,y:1,enter:"bottom"}};break;case 12:n=o.interpolate(d,c,f),s=o.interpolate(m,u,f),h.edges.left={path:[[0,n],[1,s]],move:{x:1,y:0,enter:"left"}};break;case 9:a=o.interpolate(d,m,f),r=o.interpolate(c,u,f),h.edges.bottom={path:[[a,0],[r,1]],move:{x:0,y:1,enter:"bottom"}};break;case 3:n=o.interpolate(d,c,f),s=o.interpolate(m,u,f),h.edges.right={path:[[1,s],[0,n]],move:{x:-1,y:0,enter:"right"}};break;case 6:a=o.interpolate(d,m,f),r=o.interpolate(c,u,f),h.edges.top={path:[[r,1],[a,0]],move:{x:0,y:-1,enter:"top"}};break;case 10:n=o.interpolate(d,c,f),s=o.interpolate(m,u,f),a=o.interpolate(d,m,f),r=o.interpolate(c,u,f),(d+m+u+c)/4<f?(h.edges.left={path:[[0,n],[r,1]],move:{x:0,y:1,enter:"bottom"}},h.edges.right={path:[[1,s],[a,0]],move:{x:0,y:-1,enter:"top"}}):(h.edges.right={path:[[1,s],[r,1]],move:{x:0,y:1,enter:"bottom"}},h.edges.left={path:[[0,n],[a,0]],move:{x:0,y:-1,enter:"top"}});break;case 5:n=o.interpolate(d,c,f),s=o.interpolate(m,u,f),a=o.interpolate(d,m,f),r=o.interpolate(c,u,f),(d+m+u+c)/4<f?(h.edges.bottom={path:[[a,0],[0,n]],move:{x:-1,y:0,enter:"right"}},h.edges.top={path:[[r,1],[1,s]],move:{x:1,y:0,enter:"left"}}):(h.edges.top={path:[[r,1],[0,n]],move:{x:-1,y:0,enter:"right"}},h.edges.bottom={path:[[a,0],[1,s]],move:{x:1,y:0,enter:"left"}})}return h}}function We(t,e,i){t.points.push([(2*t._x0+t._x1)/3,(2*t._y0+t._y1)/3]),t.points.push([(t._x0+2*t._x1)/3,(t._y0+2*t._y1)/3]),t.points.push([(t._x0+4*t._x1+e)/6,(t._y0+4*t._y1+i)/6])}function Be(){this.points=[]}function Ye(t){let e=t.data;const i=t.values,o=t.smooth,n=Ie(e,i,{linearRing:!1}),s=t.latmin,r=(t.latmax-s)/(t.latnum-1),a=t.lonmin,h=(t.lonmax-a)/(t.lonnum-1);let l={type:"FeatureCollection",features:[]};for(let t=0;t<n.length;t++){const e=n[t];for(let t=e.length-2;t>=0;t--){const i=e[t+1],o=e[t];o[0][0]==i[i.length-1][0]&&o[0][1]==i[i.length-1][1]&&(o.shift(),e[t+1]=i.concat(o),e.splice(t,1))}for(let t=0;t<e.length;t++){const i=e[t];if(o){const o=new Be;o.lineStart();for(let t=0;t<i.length;t++)o.point(i[t][0],i[t][1]);o.lineEnd();const n=o.points;for(let t=0;t<n.length;t++)n[t][0]=a+n[t][0]*h,n[t][1]=s+n[t][1]*r;if(n.length<=1)continue;e[t]=n}else for(let t=0;t<i.length;t++)i[t][0]=a+i[t][0]*h,i[t][1]=s+i[t][1]*r}l.features[t]={type:"Feature",geometry:{type:"MultiLineString",coordinates:e},properties:{value:i[t]}}}return l}function Ke(t,e=5,i=1){if(e%2==0)throw new Error("Kernel size must be odd number");if(!t||0===t.length||0===t[0].length)return[];const o=function(t,e=1){const i=[],o=Math.floor(t/2);let n=0;for(let s=0;s<t;s++){i[s]=[];for(let r=0;r<t;r++){const t=s-o,a=r-o,h=Math.exp(-(t*t+a*a)/(2*e*e));i[s][r]=h,n+=h}}for(let e=0;e<t;e++)for(let o=0;o<t;o++)i[e][o]/=n;return i}(e,i),n=Math.floor(e/2),s=t.length,r=t[0].length,a=new Array(s).fill(0).map((()=>new Array(r).fill(0)));for(let e=0;e<s;e++)for(let i=0;i<r;i++){let h=0,l=!0;for(let a=-n;a<=n&&l;a++)for(let c=-n;c<=n;c++){const u=e+a,m=i+c,d=Math.max(0,Math.min(s-1,u)),f=Math.max(0,Math.min(r-1,m)),x=o[a+n][c+n];if(t[d][f]<=-99){h=t[e][i],l=!1;break}h+=t[d][f]*x}a[e][i]=h}return a}function Ne(t,e){return t[1]-e[1]}function Ve(t,e){let i=[];const o=new ie(t,Ne);for(;o.length;){const t=o.pop();if(i.push(t),i.length===e)return i}return i}function ke(t){const e=t.data,i=t.power||2,o=t.maxNum,n=t.range,s=t.gs,r=t.gsSize,a=t.gsSigma;function h(t){let o=0,n=0;for(const s of t){if(0==s[1])return e[s[0]].value;const t=1/Math.pow(s[1],i);o+=t*e[s[0]].value,n+=t}return o/n}const l=t.latmin,c=t.latmax,u=t.lonmin,m=t.lonmax,d=t.interval,f=Math.round((c-l)/d+1),x=Math.round((m-u)/d+1),p=new Array(f);for(let t=0;t<f;t++)p[t]=new Array(x);const y=new Ht(e.length,32);for(const{lon:t,lat:i}of e)y.add(t,i);y.finish();for(let t=0;t<f;t++){const e=l+t*d;for(let i=0;i<x;i++){const s=u+i*d;let r=y.within(s,e,n);(o&&(r=Ve(r,o)),0!=r.length)?p[t][i]=h(r):p[t][i]=-99}}return s?Ke(p,r,a):p}Ge.prototype.cellsInBand=function(t,e,i){var o=[];return i=typeof i>"u"||i,this.lowerBound>e||this.upperBound<t||(this.childA||this.childB||this.childC||this.childD?(this.childA&&(o=o.concat(this.childA.cellsInBand(t,e,i))),this.childB&&(o=o.concat(this.childB.cellsInBand(t,e,i))),this.childD&&(o=o.concat(this.childD.cellsInBand(t,e,i))),this.childC&&(o=o.concat(this.childC.cellsInBand(t,e,i)))):(i||this.lowerBound<=t||this.upperBound>=e)&&o.push({x:this.x,y:this.y})),o},Ge.prototype.cellsBelowThreshold=function(t,e){var i=[];return e=typeof e>"u"||e,this.lowerBound>t||(this.childA||this.childB||this.childC||this.childD?(this.childA&&(i=i.concat(this.childA.cellsBelowThreshold(t,e))),this.childB&&(i=i.concat(this.childB.cellsBelowThreshold(t,e))),this.childD&&(i=i.concat(this.childD.cellsBelowThreshold(t,e))),this.childC&&(i=i.concat(this.childC.cellsBelowThreshold(t,e)))):(e||this.upperBound>=t)&&i.push({x:this.x,y:this.y})),i},Be.prototype={areaStart:function(){this._line=0},areaEnd:function(){this._line=NaN},lineStart:function(){this._x0=this._x1=this._y0=this._y1=NaN,this._point=0},lineEnd:function(){switch(this._point){case 3:We(this,this._x1,this._y1);case 2:this.points.push([this._x1,this._y1])}},point:function(t,e){switch(t=+t,e=+e,this._point){case 0:this._point=1,this.points.push([t,e]);break;case 1:this._point=2;break;case 2:this._point=3,this.points.push([(5*this._x0+this._x1)/6,(5*this._y0+this._y1)/6]);default:We(this,t,e)}this._x0=this._x1,this._x1=t,this._y0=this._y1,this._y1=e}};class He extends Ee{constructor(t){super(t)}init(t){this.index=t.index||x,this.pointSize=t.pointSize||5,this.data=t.data,this.color=t.color||"black",this.deciNum=t.deciNum||50,this.minZoom=t.minZoom||5,this.useSort=t.useSort,this.lineWidth=t.lineWidth||1,this.shadowWidth=t.shadowWidth,this.shadowColor=t.shadowColor,this.useSort=t.useSort,this.sortKey=t.sortKey||"value",this.customWind=t.customWind,this.showTexts=t.showTexts,this.textKey=t.textKey,this.fontSize=t.fontSize||16,this.fontWeight=t.fontWeight||500,this.textOffset=t.textOffset||[0,0],this.strokeWidth=t.strokeWidth,this.strokeColor=t.strokeColor,this.fontColor=t.fontColor||"black",t.getValue&&(this.getValue=t.getValue),this.showZero=!("showZero"in t)||t.showZero,this.textsMap={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10,"-":11},this.rbush=new ae,this.useSort&&this.buildQueen(),this.drawWindbar()}initVao(t){this.gl=t;let e=this.programs.wind;t.useProgram(e);const i=t.createVertexArray();t.bindVertexArray(i);const o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o);let n=t.getAttribLocation(e,"a_position");t.enableVertexAttribArray(n),t.vertexAttribPointer(n,2,t.FLOAT,!1,0,0),e.vbuffer=o;let s=t.getAttribLocation(e,"a_sts");e.stbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.stbuffer),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,1,t.FLOAT,!1,0,0);let r=t.getAttribLocation(e,"angle");if(e.angleBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e.angleBuffer),t.enableVertexAttribArray(r),t.vertexAttribPointer(r,1,t.FLOAT,!1,0,0),e.vao=i,this.u_scale=t.getUniformLocation(e,"scale"),this.u_oripx=t.getUniformLocation(e,"oripx"),this.u_size=t.getUniformLocation(e,"size"),this.showTexts){const e=this.createTextTexture(),i=this.programs.texts,o=t.createVertexArray();t.bindVertexArray(o);const n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n);let s=t.getAttribLocation(i,"a_position");t.enableVertexAttribArray(s),t.vertexAttribPointer(s,3,t.FLOAT,!1,0,0),i.vbuffer=n;let r=t.getAttribLocation(i,"sts");i.stbuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i.stbuffer),t.enableVertexAttribArray(r),t.vertexAttribPointer(r,2,t.FLOAT,!1,0,0),i.vao=o,t.useProgram(i),this.textTexture=L(t,e,0,!0,!1)}this.setUniforms(t),this.computePointsStatic()}initSelfDraw(t){this.programs={},this.programs.wind=b(t.contexts[this.target].context,"#version 300 es\nin vec2 a_position;\nin float a_sts;\nin float angle;\nuniform float scale;\nuniform vec2 oripx;\nuniform vec2 size;\nuniform float radius;\nuniform float rto;\n// out float v_radius;\nout float sts;\nout float v_angle;\nvoid main(){\n    vec2 point = a_position*scale;\n    point = point - oripx;\n    point.x = point.x / size.x*rto;\n    point.y = point.y / size.y*rto;\n    point.y = 1.0 - 2.0*point.y;\n    point.x = 2.0*point.x - 1.0;\n    gl_Position = vec4(point,0.0,1.0);\n    gl_PointSize = radius*2.0*rto + 1.0;\n    sts = a_sts;\n    v_angle = angle;\n    // v_radius = radius;\n}","#version 300 es\nprecision highp float;\nin float sts;\nin float v_angle;\nuniform sampler2D u_img;\n\nout vec4 outColor;\nvoid main(){\n    float vnum = sts;\n    float rad = radians(v_angle);\n    float cosrot = cos(rad);\n    float sinrot = sin(rad);\n    mat2 rotMatrix = mat2(cosrot,sinrot,-sinrot,cosrot);\n    vec2 xy = gl_PointCoord - 0.5;\n    xy = xy * rotMatrix;\n    if(abs(xy.x) >sqrt(2.)/4. || abs(xy.y)>sqrt(2.)/4.){\n        discard;\n    }\n    xy = xy * sqrt(2.);\n    xy +=0.5;\n    xy.y = floor(vnum/5.)/5. + xy.y/5.;\n    xy.x = mod(vnum,5.)/5. + xy.x/5.;\n    outColor = texture(u_img,xy);\n    \n}\n"),this.showTexts&&(this.programs.texts=b(t.contexts[this.target].context,"#version 300 es\n        in vec3 a_position;\n        in vec2 sts;\n        // in float angle;\n        uniform float scale;\n        uniform vec2 oripx;\n        uniform vec2 size;\n        uniform float fontSize;\n        uniform float rto;\n        uniform vec2 offset;\n        out float v_sts;\n        void main(){\n            vec2 off = vec2(offset.x,offset.y);\n            vec2 point = a_position.xy*scale;\n            point.x = point.x + offset.x;\n            if(sts.y==1.){\n             point.y = point.y - offset.y;\n            }else{\n            point.y = point.y + offset.y;\n            }\n            point = point - oripx;\n            \n            // point = vec2(500.0);\n            point.x = (point.x+ a_position.z)*rto/ size.x;\n            point.y = point.y*rto / size.y;\n            point.y = 1.0 - 2.0*point.y;\n            point.x = 2.0*point.x - 1.0;\n            gl_Position = vec4(point,0.0,1.0);\n            // gl_Position = a_position;\n            gl_PointSize = fontSize*rto;\n            v_sts = sts.x;\n        }","#version 300 es\n        precision highp float;\n        uniform sampler2D u_img;\n        // uniform float n;\n        out vec4 outColor;\n        in float v_sts;\n        void main(){\n            float n = 12.;\n            vec2 xy = gl_PointCoord.xy;\n            xy.x = xy.x/n;\n            xy.x += v_sts/n;\n            // xy.y += floor(v_sts/n)/n;\n            outColor = texture(u_img,xy);\n            // outColor = vec4(1.,0,0,1.);\n        }\n        ")),this.initVao(t.contexts[this.target].context)}setUniforms(t){const e=this.programs.wind;t.useProgram(e),this.texture=L(t,this.windCanvas,0,!1,!1),this.u_img=t.getUniformLocation(this.programs.wind,"u_img");const i=t.getUniformLocation(this.programs.wind,"radius");if(t.uniform1f(i,this.pointSize*Math.sqrt(2)),this.u_rto=t.getUniformLocation(this.programs.wind,"rto"),this.showTexts){const e=this.programs.texts;t.useProgram(e),this.t_scale=t.getUniformLocation(e,"scale"),this.t_oripx=t.getUniformLocation(e,"oripx"),this.t_size=t.getUniformLocation(e,"size"),this.t_img=t.getUniformLocation(e,"u_img");const i=t.getUniformLocation(e,"fontSize");t.uniform1f(i,this.fontSize),this.t_rto=t.getUniformLocation(e,"rto");const o=t.getUniformLocation(e,"offset");t.uniform2f(o,...this.textOffset)}}valueFun(t){if(0==t)return-1;if(t<=1)return 0;{let e=Math.floor(t/2);return e>20&&(e=20),e}}computePointsStatic(){const t=this.textsMap,e=this.mesureCanvas,i=this.getValue,o=[];if(this.valueFun,this.useSort){let s=this.q;for(;s.length;){const r=s.pop(),a=r.lat,h=r.lon,l=n(a,h,8);let c,u=this.valueFun(r.spd);if(-1==u)continue;c=r.dir;let m=c>=90&&c<=270?1:0,d=[],f=[];if(this.showTexts){const o=i(r.spd),n=o.length;let s=-e.measureText(o).width/2;const a=o.charAt(0);s+=e.measureText(a).width/2,d.push(l.x,l.y,s),f.push(t[a],m);for(let i=1;i<n;i++){const n=o.charAt(i-1),r=o.charAt(i);s+=e.measureText(r).width/2+e.measureText(n).width/2,d.push(l.x,l.y,s),f.push(t[r],m)}}o.push({px:l,sts:u,lat:a,lon:h,angles:c,tsts:f,tpxs:d})}this.q=null}else{let s=this.data;for(let r=0;r<s.length;r++){const a=s[r],h=a.lat,l=a.lon,c=n(h,l,8);let u,m=this.valueFun(a.spd);if(-1==m)continue;u=a.dir;let d=u>=90&&u<=270?1:0,f=[],x=[];if(this.showTexts){const o=i(a.spd),n=o.length;let s=-e.measureText(o).width/2;const r=o.charAt(0);s+=e.measureText(r).width/2,f.push(c.x,c.y,s),x.push(t[r],d);for(let i=1;i<n;i++){const n=o.charAt(i-1),r=o.charAt(i);s+=e.measureText(r).width/2+e.measureText(n).width/2,f.push(c.x,c.y,s),x.push(t[r],d)}}o.push({px:c,sts:m,lat:h,lon:l,angles:u,tpxs:f,tsts:x})}}this.computePointsByZoomSort(o)}computePoints(t,e){t=Math.round(t);let i=[],o=[],n=[],s=[],r=[],a=this.minZoom;t<a&&(t=a);for(let h=a;h<=t;h++){let t=this.drawZoomData[h];if(t)for(let a=0;a<t.length;a++){let h=t[a].lat,l=t[a].lon;h<e.latlngMin.lat||h>e.latlngMax.lat||l<e.latlngMin.lon||l>e.latlngMax.lon||(i.push(t[a].px.x,t[a].px.y),o.push(t[a].sts),n.push(t[a].angles),Array.prototype.push.apply(s,t[a].tsts),Array.prototype.push.apply(r,t[a].tpxs))}}return i.length==this.pxlength?{stateChange:!1}:(this.pxlength=i.length,{stateChange:!0,pxs:i,sts:o,angles:n,tsts:s,tpxs:r})}drawWindbar(){this.customWind?(this.windCanvas=this.customWind.img,this.valueFun=this.customWind.valueFun):this.windCanvas=H(this.pointSize,this.color,this.lineWidth,this.shadowWidth,this.shadowColor)}render(t){const e=t.zoom,i=t.context,o=t.pxbounds,n=t.drawSize;this.zoom=e,this.pxbounds=o;const{stateChange:s,pxs:r,sts:a,angles:h,tsts:l,tpxs:c}=this.computePoints(e,t.bounds);let u=!1;devicePixelRatio!=this.devicePixelRatio&&(this.devicePixelRatio=devicePixelRatio,u=!0);let m=this.programs.wind;i.useProgram(m),i.bindVertexArray(m.vao),s&&(this.u_drawNum=r.length/2,i.bindBuffer(i.ARRAY_BUFFER,m.vbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(r),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,m.stbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(a),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,m.angleBuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(h),i.STATIC_DRAW)),u&&i.uniform1f(this.u_rto,devicePixelRatio);const d=Math.pow(2,e-8);if(i.uniform1f(this.u_scale,d),i.uniform2f(this.u_oripx,o.xmin,o.ymin),i.uniform2f(this.u_size,n[0],n[1]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.texture),i.uniform1i(this.u_img,0),t.firstDraw&&(i.clear(i.COLOR_BUFFER_BIT),t.firstDraw=!1),i.drawArrays(i.POINTS,0,this.u_drawNum),this.showTexts){let r=this.programs.texts;i.useProgram(r),i.bindVertexArray(r.vao),s&&(this.t_drawNum=c.length/3,i.bindBuffer(i.ARRAY_BUFFER,r.vbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(c),i.STATIC_DRAW),i.bindBuffer(i.ARRAY_BUFFER,r.stbuffer),i.bufferData(i.ARRAY_BUFFER,new Float32Array(l),i.STATIC_DRAW)),u&&i.uniform1f(this.t_rto,devicePixelRatio);const a=Math.pow(2,e-8);i.uniform1f(this.t_scale,a),i.uniform2f(this.t_oripx,o.xmin,o.ymin),i.uniform2f(this.t_size,n[0],n[1]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.textTexture),i.uniform1i(this.t_img,0),t.firstDraw&&(i.clear(i.COLOR_BUFFER_BIT),t.firstDraw=!1),i.drawArrays(i.POINTS,0,this.t_drawNum)}}}class Oe extends U{constructor(t){super(t)}init(t){this.index=t.index||x,this.data=JSON.parse(JSON.stringify(t.data)),this.minZoom=t.minZoom||4,this.deciNum=t.deciNum||50,this.radius=t.radius||5,this.showPoints=t.showPoints,this.fillStyle=t.fillStyle,this.strokeStyle=t.strokeStyle,this.filter=t.filter,this.texts=t.texts||[],this.useSort=t.useSort,this.sortKey=t.sortKey,this.clickEnable=t.clickEnable,this.rbush=new ae,this.clickEnable&&(this.kdbushs={}),this.useSort&&this.buildQueen(),this.computePointsStatic()}buildQueen(){const t=(i=this.sortKey,new Function("a","b",`return a.${i} - b.${i}`)),e=new ie([],t);var i;let o=this.data;const n=this.sortKey;for(let t=0;t<this.data.length;t++){const i=o[t],s=i[n];!s&&0!=s||s>=999999||s<=-99||e.push(i)}this.q=e}computePointsByZoomSort(){let t=this.minZoom;const e=this.rbush;e.clear();let i={},o=[];if(this.useSort){let t=this.q;for(;t.length;)o.push(t.pop());this.q=null}else o=this.data;for(;o.length>0&&t<=13;){i[t]=[];const n=Math.pow(2,t-8),s=this.deciNum/n/devicePixelRatio;for(let n=o.length-1;n>=0;n--){const r=o[n],a=r.px.x,h=r.px.y;let l={minX:a-s,minY:h-s,maxX:a+s,maxY:h+s};e.collides(l)||(i[t].push(r),o.splice(n,1),e.insert({minX:a,minY:h,maxX:a,maxY:h}))}t++}if(this.drawZoomData=i,this.clickEnable)for(let t in i){const e=i[t];this.kdbushs[t]=new Ht(e.length,32);let o=this.kdbushs[t];for(let t=0;t<e.length;t++)o.add(e[t].px.x,e[t].px.y);this.kdbushs[t].finish()}}fireEvent(t){const e=Math.pow(2,this.zoom-8),i=this.radius/e/devicePixelRatio;let o=n(t.latlon.lat,t.latlon.lon,8);if(!(this.zoom<this.minZoom)){for(let e=this.minZoom;e<=this.zoom;e++){let n=this.kdbushs[e];if(!n)continue;let s=n.within(o.x,o.y,i);if(s.length>0){const i=this.drawZoomData[e][s[0][0]];this.fire(t.type,i);break}}return!1}{let e=this.kdbushs[this.minZoom];if(!e)return;let n=e.within(o.x,o.y,i);const s=this.drawZoomData[z][n[0]];this.fire(t.type,s)}}computePointsStatic(){let t=this.data;for(let e=0;e<t.length;e++){const i=t[e],o=n(i.lat,i.lon,8);i.px=o}this.computePointsByZoomSort()}changeData(t,e){this.texts=t,e?(this.data=e,this.useSort&&this.buildQueen(),this.computePointsStatic(),this.layerChangeEvent()):this.layerChangeEvent()}drawPoints(t,e,i,o){const n=this.drawZoomData;let s=this.minZoom,r=i;i<s&&(i=s);const a=this.radius,h=Math.pow(2,r-8)*devicePixelRatio;i=Math.round(i),this.zoom=i;const l=this.texts;t.beginPath();const c=[],u=this.filter,m=[];for(let r=s;r<=i;r++){let i=n[r];if(i)for(let n=0;n<i.length;n++){let s=i[n].lat,r=i[n].lon;if(!(s<o.latlngMin.lat||s>o.latlngMax.lat||r<o.latlngMin.lon||r>o.latlngMax.lon))if(u&&u.search(i[n]))m.push(i[n]);else{let o=i[n].px.x*h-e.xmin*devicePixelRatio,s=i[n].px.y*h-e.ymin*devicePixelRatio;t.moveTo(o+a*devicePixelRatio,s),t.arc(o,s,a*devicePixelRatio,0,2*Math.PI,!1),i[n].drawx=o,i[n].drawy=s,c.push(i[n])}}}this.showPoints&&(t.fillStyle=this.fillStyle,t.fill(),this.strokeStyle&&(t.strokeStyle=this.strokeStyle,t.stroke()));for(let e=0;e<l.length;e++){t.save();const i=l[e],o=i.offset||[0,0];if(i.font&&(t.font=i.font),i.strokeStyle&&(t.strokeStyle=i.strokeStyle,t.lineWidth=i.lineWidth||1),i.fillStyle&&(t.fillStyle=i.fillStyle),i.center){for(let e=0;e<c.length;e++){const n=c[e][i.key],s=-t.measureText(n).width/2;i.strokeStyle&&t.strokeText(n,c[e].drawx+s,c[e].drawy+o[1]),t.fillText(n,c[e].drawx+s,c[e].drawy+o[1])}t.restore()}else{for(let e=0;e<c.length;e++){const n=c[e][i.key];i.strokeStyle&&t.strokeText(n,c[e].drawx+o[0],c[e].drawy+o[1]),t.fillText(n,c[e].drawx+o[0],c[e].drawy+o[1])}t.restore()}}u&&u.callback&&u.callback(m)}render(t){const e=t.zoom,i=t.context;t.firstDraw&&(i.clearRect(0,0,t.drawSize[0],t.drawSize[1]),t.firstDraw=!1),this.drawPoints(i,t.pxbounds,e,t.bounds)}}class je extends ${constructor(t){super(t)}init(t){this.url=t.url,this.startCmd=t.startCmd,this.closeCmd=t.closeCmd,this.decodeFun=t.decodeFun,this.latst=t.latst,this.lonst=t.lonst,this.colors=t.colors,this.linear=t.linear||0,this.maxRange=t.maxRange||5,this.pxZoom=t.pxZoom||15,this.elev=null,this.rnum=null,this.interval=null,this.range=null,this.socketDatas=[],this.computePxToLat(),this.initSocket()}initSelfDraw(t){this.createDraw(t.contexts[this.target].context,"#version 300 es\n    in vec4 a_position;out vec2 point;void main(){gl_Position = a_position;point = a_position.xy;}","#version 300 es\n    #define PI 3.141592653589793238\n    #define PID 57.29577951308232\n    #define Rm 8495.1907\n    #ifdef GL_ES\n    precision highp float;\n    #endif\n    uniform float minpx;\n    uniform sampler2D u_lat;\n    uniform float latnum;\n    uniform float scc;\n    out vec4 outColor;\n    vec2 pxToLatlng(vec3 px){\n       float scale = px.z;\n       float x = scale*px.x - PI;\n       float ynum = px.y*scc - minpx;\n       float stx = mod(ynum,latnum)/(latnum-1.0);\n       float sty = floor(ynum/latnum)/(latnum-1.0);\n       float lat = texture(u_lat,vec2(stx,sty)).r;\n       float lon = x;\n       lon = mod(lon,360.0);\n       return vec2(lat,lon);\n   }\n   uniform vec3 info;\n    vec2 latlngToJ(float latpt,float lonpt){\n       float lonrad = info.y;\n       float latrad = info.x;  \n       float x0 = lonpt;\n       float y0 = latpt;\n       float z0 = info.z;\n       float havLat = sin((latrad - y0) / 2.0);\n       float havLon = sin((lonrad - x0) / 2.0);\n       float a = havLat * havLat + cos(latrad) * cos(y0) * havLon * havLon;\n       float s = 2.0 * atan(sqrt(a),sqrt(1.0 - a));\n       float s1 = 1.5 * atan(sqrt(a)/sqrt(1.0 - a));\n       float r = sin(s1)*Rm /(cos(z0+s1));\n       float aa = cos(y0) * sin(x0 - lonrad) / sin(s);\n       float bb = (sin(y0) - cos(s)*sin(latrad)) / sin(s) / cos(latrad);\n       float a1 = 0.0;\n       if (aa <= 0.93969 && aa >= -0.93969) {\n           a1 = asin(aa);\n           if (bb<=0.0) {\n               a1 = PI - a1;\n           }\n           else if (aa<=0.0 && bb>0.0) {\n               a1 = 2.0 * PI + a1;\n           }\n       }\n       else {\n           a1 = acos(bb);\n           if (lonrad >= x0) {\n               a1 = 2.0 * PI - a1;\n           }\n       }\n       float azi = a1 * PID;\n       return vec2(r,azi);\n   }\nin vec2 point;\nuniform sampler2D u_color;\nuniform sampler2D u_img;\nuniform vec4 oripx;\nuniform vec3 scale;\nuniform vec2 vrange;\nuniform vec2 rs;\nuniform float rto;\nuniform float u_angle; \nvoid main(){\n    float x = oripx.x +gl_FragCoord.x/rto;  \n    float y = oripx.y + (oripx.w - gl_FragCoord.y)/rto;\n    outColor = vec4(1.,0,0,1.);\n    vec2 latlng = pxToLatlng(vec3(x,y,oripx.z));\n    vec2 ij = latlngToJ(latlng.x,latlng.y);\n    float r = ij.x /rs.x;\n    if(fract(r)>=0.5){\n        r = ceil(r);\n    }else{\n        r = floor(r);\n    }\n    r *= rs.x;\n    float a = (r-rs.x)/(rs.y-rs.x);\n    float angle = ij.y - u_angle -1.0;    \n    if(fract(ij.y)>0.5){\n        ij.y = ceil(ij.y);\n    }else{\n        ij.y = floor(ij.y);\n    }\n    \n    float b = ij.y==360.?0.:ij.y/359.;\n    float value = 0.0;  \n    if(a>=0.0&&a<=1.0){ \n        value = texture(u_img,vec2(a,b)).r;\n    }else{\n        discard;  \n    }\n    float vin = (value - vrange.x)/(vrange.y -vrange.x);\n    outColor = texture(u_color,vec2(vin,0.5));\n    float o = (value - vrange.x*0.8)/0.5/vrange.x;\n    o = max(o,0.0); \n    o = min(o,1.0); \n    outColor.a = outColor.a *o;\n\n\n    \n    if((angle + 3.0)>360.0){        \n        angle -= 360.0;    \n    }    \n    float ca = (angle + 3.0)/3.0;    \n    if(ca>1.0 || ca < 0.0){        \n        ca = 0.0;    \n    }    \n    ca = ca * 0.8;    \n    vec3 color = vec3(1.0,0,0);    \n    float aa = outColor.a * (1.0 - ca);    \n    outColor.rgb = color*ca + outColor.rgb*aa;    \n    outColor.a = ca + aa;\n    \n}"),this.setUniforms(t.contexts[this.target].context,this.program),this.createTexture(t.contexts[this.target].context)}setUniforms(t,e){this.gl=t,t.useProgram(this.program),this.oripx=t.getUniformLocation(e,"oripx"),this.radarInfo=t.getUniformLocation(e,"info"),this.rs=t.getUniformLocation(e,"rs"),this.rto=t.getUniformLocation(e,"rto"),t.uniform1f(this.rto,1),this.u_lat=t.getUniformLocation(e,"u_lat"),this.latTexture=t.createTexture(),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,this.latTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.R32F,this.latTextureSize,this.latTextureSize,0,t.RED,t.FLOAT,this.pxToLat);const i=t.getUniformLocation(e,"minpx");t.uniform1f(i,this.minpx);const o=t.getUniformLocation(e,"latnum");t.uniform1f(o,this.latTextureSize),this.scdif=t.getUniformLocation(e,"scc"),this.u_angle=t.getUniformLocation(e,"u_angle")}createTexture(t){this.u_img=t.getUniformLocation(this.program,"u_img"),this.texture=t.createTexture();const e=B(this.colors,this.linear);this.colorTexture=L(t,e.canvas,1),this.u_color=t.getUniformLocation(this.program,"u_color"),t.uniform1i(this.u_color,1),this.vrange=t.getUniformLocation(this.program,"vrange"),t.uniform2f(this.vrange,e.vmin,e.vmax),this.run()}initSocket(){const t=new WebSocket(this.url);t.binaryType="arraybuffer";const e=this.startData.bind(this);t.onopen=function(){e()},t.onmessage=function(t){this.socketDatas.push(t.data),this.socketDatas.length>10&&this.socketDatas.shift()}.bind(this),this.ws=t}closeData(){let t=(new TextEncoder).encode(this.closeCmd);this.ws.send(t)}startData(){let t=(new TextEncoder).encode(this.startCmd);this.ws.send(t)}run(){this.useSocketData(),this.play=window.requestAnimationFrame(this.run.bind(this))}useSocketData(){if(!this.socketDatas)return;const t=this.gl;if(0==this.socketDatas.length)return;const e=this.socketDatas.shift(),i=this.decodeFun(e);if(!i)return;if(this.interval!=i.interval||this.range!=i.range){this.interval=i.interval,this.range=i.range;const e=this.interval,o=this.range;t.uniform2f(this.rs,e,o);const n=Math.round(o/e);t.activeTexture(t.TEXTURE0),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.bindTexture(t.TEXTURE_2D,this.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.R32F,n,360,0,t.RED,t.FLOAT,null)}this.elev!=i.elev&&t.uniform3f(this.radarInfo,this.latst*Math.PI/180,this.lonst*Math.PI/180,this.elev*Math.PI/180);const o=i.azi;t.bindTexture(t.TEXTURE_2D,this.texture),t.texSubImage2D(t.TEXTURE_2D,0,0,o,i.datanum,1,t.RED,t.FLOAT,new Float32Array(i.data)),t.uniform1f(this.u_angle,o),this.layerChangeEvent()}render(t){const e=t.context;e.useProgram(this.program),this.setUniformScale(e,t),devicePixelRatio!=this.devicePixelRatio&&(this.devicePixelRatio=devicePixelRatio,e.uniform1f(this.rto,this.devicePixelRatio)),e.bindVertexArray(this.vao),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.uniform1i(this.u_img,0),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,this.colorTexture),e.uniform1i(this.u_color,1),t.firstDraw&&(e.clear(e.COLOR_BUFFER_BIT),t.firstDraw=!1),e.drawArrays(e.TRIANGLE_STRIP,0,4)}destroy(t){cancelAnimationFrame(this.play),this.closeData(),this.ws.close(),super.destroy(t)}}class Je{constructor(t){this.init(t)}init(t){this.startCmd=t.startCmd,this.url=t.url,this.content=t.content,this.colors=t.colors,this.socketDatas=[],this.decodeFun=t.decodeFun,this.initContet(),this.initSocket()}initSocket(){const t=new WebSocket(this.url);t.binaryType="arraybuffer",this.run();const e=this.startData.bind(this);t.onopen=function(){e()},t.onmessage=function(t){this.socketDatas.push(t.data),this.socketDatas.length>10&&this.socketDatas.shift()}.bind(this),this.ws=t}initContet(){const t=this.content.clientWidth,e=this.content.clientHeight;this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.content.appendChild(this.canvas),this.initGl()}initGl(){const t=this.canvas.getContext("webgl2");t||console.log("init gl failed"),this.gl=t,t.clearColor(0,0,0,0),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA_SATURATE,t.ZERO);const e=b(t,"#version 300 es\nin vec4 a_Position;\nout vec2 point;\nvoid main(){    \n    gl_Position = a_Position;    \n    point = gl_Position.xy;\n}","#version 300 es\n#ifdef GL_ES\nprecision mediump float;\n#endif\nin vec2 point;\nuniform sampler2D u_Sampler;\nuniform sampler2D u_Color;\nuniform vec2 vrange;\nout vec4 outColor;\nvoid main(){\n    float x = (point.x+1.)/2.;\n    float y = (1. + point.y )/2.;\n    outColor = vec4(x,y,0,1.);     \n    float value = texture(u_Sampler,vec2(x,y)).r;\n    float m = vrange.x*0.2;\n    if(m > 1.){\n        m = 1.;\n    }\n    float mid = vrange.x - m;\n    float opa = (value - mid)/m*0.5;    \n    if(opa<0.0){        \n        opa = 0.0;    \n    }    \n    float vin = (value - vrange.x)/(vrange.y -vrange.x);    \n    vec2 p = vec2(vin,0.5);    \n    vec3 rgb = texture(u_Color,p).rgb;    \n    outColor = vec4(rgb,opa);\n}");e?(t.program=e,t.useProgram(e)):cydEvent.cydError("init gl failed");let i=new Float32Array([-1,1,-1,-1,1,1,1,-1]),o=t.getAttribLocation(t.program,"a_Position");var n=E(t,i);t.vbuffer=n;var s=R(t,o,2);t.vao=s,this.createTexture()}createTexture(){const t=this.gl;t.getExtension("OES_texture_float_linear");const e=new Float32Array([10]);this.texture=w(t,e,1,1,0,!0,!1);const i=B(this.colors,0),o=t.getUniformLocation(t.program,"u_Color"),n=t.getUniformLocation(t.program,"u_Sampler");t.uniform1i(n,0),this.colorTexture=L(t,i.canvas,1),t.uniform1i(o,1);const s=t.getUniformLocation(t.program,"vrange");t.uniform2f(s,i.vmin,i.vmax)}closeData(){let t=(new TextEncoder).encode(this.closeCmd);this.ws.send(t)}startData(){let t=(new TextEncoder).encode(this.startCmd);this.ws.send(t)}run(){this.useSocketData(),this.play=window.requestAnimationFrame(this.run.bind(this))}draw(t){const e=this.gl;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.R32F,t.xnum,t.ynum,0,e.RED,e.FLOAT,new Float32Array(t.data)),e.clear(this.gl.COLOR_BUFFER_BIT),e.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}useSocketData(){if(0==this.socketDatas.length)return;const t=this.socketDatas.shift(),e=this.decodeFun(t);e&&this.draw(e)}destroy(){cancelAnimationFrame(this.play),this.closeData(),this.ws.close(),this.gl.deleteTexture(this.texture),this.gl.deleteTexture(this.colorTexture),this.gl.deleteBuffer(this.gl.vbuffer),this.gl.deleteVertexArray(this.gl.vao),this.gl.detachShader(this.gl.program,this.gl.program.vshader),this.gl.detachShader(this.gl.program,this.gl.program.fshader),this.gl.deleteShader(this.gl.program.vshader),this.gl.deleteShader(this.gl.program.fshader),this.gl.deleteProgram(this.gl.program),this.gl.getExtension("WEBGL_lose_context").loseContext(),this.gl=null,this.content.removeChild(this.canvas);for(let t in this)delete this[t]}}function Qe(t){let e=0,i=t.length;if(i<3)return e;(t[0][0]!=t[i-1][0]||t[0][1]!=t[i-1][1])&&(t.push(t[0]),i++);for(let o=0;o<i-1;o++){const[i,n]=t[o].map((t=>t*Math.PI/180)),[s,r]=t[o+1].map((t=>t*Math.PI/180));let a=r-n;a=a>Math.PI?a-2*Math.PI:a<-Math.PI?a+2*Math.PI:a,e+=a*(Math.sin(i)+Math.sin(s))/2}return Math.abs(6378137*e*6378137)}let qe="#version 300 es\n#define PI 3.141592653589793238\n#define PID 57.29577951308232\n#define useCut true\n#ifdef GL_ES\n    precision highp float;\n#endif\nvec2 pxToLatlng(vec3 px){\n    float x = (px.x*px.z - 0.5)*360.0;\n    float y = -(px.y*px.z - 0.5)*PI*2.0;\n    float lat = (2.0 * atan(exp(y)) - (PI / 2.0)) *PID ;\n    float lon = x;\n    lon = mod(lon,360.0);\n    return vec2(lat,lon);\n}\nin vec2 point;\nuniform sampler2D u_color;\nuniform sampler2D u_img;\nuniform vec4 oripx;\nuniform float rto;\nuniform vec4 tbound;\nuniform vec3 vrange;\nuniform bool tminOpacity;\nout vec4 outColor;\n#ifdef useCut\nuniform sampler2D cutImg;\nuniform vec4 cutArea;\nvoid main(){    \n    float x = oripx.x +gl_FragCoord.x/rto;                  \n    float y = oripx.y + (oripx.w - gl_FragCoord.y)/rto;\n    vec2 latlng = pxToLatlng(vec3(x,y,oripx.z));\n    float cuta = (latlng.x - cutArea.x)/(cutArea.y - cutArea.x);\n    float cutb = (latlng.y - cutArea.z)/(cutArea.w - cutArea.z);\n    float cutValue = texture(cutImg,vec2(cutb,cuta)).r;\n    if(cutValue>0.5){\n        discard;\n    }\n    float value = 0.0;\n    float b = (latlng.x - tbound.x)/(tbound.y - tbound.x);\n    float a = (latlng.y - tbound.z)/(tbound.w - tbound.z);\n    value = texture(u_img,vec2(a,b)).r + vrange.z;\n    float vin = (value - vrange.x)/(vrange.y -vrange.x);\n    outColor = texture(u_color,vec2(vin,0.5));\n    if(tminOpacity){\n        float o = (value - vrange.x*0.8)/0.5/vrange.x;\n        o = max(o,0.0);\n        o = min(o,1.0);\n        outColor.a = outColor.a *o;\n    }\n}\n#else\nvoid main(){    \n    float x = oripx.x +gl_FragCoord.x/rto;                  \n    float y = oripx.y + (oripx.w - gl_FragCoord.y)/rto;\n    vec2 latlng = pxToLatlng(vec3(x,y,oripx.z));\n    float value = 0.0;\n    if(latlng.x>=tbound.x&&latlng.x<=tbound.y&&latlng.y>=tbound.z&&latlng.y<=tbound.w){\n        float b = (latlng.x - tbound.x)/(tbound.y - tbound.x);\n        float a = (latlng.y - tbound.z)/(tbound.w - tbound.z);\n        value = texture(u_img,vec2(a,b)).r + vrange.z;\n    }else{\n        discard;\n    }\n    float vin = (value - vrange.x)/(vrange.y -vrange.x);\n    outColor = texture(u_color,vec2(vin,0.5));\n    if(tminOpacity){\n        float o = (value - vrange.x*0.8)/0.5/vrange.x;\n        o = max(o,0.0);\n        o = min(o,1.0);\n        outColor.a = outColor.a *o;\n    }\n}\n#endif\n";class $e extends tt{constructor(t){super(t),this.data=t.data,this.height=t.height,this.width=t.width}initSelfDraw(t){this.cut||(qe=qe.replace("#define useCut true","")),this.createDraw(t.contexts[this.target].context,"#version 300 es\nin vec4 a_position;\nout vec2 point;\nvoid main(){\n    gl_Position = a_position;\n    point = a_position.xy;\n}",qe),this.setUniforms(t.contexts[this.target].context,this.program),this.createTexture(t.contexts[this.target].context),this.cut&&this.createCutTexture(t.contexts[this.target].context)}createTexture(t){t.getExtension("OES_texture_float_linear");const e=this.data.flat();this.texture=w(t,e,this.width,this.height,0,this.grid,this.flipy),this.ready=!0;const i=B(this.colors,this.linear);this.colorTexture=L(t,i.canvas,1),this.u_color=t.getUniformLocation(this.program,"u_color"),t.uniform1i(this.u_color,1),this.vrange=t.getUniformLocation(this.program,"vrange");let o=0;i.vmin<0&&(i.vmin=Math.abs(i.vmin),i.vmax=i.vmax+2*i.vmin,o=2*i.vmin),t.uniform3f(this.vrange,i.vmin,i.vmax,o)}changeGridData(t){const e=this.gl;e.activeTexture(e.TEXTURE0),this.flipy?e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1):e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.R32F,this.width,this.height,0,e.RED,e.FLOAT,new Float32Array(t.flat())),this.layerChangeEvent()}}class ti extends u{constructor(t){super(t),this.index=t.index||f}init(t){this.coords=t.coords,this.lineWidth=t.lineWidth||1,this.lineJoin=t.lineJoin||"miter",this.color=t.color||"black",t.outLine&&(this.outLineWidth=t.lineWidth+2*t.outLine,this.outLineColor=t.outLineColor||"black"),this.zoom=null,this.dash=t.dash??!1,t.dash&&(this.dashOffset=t.dashOffset||1,this.dashArr=t.dashArr||[5,5])}testOptions(t){if(!t.coords)throw new Error("no coords")}computePos8(){}computePos(t,e,i,o,s){const r=Math.round(t),a=this.coords;if(r!=this.zoom){this.pxes=new Array(a.length),this.zoom=r;const t=n(a[0][0],a[0][1],r);this.pxes[0]=[t.x,t.y],t.x=t.x*i-o.xmin,t.y=t.y*i-o.ymin,e.moveTo(t.x*s,t.y*s);const h=this.pxes;for(let t=1;t<a.length;t++){const l=n(a[t][0],a[t][1],r);h[t]=[l.x,l.y],l.x=l.x*i-o.xmin,l.y=l.y*i-o.ymin,e.lineTo(l.x*s,l.y*s)}}else{const t=this.pxes;e.moveTo((t[0][0]*i-o.xmin)*s,(t[0][1]*i-o.ymin)*s);for(let n=1;n<t.length;n++){const r=t[n][0]*i-o.xmin,a=t[n][1]*i-o.ymin;e.lineTo(r*s,a*s)}}}render(t){const e=t.context,i=t.pxbounds,o=t.zoom,n=t.devicePixelRatio;t.firstDraw&&(e.clearRect(0,0,t.drawSize[0],t.drawSize[1]),t.firstDraw=!1),this.dash&&(e.setLineDash(this.dashArr),e.lineDashOffset=this.dashOffset),e.beginPath(),this.computePos(o,e,t.zoomScale,i,n),e.lineJoin=this.lineJoin,this.outLineWidth&&(e.lineWidth=this.outLineWidth,e.strokeStyle=this.outLineColor,e.stroke()),e.strokeStyle=this.color,e.lineWidth=this.lineWidth,e.stroke()}}export{Be as Basis,Ee as DeciPointGroup,Oe as DeciTextGroup,It as ElImgMarker,I as ElMarker,He as GDeciWindbar,D as GMarker,$t as GMarkerGroup,Ut as GPolygon,Q as GPolyline,Yt as GText,P as GTileLayer,Ft as GVectorPoints,Gt as GVectorTile,_e as GWindbar,te as GeojsonLines,Re as GeojsonLinesLabel,Le as GeojsonPolygon,we as GeojsonVolume,tt as GlImg,$e as GridImg,ee as GridPoints,Vt as GridWindbar,Nt as Img3857,Ae as ImgdataGetter,Ye as Isoline,$ as JzbImg,je as JzbImgSocket,Bt as JzbProfile,u as Layer,X as LayerGroup,c as Map,W as PointGroup,C as PointLayer,ke as PointToGrid,ti as PolyLine,Kt as Profile,Se as SliceImg,v as TileLayer,Z as VectorTile,Pe as Windy,Me as Wms,Qe as calculatePolygonArea,n as project,Je as socketProfile};
