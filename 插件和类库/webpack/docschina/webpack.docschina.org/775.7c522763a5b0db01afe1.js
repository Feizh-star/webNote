(self.webpackChunk=self.webpackChunk||[]).push([[775],{775:function(n){n.exports='<p>插件是 webpack 生态的关键部分， 它为社区用户提供了一种强有力的方式来直接触及 webpack 的编译过程(compilation process)。 插件能够 <a href="api/compiler-hooks/index.htm#hooks"/*tpa=https://webpack.docschina.org/api/compiler-hooks/#hooks*/>hook</a> 到每一个编译(compilation)中发出的关键事件中。 在编译的每个阶段中，插件都拥有对 <code>compiler</code> 对象的完全访问能力， 并且在合适的时机，还可以访问当前的 <code>compilation</code> 对象。</p> <blockquote class="tip"> <p>关于编写插件的高级介绍，请移步： <a href="contribute/writing-a-plugin.htm"/*tpa=https://webpack.docschina.org/contribute/writing-a-plugin*/>自定义插件</a>。</p> </blockquote> <p>让我们首先从 tapable 工具开始， 它为 webpack 插件接口提供了核心能力的。</p> <h2 id="tapable">Tapable <a href="#tapable" aria-hidden="true" tabindex="-1"><span class="header-link"></span></a></h2> <p>这个小型库是 webpack 的一个核心工具，但也可用于其他地方， 以提供类似的插件接口。 在 webpack 中的许多对象都扩展自 <code>Tapable</code> 类。 它对外暴露了 <code>tap</code>，<code>tapAsync</code> 和 <code>tapPromise</code> 等方法， 插件可以使用这些方法向 webpack 中注入自定义构建的步骤，这些步骤将在构建过程中触发。</p> <p>请查阅<a href="https://github.com/webpack/tapable">文档</a>了解更多知识。 理解上面的的三种 <code>tap</code> 方法， 以及提供这些方法的钩子(hooks)对于编写插件来说是至关重要的。 那些扩展自 <code>Tapable</code> 的对象（例如：compiler）， 以及其提供的钩子(hooks)和每个钩子的类型（例如：<code>同步钩子(SyncHook)</code>）值得关注。</p> <h2 id="plugin-types">插件类型 <a href="#plugin-types" aria-hidden="true" tabindex="-1"><span class="header-link"></span></a></h2> <p>根据使用不同的钩子(hooks)和 <code>tap</code> 方法， 插件可以以多种不同的方式运行。 这个工作方式与 Tapable 提供的<a href="https://github.com/webpack/tapable#tapable">钩子(hooks)</a>密切相关。 <a href="api/compiler-hooks/index.htm#hooks"/*tpa=https://webpack.docschina.org/api/compiler-hooks/#hooks*/>compiler hooks</a> 分别记录了 Tapable 内在的钩子， 并指出哪些 tap 方法可用。</p> <p>所以，依赖于使用的 <code>tap</code> 方法的不同， 插件可能会以不同的方式运行。 例如：当你钩入到 <code>编译(compile)</code> 阶段时，只有同步的 <code>tap</code> 方法可以使用。</p> <pre><code class="hljs language-js">compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compile<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">\'MyPlugin\'</span><span class="token punctuation">,</span> <span class="token parameter">params</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'以同步方式触及 compile 钩子。\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> <p>然而，对于可以使用 <code>AsyncHook</code> 的 <code>run</code> 阶段， 则需使用 <code>tapAsync</code> 或 <code>tapPromise</code>（以及 <code>tap</code>）方法。</p> <pre><code class="hljs language-js">compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">\'MyPlugin\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> routesList<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'以异步方式触及 run 钩子。\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ncompiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">\'MyPlugin\'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> routesList</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'以具有延迟的异步方式触及 run 钩子。\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\ncompiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>run<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">\'MyPlugin\'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> routesList</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">\'以具有延迟的异步方式触及 run 钩子。\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> <p>这些需求(story)的含义在于， 我们可以有多种方式 hook 到 compiler 中，可以让各种插件都以合适的方式去运行。</p> <h2 id="custom-hooks">自定义钩子 <a href="#custom-hooks" aria-hidden="true" tabindex="-1"><span class="header-link"></span></a></h2> <p>为了便于其他插件的编译过程中可以 <code>tap</code> 到，则需要创建一个新的 hook， 我们只需要简单的从 <code>tapable</code> 中 <code>require</code> 所需的 hook 类，并创建：</p> <pre><code class="hljs language-js"><span class="token keyword">const</span> SyncHook <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">\'tapable\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>SyncHook<span class="token punctuation">;</span>\n\n<span class="token keyword">if</span> <span class="token punctuation">(</span>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>myCustomHook<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">\'已存在该钩子\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\ncompiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>myCustomHook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">\'a\'</span><span class="token punctuation">,</span> <span class="token string">\'b\'</span><span class="token punctuation">,</span> <span class="token string">\'c\'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// 在你想要触发钩子的位置/时机下调用……</span>\ncompiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">myCustomHook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> <p>再次声明， 查看 <code>tapable</code> <a href="https://github.com/webpack/tapable">文档</a> 来了解更多不同的钩子类(hook class)，以及它们是如何工作的。</p> <h2 id="reporting-progress">进度报告 <a href="#reporting-progress" aria-hidden="true" tabindex="-1"><span class="header-link"></span></a></h2> <p>插件能够通过 <a href="plugins/progress-plugin/index.htm"/*tpa=https://webpack.docschina.org/plugins/progress-plugin/*/><code>ProgressPlugin</code></a> 这个在默认情况下将信息打印到标准错误输出(stderr)的插件来进行进度报告。如果想要使用这个功能，只需要在使用 <a href="api/cli/index.htm"/*tpa=https://webpack.docschina.org/api/cli/*/>webpack CLI</a> 的时候传入 <code>--progress</code> 参数。</p> <p>如果想要自定义打印输出，只需要传递不同的参数到 <a href="plugins/progress-plugin/index.htm"/*tpa=https://webpack.docschina.org/plugins/progress-plugin/*/><code>ProgressPlugin</code></a> 的 <code>reportProgress</code> 方法。</p> <p>如果想要报告进度，插件必须在 <code>tap</code> 到 hook 的时候使用 <code>context: true</code> 选项。</p> <pre><code class="hljs language-js">compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>\n  name<span class="token operator">:</span> <span class="token string">\'MyPlugin\'</span><span class="token punctuation">,</span>\n  context<span class="token operator">:</span> <span class="token boolean">true</span>\n<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">context<span class="token punctuation">,</span> compiler<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> reportProgress <span class="token operator">=</span> context <span class="token operator">&#x26;&#x26;</span> context<span class="token punctuation">.</span>reportProgress<span class="token punctuation">;</span>\n  <span class="token keyword">if</span> <span class="token punctuation">(</span>reportProgress<span class="token punctuation">)</span> <span class="token function">reportProgress</span><span class="token punctuation">(</span><span class="token number">0.95</span><span class="token punctuation">,</span> <span class="token string">\'Starting work\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>reportProgress<span class="token punctuation">)</span> <span class="token function">reportProgress</span><span class="token punctuation">(</span><span class="token number">0.95</span><span class="token punctuation">,</span> <span class="token string">\'Done work\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> <p><code>reportProgress</code> 方法在被调用的时候会传入以下的参数：</p> <pre><code class="hljs language-js"><span class="token function">reportProgress</span><span class="token punctuation">(</span>percentage<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre> <ul> <li><code>percentage</code>：此参数未使用。作为代替，<a href="plugins/progress-plugin/index.htm"/*tpa=https://webpack.docschina.org/plugins/progress-plugin/*/><code>ProgressPlugin</code></a> 插件会基于当前的钩子(hook)计算进度。</li> <li><code>...args</code>：任意数量的字符串，这些字符串会传递给 <code>ProgressPlugin</code> 插件并报告给用户。</li> </ul> <p>注意：只有 compiler 和 compilation 钩子的子集才支持 <code>reportProgress</code> 方法。请查看 <a href="plugins/progress-plugin/index.htm#supported-hooks"/*tpa=https://webpack.docschina.org/plugins/progress-plugin/#supported-hooks*/><code>ProgressPlugin</code></a> 了解更多信息。</p> <h2 id="logging">日志 <a href="#logging" aria-hidden="true" tabindex="-1"><span class="header-link"></span></a></h2> <p>日志的 API 在 webpack 4.37 版本后提供支持。当 <code>logging</code> 在 <a href="configuration/stats/index.htm#statslogging"/*tpa=https://webpack.docschina.org/configuration/stats/#statslogging*/><code>统计配置(stats configuration)</code></a>中可用和(或)当 <a href="configuration/other-options/index.htm#infrastructurelogging"/*tpa=https://webpack.docschina.org/configuration/other-options/#infrastructurelogging*/><code>infrastructure logging</code></a> 可用的时候，插件会通过各自的记录格式(stats，infrastructure)打印信息。</p> <ul> <li>插件可以使用 <code>compilation.getLogger(\'PluginName\')</code> 来做记录。这种形式的记录保存在统计数据(Stats)中并做相应的格式化。它能够被用户过滤和导出。</li> <li>插件也可以使用 <code>compilation.getInfrastructureLogger(\'PluginName\')</code> 来做记录。使用 <code>infrastructure</code> 的形式并不会被保存在统计数据(Stats)中，因此也不会被格式化。它通常直接将记录载入到 console/dashboard/GUI 中。它能够被用户过滤。</li> <li>插件也可以使用特殊的降级逻辑 <code>compilation.getLogger ? compilation.getLogger(\'PluginName\') : console</code> 来检测是否支持记录，以此来在不支持 <code>compilation.getLogger</code> 方法的旧版本 webpack 中提供降级方法。</li> </ul> <h2 id="next-steps">下一步 <a href="#next-steps" aria-hidden="true" tabindex="-1"><span class="header-link"></span></a></h2> <p>查看 <a href="api/compiler-hooks/index.htm"/*tpa=https://webpack.docschina.org/api/compiler-hooks/*/>compiler hooks</a> 部分， 了解所有可用的 <code>compiler</code> 钩子以及它们提供的参数的详细列表。</p> '}}]);